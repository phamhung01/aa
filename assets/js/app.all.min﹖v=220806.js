var app=angular.module("WebApp",["ngRoute","ui.bootstrap","dynamicNumber","pascalprecht.translate","ngCookies","tc.chartjs","ngSanitize","ui.select"]);app.config(["dynamicNumberStrategyProvider",function(a){a.addStrategy("number",{numInt:6,numFract:4,numSep:".",numPos:!0,numNeg:!1,numRound:"round",numThousand:!0,numThousandSep:" "})}]),app.config(["$routeProvider",function(a){a.when("/dashboard",{templateUrl:"app/components/Systems/Dashboard/dashboard.html?nd="+Date.now(),controller:"DashboardCtrl"}).when("/itemCategory",{templateUrl:"app/components/Master/ItemCategory/ItemCategoryList.html?nd="+Date.now(),controller:"ItemCategoryCtrl"}).when("/UnitOfMeasure",{templateUrl:"app/components/Master/UnitOfMeasure/UnitOfMeasureList.html?nd="+Date.now(),controller:"UnitOfMeasureCtrl"}).when("/Item",{templateUrl:"app/components/Master/Item/ItemList.html?nd="+Date.now(),controller:"ItemCtrl"}).when("/Item2",{templateUrl:"app/components/Master/ItemPOS/ItemPOSList.html?nd="+Date.now(),controller:"ItemPOSCtrl"}).when("/Area",{templateUrl:"app/components/Master/SaleArea/SaleAreaList.html?nd="+Date.now(),controller:"SaleAreaCtrl"}).when("/RoomType",{templateUrl:"app/components/Master/LoaiPhong/LoaiPhongList.html?nd="+Date.now(),controller:"LoaiPhongCtrl"}).when("/tablelayout",{templateUrl:"app/components/Master/SaleTable/SaleTableList.html?nd="+Date.now(),controller:"SaleTableCtrl"}).when("/TimeOfSale",{templateUrl:"app/components/Master/TimeOfSale/TimeOfSaleList.html?nd="+Date.now(),controller:"TimeOfSaleCtrl"}).when("/PriceList",{templateUrl:"app/components/Master/PriceList/PriceList.html?nd="+Date.now(),controller:"PriceCtrl"}).when("/Price2",{templateUrl:"app/components/Master/GiaLePOS/GiaLePOSList.html?nd="+Date.now(),controller:"GiaLePOSCtrl"}).when("/Price3",{templateUrl:"app/components/Master/GiaLeKaraoke/GiaLeKaraokeList.html?nd="+Date.now(),controller:"GiaLeKaraokeCtrl"}).when("/RelationPrice",{templateUrl:"app/components/Master/RelationPrice/RelationPriceList.html?nd="+Date.now(),controller:"RelationPriceCtrl"}).when("/LocationStore",{templateUrl:"app/components/Master/LocationStore/LocationStoreList.html?nd="+Date.now(),controller:"LocationStoreCtrl"}).when("/CustomerCategory",{templateUrl:"app/components/Master/CustomerCategory/CustomerCategoryList.html?nd="+Date.now(),controller:"CustomerCategoryCtrl"}).when("/Customer",{templateUrl:"app/components/Master/Customer/CustomerList.html?nd="+Date.now(),controller:"CustomerCtrl"}).when("/SupplierCategory",{templateUrl:"app/components/Master/SupplierCategory/SupplierCategoryList.html?nd="+Date.now(),controller:"SupplierCategoryCtrl"}).when("/Supplier",{templateUrl:"app/components/Master/Supplier/SupplierList.html?nd="+Date.now(),controller:"SupplierCtrl"}).when("/GroupShipper",{templateUrl:"app/components/Master/GroupShipper/GroupShipperList.html?nd="+Date.now(),controller:"GroupShipperCtrl"}).when("/Shipper",{templateUrl:"app/components/Master/Shipper/ShipperList.html?nd="+Date.now(),controller:"ShipperCtrl"}).when("/DauKyCNKH",{templateUrl:"app/components/Master/DauKyCongNoKH/DauKyCongNoKHList.html?nd="+Date.now(),controller:"DauKyCongNoKHCtrl"}).when("/DauKyCNNCC",{templateUrl:"app/components/Master/DauKyCongNoNCC/DauKyCongNoNCCList.html?nd="+Date.now(),controller:"DauKyCongNoNCCCtrl"}).when("/Promotion",{templateUrl:"app/components/Promotion/Promotion/PromotionList.html?nd="+Date.now(),controller:"PromotionCtrl"}).when("/discountrate",{templateUrl:"app/components/Promotion/KhaiBaoMucChietKhau/KhaiBaoMucChietKhauList.html?nd="+Date.now(),controller:"KhaiBaoMucChietKhauCtrl"}).when("/cogVip",{templateUrl:"app/components/Promotion/ThietLapTheVip/ThietLapTheVipList.html?nd="+Date.now(),controller:"ThietLapTheVipCtrl"}).when("/RVip01",{templateUrl:"app/components/Promotion/LogGiaoDichTheVip/LogGiaoDichTheVipList.html?nd="+Date.now(),controller:"LogGiaoDichTheVipCtrl"}).when("/InvStockIn",{templateUrl:"app/components/Inventory/InvStockIn/StockInList.html?nd="+Date.now(),controller:"StockInCtrl"}).when("/InvStockInBranch",{templateUrl:"app/components/Inventory/InvStockInOtherBranch/StockInOtherBranchList.html?nd="+Date.now(),controller:"StockInOtherBranchCtrl"}).when("/InvStockOut",{templateUrl:"app/components/Inventory/InvStockOut/StockOutList.html?nd="+Date.now(),controller:"StockOutCtrl"}).when("/InvStockOutBranch",{templateUrl:"app/components/Inventory/InvStockOutOtherBranch/StockOutOtherBranchList.html?nd="+Date.now(),controller:"StockOutOtherBranchCtrl"}).when("/InvStockTransfer",{templateUrl:"app/components/Inventory/InvStockTransfer/StockTransferList.html?nd="+Date.now(),controller:"StockTransferCtrl"}).when("/InvBOM",{templateUrl:"app/components/Inventory/InvKhaoBaoDinhMuc/InvKhaiBaoDinhMucList.html?nd="+Date.now(),controller:"InvKhaiBaoDinhMucCtrl"}).when("/InvRawMaterial",{templateUrl:"app/components/Inventory/InvDinhLuong/InvTinhDinhLuongList.html?nd="+Date.now(),controller:"InvTinhDinhLuongCtrl"}).when("/InvPhysical",{templateUrl:"app/components/Inventory/InvPhysical/InvPhysicalList.html?nd="+Date.now(),controller:"InvPhysicalCtrl"}).when("/InvR01",{templateUrl:"app/components/Inventory/InvBaoCaoTonKho/InvBaoCaoTonKhoList.html?nd="+Date.now(),controller:"InvBaoCaoTonKhoCtrl"}).when("/InvR02",{templateUrl:"app/components/Inventory/InvBaoCaoNhapXuatTon/InvBaoCaoNhapXuatTonList.html?nd="+Date.now(),controller:"InvBaoCaoNhapXuatTonCtrl"}).when("/InvR03",{templateUrl:"app/components/Inventory/InvBaoCaoGiaVonThanhPham/InvBaoCaoGiaVonThanhPhamList.html?nd="+Date.now(),controller:"InvBaoCaoGiaVonThanhPhamCtrl"}).when("/InvR04",{templateUrl:"app/components/Inventory/InvCanhBaoHangTonKho/InvCanhBaoHangTonKhoList.html?nd="+Date.now(),controller:"InvCanhBaoHangTonKhoCtrl"}).when("/InvR05",{templateUrl:"app/components/Inventory/CongNoNhaCungCap/CongNoNhaCungCapList.html?nd="+Date.now(),controller:"CongNoNhaCungCapCtrl"}).when("/InvR06",{templateUrl:"app/components/Inventory/InvBaoCaoHangNhapMuaNCC/InvBaoCaoHangNhapMuaNCCList.html?nd="+Date.now(),controller:"InvBCNhapMuaNCCCtrl"}).when("/Branch",{templateUrl:"app/components/Systems/Branch/BranchList.html?nd="+Date.now(),controller:"BranchCtrl"}).when("/Counter",{templateUrl:"app/components/Systems/Counter/counterList.html?nd="+Date.now(),controller:"CounterCtrl"}).when("/permission",{templateUrl:"app/components/Systems/Permission/PermissionInfo.html?nd="+Date.now(),controller:"PermissionCtrl"}).when("/Setting",{templateUrl:"app/components/Systems/Setting/SettingList.html?nd="+Date.now(),controller:"SettingCtrl"}).when("/sysUserGroup",{templateUrl:"app/components/Systems/sysUserGroup/sysUserGroupList.html?nd="+Date.now(),controller:"sysUserGroupCtrl"}).when("/sysUser",{templateUrl:"app/components/Systems/sysUser/sysUserList.html?nd="+Date.now(),controller:"sysUserCtrl"}).when("/connectedstatus",{templateUrl:"app/components/Systems/Auth/ConnectedStatus.html?nd="+Date.now(),controller:"ConnectedStatusCtrl"}).when("/logTransaction",{templateUrl:"app/components/Systems/LogTransaction/LogTransactionList.html?nd="+Date.now(),controller:"LogTransactionCtrl"}).when("/deviceconnected",{templateUrl:"app/components/Systems/DeviceConnected/DeviceConnected.html?nd="+Date.now(),controller:"DeviceConnectedCtrl"}).when("/QuanLyChuoi",{templateUrl:"app/components/Systems/BaoCaoChuoiCuaHang/ChuoiCuaHangList.html?nd="+Date.now(),controller:"ChuoiCuaHangCtrl"}).when("/TouchScreen",{templateUrl:"app/components/Sales/Restaurant/TouchScreen.html?nd="+Date.now(),controller:"RestaurantCtrl"}).when("/POS",{templateUrl:"app/components/Sales/POS/ManHinhBanLe.html?nd="+Date.now(),controller:"ManHinhBanLeCtrl"}).when("/POSv2",{templateUrl:"app/components/Sales/POS/ManHinhBanLe_v2.html?nd="+Date.now(),controller:"ManHinhBanLeCtrl"}).when("/Motel",{templateUrl:"app/components/Sales/Motel/Motel.html?nd="+Date.now(),controller:"MotelCtrl"}).when("/ListRetail",{templateUrl:"app/components/Sales/RestaurantList/RestaurantList.html?nd="+Date.now(),controller:"RestaurantListCtrl"}).when("/ListRefund",{templateUrl:"app/components/Sales/POSRefund/HoaDonTraHangList.html?nd="+Date.now(),controller:"HoaDonTraHangCtrl"}).when("/SR01",{templateUrl:"app/components/Sales/DoanhThuTheoNgay/DoanhThuTheoNgayList.html?nd="+Date.now(),controller:"DoanhThuTheoNgayCtrl"}).when("/SR02",{templateUrl:"app/components/Sales/ChiTietBanHangTheoNhomHang/ChiTietBanHangTheoNhomHangList.html?nd="+Date.now(),controller:"ChiTietBanHangTheoNhomHangCtrl"}).when("/SR03",{templateUrl:"app/components/Sales/ChiTietBanHangTheoKhuVuc/ChiTietBanHangTheoKhuVucList.html?nd="+Date.now(),controller:"ChiTietBanHangTheoKhuVucCtrl"}).when("/SR04",{templateUrl:"app/components/Sales/TongHopTraMon/TongHopTraMonList.html?nd="+Date.now(),controller:"TongHopTraMonCtrl"}).when("/SR05",{templateUrl:"app/components/Sales/BaoCaoTongHop/BaoCaoTongHopList.html?nd="+Date.now(),controller:"BaoCaoTongHopCtrl"}).when("/SR06",{templateUrl:"app/components/Sales/BieuDoDoanhThu/BieuDoDoanhThuList.html?nd="+Date.now(),controller:"BieuDoDoanhThuCtrl"}).when("/SR07",{templateUrl:"app/components/Sales/NhatKyBanHang/NhatKyBanHangList.html?nd="+Date.now(),controller:"NhatKyBanHangCtrl"}).when("/SR08",{templateUrl:"app/components/Sales/CongNoKhachHang/CongNoKhachHangList.html?nd="+Date.now(),controller:"CongNoKhachHangCtrl"}).when("/SR09",{templateUrl:"app/components/Sales/ChiTietBanHang_Shipper/ChiTietBanHang_ShipperList.html?nd="+Date.now(),controller:"ChiTietBanHang_ShipperCtrl"}).when("/SR10",{templateUrl:"app/components/Sales/DoanhThuChiTietTheoNgay/DoanhThuChiTietTheoNgayList.html?nd="+Date.now(),controller:"DoanhThuChiTietTheoNgayCtrl"}).when("/SR11",{templateUrl:"app/components/Sales/DoanhThuChiTietHangHoa/DoanhThuChiTietHangHoaList.html?nd="+Date.now(),controller:"DoanhThuChiTietHangHoaCtrl"}).when("/DonDatHangBan",{templateUrl:"app/components/Sales/DonDatHangBan/DonDatHangBanList.html?nd="+Date.now(),controller:"DonDatHangBanCtrl"}).when("/HoaDonBanSi",{templateUrl:"app/components/Sales/HoaDonBanSi/HoaDonBanSiList.html?nd="+Date.now(),controller:"HoaDonBanSiCtrl"}).when("/SR12",{templateUrl:"app/components/Sales/LichSuKetCa/LichSuKetCaList.html?nd="+Date.now(),controller:"LichSuKetCaCtrl"}).when("/SR13",{templateUrl:"app/components/Sales/DoanhThuChiTietTienGio/DoanhThuChiTietTienGioList.html?nd="+Date.now(),controller:"DoanhThuChiTietTienGioCtrl"}).when("/SR14",{templateUrl:"app/components/Sales/TongHopDoanhSoTrongNgay/TongHopDoanhSoTrongNgayList.html?nd="+Date.now(),controller:"TongHopDoanhSoTrongNgayCtrl"}).when("/SR15",{templateUrl:"app/components/Sales/ChiTietBanHangNhomKhachHang/ChiTietBanHangNhomKhachHangList.html?nd="+Date.now(),controller:"ChiTietBanHangNhomKhachHangCtrl"}).when("/SR16",{templateUrl:"app/components/Sales/ChiTietBanHangPTLaiLo/ChiTietBanHangPTLaiLoList.html?nd="+Date.now(),controller:"ChiTietBanHangPTLaiLoCtrl"}).when("/Receipt",{templateUrl:"app/components/Finacial/Receipts/ReceiptsList.html?nd="+Date.now(),controller:"ReceiptsCtrl"}).when("/Payment",{templateUrl:"app/components/Finacial/Payments/PaymentsList.html?nd="+Date.now(),controller:"PaymentsCtrl"}).when("/cost",{templateUrl:"app/components/Master/Cost/CostList.html?nd="+Date.now(),controller:"CostCtrl"}).when("/nganquy",{templateUrl:"app/components/Master/NganQuy/NganQuyList.html?nd="+Date.now(),controller:"NganQuyCtrl"}).when("/FinR01",{templateUrl:"app/components/Finacial/SoQuyTien/SoQuyTienList.html?nd="+Date.now(),controller:"FinacialSoQuyTienCtrl"}).when("/FinR02",{templateUrl:"app/components/Finacial/KetQuaKinhDoanh/KetQuaKinhDoanhList.html?nd="+Date.now(),controller:"FinacialKetQuaKinhDoanhCtrl"}).when("/FinR03",{templateUrl:"app/components/Finacial/TongHopChiPhi/TongHopChiPhiList.html?nd="+Date.now(),controller:"FinacialTongHopChiPhiCtrl"}).otherwise({redirectTo:"/dashboard"})}]),app.controller("HeaderController",["$scope","$window","$http","AppDialog","AppServices",function(a,b,c,d,e){function f(){e.showloading(),e.Post("GetListBranchByUser",{CompanyId:e.CompanyId},e.Url+"api/Branch/").then(function(c){a.branchList=c.data.Data,b.sessionStorage.branchList=JSON.stringify(a.branchList)},function(a){})["finally"](function(){e.closeloading()})}a.UserName="",a.BranchName="",a.Address="",a.branchList=null,a.updated=Date.now(),a.menuTinhDinhLuong="";var g=null;b.sessionStorage.TokenInfo&&(g=JSON.parse(b.sessionStorage.TokenInfo),a.UserName=g.userName,a.BranchName=g.BranchName,a.Address=g.Address,a.MaNganh=g.MaNganh,a.LoaiPM=g.MaNganh,a.LoaiHinhKinhDoanh=g.LoaiHinhKinhDoanh,"Restaurant"===a.LoaiPM&&(a.menuTinhDinhLuong=" - Tính định lượng")),a.ChiNhanh=a.BranchName,a.logout=function(){d.ShowConfirmDialog("Bạn có chắc muốn thoát chương trình ?").then(function(a){0==a&&(e.url=e.Url+"api/Auth/",e.Post("LogOff",null,e.url).then(function(a){sessionStorage.clear(),b.localStorage.TokenInfo=null,e.accessToken=void 0,window.location="/login.html"}))})},a.changePass=function(){var a={};d.ShowDetailFormDialog({data:a,tempUrl:"app/components/Systems/sysUser/ChangePassword.html",ctrl:"sysUserChangePassCtrl",cssclass:"Modal-width550",focuscontrolid:"Pwd"}).then(function(a){})},f(),a.btnDoiChiNhanh_Click=function(){a.branchList.length>1&&d.ShowDetailFormDialog({data:a.branchList,tempUrl:"app/components/systems/Branch/SelectChiNhanh.html",ctrl:"DoiChiNhanhCtrl",cssclass:"Modal-width600",focuscontrolid:""}).then(function(b){if(1===b.status){var c=b.responValue;g.Address=c.Address,g.BranchId=c.ID,g.BranchName=c.Name,g.MaGianHang=c.Code,a.Address=c.Address,a.BranchId=c.ID,a.BranchName=c.Name,a.MaGianHang=c.Code,a.ChiNhanh=c.Name,location.reload()}})}}]),app.controller("DoiChiNhanhCtrl",["$scope","$timeout","$window","$location","$http","$uibModalInstance","data","AppDialog",function(a,b,c,d,e,f,g,h){a.branchList=angular.copy(g),a.branchSelected=null,a.btnCancel=function(){f.close({status:0,responValue:null})},a.btnChiNhanh_Click=function(b){for(var c=0;c<=a.branchList.length-1;c++)a.branchList[c].ID===b.ID?(a.branchList[c].selected=1,a.branchSelected=a.branchList[c]):a.branchList[c].selected=0},a.btnSelect_Click=function(){if(null!==a.branchSelected){var b=null;c.sessionStorage.TokenInfo&&(b=JSON.parse(c.sessionStorage.TokenInfo));var d=c.localStorage.UserMP,g=void 0===d?"":window.atob(d),h="grant_type=password&username="+b.userName+"&password="+g+"&LoginDevice=WebApp&subDomain="+a.branchSelected.Code+"&hostWebService="+sessionStorage.getItem("host")+"&ChangeBranch=1";e.post(sessionStorage.getItem("host")+"token",h,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){console.log(a);var b=c.localStorage.Version;b=void 0===b||null===b?"1.0.0.0":b;var d=JSON.parse(a.Role);userInfo={accessToken:a.access_token,userName:a.userName,subDomain:a.subDomain,MaGianHang:a.BranchCode,CompanyId:a.CompanyId,BranchId:a.BranchId,BranchName:a.BranchName,Address:a.Address,AddOn:a.AddOn,IsAdministrator:a.IsAdministrator,Role:d,LoginTime:a.LoginTime,Version:a.Version,BanHangCanTeen:a.BanHangCanTeen,InVaLuuHoaDon:a.InVaLuuHoaDon,userId:a.userId,MaNganh:a.MaNganh,LoaiHinhKinhDoanh:a.LoaiHinhKinhDoanh,TraSua_SuaSoLuong:a.TraSua_SuaSoLuong,EmployeeName:a.EmployeeName,IsUsedColor_Size:a.IsUsedColor_Size,NumDeviceConnect:a.NumDeviceConnect},c.sessionStorage.TokenInfo=JSON.stringify(userInfo),c.localStorage.TokenInfo=JSON.stringify(userInfo),c.localStorage.MaGianHang=userInfo.MaGianHang,c.localStorage.UserName=userInfo.userName,c.localStorage.Version=a.Version,f.close({status:1,responValue:{Address:userInfo.Address,BranchId:userInfo.BranchId,BranchName:userInfo.BranchName,MaGianHang:userInfo.MaGianHang}})}).error(function(a,b){})}},a.btnQuanLyChuoi_Click=function(){d.path("/QuanLyChuoi"),f.close({status:0,responValue:null})}}]),app.config(["$translateProvider",function(a){var b=void 0===window.localStorage.NG_TRANSLATE_LANG_KEY?"VN":window.localStorage.NG_TRANSLATE_LANG_KEY;a.useStaticFilesLoader({prefix:"app/translations/",suffix:".json"}).preferredLanguage(b).useLocalStorage().useSanitizeValueStrategy(null)}]),app.factory("fileReader",["$q","$log",function(a,b){var c=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},d=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},e=function(a,b){return function(a){b.$broadcast("fileProgress",{total:a.total,loaded:a.loaded})}},f=function(a,b){var f=new FileReader;return f.onload=c(f,a,b),f.onerror=d(f,a,b),f.onprogress=e(f,b),f},g=function(b,c){var d=a.defer(),e=f(d,c);return e.readAsDataURL(b),d.promise};return{readAsDataUrl:g}}]),app.directive("ngFileSelect",["fileReader","$timeout",function(a,b){return{scope:{ngModel:"="},link:function(c,d){function e(d){a.readAsDataUrl(d,c).then(function(a){b(function(){c.ngModel=a})})}d.bind("change",function(a){var b=(a.srcElement||a.target).files[0];e(b)})}}}]),app.directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),app.directive("notPermission",function(){return{templateUrl:"app/shared/templates/customShowNotPermission.html?nd="+Date.now()}}),app.directive("scrollDetector",function(){return{restrict:"A",link:function(a,b,c){var d=b[0];b.bind("scroll",function(){d.scrollTop+d.offsetHeight>=d.scrollHeight&&a.$apply(c.scrollDetector)})}}}),app.directive("selectOnClick",["$window",function(a){return function(b,c,d){c.bind("focus",function(){a.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}]),app.filter("sumByKey",function(){return function(a,b){if("undefined"==typeof a||"undefined"==typeof b)return 0;for(var c=0,d=a.length-1;d>=0;d--)c+=parseInt(a[d][b]);return c}}),app.filter("customNumber",function(){return function(a,b){if(void 0===a||null===a)return"";var c=a.toString().indexOf(".");if(c>0&&0===a.toString().split(".")[1].length)return a;var d=Math.pow(10,b).toString().replace("1","."),e=a.toFixed(b).replace(d,"");if(c=e.indexOf("."),c>0){var f=e.split(".")[0];const g=Number("0."+e.split(".")[1]);e=f.toString()+"."+g.toString().replace("0.","")}return e=e.replace(/\B(?=(\d{3})+(?!\d))/g,","),"0"===e?"-":e}}),app.service("AuthenticationService",["$http","$q","$window",function(a,b,c){var d;this.setTokenInfo=function(a){d=a,c.sessionStorage.TokenInfo=JSON.stringify(d),c.localStorage.TokenInfo=JSON.stringify(d)},this.getTokenInfo=function(){return void 0!==d?d:void("/login.html"!==window.location.pathname&&(window.location="/login.html"))},this.removeToken=function(){d=null,c.sessionStorage.TokenInfo=null,c.localStorage.TokenInfo=null},this.init=function(){var a=b.defer();if(c.sessionStorage.TokenInfo&&(d=JSON.parse(c.sessionStorage.TokenInfo)),void 0===d||"null"===e){var e=c.localStorage.TokenInfo;void 0!==e&&null!==e&&"null"!==e&&(c.sessionStorage.TokenInfo=c.localStorage.TokenInfo,d=JSON.parse(e))}return a.resolve(0),a.promise},this.setHeader=function(a){delete a.defaults.headers.common["X-Requested-With"],void 0!=d&&void 0!=d.accessToken&&null!=d.accessToken&&""!=d.accessToken&&(a.defaults.headers.common.Authorization="Bearer "+d.accessToken,a.defaults.headers.common["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8")},this.init().then(function(){if(void 0!==d&&"null"!==d)if(void 0===d.LoginTime)"/login.html"!==window.location.pathname&&(window.location="/login.html");else{var a=new Date,b=a.getDate(),c=a.getMonth()+1,e=a.getFullYear();10>b&&(b="0"+b),10>c&&(c="0"+c);var a=e.toString()+c.toString()+b.toString();parseFloat(a)-parseFloat(d.LoginTime)>0&&"/login.html"!==window.location.pathname&&(window.location="/login.html")}})}]),app.service("AppDialog",["$uibModal","$http","$q",function(a,b,c){this.ShowDetailFormDialog=function(b){var d=c.defer(),e=b.focuscontrolid,f=a.open({animation:!0,backdrop:"static",templateUrl:b.tempUrl+"?nd"+Date.now(),controller:b.ctrl,windowClass:b.cssclass,resolve:{data:function(){return b.data}}});return f.rendered.then(function(){null!=e&&e.length>0&&document.getElementById(e).focus()}),f.result.then(function(a){d.resolve(a)}),d.promise},this.ShowMessageDialog=function(b,d){var e=c.defer(),f=a.open({animation:!0,backdrop:"static",templateUrl:"app/shared/templates/customshowmessage.html?nd="+Date.now(),controller:"ShowMessageController",windowClass:"Modal-width400",resolve:{data:function(){return{msg:b,autoClose:d}}}});return f.result.then(function(){e.resolve()}),e.promise},this.ShowConfirmDialog=function(b,d){var e={msg:b,showbtnCancel:d},f=c.defer(),g=a.open({animation:!0,backdrop:"static",templateUrl:"app/shared/templates/customconfirmmessage.html?nd="+Date.now(),controller:"ShowConfirmController",windowClass:"Modal-width400",resolve:{data:function(){return e}}});return g.result.then(function(a){f.resolve(a)}),f.promise},this.FormSearchShow=function(b,d){var e=c.defer(),f=a.open({animation:!0,backdrop:"static",templateUrl:"app/shared/templates/customsearchformdialog.html?nd="+Date.now(),controller:"FormSearchShowController",windowClass:"Modal-width800 Modal-height550",resolve:{gridOptions:function(){return d}}});return f.result.then(function(a){e.resolve(a)}),e.promise},this.ShowMsgBanQuyen=function(b,d){var e=c.defer(),f=a.open({animation:!0,backdrop:"static",templateUrl:"app/shared/templates/customshowBanQuyen.html?nd="+Date.now(),controller:"ShowMsgBanQuyenController",windowClass:"Modal-width400",resolve:{data:function(){return{msg:b,autoClose:d}}}});return f.result.then(function(){e.resolve()}),e.promise}}]),app.controller("ShowMessageController",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){a.message=d.msg,a.autoClose=void 0===d.autoClose?0:d.autoClose,c(function(){$("#btnClose").focus()},50),c(function(){1===a.autoClose&&a.cancel()},700),a.cancel=function(){b.close()}}]),app.controller("ShowConfirmController",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){a.message=d.msg,a.showbtnCancel=void 0==d.showbtnCancel?!1:!0,c(function(){$("#btnNo").focus()},50),a.No=function(){b.close("1")},a.Yes=function(){b.close("0")},a.Cancel=function(){b.close("2")}}]),app.controller("FormSearchShowController",["$scope","$uibModalInstance","$filter","$timeout","gridOptions",function(a,b,c,d,e){function f(){d(function(){document.getElementById("searchfilter").focus()},50)}a.gridOptions=angular.copy(e.options),a.searchfilter=e.strFilter,a.dataLength=void 0==a.gridOptions.data?0:a.gridOptions.data.length,a.selectedRow=0,a.fnCancel=function(){b.close(0)},a.setClickedRow=function(b){a.selectedRow=b},a.$watch("selectedRow",function(){a.filteredData=c("filter")(a.gridOptions.data,a.searchfilter),a.dataLength=a.filteredData.length,a.selectedRow>=a.dataLength&&(a.selectedRow=0)}),f(),a.SelectedObject=function(){a.filteredData=c("filter")(a.gridOptions.data,a.searchfilter);var d=a.filteredData[a.selectedRow];b.close(d)},a.EnterSelectedObject=function(b){13==b.which&&a.SelectedObject()}}]),app.controller("ShowMsgBanQuyenController",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){a.message=d.msg,a.autoClose=void 0===d.autoClose?0:d.autoClose,c(function(){$("#btnClose").focus()},50),c(function(){1===a.autoClose&&a.cancel()},700),a.btnDungFree_Click=function(){b.close()},a.btnNangCap_Click=function(){b.close(),window.open("https://www.dantrisoft.com/p/ban-quyen.html","_blank")}}]),app.factory("AppServices",["$q","$http","$translate","$filter","$window","AuthenticationService",function(a,b,c,d,e,f){var g={};g.Url=e.localStorage.host,g.accessToken=void 0;var h=f.getTokenInfo();return void 0!==h&&(g.CompanyId=h.CompanyId,g.BranchId=h.BranchId,g.UserName=h.userName,g.accessToken=h.accessToken,g.MaGianHang=h.MaGianHang,g.AddOn=h.AddOn,g.Role=h.Role,g.IsAdministrator=h.IsAdministrator,g.BanHangCanTeen=h.BanHangCanTeen,g.InVaLuuHoaDon=h.InVaLuuHoaDon,g.userId=h.userId,g.MaNganh=h.MaNganh,g.LoaiHinhKinhDoanh=h.LoaiHinhKinhDoanh,g.IPAddress=e.localStorage.IPAddress,g.TraSua_SuaSoLuong=h.TraSua_SuaSoLuong,g.PublicIP=e.localStorage.PublicIP,g.IsUsedColor_Size=h.IsUsedColor_Size,g.NumDeviceConnect=h.NumDeviceConnect),g.setChangeBranch=function(a){if(a!==g.BranchId){var b=f.getTokenInfo();void 0!==b&&(g.CompanyId=b.CompanyId,g.BranchId=b.BranchId,g.UserName=b.userName,g.accessToken=b.accessToken,g.MaGianHang=b.MaGianHang,g.AddOn=b.AddOn,g.Role=b.Role,g.IsAdministrator=b.IsAdministrator,g.BanHangCanTeen=b.BanHangCanTeen,g.InVaLuuHoaDon=b.InVaLuuHoaDon,g.userId=b.userId,g.MaNganh=b.MaNganh,g.LoaiHinhKinhDoanh=b.LoaiHinhKinhDoanh,g.IPAddress=e.localStorage.IPAddress,g.TraSua_SuaSoLuong=b.TraSua_SuaSoLuong,g.PublicIP=e.localStorage.PublicIP,g.IsUsedColor_Size=b.IsUsedColor_Size,g.NumDeviceConnect=b.NumDeviceConnect)}},g.Post=function(c,d,e){void 0===g.accessToken&&(window.location="/login.html");var f=g.accessToken,h={};f&&(h.Authorization="Bearer "+f);var i=e+c,j=a.defer();return b({url:i,method:"post",contentType:!1,processData:!1,data:d,headers:h}).success(function(a){j.resolve(g.Results=a)}).error(function(a){j.reject(a)})},g.UploadFiles=function(c,d,e){void 0===g.accessToken&&(window.location="/login.html");var f=g.accessToken,h={};f&&(h.Authorization="Bearer "+f);var i=e+c,j=a.defer();return b({url:i,method:"post",contentType:!1,processData:!1,data:d,xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1}).success(function(a){j.resolve(g.Results=a)}).error(function(a){j.reject(a)})},g.Get=function(c,d){void 0===g.accessToken&&(window.location="/login.html");var e=d+c+"/?access_token="+g.accessToken,f=a.defer();return b({url:e,method:"get",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1}).success(function(a){f.resolve(g.Results=a)}).error(function(a){f.reject(a)})},g.ExportExcel=function(d,e,f,h){void 0===g.accessToken&&(window.location="/login.html");var i=g.accessToken,j={};i&&(j.Authorization="Bearer "+i);var k=f+d,l=a.defer();return b({url:k,method:"post",contentType:!1,processData:!1,data:e,xhrFields:{withCredentials:!0},headers:j,cache:!1,responseType:"arraybuffer"}).success(function(a,b,d){console.log(a);var e=d["content-type"];if(0===a.byteLength)return showAlertMessage(c.instant("Không có dữ liệu Export")),l.resolve(-1),l.promise;var f=document.createElement("a");try{var g=new Blob([a],{type:e}),i=window.URL.createObjectURL(g);f.setAttribute("href",i),f.setAttribute("download",h);var j=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(j)}catch(k){console.log(k)}l.resolve(0)}).error(function(a){l.reject(a)})},g.showloading=function(){var a=$(window).height(),b=$(window).width(),c=parseInt((parseInt(a)-120)/2),d=parseInt((parseInt(b)-120)/2);$("#spinnerLoadingImg").css("top",c),$("#spinnerLoadingImg").css("right",d),document.getElementById("spinnerLoadingImg").style.display="block",document.getElementById("spinnerLoadingLockScreen").style.display="block"},g.closeloading=function(){document.getElementById("spinnerLoadingImg").style.display="none",document.getElementById("spinnerLoadingLockScreen").style.display="none"},g}]),app.factory("signalR",["$rootScope","$q","$window","AppDialog",function(a,b,c,d){var e={},f=!0,g=null,h=localStorage.getItem("host");return e.serviceHub=$.connection.serviceHub,$.connection.hub.url=h+"signalr/hubs",e.connection=$.connection,e.startHub=function(a){g=a;var c=b.defer();return $.connection.hub&&$.connection.hub.state===$.signalR.connectionState.disconnected?$.connection.hub.start().done(function(){e.serviceHub.server.connect(a),f=!0,c.resolve()}):$.connection.hub&&$.connection.hub.state===$.signalR.connectionState.connected&&c.resolve(),c.promise},void 0!==$.connection.hub.stateChanged&&$.connection.hub.stateChanged(function(a){a.newState===$.signalR.connectionState.reconnecting?(console.log(Date.now()+" liveFeed is reconnecting!"),f===!0&&(f=!1)):a.newState===$.signalR.connectionState.connected&&(console.log(Date.now()+" liveFeed is connected!"),f===!1&&$.connection.hub.start().done(function(){e.serviceHub.server.connect(g),f=!0}))}),e.disconnected=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.disconnected2(a).done(function(a){})})},e.serviceHub.client.responseLogoutDevice=function(a){sessionStorage.clear(),c.localStorage.TokenInfo=null,d.ShowMessageDialog("[Cấp quản lý] yêu cầu hệ thống phải Đăng xuất.").then(function(){e.disconnected({MaGianHang:a.MaGianHang,ComputerName:a.ComputerName}),window.location="/login.html"})},e.sendSaveInvoiceTemp=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.sendSaveInvoiceTemp(a).done(function(a){})})},e.serviceHub.client.responseInitTouchScreen2=function(b){a.$broadcast("handleResponseInitTouchScreen2",b)},e.serviceHub.client.responseSaveInvoiceTemp=function(b){a.$broadcast("handleResponseSaveInvoiceTemp",b)},e.sendSaveInvoiceCompleted=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.sendSaveInvoiceCompleted(a).done(function(a){})})},e.serviceHub.client.responseSaveInvoiceCompleted=function(b){a.$broadcast("handleResponseSaveInvoiceCompleted",b)},e.sendChuyenGopBan=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.sendChuyenGopBan(a).done(function(a){})})},e.serviceHub.client.responseChuyenGopBan=function(b){a.$broadcast("handleResponseChuyenGopBan",b)},e.sendInCheBienFromAppOrder=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.sendInCheBienFromAppOrder(a).done(function(a){})})},e.sendInitTouchScreen2=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.sendInitTouchScreen2(a).done(function(a){})})},e.LogoutDevice=function(a){e.startHub(g).then(function(){})["finally"](function(){e.serviceHub.server.logoutDevice(a).done(function(a){})})},e.serviceHub.client.webErrorData=function(b){a.$broadcast("handlewebErrorData",b)},e}]),app.service("LoginService",["$http","$q","$window","AuthenticationService",function(a,b,c,d){var e,f;sessionStorage.getItem("host");this.login=function(g,h,i){f=b.defer();var j="grant_type=password&username="+h+"&password="+i+"&LoginDevice=WebApp&subDomain="+g+"&hostWebService="+sessionStorage.getItem("host");return a.post(sessionStorage.getItem("host")+"token",j,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){var b=c.localStorage.Version;b=void 0===b||null===b?"1.0.0.0":b;var g=JSON.parse(a.Role);e={accessToken:a.access_token,userName:a.userName,subDomain:a.subDomain,MaGianHang:a.BranchCode,CompanyId:a.CompanyId,BranchId:a.BranchId,BranchName:a.BranchName,Address:a.Address,AddOn:a.AddOn,IsAdministrator:a.IsAdministrator,Role:g,LoginTime:a.LoginTime,Version:a.Version,BanHangCanTeen:a.BanHangCanTeen,InVaLuuHoaDon:a.InVaLuuHoaDon,userId:a.userId,MaNganh:a.MaNganh,LoaiHinhKinhDoanh:a.LoaiHinhKinhDoanh,TraSua_SuaSoLuong:a.TraSua_SuaSoLuong,EmployeeName:a.EmployeeName,IsUsedColor_Size:a.IsUsedColor_Size,NumDeviceConnect:a.NumDeviceConnect},d.setTokenInfo(e),c.localStorage.MaGianHang=e.MaGianHang,c.localStorage.UserName=e.userName,c.localStorage.Version=a.Version,c.localStorage.UserMP=window.btoa(i),b<a.Version&&window.location.reload(!0),f.resolve(null)}).error(function(a,b){f.resolve(a)}),f.promise},this.logOut=function(){d.removeToken()}}]),app.service("appKeyBoard",["$uibModal","$http","$q","$templateCache",function(a,b,c,d){this.keyBoardNumber=function(b,d,e,f,g){var h={label:e,value:b,percent:d,tongtien:f,discountType:g,Cancel:0},i=c.defer(),j=a.open({animation:!0,backdrop:"static",templateUrl:"app/components/Sales/Restaurant/KeyNumber.html?nd="+Date.now(),controller:"KeyNumberCtrl",windowClass:"Modal-width400",resolve:{data:function(){return h}}});return j.result.then(function(a){i.resolve(a)}),i.promise},this.returnNumber=function(b,d){var e={curValue:b,returnNumber:d,Cancel:0},f=c.defer(),g=a.open({animation:!0,backdrop:"static",templateUrl:"app/components/Sales/Restaurant/returnNumber.html?nd="+Date.now(),controller:"ReturnNumberCtrl",windowClass:"Modal-width400",resolve:{data:function(){return e}}});return g.result.then(function(a){
f.resolve(a)}),f.promise},this.selectVAT=function(b,d){var e={Code:"",GiaTri:b,VatList:d,Cancel:0},f=c.defer(),g=a.open({animation:!0,backdrop:"static",templateUrl:"app/components/Sales/Restaurant/selectVAT.html?nd="+Date.now(),controller:"selectVATCtrl",windowClass:"Modal-width400",resolve:{data:function(){return e}}});return g.result.then(function(a){f.resolve(a)}),f.promise},this.selectChuongTrinhKhuyenMai=function(b){var d={PromotionType:"",ID:"",PromotionList:b,Cancel:0},e=c.defer(),f=a.open({animation:!0,backdrop:"static",templateUrl:"app/components/Sales/Restaurant/selectChuongTrinhKhuyenMai.html?nd="+Date.now(),controller:"selectChuongTrinhKhuyenMaiCtrl",windowClass:"Modal-width500",resolve:{data:function(){return d}}});return f.result.then(function(a){e.resolve(a)}),e.promise},this.NoteDialog=function(b){var d={value:b},e=c.defer(),f=a.open({animation:!0,backdrop:"static",templateUrl:"app/components/Sales/Restaurant/NoteDialog.html?nd="+Date.now(),controller:"NoteDialogCtrl",windowClass:"Modal-width400",resolve:{data:function(){return d}}});return f.result.then(function(a){e.resolve(a)}),e.promise},this.LyDoTraDialog=function(b){var d={value:"",Cancel:0},e=c.defer(),f=a.open({animation:!0,backdrop:"static",templateUrl:"app/components/Sales/Restaurant/LyDoDialog.html?nd="+Date.now(),controller:"LyDoDialogCtrl",windowClass:"Modal-width400",resolve:{data:function(){return d}}});return f.result.then(function(a){e.resolve(a)}),e.promise}}]),app.controller("KeyNumberCtrl",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){function e(a){var b=/^-{0,1}\d*\.{0,1}\d+$/;return b.test(a)}a.discountType=0,a.request={label:d.label,value:d.value,percent:d.percent,tongtien:d.tongtien,discountType:d.discountType,Cancel:d.Cancel};var f=!1;a.displayNumber=-1==d.discountType?d.value:1==d.discountType?d.value:d.percent.toFixed(2),a.btnOK_Click=function(){a.request.discountType=a.discountType,1==e(a.displayNumber)?0==a.discountType&&parseFloat(a.displayNumber)>100?a.message="% giảm giá không được lớn hơn 100%":1==a.discountType&&parseFloat(a.displayNumber)>a.request.tongtien?a.message="Tiền giảm giá không được lớn hơn "+a.request.tongtien:(a.request.value=a.displayNumber,b.close(a.request)):a.message="Giá trị không hợp lệ."},a.btnCancel_Click=function(){a.request.value=d.value,a.request.Cancel=1,b.close(a.request)},a.btnClear_Click=function(){a.displayNumber=""},a.btnNumber_Click=function(b){0==f?(a.displayNumber=b,f=!0):a.displayNumber=a.displayNumber+""+b},a.btnNumberDot_Click=function(){0==f?(a.displayNumber=".",f=!0):a.displayNumber=a.displayNumber+"."},a.radPecent_Change=function(b){a.displayNumber=1==b?d.value:d.percent.toFixed(2)},a.displayNumber_Keydown=function(a){13===a.which&&c(function(){document.getElementById("btnOK_KeyNumber").click()},0)},c(function(){a.discountType=void 0==d.discountType?-1:d.discountType,$("#displayNumber").focus(),$("#displayNumber").select()},5)}]),app.controller("NoteDialogCtrl",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){a.request={value:d.value},a.btnOK_Click=function(){b.close(a.request)},a.btnCancel_Click=function(){a.request.value=d.value,b.close(a.request)},a.btnClear_Click=function(){a.request.value=""}}]),app.controller("selectVATCtrl",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){function e(){for(var b=0;b<=a.request.VatList.length-1;b++)parseFloat(a.request.VatList[b].Field3)===parseFloat(a.request.GiaTri)?a.request.VatList[b].Selected=1:a.request.VatList[b].Selected=0}a.request={Code:d.Code,GiaTri:d.GiaTri,VatList:d.VatList,Cancel:d.Cancel},a.btnOK_Click=function(){b.close(a.request)},c(function(){e()},100),a.btnCancel_Click=function(){a.request.Code=d.Code,a.request.Cancel=1,b.close(a.request)},a.btnThueSuat_Click=function(b){a.request.Code=b.Code,a.request.GiaTri=parseFloat(b.Field3);for(var c=0;c<=a.request.VatList.length-1;c++)parseFloat(a.request.VatList[c].Field3)===parseFloat(b.Field3)?a.request.VatList[c].Selected=1:a.request.VatList[c].Selected=0},a.btnClear_Click=function(){a.request.Code=""}}]),app.controller("selectChuongTrinhKhuyenMaiCtrl",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){function e(){for(var b=0;b<=a.request.PromotionList.length-1;b++)a.request.PromotionList[b].Selected=0}a.request={PromotionType:"",ID:"",PromotionList:d.PromotionList,Cancel:0},a.btnOK_Click=function(){b.close(a.request)},c(function(){e()},100),a.btnCancel_Click=function(){a.request.Cancel=1,b.close(a.request)},a.btnKhuyenMai_Click=function(b){a.request.PromotionType=b.PromotionType,a.request.ID=b.Id;for(var c=0;c<=a.request.PromotionList.length-1;c++)a.request.PromotionList[c].Id===b.Id?a.request.PromotionList[c].Selected=1:a.request.PromotionList[c].Selected=0},a.btnClear_Click=function(){a.request.PromotionType="",a.request.ID=""}}]),app.controller("ReturnNumberCtrl",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){function e(a){var b=/^-{0,1}\d*\.{0,1}\d+$/;return b.test(a)}a.request={curValue:d.curValue,returnNumber:d.returnNumber,Cancel:d.Cancel,LyDo:""};var f=!1;a.btnOK_Click=function(){1==e(a.request.returnNumber)?parseFloat(a.request.returnNumber)<=0?a.message="Giá trị phải lớn hơn 0.":parseFloat(a.request.returnNumber)>parseFloat(a.request.curValue)?a.message="Giá trị phải nhỏ hơn hoặc bằng "+a.request.curValue:""===a.request.LyDo||void 0===a.request.LyDo?(a.message="Vui lòng nhập lý do trả.",$("#LyDo").focus()):b.close(a.request):a.message="Giá trị không hợp lệ."},a.btnCancel_Click=function(){a.request.returnNumber=1,a.request.Cancel=1,b.close(a.request)},a.btnClear_Click=function(){a.request.returnNumber=""},a.btnNumber_Click=function(b){0==f?(a.request.returnNumber=b,f=!0):a.request.returnNumber=a.request.returnNumber+""+b},a.btnNumberDot_Click=function(){0==f?(a.request.returnNumber=".",f=!0):a.request.returnNumber=a.request.returnNumber+"."}}]),app.controller("LyDoDialogCtrl",["$scope","$uibModalInstance","$timeout","data",function(a,b,c,d){a.msg="",a.request={value:d.value,Cancel:0},a.btnOK_Click=function(){""===a.request.value||void 0===a.request.value?a.msg="Vui lòng nhập lý do trả món.":(a.request.Cancel=0,b.close(a.request))},a.btnCancel_Click=function(){a.request.value=d.value,a.request.Cancel=1,b.close(a.request)},a.btnClear_Click=function(){a.request.value=""}}]),app.directive("customDatagrid",["$document",function(a){return{restrict:"E",templateUrl:"app/shared/templates/customDataGrid.html?nd="+Date.now(),scope:{options:"=",editEvent:"&",deleteEvent:"&",printEvent:"&",chkEvent:"&",searchEvent:"&",ngDatasource:"="},link:function(a,b,c){function d(){if(null!=a.dataSource){var b=(a.currentPage-1)*a.itemsPerPage,c=b+a.itemsPerPage;a.filterSource=a.dataSource.slice(b,c),a.totalPage=Math.ceil(a.dataSource.length/a.itemsPerPage)}}a.gridOptions=a.options,a.dataSource=a.ngDatasource,a.filterSource=[],a.gridOptions.showPrint=void 0===a.gridOptions.showPrint?!1:a.gridOptions.showPrint,a.currentPage=1,a.itemsPerPage=15,a.maxSize=3,a.listPageSize=[15,30,50,100,200],a.totalPage=Math.ceil(a.dataSource.length/a.itemsPerPage),a.pageChanged=function(b){a.currentPage=b,$("#"+a.gridOptions.id+"_SelectAll").prop("checked",!1)},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){d()}),a.$watch("ngDatasource",function(b,c){b!=c&&(a.dataSource=a.ngDatasource,d())},!0),a.selectAll=function(){var b=!a.checkIsSelectAll();angular.forEach(a.filterSource,function(c,d){$("#"+a.gridOptions.id+"_"+d).prop("checked",b)})},a.checkIsSelectAll=function(){var b=[];return angular.forEach(a.filterSource,function(c,d){if(0!==c.ShowCheckedOnGrid){var e=$("#"+a.gridOptions.id+"_"+d).prop("checked");e===!0&&b.push(c)}}),a.options.ListCheckSelected=b,b.length===a.filterSource.length},a.buttonevent=function(b,c){"Edit"==b?a.editEvent({valueEdit:c}):"Del"==b?a.deleteEvent({valueDel:c}):"Print"===b&&a.printEvent({valuePrint:c})},a.checkboxevent=function(b){a.chkEvent({value:b})},a.selectedRow=0,a.setClickedRow=function(b){a.selectedRow=b}}}}]),app.directive("customCodename",["$timeout","$filter",function(a,b){return{restrict:"E",require:"ngModel",templateUrl:"app/shared/templates/customcodename.html?nd="+Date.now(),scope:{ngModel:"=",ngDatasource:"=",ngDisabled:"=",options:"=",selectedrow:"&",eventKeydownEnter:"&"},link:function(c,d,e,f){function g(a){document.getElementById(c.idModel).value=null==a?null:null==a.ID||void 0==a.ID?a.Code:a.ID,document.getElementById(c.idCode).value=null==a?null:a.Code,document.getElementById(c.idName).value=null==a?null:a.Name,f.$setViewValue(document.getElementById(c.idModel).value),c.options.setValue=null==a?0:a.ID,$("#"+c.idControl).attr("aaID",null==a?null:a.ID),$("#"+c.idControl).attr("aaCode",null==a?null:a.Code),$("#"+c.idControl).attr("aaName",null==a?null:a.Name),$("#"+c.idControl).attr("aaField3",null==a?null:a.Field3),$("#"+c.idControl).attr("aaField4",null==a?null:a.Field4),$("#"+c.idControl).attr("aaField5",null==a?null:a.Field5)}c.maxLengthFilter=50,c.oldValue=null,c.isFocus=!1,c.idControl=d[0].id,c.style=e.style,c.codenameOptions=c.options,c.require=e.ngRequired,c.isSetValue=!1,c.Disable=e.ngDisabled,c.idCode=c.idControl+"_Code",c.idName=c.idControl+"_Name",c.idModel=c.idControl+"_Model",c.idButton=c.idControl+"_Button",c.idContainer=c.idControl+"_Container",c.idboundCtrl=c.idControl+"_boundCtrl",c.selectedRow=0,c.dataSource=c.ngDatasource,c.dataFilter=null,null!=c.dataSource&&(c.dataFilter=angular.copy(c.dataSource).slice(0,c.maxLengthFilter)),void 0===c.options&&(c.options={},c.options.showcode=void 0===c.options.showcode?!0:c.options.showcode,c.options.showname=void 0===c.options.showname?!0:c.options.showname,c.options.showfield3=void 0===c.options.showfield3?!1:c.options.showfield3,c.options.showfield4=void 0===c.options.showfield4?!1:c.options.showfield4,c.options.showfield5=void 0===c.options.showfield5?!1:c.options.showfield5,c.options.codewidth=void 0===c.options.codewidth?100:c.options.codewidth,c.options.namewidth=void 0===c.options.namewidth?200:c.options.namewidth,c.options.field3width=void 0===c.options.field3width?0:c.options.field3width,c.options.field4width=void 0===c.options.field4width?0:c.options.field4width,c.options.field5width=void 0===c.options.field5width?0:c.options.field5width,c.options.maxDropDownItems=void 0===c.options.maxDropDownItems?6:c.options.maxDropDownItems,c.codenameOptions=c.options);var h=28;c.popupHeight=h*c.options.maxDropDownItems+1;var i=0,j=0,k=0;c.popupWidth=100,c.popupWidth=(1==c.options.showcode?parseInt(c.options.codewidth):parseInt(0))+(1==c.options.showname?parseInt(c.options.namewidth):parseInt(0))+(1==c.options.showfield3?parseInt(c.options.field3width):parseInt(0))+(1==c.options.showfield4?parseInt(c.options.field4width):parseInt(0))+(1==c.options.showfield5?parseInt(c.options.field5width):parseInt(0)),c.codewidth=parseInt(c.options.codewidth),a(function(){var a=$("#"+c.idCode).width()+8+($("#"+c.idName).width()+8)+35;c.popupWidth>a?$("#"+c.idContainer).css("width",c.popupWidth+"px"):$("#"+c.idContainer).css("width",a+"px"),$("#"+c.idContainer).css("height",c.popupHeight+"px")},30),c.idCode_onKeyPress=function(d){if(40==d.which){if(c.selectedRow==c.dataFilter.length-1)return;c.selectedRow++;var e=document.getElementById(c.idControl+"_table").rows,f=document.querySelector("#"+c.idControl+"_"+c.selectedRow);k=f.getBoundingClientRect().top,k>=j-h&&e[c.selectedRow].scrollIntoView(!1)}else if(38==d.which){if(0==c.selectedRow)return;c.selectedRow--;var e=document.getElementById(c.idControl+"_table").rows,f=document.querySelector("#"+c.idControl+"_"+c.selectedRow);k=f.getBoundingClientRect().top,i+h>=k&&e[c.selectedRow].scrollIntoView(!1)}else if(13==d.which){var l=$("#"+c.idControl+"_dropdown").attr("class");if(l.indexOf("show")>=0){var m=c.dataFilter[c.selectedRow];g(m),a(function(){$("#"+c.idControl+"_dropdown").removeClass("show")},20),c.oldValue!=m.Code&&(c.selectedrow({rowItem:m}),c.oldValue=m.Code),c.eventKeydownEnter({id:c.idControl})}else{var n=document.getElementById(c.idCode).value;if(null!=n&&""!=n&&void 0!=n){var o=b("filter")(c.dataFilter,{Code:n},!0)[0];void 0!==o?c.eventKeydownEnter({id:c.idControl}):c.ShowPopup()}else c.ShowPopup()}}},c.ShowPopup=function(){if(void 0!=c.dataSource)for(var a=c.dataFilter.length,d=c.dataSource.length>c.maxLengthFilter+a?c.maxLengthFilter+a:c.dataSource.length,e=0;d>e;e++){var f=b("filter")(c.dataFilter,{Code:c.dataSource[e].Code},!0)[0];if(null==f&&c.dataFilter.push(c.dataSource[e]),c.dataFilter.length>=c.maxLengthFilter)break}c.isFocus=!0;var g=document.querySelector("#"+c.idCode),h=g.getBoundingClientRect().top,k=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;k-h-32<parseInt(c.popupHeight)?($("#"+c.idboundCtrl).addClass("dropup"),$("#"+c.idboundCtrl).removeClass("dropdown")):($("#"+c.idboundCtrl).addClass("dropdown"),$("#"+c.idboundCtrl).removeClass("dropup"));var l=document.getElementById(c.idControl+"_table").rows;l.length>0&&(document.getElementById(c.idControl+"_dropdown").classList.toggle("show"),$("#"+c.idCode).focus());var m=document.querySelector("#"+c.idControl+"_dropdown");i=m.getBoundingClientRect().top,j=m.getBoundingClientRect().bottom},c.setClickedRow=function(a){c.selectedRow=a;var b=c.dataFilter[a];$("#"+c.idCode).focus(),c.isFocus=!1,document.getElementById(c.idCode).value=b.Code},c.eventLostFocus=function(){c.isFocus=!1,a(function(){var a=document.activeElement;if(""==a.id&&a.innerHTML.toString().indexOf("modal-dialog")>=0&&($("#"+c.idCode).focus(),c.isFocus=!0),0==c.isFocus){$("#"+c.idControl+"_dropdown").removeClass("show"),c.options.setfocus=!1;var d=null!=document.getElementById(c.idCode)&&""!=document.getElementById(c.idCode).value?document.getElementById(c.idCode).value:null;if(null!=d&&""!=d&&void 0!=d){var e=b("filter")(c.dataFilter,{Code:d},!0)[0];void 0!=e?(g(e),c.oldValue!=e.Code&&(c.selectedrow({rowItem:e}),c.oldValue=e.Code)):(g(null),null!=c.oldValue&&(c.selectedrow({rowItem:null}),c.oldValue=null))}else g(null),null!=c.oldValue&&(c.selectedrow({rowItem:null}),c.oldValue=null)}},250)},c.$watch(function(){return c.codeFilter},function(a,d){if(void 0!=a&&a!=d&&void 0!=c.dataSource){var e=$("#"+c.idControl+"_dropdown").attr("class");e.indexOf("show")<0&&c.ShowPopup()}if(void 0!=c.dataSource){var f=document.getElementById(c.idCode).value;c.dataFilter=b("filter")(c.dataSource,f,!1).slice(0,c.maxLengthFilter),c.selectedRow>c.dataFilter.length&&(c.selectedRow=0)}},!0),c.$watch("options",function(a,d){if(a.setValue!=d.setValue&&void 0!=a.setValue&&void 0!=c.dataSource){var e=b("filter")(c.dataSource,{ID:a.setValue},!0)[0];g(void 0!==e&&null!==e?e:null)}else a.setValue!=d.setValue&&void 0!=a.setValue&&null==c.dataSource&&(c.isSetValue=!1);a.setfocus!=d.setfocus&&1==a.setfocus&&$("#"+c.idCode).focus()},!0),c.$watch("ngDatasource",function(a,d){if(a!=d&&(c.dataSource=c.ngDatasource,c.dataFilter=angular.copy(c.dataSource).slice(0,c.maxLengthFilter),0==c.isSetValue&&0!=c.options.setValue)){var e=b("filter")(c.dataSource,{ID:c.options.setValue},!0)[0];if(void 0!=e){var f=b("filter")(c.dataFilter,{ID:e.ID},!0);0==f.length&&c.dataFilter.push(e),g(e)}c.isSetValue=!0}},!0),c.$watch("ngDisabled",function(a,b){$("#"+c.idCode).attr("readonly",a),document.getElementById(c.idButton).disabled=a},!0)}}}]),!function(a,b,c){"use strict";function d(a,b,d,e){if(a===c)return"";var g="";return g=","===b?String(a).replace(".",","):String(a),f(g,d,e)}function e(a,b,c){return","===b?String(a).replace(/[\.\s]/g,"").replace(",","."):"."===b?String(a).replace(/[,\s]/g,""):void 0}function f(a,b,c){var d=a;return c&&(d+=c),b&&(d=/^\-.+/.test(d)?d.replace("-","-"+b):/^\-/.test(d)?d:b+d),d}function g(a,b){if(a>=0){var c=parseInt(a,10);if(isNaN(c)===!1&&isFinite(c)&&c>=0)return c}return b}function h(a,b){if(a>=0){var c=parseInt(a,10);if(isNaN(c)===!1&&isFinite(c)&&c>=0)return c}return b}function i(a,b){return","===a?",":"."===a?".":b}function j(a,b){return"false"===a||a===!1?!1:"true"===a||a===!0?!0:b}function k(a,b){return"false"===a||a===!1?!1:"true"===a||a===!0?!0:b}function l(a,b){return"floor"===a?Math.floor:"ceil"===a?Math.ceil:"round"===a?Math.round:b}function m(a,b){return"false"===a||a===!1?!1:"true"===a||a===!0?!0:b}function n(a,b){return"false"===a||a===!1?!1:"true"===a||a===!0?!0:b}function o(a,b,c){if(!a)return c;var d;return d="."===b?new RegExp("^[,\\s]$"):new RegExp("^[\\.\\s]$"),d.test(a)?a:c}function p(a){var b=new RegExp("[^\\d,\\.\\s\\-]{1}");return b.test(a)?a:null}function q(a,b,c,d,e){var f="-?";d===!1&&e===!0?f="-":d===!0&&e===!1&&(f="");var g="[0-9]{0,"+a+"}";0===a&&(g="0");var h="(\\"+c+"([0-9]){0,"+b+"})";return 0===b&&(h=""),new RegExp("^"+f+g+h+"?$")}function r(a){return String(a).replace(/^0+/g,"").replace(/^-0(\d+)/g,"-$1").replace(new RegExp("^-([\\.,\\s])","g"),"-0$1").replace(new RegExp("^[\\.,\\s]","g"),"0$&")}function s(a,b,c){var d=a;return b&&(d=d.replace(new RegExp("[\\"+b+"]","g"),"")),c&&(d=d.replace(new RegExp("[\\"+c+"]","g"),"")),d}function t(a,b){return"."===b?String(a).replace(/\./g,""):","===b?String(a).replace(/,/g,""):String(a).replace(new RegExp("\\s","g"),"")}function u(a,b){return a=String(a).split("."),a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,b),a.join(".")}function v(a,b,c,d){a.$setViewValue(f(b,c,d)),a.$render()}function w(a,b,e,f,g,h,i,j,k){if(""===a||a===c||null===a)return"";if(a=Number(a),!isNaN(a)&&isFinite(a)){var l=Math.pow(10,b);return a=g?d((f(a*l)/l).toFixed(b),e,j,k):d(String(f(a*l)/l),e,j,k),h&&(a=u(a,i)),a}return g?0..toFixed(b):"0"}function x(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||"0"==a.selectionStart)&&(b=a.selectionStart);return b}function y(a,b){if(null!==a)if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()}function z(a,b,c){for(var d=0,e=0,f=0;f<a.length;f++)if(a[f]!==b){if(d++,d>=c)break}else e++;return e}function A(a,b,c){var d={awnum:a.awnum,numInt:a.numInt,numFract:a.numFract,numSep:a.numSep,numPos:a.numPos,numNeg:a.numNeg,numRound:a.numRound,numThousand:a.numThousand,numThousandSep:a.numThousandSep,numPrepend:a.numPrepend,numAppend:a.numAppend};return b&&(d[b]=c),d}function B(a,b,d,e,f){var m={};a.awnum&&(m=f.getStrategy(a.awnum));var r=g(a.numInt!==c?a.numInt:m.numInt,6),s=h(a.numFract!==c?a.numFract:m.numFract,2),t=i(a.numSep!==c?a.numSep:m.numSep,"."),u=j(a.numPos!==c?a.numPos:m.numPos,!0),v=k(a.numNeg!==c?a.numNeg:m.numNeg,!0),w=l(a.numRound!==c?a.numRound:m.numRound,Math.round),x=n(a.numThousand!==c?a.numThousand:m.numThousand,!1),y=o(a.numThousandSep!==c?a.numThousandSep:m.numThousandSep,t,"."===t?",":"."),z=p(a.numPrepend!==c?a.numPrepend:m.numPrepend),A=p(a.numAppend!==c?a.numAppend:m.numAppend);if(u===!1&&v===!1)throw new Error("Number is set to not be positive and not be negative. Change num_pos attr or/and num_neg attr to true");var B=q(r,s,t,u,v);return{element:b,attrs:d,ngModelController:e,viewRegexTest:B,integerPart:r,fractionPart:s,fractionSeparator:t,isPositiveNumber:u,isNegativeNumber:v,roundFunction:w,isThousandSeparator:x,thousandSeparator:y,prepend:z,append:A}}function C(a,b){var f=b.element,g=(b.attrs,b.ngModelController),h=b.viewRegexTest,i=(b.integerPart,b.fractionPart,b.fractionSeparator),j=(b.isPositiveNumber,b.isNegativeNumber,b.roundFunction,b.isThousandSeparator),k=b.thousandSeparator,l=b.prepend,m=b.append,n=String(a);if(n=s(n,l,m),new RegExp("^[.,"+k+"]{2,}").test(n))return v(g,0,l,m),0;var o=x(f[0]);l&&o--;var p=n.slice(0,o);if(p=t(p,k),n=t(n,k),p=r(p),n=r(n),""===n&&"0"===String(a).charAt(0))return v(g,0,l,m),0;if(n===c||""===n)return 0;if("-"===n)return v(g,"-",l,m),0;if(h.test(n)===!1){var q=d(g.$modelValue,i,l,m);return j&&(q=u(q,k)),v(g,q,l,m),y(f[0],o-1),g.$modelValue}var w=0,A=p.length;return j&&(n=u(n,k),w=z(n,k,A)),l&&(w++,new RegExp("^(\\-\\d)$").test(n)&&(w+=2),new RegExp("^(\\d)$").test(n)&&w++),v(g,n,l,m),y(f[0],A+w),setTimeout(function(){y(f[0],A+w)},1),e(n,i,k)}function D(a,b){a.$setViewValue(""),a.$render(),a.$setViewValue(b),a.$render()}function E(a,b){var c=w(a.$modelValue,b.fractionPart,b.fractionSeparator,b.roundFunction,!1,b.isThousandSeparator,b.thousandSeparator,b.prepend,b.append);D(a,c)}function F(a){return{restrict:"A",require:"?ngModel",scope:{awnum:"@",numInt:"@",numFract:"@",numSep:"@",numPos:"@",numNeg:"@",numRound:"@",numThousand:"@",numThousandSep:"@",numPrepend:"@",numAppend:"@"},link:function(b,c,d,e){if(!c[0]||"INPUT"!==c[0].tagName||"text"!==c[0].type)return void console.warn("Directive angular-dynamic-number works only for 'input' tag with type = 'text'");if(!e)return void console.warn("Directive angular-dynamic-number need ngModel attribute");var f=B(A(b),c,d,e,a);b.$watch("numInt",function(g,h){h!==g&&(f=B(A(b,"numInt",g),c,d,e,a),E(e,f))}),b.$watch("numFract",function(g,h){h!==g&&(f=B(A(b,"numFract",g),c,d,e,a),E(e,f))}),b.$watch("numSep",function(g,h){h!==g&&(f=B(A(b,"numSep",g),c,d,e,a),E(e,f))}),b.$watch("numPos",function(g,h){h!==g&&(f=B(A(b,"numPos",g),c,d,e,a),E(e,f))}),b.$watch("numNeg",function(g,h){h!==g&&(f=B(A(b,"numNeg",g),c,d,e,a),E(e,f))}),b.$watch("numThousand",function(g,h){h!==g&&(f=B(A(b,"numThousand",g),c,d,e,a),E(e,f))}),b.$watch("numThousandSep",function(g,h){h!==g&&(f=B(A(b,"numThousandSep",g),c,d,e,a),E(e,f))}),b.$watch("numAppend",function(g,h){h!==g&&(f=B(A(b,"numAppend",g),c,d,e,a),E(e,f))}),b.$watch("numPrepend",function(g,h){h!==g&&(f=B(A(b,"numPrepend",g),c,d,e,a),E(e,f))}),e.$parsers.unshift(function(a){return C(a,f)}),e.$formatters.push(function(a){return w(a,f.fractionPart,f.fractionSeparator,f.roundFunction,!1,f.isThousandSeparator,f.thousandSeparator,f.prepend,f.append)})}}}b.module("dynamicNumber",[]).provider("dynamicNumberStrategy",function(){var a={};this.addStrategy=function(b,c){a[b]=c},this.getStrategy=function(b){return a[b]},this.$get=function(){return{getStrategy:function(b){return a[b]}}}}).filter("awnum",function(){return function(a,b,c,d,e,f,g,j,k){var q=h(b,2),r=i(c,"."),s=l(d,Math.round),t=m(e,!1),u=n(f,!1),v=o(g,r,"."===r?",":"."),x=p(j),y=p(k),z=w(a,q,r,s,t,u,v,x,y);return""===z?"0":z}}).directive("awnum",["dynamicNumberStrategy",F])}(window,window.angular),app.directive("customDatepicker",function(){return{restrict:"E",templateUrl:"app/shared/templates/customdatepicker.html?nd="+Date.now(),scope:{options:"=",ngModel:"=",ngDisabled:"=",change:"&"},link:function(a,b,c){function d(a){var b=a.date,c=a.mode;return"day"===c&&(0===b.getDay()||6===b.getDay())}function e(a){var b="",c=a.getDate(),d=a.getMonth()+1,e=a.getFullYear();return 10>c&&(c="0"+c),10>d&&(d="0"+d),b=e+"-"+d+"-"+c}a.dateOptions=a.options,a.style=c.style,a.idControl=b[0].id+"_Code";var f=new Date,g=f.getDate(),h=f.getMonth(),i=f.getFullYear();a.ngModel=void 0==a.ngModel||"0001-01-01T00:00:00"==a.ngModel.toString()?new Date(Date.UTC(i,h,g,0,0,0)):new Date(a.ngModel),a.dateOptions={dateDisabled:null==a.options?"":1==a.options.dateDisabled?d:"",formatYear:"yyyy",maxDate:null==a.options?new Date(9999,12,31):a.options.maxDate,minDate:null==a.options?new Date(1900,1,1):a.options.minDate,startingDay:null==a.options?1:a.options.startingDay,setfocus:!1},a.oldValue=e(a.ngModel),a.ngclass=c["class"],a.open1=function(){a.popup1.opened=!0},a.popup1={opened:!1},a.dateChange=function(a){if(null!=a.ngModel){var b=e(a.ngModel);b!=a.oldValue&&(a.ngModel=new Date(b),a.oldValue=b,a.change({valueChange:b}))}},a.$watch("options",function(b,c){void 0!=b&&void 0!=c&&b.setfocus!=c.setfocus&&1==b.setfocus&&$("#"+a.idControl).focus()},!0),a.$watch("ngModel",function(b,c){void 0!=b&&void 0!=c&&new Date(b)!=c&&(b=new Date(Date.UTC(new Date(b).getFullYear(),new Date(b).getMonth(),new Date(b).getDate(),0,0,0,0)),a.ngModel=b)},!0),a.$watch("ngDisabled",function(b,c){$("#"+a.idControl).attr("readonly",b),document.getElementById("btn_"+a.idControl).disabled=b},!0)}}}),app.directive("customAutocomplete",["$timeout","$filter",function(a,b){return{restrict:"E",require:"ngModel",templateUrl:"app/shared/templates/customAutocomplete.html?nd="+Date.now(),scope:{ngModel:"=",ngDatasource:"=",options:"=",selectedrow:"&",eventKeydownEnter:"&"},link:function(c,d,e,f){function g(a){document.getElementById(c.idModel).value=null==a?null:null==a.ID||void 0==a.ID?a.Code:a.ID,document.getElementById(c.idCode).value=null==a?null:a.Code+" - "+a.Name,h=document.getElementById(c.idCode).value,document.getElementById(c.idCode2).value=null==a?null:a.Code,f.$setViewValue(document.getElementById(c.idModel).value),c.options.setValue=null==a?0:a.ID,$("#"+c.idControl).attr("aaID",null==a?null:a.ID),$("#"+c.idControl).attr("aaCode",null==a?null:a.Code),$("#"+c.idControl).attr("aaName",null==a?null:a.Name),$("#"+c.idControl).attr("aaField3",null==a?null:a.Field3),$("#"+c.idControl).attr("aaField4",null==a?null:a.Field4),$("#"+c.idControl).attr("aaField5",null==a?null:a.Field5)}c.maxLengthFilter=20,c.oldValue=null,c.isFocus=!1,c.idControl=d[0].id,c.style=e.style,c.codenameOptions=c.options,c.isSetValue=!1,c.elem=d,c.enterNextfocus=e.enterNextfocus,c.placeholder=e.placeholder,c.idCode=c.idControl+"_Code",c.idCode2=c.idControl+"_Code2",c.idModel=c.idControl+"_Model",c.idContainer=c.idControl+"_Container",c.idboundCtrl=c.idControl+"_boundCtrl";var h="";c.selectedRow=0,c.dataSource=c.ngDatasource,c.dataFilter=null,null!=c.dataSource&&(c.dataFilter=angular.copy(c.dataSource).slice(0,c.maxLengthFilter));var i=28;c.popupHeight=i*c.options.maxDropDownItems+1;var j=0,k=0,l=0;c.popupWidth=100,c.popupWidth=(1==c.options.showcode?parseInt(c.options.codewidth):parseInt(0))+(1==c.options.showname?parseInt(c.options.namewidth):parseInt(0))+(1==c.options.showfield3?parseInt(c.options.field3width):parseInt(0))+(1==c.options.showfield4?parseInt(c.options.field4width):parseInt(0))+(1==c.options.showfield5?parseInt(c.options.field5width):parseInt(0)),c.codewidth=parseInt(c.codenameOptions.codewidth),a(function(){var a=$("#"+c.idCode).width()+8+35;c.popupWidth>a?$("#"+c.idContainer).css("width",c.popupWidth+"px"):$("#"+c.idContainer).css("width",a+"px"),$("#"+c.idContainer).css("height",c.popupHeight+"px")},30),c.idCode_onKeyPress=function(d){if(40==d.which){if(c.selectedRow==c.dataFilter.length-1)return;c.selectedRow++;var e=document.getElementById(c.idControl+"_table").rows,f=document.querySelector("#"+c.idControl+"_"+c.selectedRow);l=f.getBoundingClientRect().top,l>=k-i&&e[c.selectedRow].scrollIntoView(!1)}else if(38==d.which){if(0==c.selectedRow)return;c.selectedRow--;var e=document.getElementById(c.idControl+"_table").rows,f=document.querySelector("#"+c.idControl+"_"+c.selectedRow);l=f.getBoundingClientRect().top,j+i>=l&&e[c.selectedRow].scrollIntoView(!1)}else if(13==d.which){var h=$("#"+c.idControl+"_dropdown").attr("class");if(h.indexOf("show")>=0){var m=c.dataFilter[c.selectedRow];g(m),a(function(){$("#"+c.idControl+"_dropdown").removeClass("show")},20),c.oldValue!=m.Code&&(c.selectedrow({rowItem:m}),c.oldValue=m.Code),c.eventKeydownEnter({id:c.idControl})}else{var n=document.getElementById(c.idCode).value;if(null!=n&&""!=n&&void 0!=n){var o=b("filter")(c.dataFilter,{Code:n},!0)[0];void 0!=o?c.eventKeydownEnter({id:c.idControl}):c.ShowPopup()}else c.ShowPopup()}}},c.ShowPopup=function(){c.isFocus=!0;var a=document.querySelector("#"+c.idCode),b=a.getBoundingClientRect().top,d=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;d-b-32<parseInt(c.popupHeight)?($("#"+c.idboundCtrl).addClass("dropup"),$("#"+c.idboundCtrl).removeClass("dropdown")):($("#"+c.idboundCtrl).addClass("dropdown"),$("#"+c.idboundCtrl).removeClass("dropup"));var e=document.getElementById(c.idControl+"_table").rows;e.length>0&&(document.getElementById(c.idControl+"_dropdown").classList.toggle("show"),$("#"+c.idCode).focus());var f=document.querySelector("#"+c.idControl+"_dropdown");j=f.getBoundingClientRect().top,k=f.getBoundingClientRect().bottom},c.setClickedRow=function(a){c.selectedRow=a;var b=c.dataFilter[a];$("#"+c.idCode).focus(),c.isFocus=!1,document.getElementById(c.idCode).value=b.Code},c.eventLostFocus=function(){c.isFocus=!1,a(function(){var a=document.activeElement;if(void 0!=a&&""==a.id&&a.innerHTML.toString().indexOf("modal-dialog")>=0&&($("#"+c.idCode).focus(),c.isFocus=!0),0==c.isFocus){$("#"+c.idControl+"_dropdown").removeClass("show"),c.options.setfocus=!1;var d=null!=document.getElementById(c.idCode).value?document.getElementById(c.idCode).value:null;if(d===h)return;if(null!==d&&""!==d&&void 0!==d){var e=b("filter")(c.dataFilter,{Code:d},!0)[0];void 0!==e?(g(e),c.oldValue!=e.Code&&(c.selectedrow({rowItem:e}),c.oldValue=e.Code)):(g(null),null!=c.oldValue&&(c.selectedrow({rowItem:null}),c.oldValue=null))}else g(null),null!=c.oldValue&&(c.selectedrow({rowItem:null}),c.oldValue=null)}},120)},c.$watch(function(){return c.codeFilter},function(a,d){if(void 0!=a&&a!=d&&void 0!=c.dataSource){var e=$("#"+c.idControl+"_dropdown").attr("class");e.indexOf("show")<0&&c.ShowPopup()}if(void 0!=c.dataSource){var f=document.getElementById(c.idCode).value;c.dataFilter=b("filter")(c.dataSource,f,!1).slice(0,c.maxLengthFilter),c.selectedRow>c.dataFilter.length&&(c.selectedRow=0)}},!0),c.$watch("options",function(a,d){if(a.setValue!=d.setValue&&void 0!=a.setValue&&void 0!=c.dataSource){var e=b("filter")(c.dataSource,{ID:a.setValue},!0)[0];void 0!==e?g(e):void 0==e&&(g(null),item=null)}else a.setValue!=d.setValue&&void 0!=a.setValue&&null==c.dataSource&&(c.isSetValue=!1);a.setfocus!=d.setfocus&&1==a.setfocus&&$("#"+c.idCode).focus()},!0),c.$watch("ngDatasource",function(a,d){if(a!=d&&(c.dataSource=c.ngDatasource,c.dataFilter=angular.copy(c.dataSource).slice(0,c.maxLengthFilter),0==c.isSetValue&&0!=c.options.setValue)){var e=b("filter")(c.dataSource,{ID:c.options.setValue},!0)[0];if(void 0!=e){var f=b("filter")(c.dataFilter,{ID:e.ID},!0);0==f.length&&c.dataFilter.push(e),g(e)}c.isSetValue=!0}},!0)}}}]),app.directive("customMultiselect",["$timeout","$filter",function(a,b){return{restrict:"E",require:"ngModel",templateUrl:"app/shared/templates/customMultiSelect.html?nd="+Date.now(),scope:{ngModel:"=",ngDatasource:"=",options:"=",selectedrow:"&"},link:function(c,d,e,f){function g(a){document.getElementById(c.idModel).value=null==a?null:null==a.ID||void 0==a.ID?a.Code:a.ID,document.getElementById(c.idCode).value=null==a?null:a.Code,document.getElementById(c.idName).value=null==a?null:a.Name,f.$setViewValue(document.getElementById(c.idModel).value),c.options.setValue=null==a?0:a.ID,$("#"+c.idControl).attr("aaID",null==a?null:a.ID),$("#"+c.idControl).attr("aaCode",null==a?null:a.Code),$("#"+c.idControl).attr("aaName",null==a?null:a.Name),$("#"+c.idControl).attr("aaField3",null==a?null:a.Field3),$("#"+c.idControl).attr("aaField4",null==a?null:a.Field4),$("#"+c.idControl).attr("aaField5",null==a?null:a.Field5)}c.maxLengthFilter=50,c.oldValue=null,c.isFocus=!1,c.idControl=d[0].id,c.style=e.style,c.codenameOptions=c.options,c.idCode=c.idControl+"_Code",c.idName=c.idControl+"_Name",c.idModel=c.idControl+"_Model",c.idButton=c.idControl+"_Button",c.idContainer=c.idControl+"_Container",c.idboundCtrl=c.idControl+"_boundCtrl",c.selectedRow=0,c.dataSource=c.ngDatasource,c.dataFilter=null,null!=c.dataSource&&(c.dataFilter=angular.copy(c.dataSource).slice(0,c.maxLengthFilter));var h=28;c.popupHeight=h*c.options.maxDropDownItems+1;var i=0,j=0,k=0;c.popupWidth=100,c.popupWidth=(1==c.options.showcode?parseInt(c.options.codewidth):parseInt(0))+(1==c.options.showname?parseInt(c.options.namewidth):parseInt(0))+(1==c.options.showfield3?parseInt(c.options.field3width):parseInt(0))+(1==c.options.showfield4?parseInt(c.options.field4width):parseInt(0))+(1==c.options.showfield5?parseInt(c.options.field5width):parseInt(0)),c.codewidth=parseInt(c.codenameOptions.codewidth),a(function(){var a=$("#"+c.idCode).width()+8+($("#"+c.idName).width()+8)+35;c.popupWidth>a?$("#"+c.idContainer).css("width",c.popupWidth+"px"):$("#"+c.idContainer).css("width",a+"px"),
$("#"+c.idContainer).css("height",c.popupHeight+"px"),$("#"+c.idControl+"_dropdown").css("height",c.popupHeight+28+"px")},30),c.idCode_onKeyPress=function(a){if(40==a.which){if(c.selectedRow==c.dataFilter.length-1)return;c.selectedRow++;var d=document.getElementById(c.idControl+"_table").rows,e=document.querySelector("#"+c.idControl+"_"+c.selectedRow);k=e.getBoundingClientRect().top,k>=j-h&&d[c.selectedRow].scrollIntoView(!1)}else if(38==a.which){if(0==c.selectedRow)return;c.selectedRow--;var d=document.getElementById(c.idControl+"_table").rows,e=document.querySelector("#"+c.idControl+"_"+c.selectedRow);k=e.getBoundingClientRect().top,i+h>=k&&d[c.selectedRow].scrollIntoView(!1)}else if(13==a.which){var f=$("#"+c.idControl+"_dropdown").attr("class");if(f.indexOf("show")>=0){var l=c.dataFilter[c.selectedRow];g(l),$("#"+c.idControl+"_dropdown").removeClass("show"),c.oldValue!=l.Code&&(c.selectedrow({rowItem:l}),c.oldValue=l.Code)}else{var m=document.getElementById(c.idCode).value;if(null!=m&&""!=m&&void 0!=m){var n=b("filter")(c.dataFilter,{Code:m},!0)[0];void 0!=n||c.ShowPopup()}else c.ShowPopup()}}},c.ShowPopup=function(){c.isFocus=!0;var a=document.querySelector("#"+c.idCode),b=a.getBoundingClientRect().top,d=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;d-b-32<parseInt(c.popupHeight)?($("#"+c.idboundCtrl).addClass("dropup"),$("#"+c.idboundCtrl).removeClass("dropdown")):($("#"+c.idboundCtrl).addClass("dropdown"),$("#"+c.idboundCtrl).removeClass("dropup"));var e=document.getElementById(c.idControl+"_table").rows;e.length>0&&(document.getElementById(c.idControl+"_dropdown").classList.toggle("show"),$("#"+c.idCode).focus());var f=document.querySelector("#"+c.idControl+"_dropdown");i=f.getBoundingClientRect().top,j=f.getBoundingClientRect().bottom},c.setClickedRow=function(a){c.selectedRow=a;var b=c.dataFilter[a];$("#"+c.idCode).focus(),c.isFocus=!1,document.getElementById(c.idCode).value=b.Code},c.eventLostFocus=function(){c.isFocus=!1,a(function(){if(0==c.isFocus){$("#"+c.idControl+"_dropdown").removeClass("show");var a=document.getElementById(c.idCode).value;if(null!=a&&""!=a&&void 0!=a){var d=b("filter")(c.dataFilter,{Code:a},!0)[0];void 0!=d?(g(d),c.oldValue!=d.Code&&(c.selectedrow({rowItem:d}),c.oldValue=d.Code)):(g(null),null!=c.oldValue&&(c.selectedrow({rowItem:null}),c.oldValue=null))}else g(null),null!=c.oldValue&&(c.selectedrow({rowItem:null}),c.oldValue=null)}},120)},c.$watch(function(){return c.codeFilter},function(a,d){if(void 0!=a&&a!=d&&void 0!=c.dataSource){var e=$("#"+c.idControl+"_dropdown").attr("class");e.indexOf("show")<0&&c.ShowPopup()}if(void 0!=c.dataSource){var f=document.getElementById(c.idCode).value;c.dataFilter=b("filter")(c.dataSource,{Code:f},!1).slice(0,c.maxLengthFilter),c.selectedRow>c.dataFilter.length&&(c.selectedRow=0)}},!0),c.$watch("options",function(a,d){if(a.setValue!=d.setValue&&void 0!=a.setValue&&void 0!=c.dataSource){var e=b("filter")(c.dataSource,{ID:a.setValue},!0)[0];void 0!=e&&g(e)}},!0),c.$watch("ngDatasource",function(a,b){a!=b&&(c.dataSource=c.ngDatasource,c.dataFilter=angular.copy(c.dataSource).slice(0,c.maxLengthFilter))},!0)}}}]),function(){"use strict";function a(a){return angular.isUndefined(a)||null===a}var b={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,COMMAND:91,MAP:{91:"COMMAND",8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",18:"ALT",19:"PAUSEBREAK",20:"CAPSLOCK",27:"ESC",32:"SPACE",33:"PAGE_UP",34:"PAGE_DOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN",43:"+",44:"PRINTSCREEN",45:"INSERT",46:"DELETE",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NUMLOCK",145:"SCROLLLOCK",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},isControl:function(a){var c=a.which;switch(c){case b.COMMAND:case b.SHIFT:case b.CTRL:case b.ALT:return!0}return a.metaKey||a.ctrlKey||a.altKey?!0:!1},isFunctionKey:function(a){return a=a.which?a.which:a,a>=112&&123>=a},isVerticalMovement:function(a){return~[b.UP,b.DOWN].indexOf(a)},isHorizontalMovement:function(a){return~[b.LEFT,b.RIGHT,b.BACKSPACE,b.DELETE].indexOf(a)},toSeparator:function(a){var c={ENTER:"\n",TAB:"	",SPACE:" "}[a];return c?c:b[a]?void 0:a}};void 0===angular.element.prototype.querySelectorAll&&(angular.element.prototype.querySelectorAll=function(a){return angular.element(this[0].querySelectorAll(a))}),void 0===angular.element.prototype.closest&&(angular.element.prototype.closest=function(a){for(var b=this[0],c=b.matches||b.webkitMatchesSelector||b.mozMatchesSelector||b.msMatchesSelector;b;){if(c.bind(b)(a))return b;b=b.parentElement}return!1});var c=0,d=angular.module("ui.select",[]).constant("uiSelectConfig",{theme:"bootstrap",searchEnabled:!0,sortable:!1,placeholder:"",refreshDelay:1e3,closeOnSelect:!0,skipFocusser:!1,dropdownPosition:"auto",removeSelected:!0,resetSearchInput:!0,generateId:function(){return c++},appendToBody:!1,spinnerEnabled:!1,spinnerClass:"glyphicon glyphicon-refresh ui-select-spin",backspaceReset:!0}).service("uiSelectMinErr",function(){var a=angular.$$minErr("ui.select");return function(){var b=a.apply(this,arguments),c=b.message.replace(new RegExp("\nhttp://errors.angularjs.org/.*"),"");return new Error(c)}}).directive("uisTranscludeAppend",function(){return{link:function(a,b,c,d,e){e(a,function(a){b.append(a)})}}}).filter("highlight",function(){function a(a){return(""+a).replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(b,c){return c&&b?(""+b).replace(new RegExp(a(c),"gi"),'<span class="ui-select-highlight">$&</span>'):b}}).factory("uisOffset",["$document","$window",function(a,b){return function(c){var d=c[0].getBoundingClientRect();return{width:d.width||c.prop("offsetWidth"),height:d.height||c.prop("offsetHeight"),top:d.top+(b.pageYOffset||a[0].documentElement.scrollTop),left:d.left+(b.pageXOffset||a[0].documentElement.scrollLeft)}}}]);d.directive("uiSelectChoices",["uiSelectConfig","uisRepeatParser","uiSelectMinErr","$compile","$window",function(a,b,c,d,e){return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(b){b.addClass("ui-select-choices");var c=b.parent().attr("theme")||a.theme;return c+"/choices.tpl.html"},compile:function(d,f){if(!f.repeat)throw c("repeat","Expected 'repeat' expression.");var g=f.groupBy,h=f.groupFilter;if(g){var i=d.querySelectorAll(".ui-select-choices-group");if(1!==i.length)throw c("rows","Expected 1 .ui-select-choices-group but got '{0}'.",i.length);i.attr("ng-repeat",b.getGroupNgRepeatExpression())}var j=b.parse(f.repeat),k=d.querySelectorAll(".ui-select-choices-row");if(1!==k.length)throw c("rows","Expected 1 .ui-select-choices-row but got '{0}'.",k.length);k.attr("ng-repeat",j.repeatExpression(g)).attr("ng-if","$select.open");var l=d.querySelectorAll(".ui-select-choices-row-inner");if(1!==l.length)throw c("rows","Expected 1 .ui-select-choices-row-inner but got '{0}'.",l.length);l.attr("uis-transclude-append","");var m=e.document.addEventListener?k:l;return m.attr("ng-click","$select.select("+j.itemName+",$select.skipFocusser,$event)"),function(b,c,e,f){f.parseRepeatAttr(e.repeat,g,h),f.disableChoiceExpression=e.uiDisableChoice,f.onHighlightCallback=e.onHighlight,f.minimumInputLength=parseInt(e.minimumInputLength)||0,f.dropdownPosition=e.position?e.position.toLowerCase():a.dropdownPosition,b.$watch("$select.search",function(a){a&&!f.open&&f.multiple&&f.activate(!1,!0),f.activeIndex=f.tagging.isActivated?-1:0,!e.minimumInputLength||f.search.length>=e.minimumInputLength?f.refresh(e.refresh):f.items=[]}),e.$observe("refreshDelay",function(){var c=b.$eval(e.refreshDelay);f.refreshDelay=void 0!==c?c:a.refreshDelay}),b.$watch("$select.open",function(a){a?(d.attr("role","listbox"),f.refresh(e.refresh)):c.removeAttr("role")})}}}}]),d.controller("uiSelectCtrl",["$scope","$element","$timeout","$filter","$$uisDebounce","uisRepeatParser","uiSelectMinErr","uiSelectConfig","$parse","$injector","$window",function(c,d,e,f,g,h,i,j,k,l,m){function n(a,b,c){if(a.findIndex)return a.findIndex(b,c);for(var d,e=Object(a),f=e.length>>>0,g=0;f>g;g++)if(d=e[g],b.call(c,d,g,e))return g;return-1}function o(){v.resetSearchInput&&(v.search=w,v.selected&&v.items.length&&!v.multiple&&(v.activeIndex=n(v.items,function(a){return angular.equals(this,a)},v.selected)))}function p(a,b){var c,d,e=[];for(c=0;c<b.length;c++)for(d=0;d<a.length;d++)a[d].name==[b[c]]&&e.push(a[d]);return e}function q(a,b){var c=z.indexOf(a);b&&-1===c&&z.push(a),!b&&c>-1&&z.splice(c,1)}function r(a){return z.indexOf(a)>-1}function s(a){function b(a,b){var c=d.indexOf(a);b&&-1===c&&d.push(a),!b&&c>-1&&d.splice(c,1)}function c(a){return d.indexOf(a)>-1}if(a){var d=[];v.isLocked=function(a,d){var e=!1,f=v.selected[d];return f&&(a?(e=!!a.$eval(v.lockChoiceExpression),b(f,e)):e=c(f)),e}}}function t(a){var c=!0;switch(a){case b.DOWN:if(!v.open&&v.multiple)v.activate(!1,!0);else if(v.activeIndex<v.items.length-1)for(var d=++v.activeIndex;r(v.items[d])&&d<v.items.length;)v.activeIndex=++d;break;case b.UP:var e=0===v.search.length&&v.tagging.isActivated?-1:0;if(!v.open&&v.multiple)v.activate(!1,!0);else if(v.activeIndex>e)for(var f=--v.activeIndex;r(v.items[f])&&f>e;)v.activeIndex=--f;break;case b.TAB:(!v.multiple||v.open)&&v.select(v.items[v.activeIndex],!0);break;case b.ENTER:v.open&&(v.tagging.isActivated||v.activeIndex>=0)?v.select(v.items[v.activeIndex],v.skipFocusser):v.activate(!1,!0);break;case b.ESC:v.close();break;default:c=!1}return c}function u(){var a=d.querySelectorAll(".ui-select-choices-content"),b=a.querySelectorAll(".ui-select-choices-row");if(b.length<1)throw i("choices","Expected multiple .ui-select-choices-row but got '{0}'.",b.length);if(!(v.activeIndex<0)){var c=b[v.activeIndex],e=c.offsetTop+c.clientHeight-a[0].scrollTop,f=a[0].offsetHeight;e>f?a[0].scrollTop+=e-f:e<c.clientHeight&&(v.isGrouped&&0===v.activeIndex?a[0].scrollTop=0:a[0].scrollTop-=c.clientHeight-e)}}var v=this,w="";if(v.placeholder=j.placeholder,v.searchEnabled=j.searchEnabled,v.sortable=j.sortable,v.refreshDelay=j.refreshDelay,v.paste=j.paste,v.resetSearchInput=j.resetSearchInput,v.refreshing=!1,v.spinnerEnabled=j.spinnerEnabled,v.spinnerClass=j.spinnerClass,v.removeSelected=j.removeSelected,v.closeOnSelect=!0,v.skipFocusser=!1,v.search=w,v.activeIndex=0,v.items=[],v.open=!1,v.focus=!1,v.disabled=!1,v.selected=void 0,v.dropdownPosition="auto",v.focusser=void 0,v.multiple=void 0,v.disableChoiceExpression=void 0,v.tagging={isActivated:!1,fct:void 0},v.taggingTokens={isActivated:!1,tokens:void 0},v.lockChoiceExpression=void 0,v.clickTriggeredSelect=!1,v.$filter=f,v.$element=d,v.$animate=function(){try{return l.get("$animate")}catch(a){return null}}(),v.searchInput=d.querySelectorAll("input.ui-select-search"),1!==v.searchInput.length)throw i("searchInput","Expected 1 input.ui-select-search but got '{0}'.",v.searchInput.length);v.isEmpty=function(){return a(v.selected)||""===v.selected||v.multiple&&0===v.selected.length},v.activate=function(a,b){if(v.disabled||v.open)v.open&&!v.searchEnabled&&v.close();else{b||o(),c.$broadcast("uis:activate"),v.open=!0,v.activeIndex=v.activeIndex>=v.items.length?0:v.activeIndex,-1===v.activeIndex&&v.taggingLabel!==!1&&(v.activeIndex=0);var f=d.querySelectorAll(".ui-select-choices-content"),g=d.querySelectorAll(".ui-select-search");if(v.$animate&&v.$animate.on&&v.$animate.enabled(f[0])){var h=function(b,c){"start"===c&&0===v.items.length?(v.$animate.off("removeClass",g[0],h),e(function(){v.focusSearchInput(a)})):"close"===c&&(v.$animate.off("enter",f[0],h),e(function(){v.focusSearchInput(a)}))};v.items.length>0?v.$animate.on("enter",f[0],h):v.$animate.on("removeClass",g[0],h)}else e(function(){v.focusSearchInput(a),!v.tagging.isActivated&&v.items.length>1&&u()})}},v.focusSearchInput=function(a){v.search=a||v.search,v.searchInput[0].focus()},v.findGroupByName=function(a){return v.groups&&v.groups.filter(function(b){return b.name===a})[0]},v.parseRepeatAttr=function(a,b,d){function e(a){var e=c.$eval(b);if(v.groups=[],angular.forEach(a,function(a){var b=angular.isFunction(e)?e(a):a[e],c=v.findGroupByName(b);c?c.items.push(a):v.groups.push({name:b,items:[a]})}),d){var f=c.$eval(d);angular.isFunction(f)?v.groups=f(v.groups):angular.isArray(f)&&(v.groups=p(v.groups,f))}v.items=[],v.groups.forEach(function(a){v.items=v.items.concat(a.items)})}function f(a){v.items=a||[]}v.setItemsFn=b?e:f,v.parserResult=h.parse(a),v.isGrouped=!!b,v.itemProperty=v.parserResult.itemName;var g=v.parserResult.source,j=function(){var a=g(c);c.$uisSource=Object.keys(a).map(function(b){var c={};return c[v.parserResult.keyName]=b,c.value=a[b],c})};v.parserResult.keyName&&(j(),v.parserResult.source=k("$uisSource"+v.parserResult.filters),c.$watch(g,function(a,b){a!==b&&j()},!0)),v.refreshItems=function(a){a=a||v.parserResult.source(c);var b=v.selected;if(v.isEmpty()||angular.isArray(b)&&!b.length||!v.multiple||!v.removeSelected)v.setItemsFn(a);else if(void 0!==a&&null!==a){var d=a.filter(function(a){return angular.isArray(b)?b.every(function(b){return!angular.equals(a,b)}):!angular.equals(a,b)});v.setItemsFn(d)}("auto"===v.dropdownPosition||"up"===v.dropdownPosition)&&c.calculateDropdownPos(),c.$broadcast("uis:refresh")},c.$watchCollection(v.parserResult.source,function(a){if(void 0===a||null===a)v.items=[];else{if(!angular.isArray(a))throw i("items","Expected an array but got '{0}'.",a);v.refreshItems(a),angular.isDefined(v.ngModel.$modelValue)&&(v.ngModel.$modelValue=null)}})};var x;v.refresh=function(a){void 0!==a&&(x&&e.cancel(x),x=e(function(){if(c.$select.search.length>=c.$select.minimumInputLength){var b=c.$eval(a);b&&angular.isFunction(b.then)&&!v.refreshing&&(v.refreshing=!0,b["finally"](function(){v.refreshing=!1}))}},v.refreshDelay))},v.isActive=function(a){if(!v.open)return!1;var b=v.items.indexOf(a[v.itemProperty]),c=b==v.activeIndex;return!c||0>b?!1:(c&&!angular.isUndefined(v.onHighlightCallback)&&a.$eval(v.onHighlightCallback),c)};var y=function(a){return v.selected&&angular.isArray(v.selected)&&v.selected.filter(function(b){return angular.equals(b,a)}).length>0},z=[];v.isDisabled=function(a){if(v.open){var b=a[v.itemProperty],c=v.items.indexOf(b),d=!1;if(c>=0&&(angular.isDefined(v.disableChoiceExpression)||v.multiple)){if(b.isTag)return!1;v.multiple&&(d=y(b)),!d&&angular.isDefined(v.disableChoiceExpression)&&(d=!!a.$eval(v.disableChoiceExpression)),q(b,d)}return d}},v.select=function(b,d,e){if(a(b)||!r(b)){if(!v.items&&!v.search&&!v.tagging.isActivated)return;if(!b||!r(b)){if(v.clickTriggeredSelect=!1,e&&("click"===e.type||"touchend"===e.type)&&b&&(v.clickTriggeredSelect=!0),v.tagging.isActivated&&v.clickTriggeredSelect===!1){if(v.taggingLabel===!1)if(v.activeIndex<0){if(void 0===b&&(b=void 0!==v.tagging.fct?v.tagging.fct(v.search):v.search),!b||angular.equals(v.items[0],b))return}else b=v.items[v.activeIndex];else if(0===v.activeIndex){if(void 0===b)return;if(void 0!==v.tagging.fct&&"string"==typeof b){if(b=v.tagging.fct(b),!b)return}else"string"==typeof b&&(b=b.replace(v.taggingLabel,"").trim())}if(y(b))return void v.close(d)}o(),c.$broadcast("uis:select",b),v.closeOnSelect&&v.close(d)}}},v.close=function(a){v.open&&(v.ngModel&&v.ngModel.$setTouched&&v.ngModel.$setTouched(),v.open=!1,o(),c.$broadcast("uis:close",a))},v.setFocus=function(){v.focus||v.focusInput[0].focus()},v.clear=function(a){v.select(null),a.stopPropagation(),e(function(){v.focusser[0].focus()},0,!1)},v.toggle=function(a){v.open?(v.close(),a.preventDefault(),a.stopPropagation()):v.activate()},v.isLocked=function(){return!1},c.$watch(function(){return angular.isDefined(v.lockChoiceExpression)&&""!==v.lockChoiceExpression},s);var A=null,B=!1;v.sizeSearchInput=function(){var a=v.searchInput[0],b=v.$element[0],d=function(){return b.clientWidth*!!a.offsetParent},f=function(b){if(0===b)return!1;var c=b-a.offsetLeft;return 50>c&&(c=b),v.searchInput.css("width",c+"px"),!0};v.searchInput.css("width","10px"),e(function(){null!==A||f(d())||(A=c.$watch(function(){B||(B=!0,c.$$postDigest(function(){B=!1,f(d())&&(A(),A=null)}))},angular.noop))})},v.searchInput.on("keydown",function(a){var d=a.which;~[b.ENTER,b.ESC].indexOf(d)&&(a.preventDefault(),a.stopPropagation()),c.$apply(function(){var c=!1;if((v.items.length>0||v.tagging.isActivated)&&(t(d)||v.searchEnabled||(a.preventDefault(),a.stopPropagation()),v.taggingTokens.isActivated)){for(var f=0;f<v.taggingTokens.tokens.length;f++)v.taggingTokens.tokens[f]===b.MAP[a.keyCode]&&v.search.length>0&&(c=!0);c&&e(function(){v.searchInput.triggerHandler("tagged");var c=v.search.replace(b.MAP[a.keyCode],"").trim();v.tagging.fct&&(c=v.tagging.fct(c)),c&&v.select(c,!0)})}}),b.isVerticalMovement(d)&&v.items.length>0&&u(),(d===b.ENTER||d===b.ESC)&&(a.preventDefault(),a.stopPropagation())}),v.searchInput.on("paste",function(a){var c;if(c=window.clipboardData&&window.clipboardData.getData?window.clipboardData.getData("Text"):(a.originalEvent||a).clipboardData.getData("text/plain"),c=v.search+c,c&&c.length>0)if(v.taggingTokens.isActivated){for(var d=[],e=0;e<v.taggingTokens.tokens.length;e++){var f=b.toSeparator(v.taggingTokens.tokens[e])||v.taggingTokens.tokens[e];if(c.indexOf(f)>-1){d=c.split(f);break}}0===d.length&&(d=[c]);var g=v.search;angular.forEach(d,function(a){var b=v.tagging.fct?v.tagging.fct(a):a;b&&v.select(b,!0)}),v.search=g||w,a.preventDefault(),a.stopPropagation()}else v.paste&&(v.paste(c),v.search=w,a.preventDefault(),a.stopPropagation())}),v.searchInput.on("tagged",function(){e(function(){o()})});var C=g(function(){v.sizeSearchInput()},50);angular.element(m).bind("resize",C),c.$on("$destroy",function(){v.searchInput.off("keyup keydown tagged blur paste"),angular.element(m).off("resize",C)}),c.$watch("$select.activeIndex",function(a){a&&d.find("input").attr("aria-activedescendant","ui-select-choices-row-"+v.generatedId+"-"+a)}),c.$watch("$select.open",function(a){a||d.find("input").removeAttr("aria-activedescendant")})}]),d.directive("uiSelect",["$document","uiSelectConfig","uiSelectMinErr","uisOffset","$compile","$parse","$timeout",function(a,b,c,d,e,f,g){return{restrict:"EA",templateUrl:function(a,c){var d=c.theme||b.theme;return d+(angular.isDefined(c.multiple)?"/select-multiple.tpl.html":"/select.tpl.html")},replace:!0,transclude:!0,require:["uiSelect","^ngModel"],scope:!0,controller:"uiSelectCtrl",controllerAs:"$select",compile:function(e,h){var i=/{(.*)}\s*{(.*)}/.exec(h.ngClass);if(i){var j="{"+i[1]+", "+i[2]+"}";h.ngClass=j,e.attr("ng-class",j)}return angular.isDefined(h.multiple)?e.append("<ui-select-multiple/>").removeAttr("multiple"):e.append("<ui-select-single/>"),h.inputId&&(e.querySelectorAll("input.ui-select-search")[0].id=h.inputId),function(e,h,i,j,k){function l(a){if(o.open){var b=!1;if(b=window.jQuery?window.jQuery.contains(h[0],a.target):h[0].contains(a.target),!b&&!o.clickTriggeredSelect){var c;if(o.skipFocusser)c=!0;else{var d=["input","button","textarea","select"],f=angular.element(a.target).controller("uiSelect");c=f&&f!==o,c||(c=~d.indexOf(a.target.tagName.toLowerCase()))}o.close(c),e.$digest()}o.clickTriggeredSelect=!1}}function m(){var b=d(h);r=angular.element('<div class="ui-select-placeholder"></div>'),r[0].style.width=b.width+"px",r[0].style.height=b.height+"px",h.after(r),s=h[0].style.width,a.find("body").append(h),h[0].style.position="absolute",h[0].style.left=b.left+"px",h[0].style.top=b.top+"px",h[0].style.width=b.width+"px"}function n(){null!==r&&(r.replaceWith(h),r=null,h[0].style.position="",h[0].style.left="",h[0].style.top="",h[0].style.width=s,o.setFocus())}var o=j[0],p=j[1];o.generatedId=b.generateId(),o.baseTitle=i.title||"Select box",o.focusserTitle=o.baseTitle+" focus",o.focusserId="focusser-"+o.generatedId,o.closeOnSelect=function(){return angular.isDefined(i.closeOnSelect)?f(i.closeOnSelect)():b.closeOnSelect}(),e.$watch("skipFocusser",function(){var a=e.$eval(i.skipFocusser);o.skipFocusser=void 0!==a?a:b.skipFocusser}),o.onSelectCallback=f(i.onSelect),o.onRemoveCallback=f(i.onRemove),o.ngModel=p,o.choiceGrouped=function(a){return o.isGrouped&&a&&a.name},i.tabindex&&i.$observe("tabindex",function(a){o.focusInput.attr("tabindex",a),h.removeAttr("tabindex")}),e.$watch(function(){return e.$eval(i.searchEnabled)},function(a){o.searchEnabled=void 0!==a?a:b.searchEnabled}),e.$watch("sortable",function(){var a=e.$eval(i.sortable);o.sortable=void 0!==a?a:b.sortable}),i.$observe("backspaceReset",function(){var a=e.$eval(i.backspaceReset);o.backspaceReset=void 0!==a?a:!0}),i.$observe("limit",function(){o.limit=angular.isDefined(i.limit)?parseInt(i.limit,10):void 0}),e.$watch("removeSelected",function(){var a=e.$eval(i.removeSelected);o.removeSelected=void 0!==a?a:b.removeSelected}),i.$observe("disabled",function(){o.disabled=void 0!==i.disabled?i.disabled:!1}),i.$observe("resetSearchInput",function(){var a=e.$eval(i.resetSearchInput);o.resetSearchInput=void 0!==a?a:!0}),i.$observe("paste",function(){o.paste=e.$eval(i.paste)}),i.$observe("tagging",function(){if(void 0!==i.tagging){var a=e.$eval(i.tagging);o.tagging={isActivated:!0,fct:a!==!0?a:void 0}}else o.tagging={isActivated:!1,fct:void 0}}),i.$observe("taggingLabel",function(){void 0!==i.tagging&&("false"===i.taggingLabel?o.taggingLabel=!1:o.taggingLabel=void 0!==i.taggingLabel?i.taggingLabel:"(new)")}),i.$observe("taggingTokens",function(){if(void 0!==i.tagging){var a=void 0!==i.taggingTokens?i.taggingTokens.split("|"):[",","ENTER"];o.taggingTokens={isActivated:!0,tokens:a}}}),i.$observe("spinnerEnabled",function(){var a=e.$eval(i.spinnerEnabled);o.spinnerEnabled=void 0!==a?a:b.spinnerEnabled}),i.$observe("spinnerClass",function(){var a=i.spinnerClass;o.spinnerClass=void 0!==a?i.spinnerClass:b.spinnerClass}),angular.isDefined(i.autofocus)&&g(function(){o.setFocus()}),angular.isDefined(i.focusOn)&&e.$on(i.focusOn,function(){g(function(){o.setFocus()})}),a.on("click",l),e.$on("$destroy",function(){a.off("click",l)}),k(e,function(a){var b=angular.element("<div>").append(a),d=b.querySelectorAll(".ui-select-match");if(d.removeAttr("ui-select-match"),d.removeAttr("data-ui-select-match"),1!==d.length)throw c("transcluded","Expected 1 .ui-select-match but got '{0}'.",d.length);h.querySelectorAll(".ui-select-match").replaceWith(d);var e=b.querySelectorAll(".ui-select-choices");if(e.removeAttr("ui-select-choices"),e.removeAttr("data-ui-select-choices"),1!==e.length)throw c("transcluded","Expected 1 .ui-select-choices but got '{0}'.",e.length);h.querySelectorAll(".ui-select-choices").replaceWith(e);var f=b.querySelectorAll(".ui-select-no-choice");f.removeAttr("ui-select-no-choice"),f.removeAttr("data-ui-select-no-choice"),1==f.length&&h.querySelectorAll(".ui-select-no-choice").replaceWith(f)});var q=e.$eval(i.appendToBody);(void 0!==q?q:b.appendToBody)&&(e.$watch("$select.open",function(a){a?m():n()}),e.$on("$destroy",function(){n()}));var r=null,s="",t=null,u="direction-up";e.$watch("$select.open",function(){("auto"===o.dropdownPosition||"up"===o.dropdownPosition)&&e.calculateDropdownPos()});var v=function(a,b){a=a||d(h),b=b||d(t),t[0].style.position="absolute",t[0].style.top=-1*b.height+"px",h.addClass(u)},w=function(a,b){h.removeClass(u),a=a||d(h),b=b||d(t),t[0].style.position="",t[0].style.top=""},x=function(){g(function(){if("up"===o.dropdownPosition)v();else{h.removeClass(u);var b=d(h),c=d(t),e=a[0].documentElement.scrollTop||a[0].body.scrollTop;b.top+b.height+c.height>e+a[0].documentElement.clientHeight?v(b,c):w(b,c)}t[0].style.opacity=1})},y=!1;e.calculateDropdownPos=function(){if(o.open){if(t=angular.element(h).querySelectorAll(".ui-select-dropdown"),0===t.length)return;if(""!==o.search||y||(t[0].style.opacity=0,y=!0),!d(t).height&&o.$animate&&o.$animate.on&&o.$animate.enabled(t)){var a=!0;o.$animate.on("enter",t,function(b,c){"close"===c&&a&&(x(),a=!1)})}else x()}else{if(null===t||0===t.length)return;t[0].style.opacity=0,t[0].style.position="",t[0].style.top="",h.removeClass(u)}}}}}}]),d.directive("uiSelectMatch",["uiSelectConfig",function(a){function b(a,b){return a[0].hasAttribute(b)?a.attr(b):a[0].hasAttribute("data-"+b)?a.attr("data-"+b):a[0].hasAttribute("x-"+b)?a.attr("x-"+b):void 0}return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(c){c.addClass("ui-select-match");var d=c.parent(),e=b(d,"theme")||a.theme,f=angular.isDefined(b(d,"multiple"));return e+(f?"/match-multiple.tpl.html":"/match.tpl.html")},link:function(b,c,d,e){function f(a){e.allowClear=angular.isDefined(a)?""===a?!0:"true"===a.toLowerCase():!1}e.lockChoiceExpression=d.uiLockChoice,d.$observe("placeholder",function(b){e.placeholder=void 0!==b?b:a.placeholder}),d.$observe("allowClear",f),f(d.allowClear),e.multiple&&e.sizeSearchInput()}}}]),d.directive("uiSelectMultiple",["uiSelectMinErr","$timeout",function(c,d){return{restrict:"EA",require:["^uiSelect","^ngModel"],controller:["$scope","$timeout",function(a,b){var c,d=this,e=a.$select;angular.isUndefined(e.selected)&&(e.selected=[]),a.$evalAsync(function(){c=a.ngModel}),d.activeMatchIndex=-1,d.updateModel=function(){c.$setViewValue(Date.now()),d.refreshComponent()},d.refreshComponent=function(){e.refreshItems&&e.refreshItems(),e.sizeSearchInput&&e.sizeSearchInput()},d.removeChoice=function(c){if(e.isLocked(null,c))return!1;var f=e.selected[c],g={};return g[e.parserResult.itemName]=f,e.selected.splice(c,1),d.activeMatchIndex=-1,e.sizeSearchInput(),b(function(){e.onRemoveCallback(a,{$item:f,$model:e.parserResult.modelMapper(a,g)})}),d.updateModel(),!0},d.getPlaceholder=function(){return e.selected&&e.selected.length?void 0:e.placeholder}}],controllerAs:"$selectMultiple",link:function(e,f,g,h){function i(a){return angular.isNumber(a.selectionStart)?a.selectionStart:a.value.length}function j(a){function c(){switch(a){case b.LEFT:return~o.activeMatchIndex?k:g;case b.RIGHT:return~o.activeMatchIndex&&h!==g?j:(m.activate(),!1);case b.BACKSPACE:return~o.activeMatchIndex?o.removeChoice(h)?k:h:g;case b.DELETE:return~o.activeMatchIndex?(o.removeChoice(o.activeMatchIndex),h):!1}}var d=i(m.searchInput[0]),e=m.selected.length,f=0,g=e-1,h=o.activeMatchIndex,j=o.activeMatchIndex+1,k=o.activeMatchIndex-1,l=h;return d>0||m.search.length&&a==b.RIGHT?!1:(m.close(),l=c(),m.selected.length&&l!==!1?o.activeMatchIndex=Math.min(g,Math.max(f,l)):o.activeMatchIndex=-1,!0)}function k(a){if(void 0===a||void 0===m.search)return!1;var b=a.filter(function(a){return void 0===m.search.toUpperCase()||void 0===a?!1:a.toUpperCase()===m.search.toUpperCase()}).length>0;return b}function l(a,b){var c=-1;if(angular.isArray(a))for(var d=angular.copy(a),e=0;e<d.length;e++)if(void 0===m.tagging.fct)d[e]+" "+m.taggingLabel===b&&(c=e);else{var f=d[e];angular.isObject(f)&&(f.isTag=!0),angular.equals(f,b)&&(c=e)}return c}var m=h[0],n=e.ngModel=h[1],o=e.$selectMultiple;m.multiple=!0,m.focusInput=m.searchInput,n.$isEmpty=function(a){return!a||0===a.length},n.$parsers.unshift(function(){for(var a,b={},c=[],d=m.selected.length-1;d>=0;d--)b={},b[m.parserResult.itemName]=m.selected[d],a=m.parserResult.modelMapper(e,b),c.unshift(a);return c}),n.$formatters.unshift(function(a){var b,c=m.parserResult&&m.parserResult.source(e,{$select:{search:""}}),d={};if(!c)return a;var f=[],g=function(a,c){if(a&&a.length){for(var g=a.length-1;g>=0;g--){if(d[m.parserResult.itemName]=a[g],b=m.parserResult.modelMapper(e,d),m.parserResult.trackByExp){var h=/(\w*)\./.exec(m.parserResult.trackByExp),i=/\.([^\s]+)/.exec(m.parserResult.trackByExp);if(h&&h.length>0&&h[1]==m.parserResult.itemName&&i&&i.length>0&&b[i[1]]==c[i[1]])return f.unshift(a[g]),!0}if(angular.equals(b,c))return f.unshift(a[g]),!0}return!1}};if(!a)return f;for(var h=a.length-1;h>=0;h--)g(m.selected,a[h])||g(c,a[h])||f.unshift(a[h]);return f}),e.$watchCollection(function(){return n.$modelValue},function(a,b){b!=a&&(angular.isDefined(n.$modelValue)&&(n.$modelValue=null),o.refreshComponent())}),n.$render=function(){if(!angular.isArray(n.$viewValue)){if(!a(n.$viewValue))throw c("multiarr","Expected model value to be array but got '{0}'",n.$viewValue);n.$viewValue=[]}m.selected=n.$viewValue,o.refreshComponent(),e.$evalAsync()},e.$on("uis:select",function(a,b){if(!(m.selected.length>=m.limit)){m.selected.push(b);var c={};c[m.parserResult.itemName]=b,d(function(){m.onSelectCallback(e,{$item:b,$model:m.parserResult.modelMapper(e,c)})}),o.updateModel()}}),e.$on("uis:activate",function(){o.activeMatchIndex=-1}),e.$watch("$select.disabled",function(a,b){b&&!a&&m.sizeSearchInput()}),m.searchInput.on("keydown",function(a){var c=a.which;e.$apply(function(){var d=!1;b.isHorizontalMovement(c)&&(d=j(c)),d&&c!=b.TAB&&(a.preventDefault(),a.stopPropagation())})}),m.searchInput.on("keyup",function(a){if(b.isVerticalMovement(a.which)||e.$evalAsync(function(){m.activeIndex=m.taggingLabel===!1?-1:0}),m.tagging.isActivated&&m.search.length>0){if(a.which===b.TAB||b.isControl(a)||b.isFunctionKey(a)||a.which===b.ESC||b.isVerticalMovement(a.which))return;if(m.activeIndex=m.taggingLabel===!1?-1:0,m.taggingLabel===!1)return;var c,d,f,g,h=angular.copy(m.items),i=angular.copy(m.items),j=!1,n=-1;if(void 0!==m.tagging.fct){if(f=m.$filter("filter")(h,{isTag:!0}),f.length>0&&(g=f[0]),h.length>0&&g&&(j=!0,h=h.slice(1,h.length),i=i.slice(1,i.length)),c=m.tagging.fct(m.search),i.some(function(a){return angular.equals(a,c)})||m.selected.some(function(a){return angular.equals(a,c)}))return void e.$evalAsync(function(){m.activeIndex=0,m.items=h});c&&(c.isTag=!0)}else{if(f=m.$filter("filter")(h,function(a){return a.match(m.taggingLabel)}),f.length>0&&(g=f[0]),d=h[0],void 0!==d&&h.length>0&&g&&(j=!0,h=h.slice(1,h.length),i=i.slice(1,i.length)),c=m.search+" "+m.taggingLabel,l(m.selected,m.search)>-1)return;if(k(i.concat(m.selected)))return void(j&&(h=i,e.$evalAsync(function(){m.activeIndex=0,m.items=h})));if(k(i))return void(j&&(m.items=i.slice(1,i.length)))}j&&(n=l(m.selected,c)),n>-1?h=h.slice(n+1,h.length-1):(h=[],c&&h.push(c),h=h.concat(i)),e.$evalAsync(function(){if(m.activeIndex=0,m.items=h,m.isGrouped){var a=c?h.slice(1):h;m.setItemsFn(a),c&&(m.items.unshift(c),m.groups.unshift({name:"",items:[c],tagging:!0}))}})}}),m.searchInput.on("blur",function(){d(function(){o.activeMatchIndex=-1})})}}}]),d.directive("uiSelectNoChoice",["uiSelectConfig",function(a){return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(b){b.addClass("ui-select-no-choice");var c=b.parent().attr("theme")||a.theme;return c+"/no-choice.tpl.html"}}}]),d.directive("uiSelectSingle",["$timeout","$compile",function(c,d){return{restrict:"EA",require:["^uiSelect","^ngModel"],link:function(e,f,g,h){var i=h[0],j=h[1];j.$parsers.unshift(function(b){if(a(b))return b;var c,d={};return d[i.parserResult.itemName]=b,c=i.parserResult.modelMapper(e,d)}),j.$formatters.unshift(function(b){if(a(b))return b;var c,d=i.parserResult&&i.parserResult.source(e,{$select:{search:""}}),f={};if(d){var g=function(a){return f[i.parserResult.itemName]=a,c=i.parserResult.modelMapper(e,f),c===b};if(i.selected&&g(i.selected))return i.selected;for(var h=d.length-1;h>=0;h--)if(g(d[h]))return d[h]}return b}),e.$watch("$select.selected",function(a){j.$viewValue!==a&&j.$setViewValue(a)}),j.$render=function(){i.selected=j.$viewValue},e.$on("uis:select",function(b,d){i.selected=d;var f={};f[i.parserResult.itemName]=d,c(function(){i.onSelectCallback(e,{$item:d,$model:a(d)?d:i.parserResult.modelMapper(e,f)})})}),e.$on("uis:close",function(a,b){c(function(){i.focusser.prop("disabled",!1),b||i.focusser[0].focus()},0,!1)}),e.$on("uis:activate",function(){k.prop("disabled",!0);
});var k=angular.element("<input ng-disabled='$select.disabled' class='ui-select-focusser ui-select-offscreen' type='text' id='{{ $select.focusserId }}' aria-label='{{ $select.focusserTitle }}' aria-haspopup='true' role='button' />");d(k)(e),i.focusser=k,i.focusInput=k,f.parent().append(k),k.bind("focus",function(){e.$evalAsync(function(){i.focus=!0})}),k.bind("blur",function(){e.$evalAsync(function(){i.focus=!1})}),k.bind("keydown",function(a){return a.which===b.BACKSPACE&&i.backspaceReset!==!1?(a.preventDefault(),a.stopPropagation(),i.select(void 0),void e.$apply()):void(a.which===b.TAB||b.isControl(a)||b.isFunctionKey(a)||a.which===b.ESC||((a.which==b.DOWN||a.which==b.UP||a.which==b.ENTER||a.which==b.SPACE)&&(a.preventDefault(),a.stopPropagation(),i.activate()),e.$digest()))}),k.bind("keyup input",function(a){a.which===b.TAB||b.isControl(a)||b.isFunctionKey(a)||a.which===b.ESC||a.which==b.ENTER||a.which===b.BACKSPACE||(i.activate(k.val()),k.val(""),e.$digest())})}}}]),d.directive("uiSelectSort",["$timeout","uiSelectConfig","uiSelectMinErr",function(a,b,c){return{require:["^^uiSelect","^ngModel"],link:function(b,d,e,f){if(null===b[e.uiSelectSort])throw c("sort","Expected a list to sort");var g=f[0],h=f[1],i=angular.extend({axis:"horizontal"},b.$eval(e.uiSelectSortOptions)),j=i.axis,k="dragging",l="dropping",m="dropping-before",n="dropping-after";b.$watch(function(){return g.sortable},function(a){a?d.attr("draggable",!0):d.removeAttr("draggable")}),d.on("dragstart",function(a){d.addClass(k),(a.dataTransfer||a.originalEvent.dataTransfer).setData("text",b.$index.toString())}),d.on("dragend",function(){q(k)});var o,p=function(a,b){this.splice(b,0,this.splice(a,1)[0])},q=function(a){angular.forEach(g.$element.querySelectorAll("."+a),function(b){angular.element(b).removeClass(a)})},r=function(a){a.preventDefault();var b="vertical"===j?a.offsetY||a.layerY||(a.originalEvent?a.originalEvent.offsetY:0):a.offsetX||a.layerX||(a.originalEvent?a.originalEvent.offsetX:0);b<this["vertical"===j?"offsetHeight":"offsetWidth"]/2?(q(n),d.addClass(m)):(q(m),d.addClass(n))},s=function(b){b.preventDefault();var c=parseInt((b.dataTransfer||b.originalEvent.dataTransfer).getData("text"),10);a.cancel(o),o=a(function(){t(c)},20)},t=function(a){var c=b.$eval(e.uiSelectSort),f=c[a],g=null;g=d.hasClass(m)?a<b.$index?b.$index-1:b.$index:a<b.$index?b.$index:b.$index+1,p.apply(c,[a,g]),h.$setViewValue(Date.now()),b.$apply(function(){b.$emit("uiSelectSort:change",{array:c,item:f,from:a,to:g})}),q(l),q(m),q(n),d.off("drop",s)};d.on("dragenter",function(){d.hasClass(k)||(d.addClass(l),d.on("dragover",r),d.on("drop",s))}),d.on("dragleave",function(a){a.target==d&&(q(l),q(m),q(n),d.off("dragover",r),d.off("drop",s))})}}}]),d.factory("$$uisDebounce",["$timeout",function(a){return function(b,c){var d;return function(){var e=this,f=Array.prototype.slice.call(arguments);d&&a.cancel(d),d=a(function(){b.apply(e,f)},c)}}}]),d.directive("uisOpenClose",["$parse","$timeout",function(a,b){return{restrict:"A",require:"uiSelect",link:function(c,d,e,f){f.onOpenCloseCallback=a(e.uisOpenClose),c.$watch("$select.open",function(a,d){a!==d&&b(function(){f.onOpenCloseCallback(c,{isOpen:a})})})}}}]),d.service("uisRepeatParser",["uiSelectMinErr","$parse",function(a,b){var c=this;c.parse=function(c){var d;if(d=c.match(/^\s*(?:([\s\S]+?)\s+as\s+)?(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+(\s*[\s\S]+?)?(?:\s+track\s+by\s+([\s\S]+?))?\s*$/),!d)throw a("iexp","Expected expression in form of '_item_ in _collection_[ track by _id_]' but got '{0}'.",c);var e=d[5],f="";if(d[3]){e=d[5].replace(/(^\()|(\)$)/g,"");var g=d[5].match(/^\s*(?:[\s\S]+?)(?:[^\|]|\|\|)+([\s\S]*)\s*$/);g&&g[1].trim()&&(f=g[1],e=e.replace(f,""))}return{itemName:d[4]||d[2],keyName:d[3],source:b(e),filters:f,trackByExp:d[6],modelMapper:b(d[1]||d[4]||d[2]),repeatExpression:function(a){var b=this.itemName+" in "+(a?"$group.items":"$select.items");return this.trackByExp&&(b+=" track by "+this.trackByExp),b}}},c.getGroupNgRepeatExpression=function(){return"$group in $select.groups track by $group.name"}}])}(),angular.module("ui.select").run(["$templateCache",function(a){a.put("bootstrap/choices.tpl.html",'<ul class="ui-select-choices ui-select-choices-content ui-select-dropdown dropdown-menu" ng-show="$select.open && $select.items.length > 0"><li class="ui-select-choices-group" id="ui-select-choices-{{ $select.generatedId }}"><div class="divider" ng-show="$select.isGrouped && $index > 0"></div><div ng-show="$select.isGrouped" class="ui-select-choices-group-label dropdown-header" ng-bind="$group.name"></div><div ng-attr-id="ui-select-choices-row-{{ $select.generatedId }}-{{$index}}" class="ui-select-choices-row" ng-class="{active: $select.isActive(this), disabled: $select.isDisabled(this)}" role="option"><span class="ui-select-choices-row-inner"></span></div></li></ul>'),a.put("bootstrap/match-multiple.tpl.html",'<span class="ui-select-match"><span ng-repeat="$item in $select.selected track by $index"><span class="ui-select-match-item btn btn-default btn-xs" tabindex="-1" type="button" ng-disabled="$select.disabled" ng-click="$selectMultiple.activeMatchIndex = $index;" ng-class="{\'btn-primary\':$selectMultiple.activeMatchIndex === $index, \'select-locked\':$select.isLocked(this, $index)}" ui-select-sort="$select.selected"><span class="close ui-select-match-close" ng-hide="$select.disabled" ng-click="$selectMultiple.removeChoice($index)">&nbsp;&times;</span> <span uis-transclude-append=""></span></span></span></span>'),a.put("bootstrap/match.tpl.html",'<div class="ui-select-match" ng-hide="$select.open && $select.searchEnabled" ng-disabled="$select.disabled" ng-class="{\'btn-default-focus\':$select.focus}"><span tabindex="-1" class="btn btn-default form-control ui-select-toggle" aria-label="{{ $select.baseTitle }} activate" ng-disabled="$select.disabled" ng-click="$select.activate()" style="outline: 0;"><span ng-show="$select.isEmpty()" class="ui-select-placeholder text-muted">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty()" class="ui-select-match-text pull-left" ng-class="{\'ui-select-allow-clear\': $select.allowClear && !$select.isEmpty()}" ng-transclude=""></span> <i class="caret pull-right" ng-click="$select.toggle($event)"></i> <a ng-show="$select.allowClear && !$select.isEmpty() && ($select.disabled !== true)" aria-label="{{ $select.baseTitle }} clear" style="margin-right: 10px" ng-click="$select.clear($event)" class="btn btn-xs btn-link pull-right"><i class="glyphicon glyphicon-remove" aria-hidden="true"></i></a></span></div>'),a.put("bootstrap/no-choice.tpl.html",'<ul class="ui-select-no-choice dropdown-menu" ng-show="$select.items.length == 0"><li ng-transclude=""></li></ul>'),a.put("bootstrap/select-multiple.tpl.html",'<div class="ui-select-container ui-select-multiple ui-select-bootstrap dropdown form-control" ng-class="{open: $select.open}"><div><div class="ui-select-match"></div><input type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="ui-select-search input-xs" placeholder="{{$selectMultiple.getPlaceholder()}}" ng-disabled="$select.disabled" ng-click="$select.activate()" ng-model="$select.search" role="combobox" aria-expanded="{{$select.open}}" aria-label="{{$select.baseTitle}}" ng-class="{\'spinner\': $select.refreshing}" ondrop="return false;"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>'),a.put("bootstrap/select.tpl.html",'<div class="ui-select-container ui-select-bootstrap dropdown" ng-class="{open: $select.open}"><div class="ui-select-match"></div><span ng-show="$select.open && $select.refreshing && $select.spinnerEnabled" class="ui-select-refreshing {{$select.spinnerClass}}"></span> <input type="search" autocomplete="off" tabindex="-1" aria-expanded="true" aria-label="{{ $select.baseTitle }}" aria-owns="ui-select-choices-{{ $select.generatedId }}" class="form-control ui-select-search" ng-class="{ \'ui-select-search-hidden\' : !$select.searchEnabled }" placeholder="{{$select.placeholder}}" ng-model="$select.search" ng-show="$select.open"><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>'),a.put("select2/choices.tpl.html",'<ul tabindex="-1" class="ui-select-choices ui-select-choices-content select2-results"><li class="ui-select-choices-group" ng-class="{\'select2-result-with-children\': $select.choiceGrouped($group) }"><div ng-show="$select.choiceGrouped($group)" class="ui-select-choices-group-label select2-result-label" ng-bind="$group.name"></div><ul id="ui-select-choices-{{ $select.generatedId }}" ng-class="{\'select2-result-sub\': $select.choiceGrouped($group), \'select2-result-single\': !$select.choiceGrouped($group) }"><li role="option" ng-attr-id="ui-select-choices-row-{{ $select.generatedId }}-{{$index}}" class="ui-select-choices-row" ng-class="{\'select2-highlighted\': $select.isActive(this), \'select2-disabled\': $select.isDisabled(this)}"><div class="select2-result-label ui-select-choices-row-inner"></div></li></ul></li></ul>'),a.put("select2/match-multiple.tpl.html",'<span class="ui-select-match"><li class="ui-select-match-item select2-search-choice" ng-repeat="$item in $select.selected track by $index" ng-class="{\'select2-search-choice-focus\':$selectMultiple.activeMatchIndex === $index, \'select2-locked\':$select.isLocked(this, $index)}" ui-select-sort="$select.selected"><span uis-transclude-append=""></span> <a href="javascript:;" class="ui-select-match-close select2-search-choice-close" ng-click="$selectMultiple.removeChoice($index)" tabindex="-1"></a></li></span>'),a.put("select2/match.tpl.html",'<a class="select2-choice ui-select-match" ng-class="{\'select2-default\': $select.isEmpty()}" ng-click="$select.toggle($event)" aria-label="{{ $select.baseTitle }} select"><span ng-show="$select.isEmpty()" class="select2-chosen">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty()" class="select2-chosen" ng-transclude=""></span> <abbr ng-if="$select.allowClear && !$select.isEmpty()" class="select2-search-choice-close" ng-click="$select.clear($event)"></abbr> <span class="select2-arrow ui-select-toggle"><b></b></span></a>'),a.put("select2/no-choice.tpl.html",'<div class="ui-select-no-choice dropdown" ng-show="$select.items.length == 0"><div class="dropdown-content"><div data-selectable="" ng-transclude=""></div></div></div>'),a.put("select2/select-multiple.tpl.html",'<div class="ui-select-container ui-select-multiple select2 select2-container select2-container-multi" ng-class="{\'select2-container-active select2-dropdown-open open\': $select.open, \'select2-container-disabled\': $select.disabled}"><ul class="select2-choices"><span class="ui-select-match"></span><li class="select2-search-field"><input type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="combobox" aria-expanded="true" aria-owns="ui-select-choices-{{ $select.generatedId }}" aria-label="{{ $select.baseTitle }}" aria-activedescendant="ui-select-choices-row-{{ $select.generatedId }}-{{ $select.activeIndex }}" class="select2-input ui-select-search" placeholder="{{$selectMultiple.getPlaceholder()}}" ng-disabled="$select.disabled" ng-hide="$select.disabled" ng-model="$select.search" ng-click="$select.activate()" style="width: 34px;" ondrop="return false;"></li></ul><div class="ui-select-dropdown select2-drop select2-with-searchbox select2-drop-active" ng-class="{\'select2-display-none\': !$select.open || $select.items.length === 0}"><div class="ui-select-choices"></div></div></div>'),a.put("select2/select.tpl.html",'<div class="ui-select-container select2 select2-container" ng-class="{\'select2-container-active select2-dropdown-open open\': $select.open, \'select2-container-disabled\': $select.disabled, \'select2-container-active\': $select.focus, \'select2-allowclear\': $select.allowClear && !$select.isEmpty()}"><div class="ui-select-match"></div><div class="ui-select-dropdown select2-drop select2-with-searchbox select2-drop-active" ng-class="{\'select2-display-none\': !$select.open}"><div class="search-container" ng-class="{\'ui-select-search-hidden\':!$select.searchEnabled, \'select2-search\':$select.searchEnabled}"><input type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-class="{\'select2-active\': $select.refreshing}" role="combobox" aria-expanded="true" aria-owns="ui-select-choices-{{ $select.generatedId }}" aria-label="{{ $select.baseTitle }}" class="ui-select-search select2-input" ng-model="$select.search"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div></div>'),a.put("selectize/choices.tpl.html",'<div ng-show="$select.open" class="ui-select-choices ui-select-dropdown selectize-dropdown" ng-class="{\'single\': !$select.multiple, \'multi\': $select.multiple}"><div class="ui-select-choices-content selectize-dropdown-content"><div class="ui-select-choices-group optgroup"><div ng-show="$select.isGrouped" class="ui-select-choices-group-label optgroup-header" ng-bind="$group.name"></div><div role="option" class="ui-select-choices-row" ng-class="{active: $select.isActive(this), disabled: $select.isDisabled(this)}"><div class="option ui-select-choices-row-inner" data-selectable=""></div></div></div></div></div>'),a.put("selectize/match-multiple.tpl.html",'<div class="ui-select-match" data-value="" ng-repeat="$item in $select.selected track by $index" ng-click="$selectMultiple.activeMatchIndex = $index;" ng-class="{\'active\':$selectMultiple.activeMatchIndex === $index}" ui-select-sort="$select.selected"><span class="ui-select-match-item" ng-class="{\'select-locked\':$select.isLocked(this, $index)}"><span uis-transclude-append=""></span> <span class="remove ui-select-match-close" ng-hide="$select.disabled" ng-click="$selectMultiple.removeChoice($index)">&times;</span></span></div>'),a.put("selectize/match.tpl.html",'<div ng-hide="$select.searchEnabled && ($select.open || $select.isEmpty())" class="ui-select-match"><span ng-show="!$select.searchEnabled && ($select.isEmpty() || $select.open)" class="ui-select-placeholder text-muted">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty() || $select.open" ng-transclude=""></span></div>'),a.put("selectize/no-choice.tpl.html",'<div class="ui-select-no-choice selectize-dropdown" ng-show="$select.items.length == 0"><div class="selectize-dropdown-content"><div data-selectable="" ng-transclude=""></div></div></div>'),a.put("selectize/select-multiple.tpl.html",'<div class="ui-select-container selectize-control multi plugin-remove_button" ng-class="{\'open\': $select.open}"><div class="selectize-input" ng-class="{\'focus\': $select.open, \'disabled\': $select.disabled, \'selectize-focus\' : $select.focus}" ng-click="$select.open && !$select.searchEnabled ? $select.toggle($event) : $select.activate()"><div class="ui-select-match"></div><input type="search" autocomplete="off" tabindex="-1" class="ui-select-search" ng-class="{\'ui-select-search-hidden\':!$select.searchEnabled}" placeholder="{{$selectMultiple.getPlaceholder()}}" ng-model="$select.search" ng-disabled="$select.disabled" aria-expanded="{{$select.open}}" aria-label="{{ $select.baseTitle }}" ondrop="return false;"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>'),a.put("selectize/select.tpl.html",'<div class="ui-select-container selectize-control single" ng-class="{\'open\': $select.open}"><div class="selectize-input" ng-class="{\'focus\': $select.open, \'disabled\': $select.disabled, \'selectize-focus\' : $select.focus}" ng-click="$select.open && !$select.searchEnabled ? $select.toggle($event) : $select.activate()"><div class="ui-select-match"></div><input type="search" autocomplete="off" tabindex="-1" class="ui-select-search ui-select-toggle" ng-class="{\'ui-select-search-hidden\':!$select.searchEnabled}" ng-click="$select.toggle($event)" placeholder="{{$select.placeholder}}" ng-model="$select.search" ng-hide="!$select.isEmpty() && !$select.open" ng-disabled="$select.disabled" aria-label="{{ $select.baseTitle }}"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>')}]),app.directive("customSelect2",["$timeout","$filter",function(a,b){return{restrict:"E",require:"ngModel",templateUrl:"app/shared/templates/customSelect2.html?nd="+Date.now(),scope:{ngModel:"=",ngDatasource:"=",ngDisabled:"=",selectedrow:"&",eventKeydownEnter:"&"},link:function(a,c,d,e){function f(b){$("#"+a.idControl).attr("aaID",null===b||void 0===b?null:b.ID),$("#"+a.idControl).attr("aaCode",null===b||void 0===b?null:b.Code),$("#"+a.idControl).attr("aaName",null===b||void 0===b?null:b.Name),$("#"+a.idControl).attr("aaField3",null===b||void 0===b?null:b.Field3),$("#"+a.idControl).attr("aaField4",null===b||void 0===b?null:b.Field4),$("#"+a.idControl).attr("aaField5",null===b||void 0===b?null:b.Field5)}a.idControl=c[0].id,a.ObjectSelected={},a.disable=a.ngDisabled,a.dataSource=a.ngDatasource,a.displayText=d.placeholder,a.style=d.style,a.currentElement=50,a.loadMore=function(){a.currentElement=a.currentElement+50},a.$watch("ngDatasource",function(c,d){if(c!=d&&(a.dataSource=a.ngDatasource,0!==a.ngModel&&void 0!==a.ngModel)){var e=b("filter")(a.dataSource,{ID:a.ngModel},!0)[0];a.ObjectSelected.selected=e,f(e)}},!0),a.$watch("ngModel",function(c,d){if(c!=d&&void 0!==a.dataSource&&null!==a.dataSource){e.$setViewValue(c);var g=b("filter")(a.dataSource,{ID:c},!0)[0];a.ObjectSelected.selected=g,f(g)}},!0),a.setClickedRow=function(b){a.selectedrow({rowItem:b}),e.$setViewValue(b.ID),f(b)},a.resetValue=function(){a.ObjectSelected.selected=void 0,e.$setViewValue(0),f(null)},a.onSelectCallback=function(b,c){a.selectedrow({rowItem:b}),e.$setViewValue(b.ID),f(b)},a.$watch("ngDisabled",function(a,b){},!0)}}}]),app.factory("FinacialKetQuaKinhDoanhService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/FinacialReport/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("FinacialKetQuaKinhDoanhCtrl",["$scope","$uibModal","$translate","$filter","$timeout","AppDialog","FinacialKetQuaKinhDoanhService",function(a,b,c,d,e,f,g){function h(){var b=new Date,d=b.getDate(),e=b.getMonth(),f=b.getFullYear();a.FromDate=new Date(Date.UTC(f,e,1,0,0,0)),a.ToDate=new Date(Date.UTC(f,e,d,0,0,0)),g.showloading(),g.Post("Init_KetQuaKinhDoanh",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.branchList=b.data.Data,i(),a.ListBranch=g.BranchId},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"Finacial_BC_KetQuaKinhDoanh"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.TotalRow=null,a.branchList=null,a.btnSearch=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,ListBranch:a.ListBranch};g.Post("BaoCao_KetQuaKinhDoanh",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,ListBranch:a.ListBranch},d="BaoCaoKetQuaKinhDoanh.xlsx";g.ExportExcel("BaoCao_KetQuaKinhDoanh_Export",b,g.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},h(),j()}]),app.factory("PaymentsService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Payments/",e}]),app.controller("PaymentsCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","PaymentsService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("GetCodeNameDataMasterList",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.PaymentTypeList=b.data.Data,a.BankAccountList=b.data.Data2,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Payments"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.PaymentTypeList=null,a.BankAccountList=null,a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"DocumentNo",display:"InvStockIn_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockIn_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"PaymentTypeName",display:"Loại",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Bank_AccountName",display:"Ngân quỹ",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"NguoiNhan",display:"Người nhận",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"TotalAmount",display:"InvStockIn_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockIn_Label_Note",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,PaymentType:a.PaymentType,Bank_AccountId:a.Bank_AccountId,BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("search",b,g.url).then(function(b){a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Finacial/Payments/PaymentsDetail.html",ctrl:"PaymentsDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){""!==b.ID&&a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){if(""!==a.ID){(null===b||void 0===b)&&(b=0);var c={CompanyId:g.CompanyId,BranchId:g.BranchId,Value01:a.ID};g.showloading(),g.Post("InPhieuChiTien",c,g.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?f.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU CHI TIEN","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),f.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){g.closeloading()})}},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})})},h(),j()}]),app.controller("PaymentsDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","PaymentsService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d){a.ControlStatus={PaymentType:b,Bank_AccountId:c,PostingDate:d}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.PaymentTypeList=b.data.Data,a.BankAccountList=b.data.Data2,a.CustomerList=b.data.Data3,a.SupplierList=b.data.Data4,a.CostList=b.data.Data5;var c=e("filter")(a.BankAccountList,{Code:"TM"},!0);parseInt(c.length)>0&&(a.detail.Bank_AccountId=c[0].ID),a.detail.PaymentType=0===a.detail.PaymentType?205:a.detail.PaymentType},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.Bank_AccountId||void 0===a.detail.Bank_AccountId)&&(g+="Vui lòng nhập Ngân quỹ chi<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#Bank_AccountId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,d=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0];(null==d||void 0==d)&&(c=!1,i.ShowMessageDialog("Vui lòng nhập dữ liệu chi tiết trên lưới.<br/>"));for(var g=e("filter")(a.detail.listDetail,{Canceled:0},!0),h=0;h<=g.length-1;h++){if(0===g[h].PaymentAmount){c=!1,i.ShowMessageDialog("Vui lòng nhập Tiền thanh toán chi tiết.<br/>");break}if(202===a.detail.PaymentType&&parseFloat(g[h].PaymentAmount)>parseFloat(g[h].RemainAmount)){c=!1,i.ShowMessageDialog("Dòng ["+(h+1).toString()+"], Tiền thanh toán không được lớn hơn tiền còn lại.<br/>");break}}return b.resolve(c),b.promise}function o(){var b=window.innerHeight-50-20;$("#PaymentDetail").height(b);var c=$(".customergrid-table").parent().height();a.itemsPerPage=Math.floor((c-60)/35),a.itemsPerPage<9&&(a.itemsPerPage=9)}function p(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function q(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"Payments"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.PaymentTypeList=null,a.BankAccountList=null,a.CustomerList=null,a.SupplierList=null,a.CostList=null,a.TienPhanBo=0,a.SoTienFilter=0,a.BankAmountFilter=0,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={PaymentType:!0,Bank_AccountId:!0,PostingDate:!0},a.AccountIdFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.detail=g,null!==g.ID&&""!==g.ID?(j(!0,!0,!1,!0,!1),k(!1,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0)),a.PaymentType_Change=function(){a.detail.TotalAmount=0,a.detail.listDetail.splice(0,a.detail.listDetail.length),201===a.detail.PaymentType?(a.AccountIdFilterOptions.setValue=-1,a.AccountIdList=angular.copy(a.CustomerList)):202===a.detail.PaymentType&&(a.AccountIdFilterOptions.setValue=-1,a.AccountIdList=angular.copy(a.SupplierList))},a.btnAddRowGrid=function(){if(0===a.CostIdFilter||void 0===a.CostIdFilter)i.ShowMessageDialog("Vui lòng nhập mã phí");else if(a.SoTienFilter<=0)i.ShowMessageDialog("Vui lòng nhập số tiền"),$("#SoTienFilter").focus();else{var b=angular.copy(a.detail.CloneDetailObj);b.AccountId=a.CostIdFilter,b.PaymentAmount=a.SoTienFilter,b.AccountName=$("#CostIdFilter option:selected").text(),b.Note="",a.detail.listDetail.push(b),a.CostIdFilter=0,a.SoTienFilter=0,a.CalculateAmount()}},a.btnAddRowBankAccount=function(){if(0===a.Bank_AccountIdFilter||void 0===a.Bank_AccountIdFilter)i.ShowMessageDialog("Vui lòng nhập ngân quỹ thu.");else if(a.BankAmountFilter<=0)i.ShowMessageDialog("Vui lòng nhập số tiền."),$("#BankAmountFilter").focus();else if(a.Bank_AccountIdFilter===a.detail.Bank_AccountId)i.ShowMessageDialog("Vui lòng nhập Ngân quỹ thu khác với Ngân quỹ chi.");else{var b=angular.copy(a.detail.CloneDetailObj),c=e("filter")(a.detail.listDetail,{AccountId:a.Bank_AccountIdFilter},!0);0===c.length?(b.AccountId=a.Bank_AccountIdFilter,b.PaymentAmount=a.BankAmountFilter,b.AccountName=$("#Bank_AccountIdFilter option:selected").text(),b.Note="",a.detail.listDetail.push(b)):c[0].PaymentAmount=a.BankAmountFilter,a.Bank_AccountIdFilter=0,a.BankAmountFilter=0,a.CalculateAmount(null)}},a.btnGetAll_DocumentNo=function(){if(void 0===a.AccountIdFilter){var b="Vui lòng chọn "+(202===a.detail.PaymentType?"Nhà cung cấp":"Khách hàng");i.ShowMessageDialog(b)}else{var c={CompanyId:h.CompanyId,BranchId:h.BranchId,AccountId:a.AccountIdFilter,PaymentType:a.detail.PaymentType};h.Post("GetCongNoPhaiChiList",c,h.url).then(function(b){var c=b.data.Data;if(a.detail.listDetail.length=0,0===c.length)i.ShowMessageDialog("Không tìm thấy dữ liệu.");else for(var d=0;d<=c.length-1;d++){var e=angular.copy(a.detail.CloneDetailObj);e.AccountId=c[d].AccountId,e.InfoId_Ref=c[d].InfoId_Ref,e.DocumentNo_Ref=c[d].DocumentNo_Ref,e.TotalAmount=c[d].TotalAmount,e.RemainAmount=c[d].RemainAmount,e.PaymentAmount=c[d].PaymentAmount,e.AccountName=c[d].AccountName,a.detail.listDetail.push(e),(null===a.detail.NguoiNhan||void 0===a.detail.NguoiNhan)&&(a.detail.NguoiNhan=c[d].AccountName),(null===a.detail.DiaChi||void 0===a.detail.DiaChi)&&(a.detail.DiaChi=c[d].Address)}},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}},a.btnPhanBoTien_Click=function(){var b=e("filter")(a.detail.listDetail,{Canceled:0},!0);if(0===b.length)result=!1,i.ShowMessageDialog("Vui lòng nhập dữ liệu chi tiết trên lưới.<br/>");else if(a.TienPhanBo<=0)i.ShowMessageDialog("Vui lòng nhập số tiền phân bổ.<br/>"),$("#TienPhanBo").focus();else{for(var c=a.TienPhanBo,d=0;d<=a.detail.listDetail.length-1;d++)c>=a.detail.listDetail[d].RemainAmount&&c>0?(a.detail.listDetail[d].PaymentAmount=a.detail.listDetail[d].RemainAmount,c-=a.detail.listDetail[d].RemainAmount):c>0?(a.detail.listDetail[d].PaymentAmount=c,c=0):0===c&&(a.detail.listDetail[d].PaymentAmount=0);a.CalculateAmount(null)}},a.SoTienFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.TienPhanBo_Keydown=function(b){13==b.which&&a.btnPhanBoTien_Click()},a.BankAmountFilter_Keydown=function(b){13==b.which&&a.btnAddRowBankAccount()},a.btnAddnew=function(c){k(!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.PayerName="",a.detail.TotalAmount=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus();
},50)},a.btnSave=function(){var b=m();b.$$state.value===!0&&(b=n());for(var c=e("filter")(a.detail.listDetail,{Canceled:0},!0),d=0;d<=c.length-1;d++)if(a.detail.listDetail[d].AccountId===a.detail.Bank_AccountId)return void i.ShowMessageDialog("Dòng ["+(d+1).toString()+"], vui lòng nhập Ngân quỹ thu khác với Ngân quỹ chi.");b.$$state.value===!0&&(a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnRemoveRow=function(b){b.Canceled=1,a.CalculateAmount()},a.CalculateAmount=function(){a.detail.TotalAmount=0;for(var b=e("filter")(a.detail.listDetail,{Canceled:0},!0),c=0;c<=b.length-1;c++){var d=b[c];0===d.Canceled&&(a.detail.TotalAmount+=parseFloat(d.PaymentAmount))}},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1),k(!1,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID};h.showloading(),h.Post("InPhieuChiTien",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU CHI TIEN","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},l(),b(function(){o()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=9,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){p()}),b(function(){q()},50)}]),app.factory("ReceiptsService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Receipts/",e}]),app.controller("ReceiptsCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","ReceiptsService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("GetCodeNameDataMasterList",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.ReceiptTypeList=b.data.Data,a.BankAccountList=b.data.Data2,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Receipts"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.ReceiptTypeList=null,a.BankAccountList=null,a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"DocumentNo",display:"InvStockIn_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockIn_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"ReceiptTypeName",display:"Loại",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Bank_AccountName",display:"Ngân quỹ",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PayerName",display:"Người nộp tiền",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"TotalAmount",display:"InvStockIn_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockIn_Label_Note",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,Bank_AccountId:a.Bank_AccountId,ReceiptType:a.ReceiptType,BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("search",b,g.url).then(function(b){a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Finacial/Receipts/ReceiptsDetail.html",ctrl:"ReceiptsDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){if(""!==a.ID){(null===b||void 0===b)&&(b=0);var c={CompanyId:g.CompanyId,BranchId:g.BranchId,Value01:a.ID};g.showloading(),g.Post("InPhieuThuTien",c,g.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?f.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU THU TIEN","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),f.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){g.closeloading()})}},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})})},h(),j()}]),app.controller("ReceiptsDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","ReceiptsService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d){a.ControlStatus={ReceiptType:b,Bank_AccountId:c,PostingDate:d}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.ReceiptTypeList=b.data.Data,a.BankAccountList=b.data.Data2,a.CustomerList=b.data.Data3,a.SupplierList=b.data.Data4,a.CostList=b.data.Data5,a.detail.ReceiptType=0===a.detail.ReceiptType?101:a.detail.ReceiptType,a.AccountIdList=angular.copy(a.CustomerList);var c=e("filter")(a.BankAccountList,{Code:"TM"},!0);parseInt(c.length)>0&&0===a.detail.Bank_AccountId&&(a.detail.Bank_AccountId=c[0].ID)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.Bank_AccountId||void 0===a.detail.Bank_AccountId)&&(g+="Vui lòng nhập Loại ngân quỹ<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#Bank_AccountId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,d=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0];(null==d||void 0==d)&&(c=!1,i.ShowMessageDialog("Vui lòng nhập dữ liệu chi tiết trên lưới.<br/>"));for(var g=e("filter")(a.detail.listDetail,{Canceled:0},!0),h=0;h<=g.length-1;h++){if(0===g[h].PaymentAmount){c=!1,i.ShowMessageDialog("Vui lòng nhập Tiền thanh toán chi tiết.<br/>");break}if(101===a.detail.ReceiptType&&parseFloat(g[h].PaymentAmount)>parseFloat(g[h].RemainAmount)){c=!1,i.ShowMessageDialog("Dòng ["+(h+1).toString()+"], Tiền thanh toán không được lớn hơn tiền còn lại.<br/>");break}}return b.resolve(c),b.promise}function o(){var b=window.innerHeight-50-20;$("#ReceiptDetail").height(b);var c=$(".customergrid-table").parent().height();a.itemsPerPage=Math.floor((c-60)/35),a.itemsPerPage<9&&(a.itemsPerPage=9)}function p(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function q(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"Receipts"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.ReceiptTypeList=null,a.BankAccountList=null,a.CustomerList=null,a.SupplierList=null,a.CostList=null,a.TienPhanBo=0,a.SoTienFilter=0,a.BankAmountFilter=0,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={ReceiptType:!0,Bank_AccountId:!0,PostingDate:!0},a.AccountIdFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.detail=g,null!==g.ID&&""!==g.ID?(j(!0,!0,!1,!0,!1),k(!1,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0)),a.ReceiptType_Change=function(){a.detail.TotalAmount=0,a.detail.listDetail.splice(0,a.detail.listDetail.length),101===a.detail.ReceiptType?(a.AccountIdFilterOptions.setValue=-1,a.AccountIdList=angular.copy(a.CustomerList)):102===a.detail.ReceiptType&&(a.AccountIdFilterOptions.setValue=-1,a.AccountIdList=angular.copy(a.SupplierList))},a.btnAddRowGrid=function(){if(0===a.CostIdFilter||void 0===a.CostIdFilter)i.ShowMessageDialog("Vui lòng nhập mã phí");else if(a.SoTienFilter<=0)i.ShowMessageDialog("Vui lòng nhập số tiền"),$("#SoTienFilter").focus();else{var b=angular.copy(a.detail.CloneDetailObj),c=e("filter")(a.detail.listDetail,{AccountId:a.CostIdFilter},!0);0===c.length?(b.AccountId=a.CostIdFilter,b.PaymentAmount=a.SoTienFilter,b.AccountName=$("#CostIdFilter option:selected").text(),b.Note="",a.detail.listDetail.push(b)):c[0].PaymentAmount=a.SoTienFilter,a.CostIdFilter=0,a.SoTienFilter=0,a.CalculateAmount(null)}},a.btnAddRowBankAccount=function(){if(0===a.Bank_AccountIdFilter||void 0===a.Bank_AccountIdFilter)i.ShowMessageDialog("Vui lòng nhập ngân quỹ chi.");else if(a.BankAmountFilter<=0)i.ShowMessageDialog("Vui lòng nhập số tiền."),$("#BankAmountFilter").focus();else if(a.Bank_AccountIdFilter===a.detail.Bank_AccountId)i.ShowMessageDialog("Vui lòng nhập Ngân quỹ chi khác với Ngân quỹ thu.");else{var b=angular.copy(a.detail.CloneDetailObj),c=e("filter")(a.detail.listDetail,{AccountId:a.Bank_AccountIdFilter},!0);0===c.length?(b.AccountId=a.Bank_AccountIdFilter,b.PaymentAmount=a.BankAmountFilter,b.AccountName=$("#Bank_AccountIdFilter option:selected").text(),b.Note="",a.detail.listDetail.push(b)):c[0].PaymentAmount=a.BankAmountFilter,a.Bank_AccountIdFilter=0,a.BankAmountFilter=0,a.CalculateAmount(null)}},a.btnGetAll_DocumentNo=function(){if(void 0===a.AccountIdFilter){var b="Vui lòng nhập "+(101===a.detail.ReceiptType?"Khách hàng":"Nhà cung cấp");i.ShowMessageDialog(b)}else{var c={CompanyId:h.CompanyId,BranchId:h.BranchId,AccountId:a.AccountIdFilter,ReceiptType:a.detail.ReceiptType};h.Post("GetCongNoPhaiThuList",c,h.url).then(function(b){var c=b.data.Data;if(a.detail.listDetail.length=0,0===c.length)i.ShowMessageDialog("Không tìm thấy dữ liệu.");else for(var d=0;d<=c.length-1;d++){var e=angular.copy(a.detail.CloneDetailObj);e.AccountId=c[d].AccountId,e.InfoId_Ref=c[d].InfoId_Ref,e.DocumentNo_Ref=c[d].DocumentNo_Ref,e.TotalAmount=c[d].TotalAmount,e.RemainAmount=c[d].RemainAmount,e.PaymentAmount=c[d].PaymentAmount,e.AccountName=c[d].AccountName,a.detail.listDetail.push(e),(null===a.detail.PayerName||void 0===a.detail.PayerName)&&(a.detail.PayerName=c[d].AccountName),(null===a.detail.DiaChi||void 0===a.detail.DiaChi)&&(a.detail.DiaChi=c[d].Address)}},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}},a.btnPhanBoTien_Click=function(){var b=e("filter")(a.detail.listDetail,{Canceled:0},!0);if(0===b.length)result=!1,i.ShowMessageDialog("Vui lòng nhập dữ liệu chi tiết trên lưới.<br/>");else if(a.TienPhanBo<=0)i.ShowMessageDialog("Vui lòng nhập số tiền phân bổ.<br/>"),$("#TienPhanBo").focus();else{for(var c=a.TienPhanBo,d=0;d<=a.detail.listDetail.length-1;d++)c>=a.detail.listDetail[d].RemainAmount&&c>0?(a.detail.listDetail[d].PaymentAmount=a.detail.listDetail[d].RemainAmount,c-=a.detail.listDetail[d].RemainAmount):c>0?(a.detail.listDetail[d].PaymentAmount=c,c=0):0===c&&(a.detail.listDetail[d].PaymentAmount=0);a.CalculateAmount(null)}},a.SoTienFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.TienPhanBo_Keydown=function(b){13==b.which&&a.btnPhanBoTien_Click()},a.BankAmountFilter_Keydown=function(b){13==b.which&&a.btnAddRowBankAccount()},a.btnAddnew=function(c){k(!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.ReceiverName="",a.detail.TotalAmount=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();b.$$state.value===!0&&(b=n());for(var c=e("filter")(a.detail.listDetail,{Canceled:0},!0),d=0;d<=c.length-1;d++)if(a.detail.listDetail[d].AccountId===a.detail.Bank_AccountId)return void i.ShowMessageDialog("Dòng ["+(d+1).toString()+"], vui lòng nhập Ngân quỹ chi khác với Ngân quỹ thu.");b.$$state.value===!0&&(a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnRemoveRow=function(b){b.Canceled=1,a.CalculateAmount()},a.CalculateAmount=function(){a.detail.TotalAmount=0;for(var b=e("filter")(a.detail.listDetail,{Canceled:0},!0),c=0;c<=b.length-1;c++){var d=b[c];0===d.Canceled&&(a.detail.TotalAmount+=parseFloat(d.PaymentAmount))}},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1),k(!1,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID};h.showloading(),h.Post("InPhieuThuTien",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU THU TIEN","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},l(),b(function(){o()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=9,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){p()}),b(function(){q()},50)}]),app.factory("FinacialSoQuyTienService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/FinacialReport/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("FinacialSoQuyTienCtrl",["$scope","$uibModal","$translate","$filter","$timeout","AppDialog","FinacialSoQuyTienService",function(a,b,c,d,e,f,g){function h(){var b=new Date,d=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,d,1),a.ToDate=new Date,g.showloading(),g.Post("Init_Finacial_SoQuyTien",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.BankAccountList=b.data.Data,i()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"Finacial_BC_SoQuyTien"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.BankAccountList=null,a.TotalRow=null,a.TongDauKy=0,a.TongThu=0,a.TongChi=0,a.TongCuoiKy=0,a.btnSearch=function(){a.TongDauKy=0,a.TongThu=0,a.TongChi=0,a.TongCuoiKy=0,g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,Bank_AccountId:a.Bank_AccountId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("Finacial_BaoCao_SoQuyTien",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId},d="BaoCaoSoQuyTien.xlsx";g.ExportExcel("Inv_BC_NhapXuatTonExport",b,g.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.Bank_AccountId=0,$("#FromDate").focus()},a.btnViewDetail_Click=function(b){b.TuNgay=a.FromDate,b.DenNgay=a.ToDate,f.ShowDetailFormDialog({data:b,tempUrl:"app/components/Finacial/SoQuyTien/ChiTietSoQuy.html",ctrl:"ChiTietSoQuyCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},h(),j()}]),app.controller("ChiTietSoQuyCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","FinacialSoQuyTienService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.showloading(),h.Post("BaoCao_ChiTietSoQuy",g,h.url).then(function(b){if(0===b.data.Status.StatusCode){a.dataResult=JSON.parse(b.data.Data),a.TienDauKy=b.data.Data2;var c=0;l();for(var d=0;d<=a.dataResult.length-1;d++)a.TongThu=a.TongThu+a.dataResult[d].ThuTrongKy,a.TongChi=a.TongChi+a.dataResult[d].ChiTrongKy,c=c+a.dataResult[d].ThuTrongKy-a.dataResult[d].ChiTrongKy,a.dataResult[d].TienCuoiKy=c}else i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}function k(){var a=window.innerHeight-50-20;$("#ChiTietSoQuy").height(a);var b=a-40-40-20;$(".customergrid-table").height(b)}function l(){null!=a.dataResult&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.TienDauKy=0,a.dataResult=null,a.TongThu=0,a.TongChi=0,a.btnExport_Click=function(){h.showloading(),g.CompanyId=h.CompanyId,g.BranchId=h.BranchId;var a="BaoCao_ChiTietSoQuy.xlsx";h.ExportExcel("BaoCao_ChiTietSoQuy_Export",g,h.url,a).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){l()}),a.btnCancel=function(){c.close(0)},b(function(){k(),j()},50)}]),app.factory("FinacialTongHopChiPhiService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/FinacialReport/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("FinacialTongHopChiPhiCtrl",["$scope","$uibModal","$translate","$filter","$timeout","AppDialog","FinacialTongHopChiPhiService",function(a,b,c,d,e,f,g){function h(){var b=new Date,d=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,d,1),a.ToDate=new Date,g.showloading(),g.Post("Init_TongHopChiPhi",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.branchList=b.data.Data,a.costList=b.data.Data2,a.ReportType=0,i(),a.ListBranch=g.BranchId},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"Finacial_BC_TongHopChiPhi"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.branchList=null,a.costList=null,a.TotalRow=null,a.btnSearch=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,ReportType:a.ReportType,ListBranch:a.ListBranch,isGetCKH:a.isGetCKH,CostId:a.CostId};g.Post("BaoCao_TongHopChiPhi",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,ReportType:a.ReportType,ListBranch:a.ListBranch,isGetCKH:a.isGetCKH,CostId:a.CostId},d="BaoCao_TongHopChiPhi.xlsx";g.ExportExcel("BaoCao_TongHopChiPhi_Export",b,g.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,$("#FromDate").focus()},h(),a.radLoaiBaoCao_Check=function(b){a.ReportType=b},j()}]),app.factory("CongNoNhaCungCapService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("CongNoNhaCungCapCtrl",["$scope","$uibModal","$translate","$filter","$timeout","AppDialog","CongNoNhaCungCapService",function(a,b,c,d,e,f,g){function h(){var b=new Date,d=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,d,1),a.ToDate=new Date,g.showloading(),g.Post("Init_BaoCaoCongNoNhaCungCap",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.SupplierList=b.data.Data,i()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"BaoCaoCongNoNhaCungCap"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.SupplierList=null,a.TotalRow=null,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,SupplierId:a.SupplierId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BaoCaoCongNoNhaCungCap",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.CustomerOptions.setValue=0,$("#FromDate").focus()},a.btnViewDetail_Click=function(a){f.ShowDetailFormDialog({data:a,tempUrl:"app/components/Inventory/CongNoNhaCungCap/CongNoNhaCungCapDetail.html",ctrl:"CongNoNhaCungCapDetailCtrl",cssclass:"Modal-width700",focuscontrolid:""}).then(function(a){})},h(),j()}]),app.controller("CongNoNhaCungCapDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","CongNoNhaCungCapService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){g.CompanyId=h.CompanyId,g.BranchId=h.BranchId,h.Post("CongNoNhaCungCapDetail",g,h.url).then(function(b){0===b.data.Status.StatusCode?(a.dataResult=JSON.parse(b.data.Data),a.TienDauKy=b.data.Data3,a.TotalRow=b.data.Data2):i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function k(){var a=window.innerHeight-50-20;$("#CongNoNhaCungCapDetail").height(a);var b=a-40-40-20;$(".customergrid-table").height(b)}a.TienDauKy=0,a.dataResult=null,a.TotalRow=null,a.detail=g,a.btnExport_Click=function(){h.showloading(),g.CompanyId=h.CompanyId,g.BranchId=h.BranchId;var a="ChiTiet_CongNoPhaiTraNhaCungCap.xlsx";h.ExportExcel("CongNoNhaCungCapDetail_Export",g,h.url,a).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(0)},b(function(){k(),j()},50)}]),app.factory("InvBaoCaoGiaVonThanhPhamService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("InvBaoCaoGiaVonThanhPhamCtrl",["$scope","$uibModal","$filter","$timeout","$translate","AppDialog","InvBaoCaoGiaVonThanhPhamService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitInv_BC_GiaVonThanhPham",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.ItemCategoryList=b.data.Data2,a.Year=(new Date).getFullYear(),a.Month=(new Date).getMonth()+1,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"Inv_BC_GiaVonThanhPham"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.ItemOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId,ItemId:a.ItemId,FromYear:a.Year,FromMonth:a.Month,ItemCategoryId:a.ItemCategoryId};g.Post("Inv_BC_GiaVonThanhPham",b,g.url).then(function(b){a.searhResultList=JSON.parse(b.data.Data),j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.ItemId=0},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=15,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("InvBCNhapMuaNCCService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("InvBCNhapMuaNCCCtrl",["$scope","$uibModal","$filter","$timeout","$translate","AppDialog","InvBCNhapMuaNCCService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,g.showloading(),g.Post("InitInv_BC_HangNhapMuaNCC",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.SupplierList=b.data.Data,a.ItemList=b.data.Data2,a.ItemCategoryList=b.data.Data3,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"Inv_BC_HangNhapMuaNCC"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.SupplierList=null,a.ItemCategoryList=null,a.ItemList=null,a.TotalRow=null,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName,SupplierId:a.SupplierId};g.Post("Inv_BC_HangNhapMuaNCC",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName,SupplierId:a.SupplierId},c="BC_HangNhapMuaNCC.xlsx";g.ExportExcel("Inv_BC_HangNhapMuaNCC_Export",b,g.url,c).then(function(a){},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.ItemId=0,a.LocationId=0,$("#FromDate").focus()},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("InvBaoCaoNhapXuatTonService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("InvBaoCaoNhapXuatTonCtrl",["$scope","$uibModal","$translate","$filter","$timeout","AppDialog","InvBaoCaoNhapXuatTonService",function(a,b,c,d,e,f,g){function h(){
var b=new Date,d=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,d,1),a.ToDate=new Date,g.showloading(),g.Post("InitInv_BC_NhapXuatTon",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.LocationList=b.data.Data2,a.ItemUnitConvertList=b.data.Data3,a.ItemCategoryList=b.data.Data4,i()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"Inv_BC_NhapXuatTon"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.ItemList=null,a.LocationList=null,a.TotalRow=null,a.ItemUnitConvertList=null,a.ItemCategoryList=null,a.ItemOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName};g.Post("Inv_BC_NhapXuatTon",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName},d="BaoCaoNhapXuatTon.xlsx";g.ExportExcel("Inv_BC_NhapXuatTonExport",b,g.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.ItemId=0,a.LocationId=0,$("#FromDate").focus()},a.btnViewTheKho_Click=function(b){var c={SLDK:b.SLDK,FromDate:a.FromDate,ToDate:a.ToDate,ItemId:b.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId};f.ShowDetailFormDialog({data:c,tempUrl:"app/components/Inventory/InvBaoCaoNhapXuatTon/InvBaoCaoTheKhoDetail.html",ctrl:"BaoCaoTheKhoCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},a.btnDisplayUnitConvert_Click=function(b,c){a.DescriptionUnitConvert="";var e=b.TenHang+": "+Math.abs(c)+" "+b.DVT+" => ",f=Math.abs(c),g=d("filter")(a.ItemUnitConvertList,{ItemId:b.ItemId},!0);if(g.length>0){for(var h=0;h<=g.length-1;h++)g[h].Qty=Math.floor(f/g[h].HeSoQuyDoi),f-=g[h].Qty*g[h].HeSoQuyDoi,e+=g[h].Qty+" "+g[h].UnitName+", ";e+=f+" "+b.DVT,showUnitConvert(e)}},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.controller("BaoCaoTheKhoCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvBaoCaoNhapXuatTonService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.Post("Inv_BC_TheKho",g,h.url).then(function(b){0===b.data.Status.StatusCode?(a.dataResult=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,l()):i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function k(){var a=window.innerHeight-50-20;$("#BaoCaoTheKho").height(a);var b=a-40-40-40;$(".customergrid-table").height(b)}function l(){null!=a.dataResult&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.dataResult=null,a.TotalRow=null,g.CompanyId=h.CompanyId,g.BranchId=h.BranchId,a.SLDK=g.SLDK,a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=50,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){l()}),a.btnCancel=function(){c.close(0)},b(function(){k(),j()},50)}]),app.factory("InvBaoCaoTonKhoService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e.urlStockIn=e.Url+"api/InvStockIn/",e.urlStockOut=e.Url+"api/InvStockOut/",e}]),app.controller("InvBaoCaoTonKhoCtrl",["$scope","$uibModal","$filter","$timeout","$translate","AppDialog","InvBaoCaoTonKhoService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,g.showloading(),g.Post("InitInv_BC_TonKho",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.LocationList=b.data.Data2,a.ItemCategoryList=b.data.Data3,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"Inv_BC_TonKho"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.TotalRow=null,a.ItemCategoryList=null,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName};g.Post("Inv_BC_TonKho",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName},c="BaoCaoTonKho.xlsx";g.ExportExcel("Inv_BC_TonKhoExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.ItemId=0,a.LocationId=0,$("#FromDate").focus()},a.SLKiemKho_Change=function(a){a.SLChenhLech=a.SLKiemKho-a.SLTon},a.btnLapPhieuNhapKho_Click=function(){var b=c("filter")(a.searhResultList,function(a){return a.SLChenhLech>0&&1==a.KiemKe});if(null===b||0==b.length)return void f.ShowMessageDialog("Không có dữ liệu cần nhập kho.");var d={ID:"0",CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",d,g.urlStockIn).then(function(b){a.data=b.data.Data,console.log(a.data)}).then(function(){console.log(b),a.data.DocumentType=2;for(var c=0;c<=b.length-1;c++){var d=angular.copy(a.data.CloneDetailObj);d.ID=0,d.ItemId=b[c].ItemId,d.ItemCode=b[c].ItemCode,d.ItemName=b[c].ItemName,d.UomId=b[c].UomId,d.UnitName=b[c].UomName,d.LocationId=a.LocationId,d.UnitCost=0==parseFloat(b[c].SLTon)?0:b[c].TienTon/b[c].SLTon,d.Quantity=b[c].SLChenhLech,d.Amount=d.UnitCost*d.Quantity,d.Canceled=0,a.data.listDetail.push(d)}f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockIn/StockInDetail.html",ctrl:"StockInDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:"SupplierId"}).then(function(a){})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnLapPhieuXuatKho_Click=function(){var b=c("filter")(a.searhResultList,function(a){return a.SLChenhLech<0&&1==a.KiemKe});if(null===b||0==b.length)return void f.ShowMessageDialog("Không có dữ liệu cần xuất kho.");var d={ID:"0",CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",d,g.urlStockOut).then(function(b){a.data=b.data.Data}).then(function(){console.log(b),a.data.DocumentType=3;for(var c=0;c<=b.length-1;c++){var d=angular.copy(a.data.CloneDetailObj);d.ID=0,d.ItemId=b[c].ItemId,d.ItemCode=b[c].ItemCode,d.ItemName=b[c].ItemName,d.UomId=b[c].UomId,d.UnitName=b[c].UomName,d.LocationId=a.LocationId,d.UnitCost=0==parseFloat(b[c].SLTon)?0:b[c].TienTon/b[c].SLTon,d.Quantity=-1*b[c].SLChenhLech,d.Amount=d.UnitCost*d.Quantity,d.Canceled=0,a.data.listDetail.push(d)}f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockOut/StockOutDetail.html",ctrl:"StockOutDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:"CustomerId"}).then(function(a){})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("InvCanhBaoHangTonKhoService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("InvCanhBaoHangTonKhoCtrl",["$scope","$uibModal","$filter","$timeout","$translate","AppDialog","InvCanhBaoHangTonKhoService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,g.showloading(),g.Post("InitInv_BC_TonKho",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.LocationList=b.data.Data2,a.ItemCategoryList=b.data.Data3,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"Inv_BC_CanhBaoHangTonKho"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.TotalRow=null,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName};g.Post("Inv_BC_CanhBaoHangTonKho",b,g.url).then(function(b){a.searhResultList=JSON.parse(b.data.Data),j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemName:a.ItemName},c="CanhBaoHangTonKho.xlsx";g.ExportExcel("Inv_BC_CanhBaoHangTonKhoExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.ItemId=0,a.LocationId=0,$("#FromDate").focus()},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("InvTinhDinhLuongService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvDinhMuc/",e}]),app.controller("InvTinhDinhLuongCtrl",["$scope","$uibModal","$translate","$q","$filter","AppDialog","InvTinhDinhLuongService",function(a,b,c,d,e,f,g){function h(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"RawMaterial"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.Year=(new Date).getFullYear(),a.FromMonth=(new Date).getMonth()+1,a.ToMonth=(new Date).getMonth()+1;window.localStorage.serviceApi;a.LoaiPM=g.MaNganh,a.btnSave_Click=function(){var b={Year:a.Year,FromMonth:a.FromMonth,ToMonth:a.FromMonth,BranchId:g.BranchId,CompanyId:g.CompanyId};g.showloading(),g.Post("TinhGiaVon",b,g.url).then(function(a){0===a.data.Status.StatusCode?f.ShowMessageDialog("Đã thực hiện xong."):f.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnTinhDinhLuong_Click=function(){var b={FromDate:a.ToDate,ToDate:a.ToDate,BranchId:g.BranchId,CompanyId:g.CompanyId};g.showloading(),g.Post("TinhDinhLuong",b,g.url).then(function(a){0===a.data.Status.StatusCode?f.ShowMessageDialog("Đã thực hiện xong."):f.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h()}]),app.factory("InvKhaiBaoDinhMucService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvDinhMuc/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("InvKhaiBaoDinhMucCtrl",["$scope","$rootScope","$uibModal","$translate","$q","$filter","AppDialog","InvKhaiBaoDinhMucService",function(a,b,c,d,e,f,g,h){function i(){h.Post("InitDinhMuc",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.ThanhPhamList=b.data.Data,a.ItemFilterList=b.data.Data2,a.CloneDinhMucObj=b.data.Data3,a.Size_TraSuaList=b.data.Data4,a.KhoHangList=b.data.Data5,a.ThanhPhamListFilter=b.data.Data,k(),a.ThanhPhamList.length>0&&a.btnThanhPham_Click(a.ThanhPhamList[0],0)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function j(b,c){var e={CompanyId:h.CompanyId,BranchId:h.BranchId,ParentItemId:b,Size_TraSua:c};h.Post("GetDinhMucByThanhPham",e,h.url).then(function(b){a.DinhMucList=b.data.Data},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function k(){null!=a.ThanhPhamList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function l(){if("1"!==h.IsAdministrator){var b=f("filter")(h.Role,{ScreenCode:"BOM"},!0);if(b.length>0){var c=f("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=f("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===d?!0:!d.IsEnable)}else a.viewRole=!1}}a.ThanhPhamList=null,a.ThanhPhamListFilter=null,a.ItemFilterList=null,a.DinhMucList=null,a.Size_TraSuaList=null,a.KhoHangList=null,a.AddOn=h.AddOn,a.UnitName=null,a.CloneDinhMucObj=null,a.viewRole=!0,a.filterType=0;var m=null,n=null;a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!0,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"50",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.selectedRowThanhPham=0,a.selectedRowDinhMuc=0,a.ItemCodeDisplay="",a.ItemNameDisplay="",i(),a.btnThanhPham_Click=function(b,c){a.ItemCodeDisplay=b.ItemCode,a.ItemNameDisplay=b.ItemName,a.selectedRowThanhPham=c,m=b,j(b.ItemId,b.Size_TraSua)},a.btnDinhMuc_Click=function(b){a.selectedRowDinhMuc=b},a.ItemFilter_selectedrow=function(b){null!==b&&(a.UnitName=b.Field3,n=b)},a.btnRemoveRow=function(b){g.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(h.showloading(),h.Post("Delete",b,h.url).then(function(c){var d=c.data.Status;0==d.StatusCode?g.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){var c=a.DinhMucList.indexOf(b);a.DinhMucList.splice(c,1)}):(g.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))})},a.filterThanhPham_Click=function(b){0===b?(a.ThanhPhamListFilter=angular.copy(a.ThanhPhamList),a.ThanhPhamListFilter.length>0&&a.btnThanhPham_Click(a.ThanhPhamListFilter[0],0)):1===b?(a.ThanhPhamListFilter=a.ThanhPhamList.filter(function(a){return 0!==a.isBOM}),a.ThanhPhamListFilter.length>0&&a.btnThanhPham_Click(a.ThanhPhamListFilter[0],0)):2===b&&(a.ThanhPhamListFilter=f("filter")(a.ThanhPhamList,{isBOM:0},!0),a.ThanhPhamListFilter.length>0&&a.btnThanhPham_Click(a.ThanhPhamListFilter[0],0))},a.btnDetailBOM_Click=function(b){var c={Id:void 0===b?0:b.Id,CompanyId:h.CompanyId,BranchId:h.BranchId,MaThanhPham:m.ItemCode,TenThanhPham:m.ItemName,ParentItemId:m.ItemId};h.Post("GetDinhMucDetail",c,h.url).then(function(c){a.data=c.data.Data,a.data.Size_TraSua=m.Size_TraSua,a.dataid=void 0===b?0:b.Id}).then(function(){a.dataid>0&&0==a.data.ID?g.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):g.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvKhaoBaoDinhMuc/DetailBOM.html",ctrl:"DetailBOMCtrl",cssclass:"Modal-width550",focuscontrolid:""}).then(function(a){1==a&&j(m.ItemId,m.Size_TraSua)})},function(a){g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})},a.btnImportData=function(){g.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvKhaoBaoDinhMuc/ImportDinhLuong.html",ctrl:"ImportDinhLuongCtrl",cssclass:"Modal-width900",focuscontrolid:""}).then(function(a){1==a&&j(m.ItemId,m.Size_TraSua)})},a.btnExport_Click=function(){h.showloading();var a={CompanyId:h.CompanyId,BranchId:h.BranchId},b="DanhSachDinhLuong.xlsx";h.ExportExcel("ExportDinhLuong",a,h.url,b).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){k()}),l()}]),app.controller("DetailBOMCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","InvKhaiBaoDinhMucService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){g.showloading(),g.Post("InitDetailBOM",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.NguyenVatLieuList=b.data.Data,a.CloneDinhMucObj=b.data.Data2,a.Size_TraSuaList=b.data.Data3,a.KhoHangList=b.data.Data4,a.itemModels=b.data.Data5},function(a){console.log(a)})["finally"](function(){g.closeloading()})}function j(b){g.showloading();var c={CompanyId:g.CompanyId,BranchId:g.BranchId,MasterType:b};g.Post("reloadMasterPlus",c,g.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?h.ShowMessageDialog(b.data.Status.MessageId):"Item"===b.data.Status.ObjData&&(a.NguyenVatLieuList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.NguyenVatLieuList=null,a.CloneDinhMucObj=null,a.Size_TraSuaList=null,a.KhoHangList=null,a.itemModels=null,a.errQty=!1,a.errFromDate=!1,a.fsavesuccess=0,a.UnitList=null,a.AddOn=g.AddOn,a.disablecode=!1,a.detail=f,console.log(a.detail),f.Id>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(c===!0||1===c)null!==a.detail&&(a.detail.Id=0,a.detail.ItemId=0,a.detail.Quantity=0);else{var e={Id:0,CompanyId:g.CompanyId,BranchId:g.BranchId,MaThanhPham:f.ItemCode,TenThanhPham:f.ItemName,ParentItemId:f.ItemId};g.Post("GetDinhMucDetail",e,g.url).then(function(b){a.detail=b.data.Data,a.dataCopy=angular.copy(a.detail)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){a.errFromDate=!1,a.errQty=!1,a.submitted=!0,null!=a.detail&&(0==a.detail.LocationId&&(a.detail.LocationId=null,a.form.$valid=!1),0==a.detail.ItemId&&(a.detail.ItemId=null,a.form.$valid=!1),(void 0===a.detail.FromDate||null===a.detail.FromDate)&&(a.errFromDate=!0,a.form.$valid=!1),a.detail.Quantity<=0&&(a.detail.Quantity=0,a.form.$valid=!1,a.errQty=!0)),a.form.$valid&&(a.iserror=!1,g.showloading(),g.Post("Save",f,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(b):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),a.form.$setPristine()},a.btnNguyenVatLieuPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.itemModels),tempUrl:"app/components/Master/Item/ItemDetail.html",ctrl:"ItemDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&j("Item")})},i()}]),app.controller("ImportDinhLuongCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","InvKhaiBaoDinhMucService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.ListImport=null,a.AddOn=g.AddOn,a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var b=$("#file").get(0).files;if(0==b.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var d=new FormData;if(b.length>0)for(var e=0;e<b.length;e++)d.append("UploadedImage"+e,b[e]);g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:d,headers:{Authorization:"Bearer "+g.accessToken},success:function(b){g.closeloading(),0===b.Status.StatusCode?c(function(){a.ListImport=b.Data},50):h.ShowMessageDialog(b.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportDinhLuong.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnSave=function(){null==a.ListImport||a.ListImport.length<=0?h.ShowMessageDialog("Vui lòng nhập dữ liệu trước khi lưu."):(g.showloading(),g.Post("LuuImportDinhMuc",a.ListImport,g.url).then(function(a){0===a.data.Status.StatusCode?(h.ShowMessageDialog(a.data.Status.MessageId),d.close(1)):h.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){d.dismiss("cancel")}}]),app.factory("InvPhysicalService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvPhysical/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("InvPhysicalCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","InvPhysicalService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("GetCodeNameDataMasterList",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.StatusList=b.data.Data,a.LocationIdList=b.data.Data2,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"PhysicalInventory"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LocationIdList=null,a.StatusList=null,a.LoaiPM=g.MaNganh,a.gridOptions={data:[],id:"grid_InvPhysical",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!1,showpaging:!0,showTotalRow:!1,columnDefs:[{field:"StatusName",display:"Trạng thái",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DocumentNo",display:"InvStockIn_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockIn_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"LocationName",display:"Kho hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"InvStockIn_Label_Note",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UpdatedBy",display:"Cập nhật",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,StatusId:a.StatusId,BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("search",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={InfoId:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvPhysical/InvPhysicalDetail.html",ctrl:"InvPhysicalDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.Id)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},h(),j()}]),app.controller("InvPhysicalDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvPhysicalService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c){a.ControlStatus={LocationId:b,PostingDate:c}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.LocationList=b.data.Data},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("Vui lòng nhập tồn kho đến ngày")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("Vui lòng nhập kho kiểm kê")+"<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0];e("filter")(a.detail.listDetail,{Canceled:0},!0);return(null==g||void 0==g)&&(c=!1,i.ShowMessageDialog(d.instant("InvStockIn_GridDetail_Invalid")+"<br/>")),b.resolve(c),b.promise}function o(){var a=window.innerHeight-50-20;$("#StockInDetail").height(a);var b=($(".customergrid-table").parent().height(),window.innerWidth-window.innerWidth/20);1e3>b?b=1e3:b>1200&&(b=1200)}function p(){a.labelThamChieu="";var b="",c="";""!==a.detail.RefStockInvDocument&&null!==a.detail.RefStockInvDocument&&void 0!==a.detail.RefStockInvDocument&&(b=a.detail.RefStockInvDocument),""!==a.detail.RefStockOutDocument&&null!==a.detail.RefStockOutDocument&&void 0!==a.detail.RefStockOutDocument&&(c=a.detail.RefStockOutDocument),(""!==b||""!==c)&&(a.labelThamChieu="Tham chiếu "+b+", "+c)}function q(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function r(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"PhysicalInventory"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.labelThamChieu="";var s={NotUpdate:0,Insert:1,Update:2,Delete:3};a.LocationList=null,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={DocumentType:!0,SupplierId:!0,LocationId:!0,PostingDate:!0},a.detail=g,p(),parseFloat(g.Id)>0?(j(!0,!0,!1,!0,!1),k(!1,!1)):(j(!1,!0,!1,!0,!1),k(!0,!0)),a.btnSearchTonKho_Click=function(){if(a.detail.LocationId<=0)return void i.ShowMessageDialog("Vui lòng chọn kho cần kiểm kê.");h.showloading();var b={FromDate:a.detail.PostingDate,ToDate:a.detail.PostingDate,ItemId:0,LocationId:a.detail.LocationId,ItemCategoryId:0,CompanyId:h.CompanyId,BranchId:h.BranchId,ItemName:""};h.Post("Inv_BC_TonKho",b,h.Url+"api/InvReports/").then(function(b){a.listTonKho=JSON.parse(b.data.Data),console.log(a.listTonKho),a.detail.listDetail=[];for(var c=0;c<=a.listTonKho.length-1;c++)a.detail.listDetail.push({ItemId:a.listTonKho[c].ItemId,UnitId:a.listTonKho[c].UomId,SLTon:a.listTonKho[c].SLTon,TienTon:a.listTonKho[c].TienTon,SLKiemKe:a.listTonKho[c].SLTon,SLChenhLech:0,Note:"",StatusId:0,BranchId:h.BranchId,IsDeleted:0,ItemCode:a.listTonKho[c].ItemCode,ItemName:a.listTonKho[c].ItemName,UnitName:a.listTonKho[c].UomName,StatusName:"",Canceled:0,RowStatus:s.Insert});q()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.SLKiemKe_Change=function(a){a.SLChenhLech=a.SLKiemKe-a.SLTon,a.SLChenhLech<0?(a.StatusId=4,a.StatusName="Xuất kho"):0===a.SLChenhLech?(a.StatusId=0,a.StatusName=""):a.SLChenhLech>0&&(a.StatusId=3,a.StatusName="Nhập kho"),a.Id>0&&(a.RowStatus=s.Update)},a.btnAddnew=function(c){k(!0,!0),j(!1,!0,!1,!0,!1),a.detail.Id=0,a.detail.StatusId=1,a.labelThamChieu="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,
a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();b.$$state.value===!0&&(b=n()),b.$$state.value===!0&&(a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnEdit=function(){var b={InfoId:a.detail.Id,CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("detail",b,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1),k(!0,!0),a.detail.Id>0&&k(!1,!1)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnImportData_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvPhysical/ImportKiemKe.html",ctrl:"ImportKiemKeCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;b(function(){for(var b=0;b<=d.length-1;b++){var c=e("filter")(a.detail.listDetail,{ItemId:d[b].ItemId,UnitId:d[b].UnitId},!0)[0];null!==c&&void 0!==c&&(parseFloat(c.SLKiemKe)!==parseFloat(d[b].SLKiemKe)||c.Note!==d[b].Note)&&(c.SLKiemKe=d[b].SLKiemKe,c.Note=d[b].Note,a.SLKiemKe_Change(c))}},50)}})},l(),b(function(){o()},0),a.btnExport_Click=function(){if(0===a.detail.Id)return void i.ShowMessageDialog("Vui lòng lưu phiếu kiểm kê trước khi Export.");var b=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0];if(null==b||void 0==b)result=!1,i.ShowMessageDialog("Không có dữ liệu.");else{h.showloading();var c={CompanyId:h.CompanyId,BranchId:h.BranchId,InfoId:a.detail.Id},f="PhieuKiemKe.xlsx";h.ExportExcel("Export",c,h.url,f).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}},a.btnXuLy_Click=function(){if(0===a.detail.listDetail.length)return void i.ShowMessageDialog("Không có dữ liệu kiểm kê");if(0===a.detail.Id)return void i.ShowMessageDialog("Vui lòng lưu phiếu kiểm kê trước khi xử lý kiểm kê.");var b=e("filter")(a.detail.listDetail,{StatusId:0},!0);return b.length===a.detail.listDetail.length?void i.ShowMessageDialog("Không có dữ liệu thay đổi cần kiểm kê kiểm kê."):void i.ShowConfirmDialog("Bạn có chắc muốn xử lý kiểm kê?").then(function(b){0===parseInt(b)&&(h.showloading(),h.Post("ThucHienKiemKe",a.detail,h.url).then(function(b){0===b.data.Status.StatusCode&&(a.detail=b.data.Data,i.ShowMessageDialog("Đã thực hiện kiểm kê"),p())},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))})},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){q()}),b(function(){r()},50)}]),app.controller("ImportKiemKeCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","InvPhysicalService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.factory("InvStockInService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvStockIn/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("StockInCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","InvStockInService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("GetCodeNameDataMasterList",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.DocumentTypeList=b.data.Data,a.LocationIdList=b.data.Data2,a.ItemList=b.data.Data3,a.DocumentType=-2,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"StockIn"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LocationIdList=null,a.DocumentTypeList=null,a.ItemList=null,a.LoaiPM=g.MaNganh,a.LocationIdOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"DocumentNo",display:"InvStockIn_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockIn_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"DocumentTypeName",display:"Loại",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"SupplierName",display:"Nhà cung cấp",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"LocationName",display:"Kho hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"InvStockIn_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockIn_Label_Note",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UpdatedBy",display:"Cập nhật",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,DocumentType:a.DocumentType,BranchId:g.BranchId,CompanyId:g.CompanyId,ItemId:a.ItemId};g.Post("search",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockIn/StockInDetail.html",ctrl:"StockInDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){(null===b||void 0===b)&&(b=0),g.showloading(),g.Post("InPhieuNhapKho",a,g.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?f.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU NHAP KHO","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),f.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){g.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnShowFormInBarcode_Click=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):g.Post("GetListDataInBarcode",b,g.url).then(function(b){var c=b.data.Status;0===c.StatusCode&&(a.ListBarcode=b.data.Data,f.ShowDetailFormDialog({data:a.ListBarcode,tempUrl:"app/components/Master/GiaLePOS/InBarcode.html",ctrl:"InBarcodeCtrl",cssclass:"Modal-width900",focuscontrolid:""}).then(function(a){}))},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})},h(),j()}]),app.controller("StockInDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvStockInService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={DocumentType:b,SupplierId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data,a.ItemFilterList=b.data.Data2,a.LocationIdFilterList=b.data.Data3,a.SupplierList=b.data.Data4,a.LocationList=b.data.Data3,a.SupplierOptions.setValue=a.detail.SupplierId,(null===g.ID||""===g.ID)&&(a.detail.LocationId=a.LocationList.length>1?0:a.LocationList[0].ID),a.QtyFilter=1},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),8===a.detail.DocumentType&&((0===parseFloat(a.detail.SupplierId)||void 0===a.detail.SupplierId)&&(g+=d.instant("InvStockIn_Supplier_Invalid")+"<br/>",e=!1,c=-1==c?0:c),parseFloat(a.detail.Info_Amount)<parseFloat(a.detail.InAdvanced)&&(g+="Số tiền thanh toán không được lớn hơn tổng tiền.<br/>",e=!1,c=-1==c?0:c)),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);return null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockIn_GridDetail_Invalid")+"<br/>")):h.length>200&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng mỗi lần cập nhật không được nhiều hơn 100 dòng.")+"<br/>")),b.resolve(c),b.promise}function o(){var b=f.defer(),c="",e=-1,g=!0;switch((0===a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockIn_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(parseFloat(a.QtyFilter)<=0||void 0==a.QtyFilter)&&(c+=d.instant("InvStockIn_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?2:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 1:$("#LocationId").focus();break;case 2:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function p(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function q(b){var c=e("filter")(a.detail.listDetail,{ItemId:parseFloat(b.ID)},!0);if(0===c.length){var d=angular.copy(a.detail.CloneDetailObj);d.ID=0,d.ItemId=parseFloat(b.ID),d.ItemCode=b.Code,d.ItemName=b.Name,d.UomId=parseFloat(b.Field3),d.UnitName=b.Field4,d.LocationId=parseInt(a.detail.LocationId),d.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),d.Quantity=a.QtyFilter,d.Amount=d.UnitCost*d.Quantity,d.Canceled=0,d.RowStatus=u.Insert,a.detail.listDetail.push(d)}else c[0].Quantity=parseFloat(c[0].Quantity)+1,c[0].Amount=c[0].UnitCost*c[0].Quantity;p()}function r(){var a=window.innerHeight-50-20;$("#StockInDetail").height(a);var b=($(".customergrid-table").parent().height(),window.innerWidth-window.innerWidth/20);1e3>b?b=1e3:b>1200&&(b=1200)}function s(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function t(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"StockIn"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g);var u={NotUpdate:0,Insert:1,Update:2,Delete:3};if(a.DocumentTypeList=null,a.SupplierList=null,a.ItemFilterList=null,a.LocationIdFilterList=null,a.LocationList=null,a.PriceFilter=0,a.QtyFilter=1,a.chkQuetBarcode=0,a.txtMaBarcode="",a.IsUsedColor_Size=h.IsUsedColor_Size,a.rowItemSelected=null,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={DocumentType:!0,SupplierId:!0,LocationId:!0,PostingDate:!0},a.SupplierOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!0,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"100",field4width:"40",field5width:"100",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.ID&&""!==g.ID){j(!0,!0,!1,!0,!1);var v=8===a.detail.DocumentType?!1:!0;k(v,!0,!0,!0),1===g.DaLapPhieuChiCongNo&&(j(!1,!0,!1,!1,!0),i.ShowMessageDialog("Chứng từ đã lập phiếu chi công nợ cho nhà cung cấp, không được phép sửa xóa."))}else j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0);a.ItemFilter_selectedrow=function(b){a.rowItemSelected=angular.copy(b),a.PriceFilter=b.CostPrice},a.ItemFilter_eventkeydownEnter=function(b){var c=e("filter")(a.ItemFilterList,{ID:parseFloat(a.ItemFilter)},!0);c.length>0&&(a.PriceFilter=c[0].CostPrice,a.QtyFilter=1),$("#PriceFilter").focus()},a.selectAllContent=function(a){b(function(){a.target.select()},50)},a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",a.detail.InAdvanced=0,1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.SupplierId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);({CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID});h.showloading(),h.Post("InPhieuNhapKho",a.detail,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU NHAP KHO","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=o();if(1==c.$$state.value){var d=e("filter")(a.detail.listDetail,{ItemId:parseFloat(a.ItemFilter),UomId:parseFloat(a.rowItemSelected.Field3),UnitCost:parseFloat(a.PriceFilter),Canceled:0},!0);0===d.length?(b.ID=0,b.ItemId=parseFloat(a.ItemFilter),b.ItemCode=null!==a.rowItemSelected?a.rowItemSelected.Code:"",b.ItemName=null!==a.rowItemSelected?a.rowItemSelected.Name:"",b.UomId=null!==a.rowItemSelected?parseFloat(a.rowItemSelected.Field3):0,b.UnitName=null!=a.rowItemSelected?a.rowItemSelected.Field4:"",b.LocationId=parseInt(a.detail.LocationId),b.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,b.RowStatus=u.Insert,a.detail.listDetail.push(b)):(d[0].Quantity=parseFloat(d[0].Quantity)+parseFloat(a.QtyFilter),d[0].Amount=d[0].UnitCost*d[0].Quantity),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,p()}},a.btnRemoveRow=function(a){a.Canceled=1,a.RowStatus=u.Delete,p()},a.eventkeydownEnter=function(a){},a.UnitCost_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=0,p()},a.Quantity_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=0,p()},a.Amount_Change=function(a){0!==a.Quantity&&(a.UnitCost=a.Amount/a.Quantity),parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=1,p()},a.PriceFilter_Keydown=function(a){13==a.which&&$("#QtyFilter").focus()},a.QtyFilter_Keydown=function(b){13==b.which&&(a.btnAddRowGrid(),a.QtyFilter=1)},a.txtMaBarcode_Keydown=function(b){if(13===b.which&&void 0!==a.ItemFilterList){var c=e("filter")(a.ItemFilterList,{Code:a.txtMaBarcode.toUpperCase()},!0);c.length>0?(a.PriceFilter=c[0].CostPrice,a.QtyFilter=1,q(c[0]),a.txtMaBarcode=""):0===c.length&&a.txtMaBarcode.length>0&&i.ShowMessageDialog("Mã Barcode không tồn tại.")}},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,a.SupplierOptions.setValue=a.detail.SupplierId,j(!0,!0,!1,!0,!1);var c=8===a.detail.DocumentType?!1:!0;k(c,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnImportData_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockIn/ImportNhapKho.html",ctrl:"ImportNhapKhoCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;b(function(){a.detail.listDetail.length=0;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneDetailObj);c.ID=0,c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UomId,c.UnitName=d[b].UnitName,c.LocationId=0,c.UnitCost=d[b].UnitCost,c.Quantity=d[b].Quantity,c.Amount=d[b].Amount,c.Canceled=0,c.RowStatus=u.Insert,a.detail.listDetail.push(c)}p()},50)}})},l(),b(function(){r()},0),a.btnTaoHangHoa_Click=function(){i.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Inventory/InvStockIn/AddItem.html",ctrl:"TaoHangHoaNhapKhoCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(b){0===b&&h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.ItemFilterList=b.data.Data2},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})})},a.btnTaoNhaCungCap_Click=function(){var b={ID:0,CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("detail",b,h.Url+"api/Supplier/").then(function(b){a.data=b.data.Data}).then(function(){a.dataid>0&&0==a.data.ID?i.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Supplier/SupplierDetail.html",ctrl:"SupplierDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.SupplierList=b.data.Data4,console.log(a.SupplierList)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})})},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})},a.btnExport_Click=function(){var b=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0];if(null==b||void 0==b)result=!1,i.ShowMessageDialog("Không có dữ liệu.");else{h.showloading();var c={CompanyId:h.CompanyId,BranchId:h.BranchId,InfoId:a.detail.ID},f="PhieuNhapKho.xlsx";h.ExportExcel("Export",c,h.url,f).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){s()}),b(function(){t()},50)}]),app.controller("ImportNhapKhoCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","InvStockInService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportNhapKho.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.controller("TaoHangHoaNhapKhoCtrl",["$scope","$uibModalInstance","$timeout","$filter","data","AppDialog","InvStockInService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:g.UserName};g.Post("InitItemDetail",b,g.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.ItemCategoryList=b.data.Data,a.UnitList=b.data.Data2)},function(a){}).then(function(c){g.Post("GetMaxCode",b,g.Url+"api/Item/").then(function(b){0===b.data.Status.StatusCode&&(a.detail=b.data.Data,a.detail.Item_Type=0)},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){g.closeloading()})},function(a){console.log("error:"+a.data)})["finally"](function(){g.closeloading()})}a.detail=null,a.ItemCategoryList=null,a.UnitList=null,a.LoaiHinhKinhDoanh=g.MaNganh,a.LoaiPM=g.MaNganh,console.log(a.LoaiPM),h(),a.btnCancel_Click=function(){b.close(-1)},a.btnSave_Click=function(){var c="";if((null===a.detail.Code||""===a.detail.Code)&&(c+="Vui lòng nhập mã hàng</br>"),(null===a.detail.Name||""===a.detail.Name)&&(c+="Vui lòng nhập tên hàng</br>"),(0===a.detail.Item_CategoryId||null===a.detail.Item_CategoryId)&&(c+="Vui lòng nhập nhóm hàng</br>"),(0===a.detail.UnitBasic||null===a.detail.UnitBasic)&&(c+="Vui lòng nhập đơn vị tính</br>"),""!==c)f.ShowMessageDialog(c);else{a.detail.CompanyId=g.CompanyId,g.showloading();({CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:g.UserName});g.Post("SaveExpress",a.detail,g.Url+"api/Item/").then(function(a){0===a.data.Status.StatusCode?(f.ShowMessageDialog("Lưu thành công."),b.close(0)):5===a.data.Status.StatusCode?f.ShowMessageDialog("Dữ liệu đã tồn tại, vui lòng nhập lại."):f.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){g.closeloading()})}}}]),app.factory("InvStockInOtherBranchService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvStockIn/",e}]),app.controller("StockInOtherBranchCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","InvStockInOtherBranchService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("GetCodeNameDataMasterList",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.DocumentTypeList=b.data.Data,a.LocationIdList=b.data.Data2,a.ItemList=b.data.Data3,a.DocumentType=-2,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"StockIn"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LocationIdList=null,a.DocumentTypeList=null,a.ItemList=null,a.LoaiPM=g.MaNganh,a.LocationIdOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.gridOptions={data:[],id:"grid_stockInBranch",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"ApplicationName",display:"Trạng thái",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DocumentNo",display:"InvStockIn_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockIn_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"SupplierName",display:"Nhà cung cấp",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"LocationName",display:"Kho hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"InvStockIn_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockIn_Label_Note",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UpdatedBy",display:"Cập nhật",headerclass:"text-align-center col-w-80px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,DocumentType:a.DocumentType,BranchId:g.BranchId,CompanyId:g.CompanyId,ItemId:a.ItemId};g.Post("searchOtherBranch",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockInOtherBranch/StockInOtherBranchDetail.html",ctrl:"StockInOtherBranchDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){(null===b||void 0===b)&&(b=0);var c={CompanyId:g.CompanyId,BranchId:g.BranchId,Value01:a.ID};g.showloading(),g.Post("InPhieuNhapKhoChiNhanh",c,g.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?f.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU NHAP KHO CHI NHANH","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),f.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){g.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})})},a.btnShowFormInBarcode_Click=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):g.Post("GetListDataInBarcode",b,g.url).then(function(b){var c=b.data.Status;0===c.StatusCode&&(a.ListBarcode=b.data.Data,f.ShowDetailFormDialog({data:a.ListBarcode,tempUrl:"app/components/Master/GiaLePOS/InBarcode.html",ctrl:"InBarcodeCtrl",cssclass:"Modal-width900",focuscontrolid:""}).then(function(a){}))},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnHoanThanhChuyenKho_Click=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("Bạn có chắc muốn hoàn thành nhận hàng từ chi nhánh khác?").then(function(c){0==c&&(g.showloading(),g.Post("UpdateAppStatusFinish",b,g.url).then(function(b){var c=b.data.Status;
0==c.StatusCode?(g.closeloading(),f.ShowMessageDialog("Thực hiện thành công.").then(function(){a.btnSearch()})):(f.ShowMessageDialog(c.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnHuyNhapKho_Click=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("Bạn có chắc muốn hủy nhận hàng từ chi nhánh khác?").then(function(c){0===parseInt(c)&&(g.showloading(),g.Post("RejectStatusStockIn",b,g.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(g.closeloading(),f.ShowMessageDialog("Thực hiện thành công.").then(function(){a.btnSearch()})):(f.ShowMessageDialog(c.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},h(),j()}]),app.controller("StockInOtherBranchDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvStockInOtherBranchService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={DocumentType:b,SupplierId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data,a.ItemFilterList=b.data.Data2,a.LocationIdFilterList=b.data.Data3,a.SupplierList=b.data.Data4,a.LocationList=b.data.Data3,a.SupplierOptions.setValue=a.detail.SupplierId,(null===g.ID||""===g.ID)&&(a.detail.LocationId=a.LocationList.length>1?0:a.LocationList[0].ID)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);return null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockIn_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng mỗi lần cập nhật không được nhiều hơn 100 dòng.")+"<br/>")),b.resolve(c),b.promise}function o(){var b=f.defer(),c="",e=-1,g=!0;switch((0==a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockIn_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(c+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",g=!1,e=-1==e?1:e),(parseFloat(a.QtyFilter)<=0||void 0==a.QtyFilter)&&(c+=d.instant("InvStockIn_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?2:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 1:$("#LocationId").focus();break;case 2:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function p(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function q(){var b=window.innerHeight-50-20;$("#StockInDetailOtherBranch").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function r(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function s(){if("1"!==h.IsAdministrator){var c=e("filter")(h.Role,{ScreenCode:"StockIn"},!0);if(c.length>0){var d=e("filter")(c,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===d?!0:!d.IsEnable)}else $("#btnSave").prop("disabled",!0)}b(function(){2!==a.detail.ApplicationStatus&&(j(!1,!1,!1,!1,!0),$("#btnTimPhieuXuatKho").prop("disabled",!0))},100)}a.dataCopy=angular.copy(g);var t={NotUpdate:0,Insert:1,Update:2,Delete:3};a.DocumentTypeList=null,a.SupplierList=null,a.ItemFilterList=null,a.LocationIdFilterList=null,a.LocationList=null,a.PriceFilter=0,a.QtyFilter=0,a.InfoId_Ref=null,a.DocumentNo_Ref=null,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={DocumentType:!0,SupplierId:!0,LocationId:!0,PostingDate:!0},a.SupplierOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.ID&&""!==g.ID?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0),a.InfoId_Ref=g.InfoId_Ref,a.DocumentNo_Ref=g.DocumentNo_Ref):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0),a.detail.ApplicationStatus=2),a.ItemFilter_selectedrow=function(b){a.PriceFilter=b.CostPrice,$("#PriceFilter").focus()},a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.SupplierId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,a.detail.DocumentType=12,a.detail.ApplicationStatus=2,a.detail.InfoId_Ref=a.InfoId_Ref,a.detail.DocumentNo_Ref=a.DocumentNo_Ref,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID};h.showloading(),h.Post("InPhieuNhapKhoChiNhanh",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU NHAP KHO CHI NHANH","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=o();1==c.$$state.value&&(b.ID=0,b.ItemId=a.ItemFilter,b.ItemCode=$("#ItemFilter").attr("aacode"),b.ItemName=$("#ItemFilter").attr("aaname"),b.UomId=$("#ItemFilter").attr("aafield3"),b.UnitName=$("#ItemFilter").attr("aafield4"),b.LocationId=parseInt(a.detail.LocationId),b.UnitCost=null==a.PriceFilter?0:a.PriceFilter,b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,b.RowStatus=t.Insert,a.detail.listDetail.push(b),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,p())},a.btnRemoveRow=function(a){a.Canceled=1,a.RowStatus=t.Delete,p()},a.eventkeydownEnter=function(a){},a.CalculateAmount=function(a){a.Amount=a.UnitCost*a.Quantity,p()},a.UnitCost_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=t.Update),a.EditAmount=0,p()},a.Quantity_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=t.Update),a.EditAmount=0,p()},a.Amount_Change=function(a){0!==a.Quantity&&(a.UnitCost=a.Amount/a.Quantity),parseFloat(a.ID)>0&&(a.RowStatus=t.Update),a.EditAmount=1,p()},a.QtyFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,a.SupplierOptions.setValue=a.detail.SupplierId,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnTimPhieuXuatKho_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockInOtherBranch/TimPhieuXuatKhoChiNhanh.html",ctrl:"TimPhieuXuatKhoChiNhanhCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;d.length>0&&(a.InfoId_Ref=d[0].InfoId,a.DocumentNo_Ref=d[0].DocumentNo),b(function(){for(var b=0;b<=a.detail.listDetail.length-1;b++)a.detail.listDetail[b].Canceled=1;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneDetailObj);c.ID=0,c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UnitId,c.UnitName=d[b].UnitName,c.LocationId=0,c.UnitCost=d[b].UnitCost,c.Quantity=d[b].Quantity,c.Amount=d[b].Amount,c.Canceled=0,a.detail.listDetail.push(c)}p()},50)}})},l(),b(function(){q()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){r()}),b(function(){s()},100)}]),app.controller("TimPhieuXuatKhoChiNhanhCtrl",["$scope","$http","$filter","$timeout","$uibModalInstance","$translate","data","InvStockInOtherBranchService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.showloading();var b={BranchId:h.BranchId,CompanyId:h.CompanyId};h.Post("TimPhieuXuatChiNhanh",b,h.url).then(function(b){d(function(){a.dtInfo=b.data.Data,a.dtDetail=b.data.Data2,a.dtInfo.length>0&&k(a.dtInfo[0].InfoId)},50)},function(b){a.gridOptions.data=null,showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}function k(b){a.dtDetailFilter=c("filter")(a.dtDetail,{InfoId:b},!0)}a.dtInfo=null,a.dtDetail=null,a.dtDetailFilter=null,j(),a.selectedRow=0,a.rowFilter_Click=function(b,d){a.selectedRow=d,a.dtDetailFilter=c("filter")(a.dtDetail,{InfoId:b.InfoId},!0)},a.btnSelected_Click=function(){var b=a.dtDetailFilter;e.close({status:1,responseData:b})},a.btnCancel=function(){e.close({status:0,responseData:[]})}}]),app.factory("InvStockOutService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvStockOut/",e}]),app.controller("StockOutCtrl",["$scope","$rootScope","$uibModal","$timeout","$translate","$filter","AppDialog","InvStockOutService",function(a,b,c,d,e,f,g,h){function i(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,h.Post("GetCodeNameDataMasterList",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data,a.LocationIdList=b.data.Data2,a.ItemList=b.data.Data3,a.DocumentType=-1,j()},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function j(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function k(){if("1"!==h.IsAdministrator){var b=f("filter")(h.Role,{ScreenCode:"StockOut"},!0);if(b.length>0){var c=f("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=f("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var e=f("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.LocationIdList=null,a.DocumentTypeList=null,a.viewRole=!0,a.ItemList=null,a.LocationIdOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"DocumentNo",display:"InvStockOut_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockOut_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"DocumentTypeName",display:"Loại",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"CustomerName",display:"Khách hàng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"LocationName",display:"Kho hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"InvStockOut_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockOut_Label_Note",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UpdatedBy",display:"Cập nhật",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){h.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,DocumentType:a.DocumentType,BranchId:h.BranchId,CompanyId:h.CompanyId,ItemId:a.ItemId};h.Post("search",b,h.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+e.instant("CMN_SearchResult"))):g.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("detail",c,h.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?g.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):g.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockOut/StockOutDetail.html",ctrl:"StockOutDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){g.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.ID};h.showloading(),h.Post("InPhieuXuatKho",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?g.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU XUAT KHO","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),g.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?g.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):g.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(h.showloading(),h.Post("deletelist",b,h.url).then(function(c){var d=c.data.Status;0==d.StatusCode?g.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))})},i(),k()}]),app.controller("StockOutDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvStockOutService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={DocumentType:b,CustomerId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data,a.ItemFilterList=b.data.Data2,a.LocationIdFilterList=b.data.Data3,a.CustomerList=b.data.Data4,a.LocationList=b.data.Data3,a.CustomerOptions.setValue=a.detail.CustomerId,a.detail.DocumentType=0===a.detail.DocumentType?1:a.detail.DocumentType,(null===g.ID||""===g.ID)&&(a.detail.LocationId=a.LocationList.length>1?0:a.LocationList[0].ID),a.QtyFilter=1},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch(null==a.detail.PostingDate&&(g+=d.instant("InvStockOut_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockOut_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),""!==g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);return null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockOut_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng mỗi lần cập nhật không được nhiều hơn 100 dòng.")+"<br/>")),b.resolve(c),b.promise}function o(){var b=f.defer(),c="",e=-1,g=!0;switch((0==a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockOut_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(parseFloat(a.QtyFilter)<=0||void 0==a.QtyFilter)&&(c+=d.instant("InvStockOut_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?2:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 1:$("#LocationId").focus();break;case 2:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function p(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function q(b){var c=e("filter")(a.detail.listDetail,{ItemId:parseFloat(b.ID)},!0);if(0===c.length){var d=angular.copy(a.detail.CloneDetailObj);d.ID=0,d.ItemId=parseFloat(b.ID),d.ItemCode=b.Code,d.ItemName=b.Name,d.UomId=parseFloat(b.Field3),d.UnitName=b.Field4,d.LocationId=parseInt(a.detail.LocationId),d.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),d.Quantity=a.QtyFilter,d.Amount=d.UnitCost*d.Quantity,d.Canceled=0,d.RowStatus=u.Insert,a.detail.listDetail.push(d)}else c[0].Quantity=parseFloat(c[0].Quantity)+1,c[0].Amount=c[0].UnitCost*c[0].Quantity;p()}function r(){var b=window.innerHeight-50-20;console.log(b),$("#StockOutDetail").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function s(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function t(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"StockOut"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g);var u={NotUpdate:0,Insert:1,Update:2,Delete:3};a.DocumentTypeList=null,a.CustomerList=null,a.ItemFilterList=null,a.LocationIdFilterList=null,a.LocationList=null,a.PriceFilter=0,a.QtyFilter=1,a.chkQuetBarcode=0,a.txtMaBarcode="",a.rowItemSelected=null,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={DocumentType:!0,CustomerId:!0,LocationId:!0,PostingDate:!0},a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!0,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"40",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.ID&&""!==g.ID?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0)),a.ItemFilter_selectedrow=function(b){a.rowItemSelected=angular.copy(b),$("#PriceFilter").focus()},a.ItemFilter_eventkeydownEnter=function(b){$("#PriceFilter").focus();var c=e("filter")(a.ItemFilterList,{ID:parseFloat(a.ItemFilter)},!0);c.length>0&&(a.PriceFilter=c[0].CostPrice,a.QtyFilter=1)},a.selectAllContent=function(a){b(function(){a.target.select()},50)},a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.CustomerId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID};h.showloading(),h.Post("InPhieuXuatKho",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU XUAT KHO","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=o();if(1==c.$$state.value){var d=e("filter")(a.detail.listDetail,{ItemId:parseFloat(a.ItemFilter),UomId:parseFloat(a.rowItemSelected.Field3),UnitCost:parseFloat(a.PriceFilter),Canceled:0},!0);0===d.length?(b.ID=0,b.ItemId=parseFloat(a.ItemFilter),b.ItemCode=null!==a.rowItemSelected?a.rowItemSelected.Code:"",b.ItemName=null!==a.rowItemSelected?a.rowItemSelected.Name:"",b.UomId=null!==a.rowItemSelected?parseFloat(a.rowItemSelected.Field3):0,b.UnitName=null!=a.rowItemSelected?a.rowItemSelected.Field4:"",b.LocationId=parseInt(a.detail.LocationId),b.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,b.RowStatus=u.Insert,a.detail.listDetail.push(b)):(d[0].Quantity=parseFloat(d[0].Quantity)+parseFloat(a.QtyFilter),d[0].Amount=d[0].UnitCost*d[0].Quantity),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,p()}},a.btnRemoveRow=function(a){a.Canceled=1,a.RowStatus=u.Delete,p()},a.eventkeydownEnter=function(a){},a.CalculateAmount=function(a){a.Amount=a.UnitCost*a.Quantity,p()},a.UnitCost_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=0,p()},a.Quantity_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=0,p()},a.Amount_Change=function(a){0!==a.Quantity&&(a.UnitCost=a.Amount/a.Quantity),parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=1,p()},a.PriceFilter_Keydown=function(a){13==a.which&&$("#QtyFilter").focus()},a.QtyFilter_Keydown=function(b){13==b.which&&(a.btnAddRowGrid(),a.QtyFilter=1)},a.txtMaBarcode_Keydown=function(b){if(13===b.which&&void 0!==a.ItemFilterList){var c=e("filter")(a.ItemFilterList,{Code:a.txtMaBarcode.toUpperCase()},!0);c.length>0?(a.PriceFilter=c[0].CostPrice,a.QtyFilter=1,q(c[0]),a.txtMaBarcode=""):0===c.length&&a.txtMaBarcode.length>0&&i.ShowMessageDialog("Mã Barcode không tồn tại.")}},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,a.CustomerOptions.setValue=a.detail.CustomerId,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnImportData_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockOut/ImportXuatKho.html",ctrl:"ImportXuatKhoCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;b(function(){a.detail.listDetail.length=0;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneDetailObj);c.ID=0,c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UomId,c.UnitName=d[b].UnitName,c.LocationId=0,c.UnitCost=d[b].UnitCost,c.Quantity=d[b].Quantity,c.Amount=d[b].Amount,c.Canceled=0,c.RowStatus=u.Insert,a.detail.listDetail.push(c)}p()},50)}})},l(),b(function(){r()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){s()}),b(function(){t()},50)}]),app.controller("ImportXuatKhoCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","InvStockOutService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportXuatKho.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.factory("InvStockOutOtherBranchService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvStockOut/",e}]),app.controller("StockOutOtherBranchCtrl",["$scope","$rootScope","$uibModal","$timeout","$translate","$filter","AppDialog","InvStockOutOtherBranchService",function(a,b,c,d,e,f,g,h){function i(){h.showloading();var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,h.Post("GetCodeNameDataMasterList",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data,a.LocationIdList=b.data.Data2,a.ItemList=b.data.Data3,a.DocumentType=-1,j()},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}function j(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function k(){if("1"!==h.IsAdministrator){var b=f("filter")(h.Role,{ScreenCode:"StockOut"},!0);if(b.length>0){var c=f("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=f("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var e=f("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.LocationIdList=null,a.DocumentTypeList=null,a.viewRole=!0,a.ItemList=null,a.LocationIdOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.gridOptions={data:[],id:"grid_stock",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"ApplicationName",display:"Trạng thái",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DocumentNo",display:"InvStockOut_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockOut_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"CustomerName",display:"Khách hàng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"LocationName",display:"Kho hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"InvStockOut_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockOut_Label_Note",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UpdatedBy",display:"Cập nhật",headerclass:"text-align-center col-w-80px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){h.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,DocumentType:a.DocumentType,BranchId:h.BranchId,CompanyId:h.CompanyId,ItemId:a.ItemId};h.Post("searchOtherBranch",b,h.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+e.instant("CMN_SearchResult"))):g.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("detail",c,h.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?g.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):g.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockOutOtherBranch/StockOutOtherBranchDetail.html",ctrl:"StockOutDetailOtherBranchCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){g.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.ID
};h.showloading(),h.Post("InPhieuXuatKhoChiNhanh",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?g.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU XUAT KHO CHI NHANH","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),g.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?g.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):g.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&h.Post("deletelist",b,h.url).then(function(c){var d=c.data.Status;0==d.StatusCode?g.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(g.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})})},a.btnThucHienChuyenKho_Click=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?g.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):g.ShowConfirmDialog("Bạn có chắc muốn bắt đầu chuyển hàng qua chi nhánh khác?").then(function(c){0==c&&(h.showloading(),h.Post("UpdateAppStatusTransfer",b,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(h.closeloading(),g.ShowMessageDialog("Thực hiện thành công.").then(function(){a.btnSearch()})):(g.ShowMessageDialog(c.MessageId),a.success=!1)},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))})},i(),k()}]),app.controller("StockOutDetailOtherBranchCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvStockOutOtherBranchService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={DocumentType:b,CustomerId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data,a.ItemFilterList=b.data.Data2,a.LocationIdFilterList=b.data.Data3,a.CustomerList=b.data.Data4,a.LocationList=b.data.Data3,a.BranchList=b.data.Data5,a.CustomerOptions.setValue=a.detail.CustomerId,a.detail.DocumentType=0===a.detail.DocumentType?1:a.detail.DocumentType,(null===g.ID||""===g.ID)&&(a.detail.LocationId=a.LocationList.length>1?0:a.LocationList[0].ID),a.QtyFilter=1},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch(null==a.detail.PostingDate&&(g+=d.instant("InvStockOut_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockOut_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),(""===a.detail.To_BranchId||void 0===a.detail.To_BranchId)&&(g+=d.instant("Vui lòng nhập Chi nhánh nhận kho.")+"<br/>",e=!1,c=-1==c?1:c),""!==g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);return null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockOut_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng mỗi lần cập nhật không được nhiều hơn 100 dòng.")+"<br/>")),b.resolve(c),b.promise}function o(){var b=f.defer(),c="",e=-1,g=!0;switch((0==a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockOut_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(parseFloat(a.QtyFilter)<=0||void 0==a.QtyFilter)&&(c+=d.instant("InvStockOut_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?2:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 1:$("#LocationId").focus();break;case 2:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function p(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function q(b){var c=e("filter")(a.detail.listDetail,{ItemId:parseFloat(b.ID)},!0);if(0===c.length){var d=angular.copy(a.detail.CloneDetailObj);d.ID=0,d.ItemId=parseFloat(b.ID),d.ItemCode=b.Code,d.ItemName=b.Name,d.UomId=parseFloat(b.Field3),d.UnitName=b.Field4,d.LocationId=parseInt(a.detail.LocationId),d.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),d.Quantity=a.QtyFilter,d.Amount=d.UnitCost*d.Quantity,d.Canceled=0,d.RowStatus=u.Insert,a.detail.listDetail.push(d)}else c[0].Quantity=parseFloat(c[0].Quantity)+1,c[0].Amount=c[0].UnitCost*c[0].Quantity;p()}function r(){var b=window.innerHeight-50-20;console.log(b),$("#StockOutDetailOtherBranch").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function s(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function t(){if("1"!==h.IsAdministrator){var b=e("filter")(h.Role,{ScreenCode:"StockOut"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===c?!0:!c.IsEnable)}else $("#btnSave").prop("disabled",!0)}0!==a.detail.ApplicationStatus&&(j(!1,!1,!1,!1,!0),$("#btnImport").prop("disabled",!0))}a.dataCopy=angular.copy(g);var u={NotUpdate:0,Insert:1,Update:2,Delete:3};a.DocumentTypeList=null,a.CustomerList=null,a.ItemFilterList=null,a.LocationIdFilterList=null,a.LocationList=null,a.PriceFilter=0,a.QtyFilter=1,a.chkQuetBarcode=0,a.BranchList=null,a.txtMaBarcode="",a.rowItemSelected=null,a.fsavesuccess=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={DocumentType:!0,CustomerId:!0,LocationId:!0,PostingDate:!0},a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!0,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"40",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.ID&&""!==g.ID?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0)),a.ItemFilter_selectedrow=function(b){a.rowItemSelected=angular.copy(b),a.PriceFilter=b.CostPrice,$("#PriceFilter").focus()},a.ItemFilter_eventkeydownEnter=function(b){$("#PriceFilter").focus();var c=e("filter")(a.ItemFilterList,{ID:parseFloat(a.ItemFilter)},!0);c.length>0&&(a.PriceFilter=c[0].CostPrice,a.QtyFilter=1)},a.selectAllContent=function(a){b(function(){a.target.select()},50)},a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.CustomerId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,a.detail.DocumentType=13,a.detail.ApplicationStatus=0,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID};h.showloading(),h.Post("InPhieuXuatKhoChiNhanh",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU XUAT KHO CHI NHANH","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=o();if(1==c.$$state.value){var d=e("filter")(a.detail.listDetail,{ItemId:parseFloat(a.ItemFilter),UomId:parseFloat(a.rowItemSelected.Field3),UnitCost:parseFloat(a.PriceFilter),Canceled:0},!0);0===d.length?(b.ID=0,b.ItemId=parseFloat(a.ItemFilter),b.ItemCode=null!==a.rowItemSelected?a.rowItemSelected.Code:"",b.ItemName=null!==a.rowItemSelected?a.rowItemSelected.Name:"",b.UomId=null!==a.rowItemSelected?parseFloat(a.rowItemSelected.Field3):0,b.UnitName=null!=a.rowItemSelected?a.rowItemSelected.Field4:"",b.LocationId=parseInt(a.detail.LocationId),b.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,b.RowStatus=u.Insert,a.detail.listDetail.push(b)):(d[0].Quantity=parseFloat(d[0].Quantity)+parseFloat(a.QtyFilter),d[0].Amount=d[0].UnitCost*d[0].Quantity),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,p()}},a.btnRemoveRow=function(a){a.Canceled=1,a.RowStatus=u.Delete,p()},a.eventkeydownEnter=function(a){},a.CalculateAmount=function(a){a.Amount=a.UnitCost*a.Quantity,p()},a.UnitCost_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=0,p()},a.Quantity_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=0,p()},a.Amount_Change=function(a){0!==a.Quantity&&(a.UnitCost=a.Amount/a.Quantity),parseFloat(a.ID)>0&&(a.RowStatus=u.Update),a.EditAmount=1,p()},a.PriceFilter_Keydown=function(a){13===a.which&&$("#QtyFilter").focus()},a.QtyFilter_Keydown=function(b){13==b.which&&(a.btnAddRowGrid(),a.QtyFilter=1)},a.txtMaBarcode_Keydown=function(b){if(13===b.which&&void 0!==a.ItemFilterList){var c=e("filter")(a.ItemFilterList,{Code:a.txtMaBarcode.toUpperCase()},!0);c.length>0?(a.PriceFilter=c[0].CostPrice,a.QtyFilter=1,q(c[0]),a.txtMaBarcode=""):0===c.length&&a.txtMaBarcode.length>0&&i.ShowMessageDialog("Mã Barcode không tồn tại.")}},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,a.CustomerOptions.setValue=a.detail.CustomerId,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnImportData_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockOutOtherBranch/ImportXuatKhoOtherBranch.html",ctrl:"ImportXuatKhoOtherBranchCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;b(function(){a.detail.listDetail.length=0;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneDetailObj);c.ID=0,c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UomId,c.UnitName=d[b].UnitName,c.LocationId=0,c.UnitCost=d[b].UnitCost,c.Quantity=d[b].Quantity,c.Amount=d[b].Amount,c.Canceled=0,c.RowStatus=u.Insert,a.detail.listDetail.push(c)}p()},50)}})},l(),b(function(){r()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){s()}),b(function(){t()},50)}]),app.controller("ImportXuatKhoOtherBranchCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","InvStockOutOtherBranchService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportXuatKho.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.factory("InvStockTransferService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvStockTransfer/",e}]),app.controller("StockTransferCtrl",["$scope","$rootScope","$uibModal","$timeout","$translate","$filter","AppDialog","InvStockTransferService",function(a,b,c,d,e,f,g,h){function i(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,h.Post("GetCodeNameDataMasterList",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.DocumentTypeList=b.data.Data2,a.LocationIdList=b.data.Data,a.ItemList=b.data.Data3,a.DocumentType=-2,j()},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function j(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function k(){if("1"!==h.IsAdministrator){var b=f("filter")(h.Role,{ScreenCode:"StockTransfer"},!0);if(b.length>0){var c=f("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=f("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var e=f("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.LocationIdList=null,a.viewRole=!0,a.DocumentTypeList=null,a.ItemList=null,a.LocationIdOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,showTotalRow:!0,columnDefs:[{field:"DocumentNo",display:"InvStockTransfer_Label_DocumentNo",headerclass:"text-align-center col-w-130px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockTransfer_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"DocumentTypeName",display:"Loại",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"FromLocationName",display:"Kho xuất",headerclass:"text-align-center col-w-130px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"ToLocationName",display:"Kho nhận",headerclass:"text-align-center col-w-130px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"ReceiverName",display:"Người nhận",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"InvStockTransfer_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0,sumTotal:!0},{field:"Note",display:"InvStockTransfer_Label_Note",headerclass:"text-align-center col-w-180px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UpdatedBy",display:"Cập nhật",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){h.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,DocumentType:a.DocumentType,BranchId:h.BranchId,CompanyId:h.CompanyId,ItemId:a.ItemId};h.Post("search",b,h.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+e.instant("CMN_SearchResult"))):g.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("detail",c,h.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?g.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):g.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockTransfer/StockTransferDetail.html",ctrl:"StockTransferDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){g.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.gridPrintData=function(a,b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.ID};h.showloading(),h.Post("InPhieuChuyenKho",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?g.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU CHUYEN KHO","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),g.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?g.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):g.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(h.showloading(),h.Post("deletelist",b,h.url).then(function(c){var d=c.data.Status;0==d.StatusCode?g.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))})},i(),k()}]),app.controller("StockTransferDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","InvStockTransferService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={PostingDate:b,From_LocationId:c,To_LocationId:d,DocumentType:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.ItemFilterList=b.data.Data,a.LocationList=b.data.Data2,a.DocumentTypeList=b.data.Data4,a.detail.DocumentType=0===a.detail.DocumentType?a.PhieuChuyenKhoNoiBo:a.detail.DocumentType,a.BranchList=b.data.Data5,a.LocationAllBranch=b.data.Data6,a.QtyFilter=1},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((0===parseFloat(a.detail.From_LocationId)||void 0===a.detail.From_LocationId)&&(g+=d.instant("InvStockTransfer_From_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),a.detail.DocumentType!==a.PhieuChuyenKhoNoiBo&&(""===a.detail.To_BranchId||void 0===a.detail.To_BranchId)&&(g+=d.instant("Vui lòng nhập Chi nhánh nhận kho.")+"<br/>",e=!1,c=-1==c?1:c),(0===parseFloat(a.detail.To_LocationId)||void 0===a.detail.To_LocationId)&&(g+=d.instant("InvStockTransfer_To_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?1:c),parseFloat(a.detail.From_LocationId)===parseFloat(a.detail.To_LocationId)&&(g+=d.instant("InvStockTransfer_LocationId_Duplicate_Invalid")+"<br/>",e=!1,c=-1==c?0:c),(null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockTransfer_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?2:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#From_LocationId").focus();break;case 1:$("#To_LocationId").focus();break;case 2:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);return null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockTransfer_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng mỗi lần cập nhật không được nhiều hơn 100 dòng.")+"<br/>")),b.resolve(c),b.promise}function o(){var b=f.defer(),c="",e=-1,g=!0;switch((0==a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockTransfer_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(parseFloat(a.QtyFilter)<=0||void 0===a.QtyFilter)&&(c+=d.instant("InvStockTransfer_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?3:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 3:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function p(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function q(){var b=window.innerHeight-50-20;console.log(b),$("#StockTransferDetail").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function r(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function s(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"StockTransfer"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g);var t={NotUpdate:0,Insert:1,Update:2,Delete:3};a.ItemFilterList=null,a.LocationList=null,a.PriceFilter=0,a.QtyFilter=0,a.BranchList=null,a.rowItemSelected=null,a.fsavesuccess=0,a.LocationAllBranch=null,a.DocumentTypeList=null,a.PhieuChuyenKhoNoiBo=22,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={PostingDate:!0,From_LocationId:!0,To_LocationId:!0,DocumentType:!0},a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!0,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"40",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.ID&&""!==g.ID?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0)),a.ItemFilter_selectedrow=function(b){a.rowItemSelected=angular.copy(b),a.PriceFilter=b.CostPrice,$("#PriceFilter").focus()},a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.SupplierId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.cboTo_BranchId_Change=function(){a.detail.To_LocationId=0},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].From_LocationId=a.detail.From_LocationId,a.detail.listDetail[c].From_BranchId=h.BranchId,a.detail.listDetail[c].To_LocationId=a.detail.To_LocationId,a.detail.listDetail[c].To_BranchId=a.detail.To_BranchId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.From_BranchId=h.BranchId,a.detail.To_BranchId=h.BranchId,a.detail.UserName=h.UserName,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1,!1),a.fsavesuccess=1):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.ID};h.showloading(),h.Post("InPhieuChuyenKho",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU CHUYEN KHO","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=o();if(1==c.$$state.value){var d=e("filter")(a.detail.listDetail,{ItemId:parseFloat(a.ItemFilter),UomId:parseFloat(a.rowItemSelected.Field3),UnitCost:parseFloat(a.PriceFilter),Canceled:0},!0);0===d.length?(b.ID=0,b.ItemId=parseFloat(a.ItemFilter),b.ItemCode=null!==a.rowItemSelected?a.rowItemSelected.Code:"",b.ItemName=null!==a.rowItemSelected?a.rowItemSelected.Name:"",b.UomId=null!==a.rowItemSelected?parseFloat(a.rowItemSelected.Field3):0,b.UnitName=null!=a.rowItemSelected?a.rowItemSelected.Field4:"",b.From_LocationId=a.detail.From_LocationId,b.From_BranchId=h.BranchId,b.To_LocationId=a.detail.To_LocationId,b.To_BranchId=a.detail.To_BranchId,b.UnitCost=null==a.PriceFilter?0:parseFloat(a.PriceFilter),b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,b.RowStatus=t.Insert,a.detail.listDetail.push(b)):(d[0].Quantity=parseFloat(d[0].Quantity)+parseFloat(a.QtyFilter),d[0].Amount=d[0].UnitCost*d[0].Quantity),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,p()}},a.btnRemoveRow=function(a){a.Canceled=1,a.RowStatus=t.Delete,p()},a.eventkeydownEnter=function(b){"ItemFilter"==b&&(a.QtyFilter.setfocus=!0)},a.CalculateAmount=function(a){a.Amount=a.UnitCost*a.Quantity,p()},a.UnitCost_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=t.Update),a.EditAmount=0,p()},a.Quantity_Change=function(a){a.Amount=a.UnitCost*a.Quantity,parseFloat(a.ID)>0&&(a.RowStatus=t.Update),a.EditAmount=0,p()},a.Amount_Change=function(a){0!==a.Quantity&&(a.UnitCost=a.Amount/a.Quantity),parseFloat(a.ID)>0&&(a.RowStatus=t.Update),a.EditAmount=1,p()},a.PriceFilter_Keydown=function(a){13==a.which&&$("#QtyFilter").focus()},a.selectAllContent=function(a){b(function(){a.target.select()},50)},a.QtyFilter_Keydown=function(b){13==b.which&&(a.btnAddRowGrid(),a.QtyFilter=1)},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnImportData_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Inventory/InvStockTransfer/ImportChuyenKho.html",ctrl:"ImportChuyenKhoCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;b(function(){a.detail.listDetail.length=0;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneDetailObj);c.ID=0,c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UomId,c.UnitName=d[b].UnitName,c.From_LocationId=a.detail.From_LocationId,c.From_BranchId=h.BranchId,c.To_LocationId=a.detail.To_LocationId,c.To_BranchId=a.detail.To_BranchId,c.UnitCost=d[b].UnitCost,c.Quantity=d[b].Quantity,c.Amount=d[b].Amount,c.Canceled=0,c.RowStatus=t.Insert,a.detail.listDetail.push(c)}p()},50)}})},l(),b(function(){q()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){r()}),b(function(){s()},50)}]),app.controller("ImportChuyenKhoCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","InvStockTransferService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportChuyenKho.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.factory("CostService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/CostList/",e}]),app.controller("CostCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","CostService",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Cost"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_Cost",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Mã phí",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Tên phí",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Mô tả",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("search",b,f.url).then(function(b){
0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Cost/CostDetail.html",ctrl:"CostDetailCtrl",cssclass:"Modal-width500",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("CostDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","CostService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Cost"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.listPrinter=null,a.success=!1,a.submitted=!1,a.fsavesuccess=0,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){return 0===a.detail.LyDoThu&&0===a.detail.LyDoChi?void h.ShowMessageDialog("Vui lòng chọn Lý do thu hoặc Lý do chi"):(a.submitted=!0,void(a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("CustomerService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Customer/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("CustomerCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","CustomerService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitCustomerSearch",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.CustomerCategoryList=b.data.Data,i(),a.btnSearch()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Customer"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.CustomerCategoryList=null,a.gridOptions={data:[],id:"grid_Customer",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Customer_LABEL_CODE",headerclass:"text-align-center col-w-80px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Customer_LABEL_NAME",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Address",display:"Customer_LABEL_Address",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PhoneNo",display:"Customer_LABEL_PhoneNo",headerclass:"text-align-center col-w-80px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Birthday",display:"Customer_LABEL_Birthday",headerclass:"text-align-center col-w-80px",detailclass:"",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"Cus_CategoryName",display:"Nhóm",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DiemTichLuy",display:"Điểm tích lũy",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"",formatdatetime:"",visible:!0},{field:"MucChietKhau",display:"Mức CK",headerclass:"text-align-center col-w-80px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Note",display:"Customer_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Cus_CategoryId:a.Cus_CategoryId,CompanyId:g.CompanyId};g.Post("Search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",a.Cust_CategoryId=0,$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerDetail.html",ctrl:"CustomerDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1===b.confirm&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnImportData=function(){f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerImportData.html",ctrl:"CustomerImportDataCtrl",cssclass:"Modal-width500",focuscontrolid:""})},a.btnExport_Click=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Cus_CategoryId:a.Cus_CategoryId,CompanyId:g.CompanyId},c="DanhSachKhachHang.xlsx";g.ExportExcel("Export",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h(),j()}]),app.controller("CustomerDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","CustomerService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){g.showloading(),g.Post("InitCustomerSearch",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.CustomerCategoryList=b.data.Data,a.CustomerCategoryModels=b.data.Data3,a.MucChietKhauList=b.data.Data4,a.EmployeeOptions.setValue=a.detail.EmployeeId,a.txtSoDiemMacDinh_Change()},function(a){})["finally"](function(){g.closeloading()})}function j(b){g.showloading();var c={CompanyId:g.CompanyId,BranchId:g.BranchId,MasterType:b};g.Post("reloadMasterPlus",c,g.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?h.ShowMessageDialog(b.data.Status.MessageId):"CustomerCategory"===b.data.Status.ObjData&&(a.CustomerCategoryList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function k(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Customer"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.CustomerCategoryList=null,a.CustomerCategoryModels=null,a.MucChietKhauList=null,a.EmployeeOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownCustomers:6},a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){a.submitted=!0,null!=a.detail&&0==a.detail.Cus_CategoryId&&(a.detail.Cus_CategoryId=null,a.form.$valid=!1),a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close({confirm:1,data:d.data.Data})}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("Code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("Code").focus():document.getElementById("Name").focus(),a.form.$setPristine()},i(),a.txtSoDiemMacDinh_Change=function(){for(var b=parseFloat(a.detail.SoDiemMacDinh)+parseFloat(a.detail.DiemTichLuy),c=0,d=0;d<=a.MucChietKhauList.length-1;d++)if(parseFloat(b)>=parseFloat(a.MucChietKhauList[d].TuGiaTri)&&parseFloat(b)<parseFloat(a.MucChietKhauList[d].DenCanGiaTri)){c=a.MucChietKhauList[d].MucChietKhau;break}a.detail.MucChietKhau=c},a.btnCusCategoryPlus_Click=function(){h.ShowDetailFormDialog({data:{data:angular.copy(a.CustomerCategoryModels)},tempUrl:"app/components/Master/CustomerCategory/CustomerCategoryDetail.html",ctrl:"CustomerCategoryDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&j("CustomerCategory")})},b(function(){k()},50)}]),app.controller("CustomerImportDataCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","CustomerService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(b.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện import khách hàng, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import khách hàng thành công.")):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),h.ShowMessageDialog("Lỗi import, vui lòng kiểm tra lại dữ liệu trước khi Import."),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportKhachHang.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.dismiss("cancel")}}]),app.factory("CustomerCategoryServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);d.getTokenInfo();return e.url=e.Url+"api/CustomerCategory/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("CustomerCategoryCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","CustomerCategoryServices",function(a,b,c,d,e,f){function g(){f.showloading(),f.Post("InitCustomerCategorySearch",{CompanyId:f.CompanyId},f.urlCombobox).then(function(b){a.PriceInfoList=b.data.Data,h()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function i(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"CustomerCategory"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.PriceInfoList=null,a.LoaiPM=f.MaNganh,a.gridOptions={data:[],id:"grid_CustomerCategory",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"CUSTOMER_CATEGORY_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"CUSTOMER_CATEGORY_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"CUSTOMER_CATEGORY_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PriceName",display:"Bảng giá",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:"POS"===a.LoaiPM?!0:!1}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:{data:a.data,PriceInfoList:a.PriceInfoList},tempUrl:"app/components/Master/CustomerCategory/CustomerCategoryDetail.html",ctrl:"CustomerCategoryDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),i()}]),app.controller("CustomerCategoryDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","CustomerCategoryServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"CustomerCategory"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f.data),a.success=!1,a.submitted=!1,a.LoaiPM=g.MaNganh,a.disablecode=!1,a.detail=f.data,a.PriceInfoList=f.PriceInfoList,a.detail.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("DauKyCongNoKHServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/DauKyCongNoKH/",e}]),app.controller("DauKyCongNoKHCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","DauKyCongNoKHServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"DauKyCongNoKH"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_DauKyCongNoKH",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!1,showDelete:!1,showpaging:!0,columnDefs:[{field:"DocumentNo",display:"Số chứng từ",headerclass:"text-align-center col-w-180px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DocumentDate",display:"Ngày",headerclass:"text-align-center col-w-80px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"CustomerCode",display:"Mã khách hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"CustomerName",display:"Tên khách hàng",headerclass:"text-align-center col-w-250px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Amount",display:"Số tiền",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"2",formatdatetime:"",visible:!0},{field:"Note",display:"Mô tả",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),a.btnImportData=function(){e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/DauKyCongNoKH/DauKyCongNoKHImportData.html",ctrl:"DauKyCongNoKHImportDataCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){a.btnSearch()})},h()}]),app.controller("DauKyCongNoKHImportDataCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","DauKyCongNoKHServices","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(b.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện import đầu kỳ công nợ khách hàng, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"Import/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import đầu kỳ công nợ khách hàng thành công.")):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),h.ShowMessageDialog("Lỗi import, vui lòng kiểm tra lại dữ liệu trước khi Import."),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportDauKyCongNoKH.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close("1")}}]),app.factory("DauKyCongNoNCCServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/DauKyCongNoNCC/",e}]),app.controller("DauKyCongNoNCCCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","DauKyCongNoNCCServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"DauKyCongNoNCC"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_DauKyCongNoNCC",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!1,showDelete:!1,showpaging:!0,columnDefs:[{field:"DocumentNo",display:"Số chứng từ",headerclass:"text-align-center col-w-180px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DocumentDate",display:"Ngày",headerclass:"text-align-center col-w-80px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"SupplierCode",display:"Mã nhà cung cấp",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"SupplierName",display:"Tên nhà cung cấp",headerclass:"text-align-center col-w-250px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Amount",display:"Số tiền",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"2",formatdatetime:"",visible:!0},{field:"Note",display:"Mô tả",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),a.btnImportData=function(){e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/DauKyCongNoNCC/DauKyCongNoNCCImportData.html",ctrl:"DauKyCongNoNCCImportDataCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){a.btnSearch()})},h()}]),app.controller("DauKyCongNoNCCImportDataCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","DauKyCongNoNCCServices","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(b.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện import đầu kỳ công nợ nhà cung cấp, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"Import/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import đầu kỳ công nợ nhà cung cấp thành công.")):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),h.ShowMessageDialog("Lỗi import, vui lòng kiểm tra lại dữ liệu trước khi Import."),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportDauKyCongNoNCC.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close("1")}}]),app.factory("DepartmentServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Department/",e}]),app.controller("DepartmentCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","DepartmentServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Department"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_Department",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Department_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Department_LABEL_NAME",
headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Department_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Department/DepartmentDetail.html",ctrl:"DepartmentDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("DepartmentDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","DepartmentServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Department"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("EmployeeService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Employee/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("EmployeeCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","EmployeeService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitEmployeeSearch",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.DepartmentList=b.data.Data,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Employee"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.DepartmentList=null,a.DepartmentOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownEmployees:6},a.gridOptions={data:[],id:"grid_Employee",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Employee_LABEL_CODE",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Employee_LABEL_NAME",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Address",display:"Employee_LABEL_Address",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PhoneNo",display:"Employee_LABEL_PhoneNo",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"BirthDay",display:"Employee_LABEL_BirthDay",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"Dept_Name",display:"Employee_LABEL_Dept",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Sex_Name",display:"Employee_LABEL_Sex",headerclass:"text-align-center col-w-50px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Employee_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,DeptId:a.DeptId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("Search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Employee/EmployeeDetail.html",ctrl:"EmployeeDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("Deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(c.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},h(),j()}]),app.controller("EmployeeDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$q","$filter","data","EmployeeService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.showloading(),h.Post("InitEmployeeSearch",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.urlCombobox).then(function(b){a.DepartmentList=b.data.Data,a.DepartmentOptions.setValue=a.detail.DeptId},function(a){})["finally"](function(){h.closeloading()})}function k(){var b=e.defer(),c=-1,d=!0;switch(c){case 1:a.DepartmentOptions.setfocus=!0}return b.resolve(d),b.promise}function l(){if("1"!==h.IsAdministrator){var a=f("filter")(h.Role,{ScreenCode:"Employee"},!0);if(a.length>0){var b=f("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.success=!1,a.submitted=!1,a.DepartmentList=null,a.DepartmentOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownEmployees:6},a.disablecode=!1,a.detail=g,g.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:h.BranchId,CompanyId:h.CompanyId};h.Post("GetMaxCode",e,h.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){a.submitted=!0;var d=k();d.$$state.value===!0&&a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,h.showloading(),h.Post("Save",a.detail,h.url).then(function(d){var e=d.data.Status;0==e.StatusCode?i.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,i.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("Code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("Code").focus():document.getElementById("Name").focus(),a.form.$setPristine()},j(),b(function(){l()},50)}]),app.factory("GiaLeKaraokeService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Price/",e}]),app.controller("GiaLeKaraokeCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","GiaLeKaraokeService",function(a,b,c,d,e,f){function g(){null!=a.PriceDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function h(){f.showloading();var b={BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){a.PriceList=b.data.Data,a.PriceObj=b.data.Data2,a.PriceDetail=JSON.parse(b.data.Data3),a.PriceDetailBackup=angular.copy(a.PriceDetail),a.TienGioTrongTuan=b.data.Data4,a.TienGioCuoiTuan_NgayLe=b.data.Data5,a.NgayLeList=b.data.Data6,a.gridOptions.data=a.NgayLeList,a.cbbPriceList=b.data.Data10,a.ItemCategoryList=b.data.Data11,i(),g()},function(b){a.PriceList=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function i(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function j(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"PriceList"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Import"},!0)[0];$("#btnImport").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave01").prop("disabled",void 0===g?!0:!g.IsEnable),$("#btnSave02").prop("disabled",void 0===g?!0:!g.IsEnable),$("#btnSave03").prop("disabled",void 0===g?!0:!g.IsEnable),$("#btnSave04").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.viewRole=!0,a.PriceList=null,a.PriceObj=null,a.PriceDetail=null,a.PriceDetailBackup=null,a.cbbPriceList=null,a.TienGioTrongTuan=null,a.TienGioCuoiTuan_NgayLe=null,a.NgayLeList=null,a.ItemCategoryList=null,a.AddOn=f.AddOn,a.gridOptions={data:[],id:"grid_NgayLe",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!1,showDelete:!1,showpaging:!0,columnDefs:[{field:"NgayLe",display:"Ngày lễ",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"GhiChu",display:"Ghi chú",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=12,a.maxSize=3,a.listPageSize=[15,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){g()}),a.btnSavePriceList=function(){f.showloading(),f.Post("SavePriceList",a.PriceList,f.url).then(function(b){0==b.data.Status.StatusCode?(a.PriceList=b.data.Data,a.cbbPriceList=b.data.Data10,0===a.PriceDetail.length&&h()):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnSavePriceDetail=function(){f.showloading(),f.Post("SavePriceDetail",a.PriceDetail,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnCreatePrice=function(){var b=((new Date).toJSON(),angular.copy(a.PriceObj));b.Code=(new Date).toJSON(),b.Name="Price"+(a.PriceList.length+1),b.BranchId=f.BranchId,b.CompanyId=f.CompanyId,b.PriceNo=b.Code+b.Name,a.PriceList.push(b)},a.btnDeletePrice=function(b){if(0==b.ID){for(var d=0,g=0;g<a.PriceList.length;g++)if(a.PriceList[g].PriceNo==b.PriceNo){d=g;break}a.PriceList[d].Canceled=1}else{var h=c.instant("CMN_MSG_CONFIRM_DELETE");e.ShowConfirmDialog(h).then(function(c){if(0==c){var d={ID:b.ID,BranchId:f.BranchId,CompanyId:f.CompanyId};f.showloading(),f.Post("Delete",d,f.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY"),a.PriceList=b.data.Data,a.cbbPriceList=b.data.Data10):(e.ShowMessageDialog(b.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})}})}},a.btnSaveTienGioNgayThuong_Click=function(){f.showloading(),f.Post("SaveTienGioNgayThuong",a.TienGioTrongTuan,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnSaveTienGioNgayLe_Click=function(){f.showloading(),f.Post("SaveTienGioCuoiTuanNgayLe",a.TienGioCuoiTuan_NgayLe,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnThemMoiNgayLe_Click=function(){var b={ID:0,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detailNgayLe",b,f.url).then(function(b){a.data=b.data.Data,a.dataid=0}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/GiaLeKaraoke/NgayLeDetail.html",ctrl:"NgayLeDetailCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){1==b&&a.btnSearchNgayLe_Click()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.btnXoaNgayLe_Click=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("DeleteNgayLe",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.NgayLeList.indexOf(b[c]);a.NgayLeList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},a.btnSearchNgayLe_Click=function(){f.showloading();var b={CompanyId:f.CompanyId};f.Post("searchNgayLe",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.NgayLeList=b.data.Data,a.gridOptions.data=a.NgayLeList):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.Item_CategoryId_Change=function(){0===parseFloat(a.Item_CategoryId)?a.PriceDetail=angular.copy(a.PriceDetailBackup):a.PriceDetail=d("filter")(a.PriceDetailBackup,{ItemCategoryId:parseFloat(a.Item_CategoryId)},!0)},h(),a.selectedRow=0,a.setClickedRow=function(b){a.selectedRow=b},a.btnImportPrice=function(){e.ShowDetailFormDialog({data:a.cbbPriceList,tempUrl:"app/components/Master/GiaLeKaraoke/PriceImport.html",ctrl:"GiaLeKaraokeImportCtrl",cssclass:"Modal-width600",focuscontrolid:""}).then(function(a){1===a&&h()})},a.btnExport_Click=function(){f.showloading();var a={CompanyId:f.CompanyId,BranchId:f.BranchId},b="BangGiaBan.xlsx";f.ExportExcel("ExportBangGiaBan",a,f.url,b).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.GiaTriDieuChinh=0,a.DieuChinhGia={Type:0,BangGiaId:0,GiaTriDieuChinh:0},a.btnDieuChinhGia_Click=function(){var b=parseFloat(a.DieuChinhGia.GiaTriDieuChinh),c=a.DieuChinhGia.BangGiaId;if(console.log(c),console.log(a.PriceList),0>=b||void 0===c)return void e.ShowMessageDialog("Vui lòng nhập bảng giá cần thay đổi hoặc giá trị cần điều chỉnh.");for(var d=0;d<=a.PriceDetail.length-1;d++){var f=parseFloat(a.PriceDetail[d][c]);0===parseInt(a.DieuChinhGia.Type)?a.PriceDetail[d][c]=f+f*b/100:1===parseInt(a.DieuChinhGia.Type)?a.PriceDetail[d][c]=f+b:2===parseInt(a.DieuChinhGia.Type)?a.PriceDetail[d][c]=f-f*b/100:3===parseInt(a.DieuChinhGia.Type)&&(a.PriceDetail[d][c]=f-b)}},j()}]),app.controller("GiaLeKaraokeImportCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","GiaLeKaraokeService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){null!=a.priceList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.selectedFile=null,a.msg="";var j=0;a.cbbPriceList=f,a.priceList=[{STT:0,MaHang:"",TenHang:"",DVT:"",Price:0}],a.priceList.length=0,a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportPrice.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnUpload_Click=function(){var b=$("#file").get(0).files;if(0==b.length)h.ShowMessageDialog("Vui lòng chọn file.");else if(0===a.PriceId||void 0===a.PriceId)h.ShowMessageDialog("Vui lòng chọn bảng giá cần import.");else{var c=new FormData;if(c.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),b.length>0)for(var d=0;d<b.length;d++)c.append("UploadedImage"+d,b[d]);c.append("PriceId",a.PriceId),$("#divImportResult").html("Đang thực hiện import bảng giá, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:c,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import bảng giá thành công."),j=1):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.btnCancel=function(a){d.close(j)},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()})}]),app.controller("NgayLeDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","GiaLeKaraokeService","AppDialog",function(a,b,c,d,e,f,g,h){a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.fsavesuccess=0,a.disablecode=!1,a.detail=f,a.btnAddnew=function(b){a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("SaveNgayLe",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),a.form.$setPristine()}}]),app.factory("GiaLePOSService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/BGLePOS/",e}]),app.controller("GiaLePOSCtrl",["$scope","$uibModal","$filter","$translate","$window","AppDialog","GiaLePOSService",function(a,b,c,d,e,f,g){function h(){a.branchList=JSON.parse(e.sessionStorage.branchList);var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40)}function i(){null!=a.PriceListDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function j(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"GiaLePOS"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable;var e=c("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.viewRole=!0,a.PriceListDetail=null,a.PriceListDetailBackup=null,a.PriceListInfo=null,a.selected=0,a.ItemCategoryList=null,a.branchList=[],a.curPriceInfo=null,a.btnSearch=function(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("search",b,g.url).then(function(b){0!=b.data.Status.StatusCode?showAlertMessage(d.instant(b.data.Status.MessageId)):(a.PriceListInfo=b.data.Data2,h(),a.btnBangGia_Click(a.PriceListInfo[0],0))},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnSearch(),a.Price_Change=function(a){a.RowStatus=2},a.btnSavePricePOS=function(){g.showloading();var b=c("filter")(a.PriceListDetail,{RowStatus:2},!0);g.Post("SavePricePos",b,g.url).then(function(a){f.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnShowFormInBarcode_Click=function(){f.ShowDetailFormDialog({data:[],tempUrl:"app/components/Master/GiaLePOS/InBarcode.html",ctrl:"InBarcodeCtrl",cssclass:"Modal-width900",focuscontrolid:""}).then(function(a){})},a.btnImportPrice=function(){f.ShowDetailFormDialog({data:a.PriceListInfo,tempUrl:"app/components/Master/GiaLePOS/ImportGiaLePOS.html",ctrl:"ImportGiaLePOSCtrl",cssclass:"Modal-width700",focuscontrolid:""}).then(function(b){1===b&&a.btnSearch()})},a.btnExport_Click=function(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId,Value01:a.curPriceInfo.ID},c="BangGiaBan.xlsx";g.ExportExcel("ExportBangGiaLePOS",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnAddOrEditBangGia_Click=function(b){var c={ID:null===b?0:b.ID,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(b){a.data=b.data.Data,a.dataid=a.data.ID}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/GiaLePOS/GiaLePOSDetail.html",ctrl:"GiaLePOSDetailCtrl",cssclass:"Modal-width500",focuscontrolid:"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.Item_CategoryId_Change=function(){0===parseFloat(a.Item_CategoryId)?a.PriceListDetail=angular.copy(a.PriceListDetailBackup):a.PriceListDetail=c("filter")(a.PriceListDetailBackup,{ItemCategoryId:parseFloat(a.Item_CategoryId)},!0)},a.btnBangGia_Click=function(b,c){a.selected=c,a.curPriceInfo=b;var e={CompanyId:g.CompanyId,BranchId:g.BranchId,ID:b.ID};g.showloading(),g.Post("GetDetailBangGiaLePosById",e,g.url).then(function(b){0!=b.data.Status.StatusCode?showAlertMessage(d.instant(b.data.Status.MessageId)):(a.PriceListDetail=JSON.parse(b.data.Data),a.PriceListDetailBackup=angular.copy(a.PriceListDetail),a.ItemCategoryList=b.data.Data2,i())},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnAssign_PriceForBranch_Click=function(){f.ShowDetailFormDialog({data:{},tempUrl:"app/components/Master/GiaLePOS/ThietLapBangGiaChiNhanh.html",ctrl:"ThietLapBangGiaChiNhanhCtrl",cssclass:"Modal-width1000",focuscontrolid:""}).then(function(a){1===a.status})},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=15,a.maxSize=3,a.listPageSize=[10,15,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()}),j()}]),app.controller("InBarcodeCtrl",["$scope","$http","$timeout","$filter","$uibModalInstance","$translate","data","GiaLePOSService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.showloading();var b={CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("InitBarcode",b,h.url).then(function(b){a.ItemCategoryList=b.data.Data,a.ItemList=b.data.Data2,a.BarcodeObj=b.data.Data3,a.PriceList=b.data.Data4},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}a.ListBarcode=g,a.ItemCategoryList=null,a.ItemList=null,a.BarcodeObj=null,a.PriceList=null,a.ItemCategoryId=0,a.ItemId=0,a.ItemOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},j(),a.btnAddRowGrid=function(){var b=[];if(b=0===a.ItemCategoryId?angular.copy(a.ItemList):d("filter")(a.ItemList,{Field6:a.ItemCategoryId.toString()},!0),parseFloat(a.ItemId)>0&&(b=d("filter")(a.ItemList,{ID:parseFloat(a.ItemId)},!0)),b.length>0)for(var c=0;c<=b.length-1;c++)if(b[c].ID>0){var e=angular.copy(a.BarcodeObj);a.priceItem=0;var f=d("filter")(a.PriceList,{ItemId:b[c].ID,UnitId:parseFloat(b[c].Field3)},!0);f.length>0&&(a.priceItem=f[0].Price);var g=d("filter")(a.ListBarcode,{MaBarcode:b[c].Code,UnitId:parseFloat(b[c].Field3)},!0);0===g.length&&(e.isChecked=1,e.MaHang=b[c].Code,e.TenHang=b[c].Name,e.DVT=b[c].Field4,e.GiaBanLe=a.priceItem,e.SoLuongTem=1,e.MaBarcode=b[c].Code,e.UnitId=parseFloat(b[c].Field3),a.ListBarcode.push(e))}},a.btnRemoveRow_Click=function(b){a.ListBarcode.splice(a.ListBarcode.indexOf(b),1)},a.btnInBarcode_Click=function(b){(null===b||void 0===b)&&(b=0),0===a.ListBarcode.length?i.ShowMessageDialog("Vui lòng nhập hàng hóa trước khi In Barcode."):(h.showloading(),h.Post("InBarcode",a.ListBarcode,h.url).then(function(a){""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"IN BARCODE","width=600,height=650").print())},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()}))},a.btnCancel=function(){e.dismiss("cancel")}}]),app.controller("ImportGiaLePOSCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","GiaLePOSService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){null!=a.priceList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.selectedFile=null,a.msg="";var j=0;a.cbbPriceList=f,a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportPrice_POS.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnUpload_Click=function(){var b=$("#file").get(0).files;if(0==b.length)h.ShowMessageDialog("Vui lòng chọn file.");else if(0===a.PriceId||void 0===a.PriceId)h.ShowMessageDialog("Vui lòng chọn bảng giá cần import.");else{var c=new FormData;if(c.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),b.length>0)for(var d=0;d<b.length;d++)c.append("UploadedImage"+d,b[d]);c.append("PriceId",a.PriceId),$("#divImportResult").html("Đang thực hiện import bảng giá, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"ImportBangGiaLePOS/",contentType:!1,processData:!1,data:c,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import bảng giá thành công."),j=1):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.btnCancel=function(a){d.close(j)},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()})}]),app.controller("GiaLePOSDetailCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","GiaLePOSService","AppDialog",function(a,b,c,d,e,f,g,h){a.dataCopy=angular.copy(f),a.listPrinter=null,a.success=!1,a.submitted=!1,a.fsavesuccess=0,a.disablecode=!1,a.detail=f,a.btnAddnew=function(b){if(1==b||1==b)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var d={CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",d,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),c(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){
a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("SavePriceInfoPos",a.detail,g.url).then(function(c){var e=c.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):d.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){d.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),document.getElementById("Name").focus(),a.form.$setPristine()},a.btnDelete=function(){h.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(b){0==b&&(g.showloading(),g.Post("DeletePriceInfoPOS",a.detail,g.url).then(function(b){var c=b.data.Status;0==c.StatusCode?h.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){d.close(1)}):(h.ShowMessageDialog(c.MessageId),a.success=!1)},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})}}]),app.controller("ThietLapBangGiaChiNhanhCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$window","data","GiaLePOSService","AppDialog",function(a,b,c,d,e,f,g,h,j){function k(b){h.showloading();var c={CompanyId:h.CompanyId,BranchId:b.ID};h.Post("GetListRelationPriceInfoPosMapBranch",c,h.url).then(function(b){0===b.data.Status.StatusCode?a.RelationPriceList=b.data.Data:j.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}function l(){a.branchList.length>0&&a.btnBranch_Click(a.branchList[0],0)}a.branchList=[],a.branchList=JSON.parse(f.sessionStorage.branchList),a.RelationPriceList=[],a.selectedRowBranch=0,a.btnBranch_Click=function(b,c){a.selectedRowBranch=c,k(b),a.msgChiTietBangGiaChiNhanh=b.Name},a.chkIsUsed_Change=function(b){if(1===parseInt(b.IsUsed))for(i=0;i<=a.RelationPriceList.length-1;i++)a.RelationPriceList[i].Id!==b.Id&&(a.RelationPriceList[i].IsUsed=0)},a.btnCancel=function(){c.close({status:0})},l(),a.btnSave_Click=function(){h.showloading(),h.Post("UpdateRelationPriceInfoPosMapBranch",a.RelationPriceList,h.url).then(function(a){var b=a.data.Status;j.ShowMessageDialog(b.MessageId)},function(b){a.success=!1,j.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}}]),app.factory("GroupShipperServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/GroupShipper/",e}]),app.controller("GroupShipperCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","GroupShipperServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"GroupShipper"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_GroupShipper",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Mã",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Tên",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Mô tả",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/GroupShipper/GroupShipperDetail.html",ctrl:"GroupShipperDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("GroupShipperDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","GroupShipperServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"GroupShipper"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("ItemService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Item/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ItemCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","ItemService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitItemSearch",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.ItemCategoryList=b.data.Data,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Item"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable);var h=e("filter")(b,{ActionCode:"Import"},!0)[0];$("#btnImport").prop("disabled",void 0===h?!0:!h.IsEnable);var i=e("filter")(b,{ActionCode:"Export"},!0)[0];$("#btnExport").prop("disabled",void 0===i?!0:!i.IsEnable)}else a.viewRole=!1}}a.ItemCategoryList=null,a.searhResultList=null,a.viewRole=!0,a.TypeHangHoa=1,a.TypeThanhPham=1,a.TypeNguyenVatLieu=1,a.SuDung=1,a.KhongSuDung=0,a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"ITEM_LABEL_CODE",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"ITEM_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UnitName",display:"ITEM_LABEL_UNIT",headerclass:"text-align-center col-w-50px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Item_CategoryName",display:"ITEM_LABEL_CATEGORY",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"ItemTypeName",display:"Loại hàng",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UnitPrice",display:"Giá bán",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:"002"===g.LoaiHinhKinhDoanh?!1:!0},{field:"Note",display:"ITEM_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Item_CategoryId:a.Item_CategoryId,CompanyId:g.CompanyId,TypeHangHoa:a.TypeHangHoa,TypeThanhPham:a.TypeThanhPham,TypeNguyenVatLieu:a.TypeNguyenVatLieu,SuDung:a.SuDung,KhongSuDung:a.KhongSuDung};g.Post("Search",b,g.url).then(function(b){0!=b.data.Status.StatusCode?f.ShowMessageDialog(b.data.Status.MessageId):(a.searhResultList=JSON.parse(b.data.Data),a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult")))},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",a.Item_CategoryId=0,a.TypeHangHoa=1,a.TypeThanhPham=1,a.TypeNguyenVatLieu=1,$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Item/ItemDetail.html",ctrl:"ItemDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("Deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnImportData=function(){f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Item/ItemImportData.html",ctrl:"ItemImportDataCtrl",cssclass:"Modal-width500",focuscontrolid:""})},h(),a.btnExport_Click=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Item_CategoryId:a.Item_CategoryId,CompanyId:g.CompanyId,TypeHangHoa:a.TypeHangHoa,TypeThanhPham:a.TypeThanhPham,TypeNguyenVatLieu:a.TypeNguyenVatLieu},c="DanhSachHangHoa.xlsx";g.ExportExcel("Export",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},j()}]),app.controller("ItemDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","ItemService","AppDialog","fileReader",function(a,b,c,d,e,f,g,h,i){function j(){g.showloading(),g.Post("InitItemDetail",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.UnitList=b.data.Data2,a.ItemCategoryList=b.data.Data,a.itemCategoryModels=b.data.Data3,a.unitModels=b.data.Data4,a.LocationList=b.data.Data5,a.HangHoaThanhPhamList=b.data.Data6,l()},function(a){})["finally"](function(){g.closeloading()})}function k(b){g.showloading();var c={CompanyId:g.CompanyId,BranchId:g.BranchId,MasterType:b};g.Post("reloadMasterPlus",c,g.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?h.ShowMessageDialog(b.data.Status.MessageId):"ItemCategory"===b.data.Status.ObjData?a.ItemCategoryList=b.data.Data:"UnitOfMeasure"===b.data.Status.ObjData&&(a.UnitList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function l(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function m(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Item"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.itemCategoryModels=null,a.unitModels=null,a.LocationList=null,a.HangHoaThanhPhamList=null,a.UnitList=null,a.ItemCategoryList=null,a.AddOn=g.AddOn,a.imageSrc="",a.showUnitPrice="002"===g.LoaiHinhKinhDoanh?!1:!0,a.isShowCombo=!1,("814c4f73-f15b-454e-b37f-0bc2bc4e4cda"===g.BranchId||"000e9c5d-44b8-4b85-8741-01ae8d83d951"===g.BranchId)&&(a.isShowCombo=!0),a.ComboObj={Id:0,ParentId:0,ItemId:0,UnitId:0,Qty:0,Price:0,BranchId:"",CompanyId:"",IsDeleted:0},a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0,a.imageSrc=f.ImgPath),a.btnAddnew=function(c){if(c===!0||1===c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e=a.detail,f={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",f,g.url).then(function(b){0==b.data.Status.StatusCode?(a.detail=b.data.Data,null!==e&&(a.detail.Item_CategoryId=e.Item_CategoryId,a.detail.UnitBasic=e.UnitBasic,a.detail.Item_Type=e.Item_Type,a.detail.AddOn=e.AddOn,a.AllowSelectedSize=e.AllowSelectedSize,a.ShowChooseAddOn=e.ShowChooseAddOn)):h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){if(a.submitted=!0,0!==a.detail.Item_Type&&(a.detail.SellLocationId=0),null!=a.detail&&(0==a.detail.UnitBasic&&(a.detail.UnitBasic=null,a.form.$valid=!1),0==a.detail.Item_CategoryId&&(a.detail.Item_CategoryId=null,a.form.$valid=!1)),a.files=[],a.form.$valid){a.iserror=!1,a.detail.CompanyId=g.CompanyId;var d=$("#file1").get(0).files,e=new FormData;if(e.append("jsonData",angular.toJson(a.detail)),d.length>0){for(var f=0;f<d.length;f++)e.append("UploadedImage"+f,d[f]);g.showloading(),$.ajax({type:"POST",url:g.url+"SaveAndUpload/",contentType:!1,processData:!1,data:e,headers:{Authorization:"Bearer "+g.accessToken},success:function(d){var e=d.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},error:function(a,b,c){console.log(a.statusText),console.log(b),console.log(c)}}),g.closeloading()}else g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})}},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("Code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("Code").focus():document.getElementById("Name").focus(),a.form.$setPristine()},a.chkAddOn_Changed=function(){1===a.detail.AddOn&&(a.detail.ShowChooseAddOn=0)},a.chkShowChooseAddOn_Changed=function(){1===a.detail.ShowChooseAddOn&&(a.detail.AddOn=0)},a.radItem_Type_Change=function(){},a.btnItemCategoryPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.itemCategoryModels),tempUrl:"app/components/Master/ItemCategory/ItemCategoryDetail.html",ctrl:"ItemCategoryDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&k("ItemCategory")})},a.btnUnitPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.unitModels),tempUrl:"app/components/Master/UnitOfMeasure/UnitOfMeasureDetail.html",ctrl:"UnitOfMeasureDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&k("UnitOfMeasure")})},a.btnThemHangHoa_Click=function(){parseFloat(a.ComboObj.ItemId)<=0&&h.ShowMessageDialog("Vui lòng chọn hàng hóa");var b=angular.copy(a.ComboObj),c=e("filter")(a.detail.ItemComboList,{ParentId:a.detail.Id,ItemId:parseFloat(a.ComboObj.ItemId),IsDeleted:0},!0);0===c.length&&(b.ParentId=a.detail.Id,b.ItemId=parseFloat($("#ItemId").attr("aaid")),b.ItemCode=$("#ItemId").attr("aacode"),b.ItemName=$("#ItemId").attr("aaname"),b.UnitId=parseFloat($("#ItemId").attr("aafield3")),b.Qty=1,b.Price=0,b.IsDeleted=0,b.BranchId=g.BranchId,b.CompanyId=g.CompanyId,b.RowStatus=1,a.detail.ItemComboList.push(b))},a.btnDeleteItem_Click=function(a){a.IsDeleted=1,a.RowStatus=3},a.Qty_Change=function(a){parseFloat(a.Id)>0&&(a.RowStatus=2)},a.Price_Change=function(a){parseFloat(a.Id)>0&&(a.RowStatus=2)},j(),a.$on("fileProgress",function(b,c){a.progress=c.loaded/c.total}),a.btnDeleteImage_Click=function(){$("#itemImage").prop("src","")},b(function(){m()},50)}]),app.controller("ItemImportDataCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","ItemService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){null!=a.itemList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.selectedFile=null,a.msg="",a.itemList=[{STT:0,MaHang:"",TenHang:"",DVT:"",NhomHang:"",TenNhomHang:"",TonToiThieu:0,TonToiDa:0,LoaiHang:0}],a.itemList.length=0,a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(b.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện import hàng hóa, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import hàng hóa thành công.")):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportHangHoa.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.dismiss("cancel")},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()})}]),app.factory("ItemCategoryServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/ItemCategory/",e}]),app.controller("ItemCategoryCtrl",["$scope","$uibModal","$translate","$filter","$window","AppDialog","ItemCategoryServices",function(a,b,c,d,e,f,g){function h(){a.branchList=JSON.parse(e.sessionStorage.branchList);var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function i(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"ItemCategory"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var f=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.branchList=[],a.gridOptions={data:[],id:"grid_ItemCategory",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"ITEM_CATEGORY_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"ITEM_CATEGORY_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"ITEM_CATEGORY_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:g.CompanyId};g.Post("search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/ItemCategory/ItemCategoryDetail.html",ctrl:"ItemCategoryDetailCtrl",cssclass:"Modal-width500",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnAssign_CategoryForBranch_Click=function(){f.ShowDetailFormDialog({data:{},tempUrl:"app/components/Master/ItemCategory/PhanNhom_NhomHangChoChiNhanh.html",ctrl:"PhanNhom_NhomHangChoChiNhanhCtrl",cssclass:"Modal-width1000",focuscontrolid:""}).then(function(a){1===a.status})},h(),i()}]),app.controller("ItemCategoryDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","ItemCategoryServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"ItemCategory"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.listPrinter=null,a.success=!1,a.submitted=!1,a.LoaiPM=g.MaNganh,a.fsavesuccess=0,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.controller("PhanNhom_NhomHangChoChiNhanhCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$window","data","ItemCategoryServices","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b){h.showloading();var c={CompanyId:h.CompanyId,BranchId:b.ID};h.Post("search",c,h.Url+"api/RelationItemCategoryPrinter/").then(function(b){0===b.data.Status.StatusCode?a.CategoryList=b.data.Data:i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}function k(){a.branchList.length>0&&a.btnBranch_Click(a.branchList[0],0)}a.branchList=[],a.branchList=JSON.parse(f.sessionStorage.branchList),a.CategoryList=[],a.selectedRowBranch=0,a.btnBranch_Click=function(b,c){a.selectedRowBranch=c,j(b),a.msgChiTietPhanQuyenChiNhanh=b.Name},a.btnCancel=function(){c.close({status:0})},k(),a.btnSave_Click=function(){h.showloading(),h.Post("UpdateUseCategoryWithBranch",a.CategoryList,h.Url+"api/RelationItemCategoryPrinter/").then(function(a){var b=a.data.Status;i.ShowMessageDialog(b.MessageId)},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}}]),app.factory("ItemPOSService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Item/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ItemPOSCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","ItemPOSService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitItemSearch",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.ItemCategoryList=b.data.Data,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Item"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable);var h=e("filter")(b,{ActionCode:"Import"},!0)[0];$("#btnImport").prop("disabled",void 0===h?!0:!h.IsEnable);var i=e("filter")(b,{ActionCode:"Export"},!0)[0];$("#btnExport").prop("disabled",void 0===i?!0:!i.IsEnable)}else a.viewRole=!1}}a.ItemCategoryList=null,a.searhResultList=null,a.viewRole=!0,a.TypeHangHoa=1,a.TypeThanhPham=1,a.TypeNguyenVatLieu=1,a.SuDung=1,a.KhongSuDung=0,a.gridOptions={data:[],id:"grid_ItemPOS",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"ITEM_LABEL_CODE",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"ITEM_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UnitName",display:"ITEM_LABEL_UNIT",headerclass:"text-align-center col-w-50px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Item_CategoryName",display:"ITEM_LABEL_CATEGORY",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"UnitPrice",display:"Giá bán lẻ",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Note",display:"ITEM_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Item_CategoryId:a.Item_CategoryId,CompanyId:g.CompanyId,LoaiPM:g.MaNganh,SuDung:a.SuDung,KhongSuDung:a.KhongSuDung};g.Post("Search",b,g.url).then(function(b){0!=b.data.Status.StatusCode?f.ShowMessageDialog(b.data.Status.MessageId):(a.searhResultList=JSON.parse(b.data.Data),a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult")))},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",a.Item_CategoryId=0,$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/ItemPOS/ItemPOSDetail.html",ctrl:"ItemPOSDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){
var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("Deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnImportData=function(){f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/ItemPOS/ItemPOSImportData.html",ctrl:"ItemPOSImportDataCtrl",cssclass:"Modal-width500",focuscontrolid:""})},h(),a.btnExport_Click=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Item_CategoryId:a.Item_CategoryId,CompanyId:g.CompanyId},c="DanhSachHangHoa.xlsx";g.ExportExcel("Export",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},j()}]),app.controller("ItemPOSDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","ItemPOSService","AppDialog","fileReader",function(a,b,c,d,e,f,g,h,i){function j(){g.showloading(),g.Post("InitItemDetail",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.UnitList=b.data.Data2,a.ItemCategoryList=b.data.Data,a.itemCategoryModels=b.data.Data3,a.unitModels=b.data.Data4,a.ItemCategoryOptions.setValue=a.detail.Item_CategoryId,l()},function(a){})["finally"](function(){g.closeloading()})}function k(b){g.showloading();var c={CompanyId:g.CompanyId,BranchId:g.BranchId,MasterType:b};g.Post("reloadMasterPlus",c,g.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?h.ShowMessageDialog(b.data.Status.MessageId):"ItemCategory"===b.data.Status.ObjData?a.ItemCategoryList=b.data.Data:"UnitOfMeasure"===b.data.Status.ObjData&&(a.UnitList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function l(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function m(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Item"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.itemCategoryModels=null,a.unitModels=null,a.UnitList=null,a.ItemCategoryList=null,a.AddOn=0,a.imageSrc="",a.ItemCategoryOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0,a.imageSrc=f.ImgPath),a.btnAddnew=function(c){if(c===!0||1===c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e=a.detail,f={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",f,g.url).then(function(b){0==b.data.Status.StatusCode?(a.detail=b.data.Data,a.detail.AllowEditUnitBasic=1,null!==e&&(a.detail.Item_CategoryId=e.Item_CategoryId,a.detail.UnitBasic=e.UnitBasic,a.detail.Item_Type=e.Item_Type,a.detail.AddOn=e.AddOn,a.AllowSelectedSize=e.AllowSelectedSize,a.ShowChooseAddOn=e.ShowChooseAddOn)):h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){if(a.submitted=!0,null!=a.detail&&(0==a.detail.UnitBasic&&(a.detail.UnitBasic=null,a.form.$valid=!1),0==a.detail.Item_CategoryId&&(a.detail.Item_CategoryId=null,a.form.$valid=!1)),a.files=[],a.form.$valid){a.iserror=!1,a.detail.CompanyId=g.CompanyId;var d=$("#file1").get(0).files,e=new FormData;if(e.append("jsonData",angular.toJson(a.detail)),d.length>0){for(var f=0;f<d.length;f++)e.append("UploadedImage"+f,d[f]);g.showloading(),$.ajax({type:"POST",url:g.url+"SaveAndUpload/",contentType:!1,processData:!1,data:e,headers:{Authorization:"Bearer "+g.accessToken},success:function(d){var e=d.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},error:function(a,b,c){console.log(a.statusText),console.log(b),console.log(c)}}),g.closeloading()}else g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})}},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("Code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("Code").focus():document.getElementById("Name").focus(),a.form.$setPristine()},a.chkAddOn_Changed=function(){1===a.detail.AddOn&&(a.detail.ShowChooseAddOn=0)},a.chkShowChooseAddOn_Changed=function(){1===a.detail.ShowChooseAddOn&&(a.detail.AddOn=0)},a.btnItemCategoryPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.itemCategoryModels),tempUrl:"app/components/Master/ItemCategory/ItemCategoryDetail.html",ctrl:"ItemCategoryDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&k("ItemCategory")})},a.btnUnitPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.unitModels),tempUrl:"app/components/Master/UnitOfMeasure/UnitOfMeasureDetail.html",ctrl:"UnitOfMeasureDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&k("UnitOfMeasure")})},j(),b(function(){var b=$("[name='UnitBasic'] option:selected").text();a.detail.UnitName=b},300),a.btnAddUnit_Click=function(){var b={Id:0,ItemId:0,UnitId:0,HeSoQuyDoi:0,Barcode:"",Note:"",CompanyId:"",ItemName:"",UnitName:"",RowStatus:1,IsDeleted:0,IsExistTransaction:!1};a.detail.ItemUnitConvertList.push(b)},a.RowUnit_Change=function(b){parseFloat(b.Id)>0&&(b.RowStatus=2);var c=e("filter")(a.UnitList,{ID:b.UnitId},!0);c.length>0&&(b.UnitName=c[0].Name)},a.btnDeleteItem_Click=function(a){a.IsExistTransaction===!1&&(a.IsDeleted=1,a.RowStatus=3)},a.UnitBasic_Change=function(){var b=$("[name='UnitBasic'] option:selected").text();a.detail.UnitName=b},a.$on("fileProgress",function(b,c){a.progress=c.loaded/c.total}),a.btnDeleteImage_Click=function(){$("#itemImage").prop("src","")},b(function(){m()},50)}]),app.controller("ItemPOSImportDataCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","ItemPOSService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){null!=a.itemList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.selectedFile=null,a.msg="",a.itemList=[{STT:0,MaHang:"",TenHang:"",DVT:"",NhomHang:"",TenNhomHang:"",TonToiThieu:0,TonToiDa:0,LoaiHang:0}],a.itemList.length=0,a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(b.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện import hàng hóa, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import hàng hóa thành công.")):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportHangHoa.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.dismiss("cancel")},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()})}]),app.factory("LoaiPhongService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/LoaiPhong/",e.urlTable=e.Url+"api/SaleTable/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("LoaiPhongCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","LoaiPhongService",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){a.MinuteList=[{value:0,displayName:"00"},{value:5,displayName:"05"},{value:10,displayName:"10"},{value:15,displayName:"15"},{value:20,displayName:"20"},{value:25,displayName:"25"},{value:30,displayName:"30"},{value:35,displayName:"35"},{value:40,displayName:"40"},{value:45,displayName:"45"},{value:50,displayName:"50"},{value:55,displayName:"55"}],a.HourList=[{value:0,displayName:"00"},{value:1,displayName:"01"},{value:2,displayName:"02"},{value:3,displayName:"03"},{value:4,displayName:"04"},{value:5,displayName:"05"},{value:6,displayName:"06"},{value:7,displayName:"07"},{value:8,displayName:"08"},{value:9,displayName:"09"},{value:10,displayName:"10"},{value:11,displayName:"11"},{value:12,displayName:"12"},{value:13,displayName:"13"},{value:14,displayName:"14"},{value:15,displayName:"15"},{value:16,displayName:"16"},{value:17,displayName:"17"},{value:18,displayName:"18"},{value:19,displayName:"19"},{value:20,displayName:"20"},{value:21,displayName:"21"},{value:22,displayName:"22"},{value:23,displayName:"23"}]}function i(){null!=a.bangGiaPhongList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function j(){null!=a.PriceDetail&&(a.beginHH=(a.currentPageHH-1)*a.itemsPerPageHH,a.endHH=a.beginHH+a.itemsPerPageHH)}a.searhResultList=null,a.viewRole=!0,a.tableList=null,a.bangGiaPhongList=null,a.PriceList=null,a.PriceDetail=null,a.CauHinhGiaPhong=null,a.MinuteList=null,a.HourList=null,a.LoaiHinhKinhDoanh=f.LoaiHinhKinhDoanh,a.gridOptions={data:[],id:"grid_LoaiPhong",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Name",display:"Loại phòng",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"SALE_AREA_LABEL_NOTE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.gridOptionsTable={data:[],id:"grid_Table",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"AreaName",display:"Loại phòng",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Số phòng",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"SALE_AREA_LABEL_NOTE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,a.tableList=b.data.Data2,a.gridOptionsTable.data=a.tableList,a.bangGiaPhongList=b.data.Data3,i(),a.PriceList=b.data.Data4,a.PriceDetail=b.data.Data5,j(),a.CauHinhGiaPhong=b.data.Data6,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/LoaiPhong/LoaiPhongDetail.html",ctrl:"LoaiPhongDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},a.btnAddOrEditTable=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.urlTable).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/LoaiPhong/TableDetail.html",ctrl:"TableDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridTableEditData=function(b){a.btnAddOrEditTable(b.ID)},a.btnDeleteTableList=function(){var b=a.gridOptionsTable.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.urlTable).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.tableList.indexOf(b[c]);a.tableList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},a.btnSaveBangGiaPhong_Click=function(){f.showloading(),f.Post("SaveBangGiaPhong",a.bangGiaPhongList,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},g(),h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[15,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()}),a.beginHH=0,a.endHH=0,a.currentPageHH=1,a.itemsPerPageHH=10,a.maxSize=3,a.listPageSize=[15,30,50,100,200],a.pageChangedHH=function(b){a.currentPageHH=b},a.itemsPerPageChangedHH=function(b){a.currentPageHH=1,a.itemsPerPageHH=b},a.$watch("currentPageHH + itemsPerPageHH",function(){j()}),a.btnImportPrice=function(){e.ShowDetailFormDialog({data:a.PriceList,tempUrl:"app/components/Master/GiaLeKaraoke/PriceImport.html",ctrl:"GiaLeKaraokeImportCtrl",cssclass:"Modal-width600",focuscontrolid:""}).then(function(b){1===b&&a.btnSearch()})},a.btnSavePriceDetail=function(){f.showloading(),f.Post("SavePriceDetail",a.PriceDetail,f.Url+"api/Price/").then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnSaveCauHinhGiaPhong_Click=function(){f.showloading(),f.Post("SaveCauHinhGiaPhong",a.CauHinhGiaPhong,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}}]),app.controller("LoaiPhongDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","LoaiPhongService","AppDialog",function(a,b,c,d,e,f,g,h){a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.fsavesuccess=0,a.disablecode=!1,a.detail=f,a.LoaiHinhKinhDoanh=g.LoaiHinhKinhDoanh,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){1==c||1==c?null!=a.detail&&(a.detail.Id=0,a.detail.Code="",a.detail.Name=""):(a.detail.ID=0,a.detail.Code="",a.detail.Name="",a.detail.Note=""),a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("name").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),document.getElementById("name").focus(),a.form.$setPristine()}}]),app.controller("TableDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","data","LoaiPhongService","AppDialog",function(a,b,c,d,e,f,g){function h(){f.showloading(),f.Post("InitTableDetail",{CompanyId:f.CompanyId,BranchId:f.BranchId},f.urlCombobox).then(function(b){a.LoaiPhongList=b.data.Data,console.log(a.LoaiPhongList)},function(a){})["finally"](function(){f.closeloading()})}a.dataCopy=angular.copy(e),a.success=!1,a.submitted=!1,a.LoaiPhongList=null,a.fsavesuccess=0,a.disablecode=!1,a.detail=e,e.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){1==c||1==c?null!=a.detail&&(a.detail.ID=0,a.detail.Code=""):(a.detail.ID=0,a.detail.Code="",a.detail.Name="",a.detail.Note=""),a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("name").focus()},50)},a.btnSave=function(b){a.submitted=!0,null!=a.detail&&0===a.detail.AreaId&&(a.detail.AreaId=null,a.form.$valid=!1),a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=f.CompanyId,a.detail.BranchId=f.BranchId,f.showloading(),f.Post("Save",a.detail,f.urlTable).then(function(d){var e=d.data.Status;0==e.StatusCode?g.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,g.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},h()}]),app.factory("LocationStoreServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/LocationStore/",e}]),app.controller("LocationStoreCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","LocationStoreServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"LocationStore"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_LocationStore",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"LOCATION_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"LOCATION_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"LOCATION_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/LocationStore/LocationStoreDetail.html",ctrl:"LocationStoreDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("LocationStoreDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","LocationStoreServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"LocationStore"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("NganQuyService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/BankAccount/",e}]),app.controller("NganQuyCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","NganQuyService",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"BankAccount"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_NganQuy",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Mã ngân quỹ",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Tên ngân quỹ",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Mô tả",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/NganQuy/NganQuyDetail.html",ctrl:"NganQuyDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("NganQuyDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","NganQuyService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"BankAccount"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("PartnerServices",["$q","$http","AppServices",function(a,b,c){var d=Object.create(c);return d.url="api/Partner/",d}]),app.controller("PartnerController",["$scope","$rootScope","$uibModal","$translate","AppDialog","PartnerServices",function(a,b,c,d,e,f){a.messageresult="",a.gridOptions={data:[],id:"grid_Partner",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"PARTNER_LABEL_CODE",headerclass:"text-align-center",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"PARTNER_LABEL_NAME",headerclass:"text-align-center",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"ApplyDate",display:"PARTNER_LABEL_APPLYDATE",headerclass:"text-align-center",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"PARTNER_LABEL_NOTE",headerclass:"text-align-center",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.fnSearch=function(){f.showloading(),console.log("Partner_fnSearch:"+a.Code);var b={Code:a.Code,Name:a.Name};f.search(b,f.url).then(function(b){a.gridOptions.data=b.data,a.gridOptions.reloaddata=1,a.messageresult=b.data.length+d.instant("CMN_SearchResult"),a.loading=!0},function(b){a.messageresult=d.instant("CMN_MSG_ERROR"),console.log("Partner_fnSearch:"+b.data.ExceptionMessage)})["finally"](function(){f.closeloading()})},a.fnAddOrEdit=function(b){f.dataDetail(b,f.url).then(function(c){a.data=c.data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({
data:a.data,tempUrl:"app/components/Master/Partner/PartnerDetail.html",ctrl:"PartnerUpdateController",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR"),console.log("Partner_fnAddOrEdit:"+a.data.ExceptionMessage)})},a.EditData=function(b){a.fnAddOrEdit(b.ID)},a.DeleteData=function(a){},a.fnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&f.deletelist(b,f.url).then(function(b){var c=JSON.parse(b.data);0==c.returnCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY"):(a.success=!1,a.messageresult=d.instant(b.data.returnMessage))},function(b){a.success=!1,a.messageresult=d.instant("CMN_MSG_ERROR"),console.log("Partner_fnDeleteList:"+b.data.ExceptionMessage)})})},b.$on("PartnerSearch",function(b,c){a.fnSearch()}),b.$on("PartnerAdd",function(b,c){a.fnAddOrEdit(0)})}]),app.controller("PartnerUpdateController",["$scope","$rootScope","$timeout","$uibModalInstance","$translate","data","PartnerServices","AppDialog",function(a,b,c,d,e,f,g,h){a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.messageupdate="",a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.fnAddnew=function(b){1==b||1==b?null!=a.detail&&(a.detail.ID=0,a.detail.Code=""):a.detail=null,a.success=!1,a.submitted=!1,a.messageupdate="",a.disablecode=!1,a.dataCopy=angular.copy(a.detail),c(function(){document.getElementById("code").focus()},50)},a.fnSave=function(c){a.submitted=!0,a.form.$valid&&(a.iserror=!1,g.Save(a.detail,g.url).then(function(f){var g=JSON.parse(f.data);0==g.returnCode?h.ShowMessageDialog("CMN_MSG_SAVE_SUCESSFULLY").then(function(){1==c||1==c?a.fnAddnew(0):(d.dismiss("cancel"),b.$emit("PartnerSearch"))}):(a.success=!1,a.messageupdate=e.instant(f.data.returnMessage))},function(b){a.success=!1,a.messageupdate=e.instant("CMN_MSG_ERROR"),console.log("Partner_fnSave:"+b.data.ExceptionMessage)}))},a.fnCancel=function(){d.dismiss("cancel")},a.reset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()}}]),app.factory("PriceService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Price/",e}]),app.controller("PriceCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","PriceService",function(a,b,c,d,e,f){function g(){null!=a.PriceDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function h(){f.showloading();var b={BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){a.PriceList=b.data.Data,a.PriceObj=b.data.Data2,a.PriceDetail=JSON.parse(b.data.Data3),a.PriceDetailBackup=angular.copy(a.PriceDetail),a.cbbPriceList=b.data.Data10,a.ItemCategoryList=b.data.Data11,i(),g()},function(b){a.PriceList=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function i(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function j(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"PriceList"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Import"},!0)[0];$("#btnImport").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave01").prop("disabled",void 0===g?!0:!g.IsEnable),$("#btnSave02").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.viewRole=!0,a.PriceList=null,a.PriceObj=null,a.PriceDetail=null,a.PriceDetailBackup=null,a.cbbPriceList=null,a.ItemCategoryList=null,a.AddOn=f.AddOn,a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=15,a.maxSize=3,a.listPageSize=[15,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){g()}),a.gridOptions01={data:[],id:"grid_Price01",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"SALE_AREA_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"SALE_AREA_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"SALE_AREA_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.gridOptions02={data:[],id:"grid_Price02",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"SALE_AREA_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"SALE_AREA_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"SALE_AREA_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/SaleArea/SaleAreaDetail.html",ctrl:"SaleAreaDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.btnSavePriceList=function(){f.showloading(),f.Post("SavePriceList",a.PriceList,f.url).then(function(b){0==b.data.Status.StatusCode?(a.PriceList=b.data.Data,a.cbbPriceList=b.data.Data10,0===a.PriceDetail.length&&h()):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnSavePriceDetail=function(){f.showloading(),f.Post("SavePriceDetail",a.PriceDetail,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnCreatePrice=function(){var b=((new Date).toJSON(),angular.copy(a.PriceObj));b.Code=(new Date).toJSON(),b.Name="Price"+(a.PriceList.length+1),b.BranchId=f.BranchId,b.CompanyId=f.CompanyId,b.PriceNo=b.Code+b.Name,a.PriceList.push(b)},a.btnDeletePrice=function(b){if(0==b.ID){for(var d=0,g=0;g<a.PriceList.length;g++)if(a.PriceList[g].PriceNo==b.PriceNo){d=g;break}a.PriceList[d].Canceled=1}else{var h=c.instant("CMN_MSG_CONFIRM_DELETE");e.ShowConfirmDialog(h).then(function(c){if(0==c){var d={ID:b.ID,BranchId:f.BranchId,CompanyId:f.CompanyId};f.showloading(),f.Post("Delete",d,f.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY"),a.PriceList=b.data.Data,a.cbbPriceList=b.data.Data10):(e.ShowMessageDialog(b.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})}})}},a.Item_CategoryId_Change=function(){0===parseFloat(a.Item_CategoryId)?a.PriceDetail=angular.copy(a.PriceDetailBackup):a.PriceDetail=d("filter")(a.PriceDetailBackup,{ItemCategoryId:parseFloat(a.Item_CategoryId)},!0)},h(),a.selectedRow=0,a.setClickedRow=function(b){a.selectedRow=b},a.btnImportPrice=function(){e.ShowDetailFormDialog({data:a.cbbPriceList,tempUrl:"app/components/Master/PriceList/PriceImport.html",ctrl:"PriceImportCtrl",cssclass:"Modal-width600",focuscontrolid:""}).then(function(a){1===a&&h()})},a.btnExport_Click=function(){f.showloading();var a={CompanyId:f.CompanyId,BranchId:f.BranchId},b="BangGiaBan.xlsx";f.ExportExcel("ExportBangGiaBan",a,f.url,b).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.GiaTriDieuChinh=0,a.DieuChinhGia={Type:0},a.btnDieuChinhGia_Click=function(){var b=parseFloat(a.GiaTriDieuChinh),c=a.BangGiaId;if(0>=b||void 0===c)return void e.ShowMessageDialog("Vui lòng nhập bảng giá cần thay đổi hoặc giá trị cần điều chỉnh.");for(var d=0;d<=a.PriceDetail.length-1;d++){var f=parseFloat(a.PriceDetail[d][c]);0===parseInt(a.DieuChinhGia.Type)?a.PriceDetail[d][c]=f+f*b/100:1===parseInt(a.DieuChinhGia.Type)?a.PriceDetail[d][c]=f+b:2===parseInt(a.DieuChinhGia.Type)?a.PriceDetail[d][c]=f-f*b/100:3===parseInt(a.DieuChinhGia.Type)&&(a.PriceDetail[d][c]=f-b)}},j()}]),app.controller("PriceImportCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","PriceService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){null!=a.priceList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.selectedFile=null,a.msg="";var j=0;a.cbbPriceList=f,a.priceList=[{STT:0,MaHang:"",TenHang:"",DVT:"",Price:0}],a.priceList.length=0,a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportPrice.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnUpload_Click=function(){var b=$("#file").get(0).files;if(0==b.length)h.ShowMessageDialog("Vui lòng chọn file.");else if(0===a.PriceId||void 0===a.PriceId)h.ShowMessageDialog("Vui lòng chọn bảng giá cần import.");else{var c=new FormData;if(c.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),b.length>0)for(var d=0;d<b.length;d++)c.append("UploadedImage"+d,b[d]);c.append("PriceId",a.PriceId),$("#divImportResult").html("Đang thực hiện import bảng giá, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:c,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import bảng giá thành công."),j=1):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.btnCancel=function(a){d.close(j)},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()})}]),app.factory("RelationPriceService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/RelationAreaTimesPrice/",e}]),app.controller("RelationPriceCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","RelationPriceService",function(a,b,c,d,e,f){function g(){f.showloading();var b={BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){a.RelationList=b.data.Data,a.PriceList=b.data.Data2,h()},function(b){a.PriceList=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function i(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"RelationPrice"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.RelationList=null,a.PriceList=null,a.viewRole=!0,a.btnSaveRelationPrice=function(){f.showloading(),f.Post("Save",a.RelationList,f.url).then(function(a){e.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},g(),i()}]),app.factory("SaleAreaServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleArea/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("SaleAreaCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","SaleAreaServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"SaleArea"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LoaiHinhKinhDoanh=f.LoaiHinhKinhDoanh,a.gridOptions={data:[],id:"grid_SaleArea",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"SALE_AREA_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"SALE_AREA_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Printer",display:"SALE_AREA_LABEL_PRINTER",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"strTinhGio",display:"Khu vực tính giờ",headerclass:"text-align-center col-w-120px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"",visible:"004"===a.LoaiHinhKinhDoanh?!0:!1},{field:"IsUsed",display:"Sử dụng",headerclass:"text-align-center col-w-70px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"SALE_AREA_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"text-align-left",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/SaleArea/SaleAreaDetail.html",ctrl:"SaleAreaDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("SaleAreaDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","SaleAreaServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){g.showloading(),g.Post("InitSaleAreaDetail",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.AreaItemObj=b.data.Data2},function(a){})["finally"](function(){g.closeloading()})}function j(){null!=a.detail.AreaItemList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"SaleArea"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.ItemList=null,a.AreaItemObj=null,a.disablecode=!1,a.detail=f,a.detail.ItemId=0,a.LoaiHinhKinhDoanh=g.LoaiHinhKinhDoanh,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},a.btnThemHangHoa_Click=function(){parseFloat(a.detail.ItemId)<=0&&h.ShowMessageDialog("Vui lòng chọn hàng hóa");var b=angular.copy(a.AreaItemObj),c=e("filter")(a.detail.AreaItemList,{ItemId:a.detail.ItemId,IsDeleted:0},!0);0===c.length&&(b.ItemId=parseFloat(a.detail.ItemId),b.ItemCode=$("#ItemId").attr("aacode"),b.ItemName=$("#ItemId").attr("aaname"),b.Qty=1,b.IsDeleted=0,b.BranchId=g.BranchId,b.RowStatus=1,a.detail.AreaItemList.push(b))},a.Qty_Change=function(a){parseFloat(a.Id)>0&&(a.RowStatus=2)},a.btnDeleteItem_Click=function(a){a.IsDeleted=1,a.RowStatus=3},b(function(){i()},10),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=5,a.maxSize=3,a.listPageSize=[5,10],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),b(function(){k()},50)}]),app.factory("SaleTableService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleTable/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("SaleTableCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","SaleTableService",function(a,b,c,d,e,f){function g(){f.showloading(),f.Post("GetCodeNameArea",{BranchID:f.BranchId},f.urlCombobox).then(function(b){a.AreaList=b.data.Data,h(),a.btnSearch()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var a=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(a-40)}function i(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"SaleTable"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"CreateAuto"},!0)[0];$("#btnCreateAuto").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.viewRole=!0,a.AreaList=null,a.TableList=null,a.ChieuDai=2,a.TuSo=1,a.DenSo=20,a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){a.TableList=b.data.Data},function(b){a.TableList=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},g(),a.btnCreateTable=function(){if(0==a.AreaID||null==a.AreaID)return void e.ShowMessageDialog("SaleTable_Area_Invalid");f.showloading();var b={AreaId:a.AreaID,KyHieu:a.KyHieu,ChieuDai:a.ChieuDai,TuSo:a.TuSo,DenSo:a.DenSo,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("CreateTable",b,f.url).then(function(b){a.TableList=b.data.Data,showAlertMessage(c.instant("CMN_MSG_SAVE_SUCESSFULLY"))},function(b){a.TableList=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnDeleteAllTableByArea=function(){return 0==a.AreaID||null==a.AreaID?void e.ShowMessageDialog("SaleTable_Area_Invalid"):void e.ShowConfirmDialog("SaleTable_Confirm_DeleteTableOnArea").then(function(b){if(0==b){f.showloading();var d={AreaId:a.AreaID,BranchId:f.BranchId,CompanyId:f.CompanyId};f.Post("DeleteAllTableByAreaId",d,f.url).then(function(b){var d=b.data.Status;0==d.StatusCode?(a.TableList=b.data.Data,showAlertMessage(c.instant("CMN_MSG_DELETE_SUCESSFULLY"))):e.ShowMessageDialog(d.MessageId)},function(b){a.TableList=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}})},a.CheckAreaExistTable=function(b){return function(b){if(null!=a.TableList){var c=d("filter")(a.TableList,{AreaId:b.ID},!0);return c.length>0?!0:!1}return!1}},a.btnEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/SaleTable/SaleTableDetail.html",ctrl:"SaleTableDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},i()}]),app.controller("SaleTableDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","data","SaleTableService","AppDialog",function(a,b,c,d,e,f,g){a.dataCopy=angular.copy(e),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=e,e.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){1==c||1==c?null!=a.detail&&(a.detail.ID=0,a.detail.Code=""):a.detail=null,a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=f.CompanyId,a.detail.BranchId=f.BranchId,f.showloading(),f.Post("Save",a.detail,f.url).then(function(d){var e=d.data.Status;0==e.StatusCode?g.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,g.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()}}]),app.factory("ShipperService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Shipper/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ShipperCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","ShipperService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitShipperSearch",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.GroupShipperList=b.data.Data,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Shipper"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.GroupShipperList=null,a.gridOptions={data:[],id:"grid_Shipper",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Mã",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Tên",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"GroupShipper_Name",display:"Nhóm",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Employee_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"IsUsedString",display:"Sử dụng",headerclass:"text-align-center col-w-200px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,GroupShipperId:a.GroupShipperId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("Search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Shipper/ShipperDetail.html",ctrl:"ShipperDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("Deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(c.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},h(),j()}]),app.controller("ShipperDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$q","$filter","data","ShipperService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.showloading(),h.Post("InitShipperSearch",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.urlCombobox).then(function(b){a.GroupShipperList=b.data.Data},function(a){})["finally"](function(){h.closeloading()})}function k(){var b=e.defer(),c=-1,d=!0;switch(c){case 1:a.DepartmentOptions.setfocus=!0}return b.resolve(d),b.promise}function l(){if("1"!==h.IsAdministrator){var a=f("filter")(h.Role,{ScreenCode:"Shipper"},!0);if(a.length>0){var b=f("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.success=!1,a.submitted=!1,a.GroupShipperList=null,a.disablecode=!1,a.detail=g,g.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:h.BranchId,CompanyId:h.CompanyId};h.Post("GetMaxCode",e,h.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){a.submitted=!0;var d=k();d.$$state.value===!0&&a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,h.showloading(),h.Post("Save",a.detail,h.url).then(function(d){var e=d.data.Status;0==e.StatusCode?i.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,i.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("Code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("Code").focus():document.getElementById("Name").focus(),a.form.$setPristine()},j(),b(function(){l()},50)}]),app.factory("SupplierService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Supplier/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("SupplierCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","SupplierService",function(a,b,c,d,e,f,g){function h(){g.Post("InitSupplierSearch",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.SupplierCategoryList=b.data.Data,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Supplier"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.SupplierCategoryList=null,a.SupplierCategoryOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownSuppliers:6},a.gridOptions={data:[],id:"grid_Supplier",showCheckall:!0,ListCheckSelected:[],
showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Supplier_LABEL_CODE",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Supplier_LABEL_NAME",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Address",display:"Supplier_LABEL_Address",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PhoneNo",display:"Supplier_LABEL_PhoneNo",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Supplier_CategoryName",display:"Nhóm",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Supplier_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Supplier_CategoryId:a.Supplier_CategoryId,CompanyId:g.CompanyId};g.Post("Search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",a.Supplier_CategoryId=0,$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Supplier/SupplierDetail.html",ctrl:"SupplierDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("Deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnImportData=function(){f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Supplier/SupplierImportData.html",ctrl:"SupplierImportDataCtrl",cssclass:"Modal-width500",focuscontrolid:""})},a.btnExport_Click=function(){g.showloading();var b={Code:a.Code,Name:a.Name,Supplier_CategoryId:a.Supplier_CategoryId,CompanyId:g.CompanyId},c="DanhSachNhaCungCap.xlsx";g.ExportExcel("Export",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h(),j()}]),app.controller("SupplierDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","SupplierService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){g.Post("InitSupplierSearch",{CompanyId:g.CompanyId},g.urlCombobox).then(function(b){a.SupplierCategoryList=b.data.Data,a.supplierCategoryModels=b.data.Data3,a.SupplierCategoryOptions.setValue=a.detail.Supplier_CategoryId,a.EmployeeOptions.setValue=a.detail.EmployeeId},function(a){})["finally"](function(){g.closeloading()})}function j(b){g.showloading();var c={CompanyId:g.CompanyId,BranchId:g.BranchId,MasterType:b};g.Post("reloadMasterPlus",c,g.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?h.ShowMessageDialog(b.data.Status.MessageId):"SupplierCategory"===b.data.Status.ObjData&&(a.SupplierCategoryList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function k(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Supplier"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.SupplierCategoryList=null,a.supplierCategoryModels=null,a.SupplierCategoryOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownSuppliers:6},a.EmployeeOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownSuppliers:6},a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("Code").focus()},50)},a.btnSave=function(b){a.submitted=!0,null!=a.detail&&0==a.detail.Supplier_CategoryId&&(a.detail.Supplier_CategoryId=null),a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("Code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("Code").focus():document.getElementById("Name").focus(),a.form.$setPristine()},i(),a.btnSupplierCategoryPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.supplierCategoryModels),tempUrl:"app/components/Master/SupplierCategory/SupplierCategoryDetail.html",ctrl:"SupplierCategoryDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&j("SupplierCategory")})},b(function(){k()},50)}]),app.controller("SupplierImportDataCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","SupplierService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(b.append("jsonData",angular.toJson({CompanyId:g.CompanyId,BranchId:g.BranchId})),a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện import nhà cung cấp, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){g.closeloading(),0===a.Status.StatusCode?($("#divImportResult").html(a.Status.MessageId),h.ShowMessageDialog("Import nhà cung cấp thành công.")):$("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),h.ShowMessageDialog("Lỗi import, vui lòng kiểm tra lại dữ liệu trước khi Import."),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportNhaCungCap.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.dismiss("cancel")}}]),app.factory("SupplierCategoryServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SupplierCategory/",e}]),app.controller("SupplierCategoryCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","SupplierCategoryServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"SupplierCategory"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_SupplierCategory",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"SUPPLIER_CATEGORY_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"SUPPLIER_CATEGORY_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"SUPPLIER_CATEGORY_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/SupplierCategory/SupplierCategoryDetail.html",ctrl:"SupplierCategoryDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("SupplierCategoryDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","SupplierCategoryServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"SupplierCategory"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("TimeOfSaleServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/TimeOfSale/",e}]),app.controller("TimeOfSaleCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","TimeOfSaleServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"TimeOfSale"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_TimeOfSale",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"TimeOfSale_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"TimeOfSale_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"TimeOfSale_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"BeginOfHour",display:"TimeOfSale_LABEL_BeginOfHour",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"BeginOfMinute",display:"TimeOfSale_LABEL_BeginOfMinute",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/TimeOfSale/TimeOfSaleDetail.html",ctrl:"TimeOfSaleDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("TimeOfSaleDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","TimeOfSaleServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){a.HourList=[{value:0,displayName:"00"},{value:1,displayName:"01"},{value:2,displayName:"02"},{value:3,displayName:"03"},{value:4,displayName:"04"},{value:5,displayName:"05"},{value:6,displayName:"06"},{value:7,displayName:"07"},{value:8,displayName:"08"},{value:9,displayName:"09"},{value:10,displayName:"10"},{value:11,displayName:"11"},{value:12,displayName:"12"},{value:13,displayName:"13"},{value:14,displayName:"14"},{value:15,displayName:"15"},{value:16,displayName:"16"},{value:17,displayName:"17"},{value:18,displayName:"18"},{value:19,displayName:"19"},{value:20,displayName:"20"},{value:21,displayName:"21"},{value:22,displayName:"22"},{value:23,displayName:"23"}],a.MinuteList=[{value:0,displayName:"00"},{value:15,displayName:"15"},{value:30,displayName:"30"},{value:45,displayName:"45"}]}function j(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"TimeOfSale"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.HourList=null,a.MinuteList=null,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},i(),b(function(){j()},50)}]),app.factory("UnitOfMeasureServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/UnitOfMeasure/",e}]),app.controller("UnitOfMeasureCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","UnitOfMeasureServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"UnitOfMeasure"},!0);if(console.log(b),b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_UnitOfMeasure",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"UOM_LABEL_CODE",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"UOM_LABEL_NAME",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"UOM_LABEL_NOTE",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/UnitOfMeasure/UnitOfMeasureDetail.html",ctrl:"UnitOfMeasureDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("UnitOfMeasureDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","UnitOfMeasureServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"UnitOfMeasure"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.fsavesuccess=0,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("KhaiBaoMucChietKhauService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/KhaiBaoMucChietKhau/",e}]),app.controller("KhaiBaoMucChietKhauCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","KhaiBaoMucChietKhauService",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"KhaiBaoMucChietKhau"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_Cost",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Mã",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"TuGiaTri",display:"Từ giá trị",headerclass:"text-align-center col-w-150px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"DenCanGiaTri",display:"Đến cận giá trị",headerclass:"text-align-center col-w-150px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"MucChietKhau",display:"Mức chiết khấu",headerclass:"text-align-center col-w-150px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"GhiChu",display:"Mô tả",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Promotion/KhaiBaoMucChietKhau/KhaiBaoMucChietKhauDetail.html",ctrl:"KhaiBaoMucChietKhauDetailCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(d.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("KhaiBaoMucChietKhauDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","KhaiBaoMucChietKhauService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"KhaiBaoMucChietKhau"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.listPrinter=null,a.success=!1,a.submitted=!1,a.fsavesuccess=0,a.disablecode=!1,a.detail=f,f.ID>0&&(a.disablecode=!0),a.btnAddnew=function(c){if(1==c||1==c)null!=a.detail&&(a.detail.ID=0,a.detail.Code="");else{var e={BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("GetMaxCode",e,g.url).then(function(b){0==b.data.Status.StatusCode?a.detail=b.data.Data:h.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){a.fsavesuccess="1",1==b||1==b?a.btnAddnew(0):c.close(a.fsavesuccess)}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.close(a.fsavesuccess)},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},b(function(){i()},50)}]),app.factory("LogGiaoDichTheVipService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/LogGiaoDichTheVip/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("LogGiaoDichTheVipCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","LogGiaoDichTheVipService",function(a,b,c,d,e,f){function g(){f.showloading(),f.Post("InitLogGiaoDich",{CompanyId:f.CompanyId,BranchId:f.BranchId},f.url).then(function(b){
a.VipList=b.data.Data,h()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function i(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"LogGiaoDichTheVip"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.VipList=null,a.TotalRow=null,a.VipOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){f.showloading();var b={VipId:a.VipId,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.VipOptions.setValue=0},a.btnViewDetail_Click=function(b){f.showloading();var c={VipId:b.Id,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.TotalRow=c.data.Data2,a.dataid=b.ID}).then(function(){""===a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:{data:a.data,TotalRow:a.TotalRow},tempUrl:"app/components/Promotion/LogGiaoDichTheVip/LogGiaoDichTheVipDetail.html",ctrl:"LogGiaoDichTheVipDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},g(),i()}]),app.controller("LogGiaoDichTheVipDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","data","LogGiaoDichTheVipService","AppDialog",function(a,b,c,d,e,f,g){function h(){var a=window.innerHeight-50-20;$("#LogTheVipDetail").height(a);var b=a-40-40-20;$(".customergrid-table").height(b)}a.dataCopy=angular.copy(e),a.success=!1,a.submitted=!1,a.TotalRow=null,a.disablecode=!1,a.detail=e.data,a.TotalRow=e.TotalRow,a.btnCancel=function(){c.dismiss("cancel")},b(function(){h()},50)}]),app.factory("PromotionService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Promotion/",e}]),app.controller("PromotionCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","PromotionService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("InitPromotionSearch",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.PromotionTypeList=b.data.Data,a.PromotionType=-1,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Promotion"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}g.urlCombobox=g.Url+"api/Combobox/",a.viewRole=!0,a.PromotionTypeList=null,a.searhResultList=null,a.BranchId=g.BranchId,a.gridOptions={data:[],id:"grid_Item",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"DocumentNo",display:"Promotion_Label_DocumentNo",headerclass:"text-align-center width150",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PromotionName",display:"Promotion_Label_PromotionName",headerclass:"text-align-center width200",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PromotionTypeName",display:"Promotion_Label_PromotionType",headerclass:"text-align-center width150",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"FromDate",display:"Promotion_Label_FromDate",headerclass:"text-align-center width100",detailclass:"",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"ToDate",display:"Promotion_Label_ToDate",headerclass:"text-align-center width100",detailclass:"",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"IsUsed",display:"Promotion_Label_Blocked",headerclass:"text-align-center width100",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Promotion_Label_Note",headerclass:"text-align-center width200",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){var b={FromDate:a.FromDate,ToDate:a.ToDate,PromotionType:a.PromotionType,CompanyId:g.CompanyId};g.Post("Search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(b.data.Data.length+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){})},a.btnAddOrEdit=function(b,c){g.Post("detail",{CompanyId:g.CompanyId,BranchId:g.BranchId,Value01:b},g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.Id?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):1==c?f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Promotion/Promotion/PromotionItemDetail.html",ctrl:"PromotionItemDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}):2==c?f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Promotion/Promotion/PromotionInvoiceDetail.html",ctrl:"PromotionInvoiceDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}):3==c&&f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Promotion/Promotion/PromotionKMTangHang.html",ctrl:"PromotionKMTangHangCtrl",cssclass:"Modal-transaction",focuscontrolid:""})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){console.log(b),a.btnAddOrEdit(b.Id,b.PromotionType)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(c.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})})},h(),j()}]),app.factory("PromotionService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);d.getTokenInfo();return e.url=e.Url+"api/Promotion/",e}]),app.controller("PromotionInvoiceDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","PromotionService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(){var b=f.defer(),c=-1,e=!0,g="";switch(null==a.detail.FromDate&&(g+=d.instant("Promotion_FromDate_Invalid")+"<br/>",e=!1,c=-1==c?0:c),null==a.detail.ToDate&&(g+=d.instant("Promotion_ToDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#FromDate").focus();break;case 1:$("#ToDate").focus()}return b.resolve(e),b.promise}function l(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listProInvoice,{Canceled:0},!0)[0];return(null==g||void 0==g)&&(c=!1,i.ShowMessageDialog(d.instant("Promotion_GridDetail_Invalid")+"<br/>")),b.resolve(c),b.promise}function m(){var a=f.defer(),b=!0;return a.resolve(b),a.promise}function n(){var b=window.innerHeight-50-20;console.log(b),$("#promotionInvoiceDetail").height(b);var c=$(".customergrid-table").parent().height();a.itemsPerPage=Math.floor((c-60)/35)-2,a.itemsPerPage<10&&(a.itemsPerPage=10)}function o(){null!=a.detail.listProInvoice&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function p(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"Promotion"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.btnStatus={Copy:!1,AddNew:!1,Edit:!1,Save:!0,Print:!1},a.ControlStatus={PromotionType:!0,EmployeeId:!0},a.detail=g,console.log(g),null!==g.Id&&""!==g.Id&&j(!0,!0,!1,!0,!1),a.btnAddnew=function(c){j(!1,!0,!1,!0,!1),a.detail.Id="",1==c||1==c?(a.detail.DocumentNo="",a.detail.FromDate=new Date,a.detail.ToDate=new Date):(a.detail.DocumentNo="",a.detail.FromDate=new Date,a.detail.ToDate=new Date,a.detail.PromotionName="",a.detail.IsUsed=!0,a.detail.EmployeeId=0,a.detail.PromotionType=0,a.detail.Note="",a.detail.listInvoice.splice(0,a.detail.listInvoice.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=k();b.$$state.value===!0&&(b=l()),b.$$state.value===!0&&(a.detail.CompanyId=h.CompanyId,a.detail.UserName=h.UserName,a.detail.PromotionType=2,h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneInvoiceDetailObj),c=m();1==c.$$state.value&&(b.ID=0,b.FromAmount=null==a.FromAmountFilter?0:a.FromAmountFilter,b.ToAmount=null==a.ToAmountFilter?0:a.ToAmountFilter,b.Discount=null==a.DiscountFilter?0:a.DiscountFilter,b.DiscAmount=null==a.DiscAmountFilter?0:a.DiscAmountFilter,b.DiscAmountEdit=a.DiscAmountEditFilter,b.Canceled=0,a.detail.listProInvoice.push(b),a.DiscountFilter=0,a.DiscAmountFilter=0,a.FromAmountFilter=0,a.ToAmountFilter=0)},a.btnRemoveRow=function(a){a.Canceled=1},a.eventkeydownEnter=function(a){"ItemFilter"==a&&$("#QtyFilter").focus(),"QtyFilter"==a&&$("#DiscountFilter").focus(),"DiscountFilter"==a&&$("#DiscAmountFilter").focus()},a.QtyFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.btnEdit=function(){var b={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.Id};h.Post("detail",b,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},b(function(){n()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){o()}),b(function(){p()},50)}]),app.factory("PromotionService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);d.getTokenInfo();return e.url=e.Url+"api/Promotion/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("PromotionItemDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","PromotionService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(){h.Post("InitPromotionItemDetail",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.ItemCategoryList=b.data.Data2},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function l(){var b=f.defer(),c=-1,e=!0,g="";switch(null==a.detail.FromDate&&(g+=d.instant("Promotion_FromDate_Invalid")+"<br/>",e=!1,c=-1==c?0:c),null==a.detail.ToDate&&(g+=d.instant("Promotion_ToDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#FromDate").focus();break;case 1:$("#ToDate").focus()}return b.resolve(e),b.promise}function m(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listProItem,{Canceled:0},!0)[0];return(null==g||void 0==g)&&(c=!1,i.ShowMessageDialog(d.instant("Promotion_GridDetail_Invalid")+"<br/>")),b.resolve(c),b.promise}function n(){var b=f.defer(),c="",e=-1,g=!0;switch((0===a.ItemCategoryId||void 0===a.ItemCategoryId)&&(c+=d.instant("Promotion_ItemCategory_Invalid")+"<br/>",g=!1,e=-1==e?0:e),""!=c&&i.ShowMessageDialog(c),e){case 0:$("#ItemCategoryId").focus()}return b.resolve(g),b.promise}function o(){var b=window.innerHeight-50-20;$("#promotionItemDetail").height(b);var c=$(".customergrid-table").parent().height();a.itemsPerPage=Math.floor((c-60)/35)-2,a.itemsPerPage<8&&(a.itemsPerPage=8)}function p(){null!=a.detail.listProItem&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function q(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"Promotion"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.ItemList=null,a.ItemCategoryList=null,a.DiscountFilter=0,a.DiscAmountFilter=0,a.DiscAmountEditFilter=!1,a.LoaiPM=h.MaNganh,a.btnStatus={Copy:!1,AddNew:!1,Edit:!1,Save:!0,Print:!1},a.ControlStatus={PromotionType:!0},a.detail=g,null!==g.Id&&""!==g.Id&&j(!0,!0,!1,!0,!1),a.btnAddnew=function(c){j(!1,!0,!1,!0,!1),a.detail.Id="",1==c||1==c?(a.detail.DocumentNo="",a.detail.FromDate=new Date,a.detail.ToDate=new Date):(a.detail.DocumentNo="",a.detail.FromDate=new Date,a.detail.ToDate=new Date,a.detail.PromotionName="",a.detail.IsUsed=!0,a.detail.EmployeeId=0,a.detail.PromotionType=0,a.detail.Note="",a.detail.listProItem.splice(0,a.detail.listProItem.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=l();b.$$state.value===!0&&(b=m()),b.$$state.value===!0&&(a.detail.CompanyId=h.CompanyId,a.detail.UserName=h.UserName,a.detail.PromotionType=1,h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnAddRowGrid=function(){var b=n();if(1==b.$$state.value){for(var c=e("filter")(a.ItemList,{Field6:a.ItemCategoryId.toString()},!0),d=0;d<c.length;d++){var f=e("filter")(a.detail.listProItem,{ItemId:c[d].ID,Canceled:0},!0);if(0===f.length){var g=angular.copy(a.detail.CloneItemDetailObj);g.ID=0,g.ItemId=c[d].ID,g.ItemCode=c[d].Code,g.ItemName=c[d].Name,g.UomId=c[d].Field3,g.UnitName=c[d].Field4,g.Discount=null==a.DiscountFilter?0:a.DiscountFilter,g.DiscAmount=null==a.DiscAmountFilter?0:a.DiscAmountFilter,g.DiscAmountEdit=a.DiscAmountEditFilter,g.Canceled=0,a.detail.listProItem.push(g)}}a.ItemCategoryId=0,a.DiscountFilter=0,a.DiscAmountFilter=0,a.DiscAmountEditFilter=!1}},a.btnRemoveRow=function(a){a.Canceled=1},a.eventkeydownEnter=function(a){"ItemFilter"==a&&$("#QtyFilter").focus(),"QtyFilter"==a&&$("#DiscountFilter").focus(),"DiscountFilter"==a&&$("#DiscAmountFilter").focus()},a.QtyFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.btnEdit=function(){var b={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.Id};h.Post("detail",b,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnImportData_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Promotion/Promotion/ImportPromotion.html",ctrl:"ImportPromotionCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData;b(function(){a.detail.listProItem.length=0;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneItemDetailObj);c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UomId,c.UnitName=d[b].UnitName,c.UnitCost=d[b].UnitCost,c.Quantity=1,c.Discount=d[b].Discount,c.DiscAmount=d[b].DiscAmount,c.DiscAmountEdit=d[b].DiscAmountEdit,c.Canceled=0,a.detail.listProItem.push(c)}},50)}})},a.btnExport_Click=function(){var b=e("filter")(a.detail.listProItem,{Canceled:0},!0);if(0===b.length)result=!1,i.ShowMessageDialog("Không có dữ liệu.");else{h.showloading();var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Id:a.detail.Id},f="KhuyenMaiHangHoa.xlsx";h.ExportExcel("ExportKhuyenMaiHangHoa",c,h.url,f).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}},k(),b(function(){o()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){p()}),b(function(){q()},50)}]),app.controller("ImportPromotionCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","PromotionService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportPromotion.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.factory("PromotionService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);d.getTokenInfo();return e.url=e.Url+"api/Promotion/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("PromotionKMTangHangCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","PromotionService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(){h.Post("InitPromotionItemDetail",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.urlCombobox).then(function(b){a.ItemList=b.data.Data},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function l(){var b=f.defer(),c=-1,e=!0,g="";switch(null==a.detail.FromDate&&(g+=d.instant("Promotion_FromDate_Invalid")+"<br/>",e=!1,c=-1==c?0:c),null==a.detail.ToDate&&(g+=d.instant("Promotion_ToDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#FromDate").focus();break;case 1:$("#ToDate").focus()}return b.resolve(e),b.promise}function m(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listProTangHang,{Canceled:0},!0)[0];return(null==g||void 0==g)&&(c=!1,i.ShowMessageDialog(d.instant("Promotion_GridDetail_Invalid")+"<br/>")),b.resolve(c),b.promise}function n(){var b=f.defer(),c="",d=-1,e=!0;switch((0===a.GroupId||void 0===a.GroupId)&&(c+="Vui lòng nhập Nhóm khuyến mãi.<br/>",e=!1,d=-1==d?0:d),(0===a.ItemFilter||void 0==a.ItemFilter)&&(c+="Vui lòng nhập hàng hóa.<br/>",e=!1,d=-1==d?0:d),""!=c&&i.ShowMessageDialog(c),d){case 0:$("#GroupId").focus()}return b.resolve(e),b.promise}function o(){var a=window.innerHeight-50-20;$("#promotionKMTangHang").height(a);$(".customergrid-table").parent().height()}function p(){null!=a.detail.listProTangHang&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function q(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"Promotion"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.ItemList=null,a.ItemCategoryList=null,a.DiscountFilter=0,a.DiscAmountFilter=0,a.DiscAmountEditFilter=!1,a.rowItemSelected=null,a.LoaiPM=h.MaNganh,a.ItemFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!0,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"100",field4width:"40",field5width:"100",setValue:0,setfocus:!1,maxDropDownItems:10},a.btnStatus={Copy:!1,AddNew:!1,Edit:!1,Save:!0,Print:!1},a.ControlStatus={PromotionType:!0},a.detail=g,null!==g.Id&&""!==g.Id&&j(!0,!0,!1,!0,!1),a.ItemFilter_selectedrow=function(b){a.rowItemSelected=angular.copy(b),a.PriceFilter=b.CostPrice},a.btnAddnew=function(c){j(!1,!0,!1,!0,!1),a.detail.Id="",1==c||1==c?(a.detail.DocumentNo="",a.detail.FromDate=new Date,a.detail.ToDate=new Date):(a.detail.DocumentNo="",a.detail.FromDate=new Date,a.detail.ToDate=new Date,a.detail.PromotionName="",a.detail.IsUsed=!0,a.detail.EmployeeId=0,a.detail.PromotionType=0,a.detail.Note="",a.detail.listProItem.splice(0,a.detail.listProItem.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=l();b.$$state.value===!0&&(b=m()),b.$$state.value===!0&&(a.detail.CompanyId=h.CompanyId,a.detail.UserName=h.UserName,a.detail.PromotionType=3,h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnAddRowGrid=function(){var b=n();if(1==b.$$state.value){console.log(a.rowItemSelected);var c=e("filter")(a.detail.listProTangHang,{ItemId:parseFloat(a.rowItemSelected.ID),UnitId:parseFloat(a.rowItemSelected.Field3),IsKhuyenMai:a.IsKhuyenMai,GroupId:a.GroupId,Canceled:0},!0);if(0===c.length){var d=angular.copy(a.detail.CloneProTangHangDetailObj);d.ID=0,d.GroupId=a.GroupId,d.ItemId=parseFloat(a.rowItemSelected.ID),d.ItemCode=a.rowItemSelected.Code,d.ItemName=a.rowItemSelected.Name,d.UnitId=parseFloat(a.rowItemSelected.Field3),d.UnitName=a.rowItemSelected.Field4,d.Qty=1,d.IsKhuyenMai=a.IsKhuyenMai,d.IsDeleted=0,d.Canceled=0,a.detail.listProTangHang.push(d)}a.IsKhuyenMai=0,a.ItemFilterOptions.setValue=0,a.ItemFilterOptions.setfocus=!0}},a.btnRemoveRow=function(a){a.Canceled=1},a.eventkeydownEnter=function(a){"ItemFilter"==a&&$("#QtyFilter").focus(),"QtyFilter"==a&&$("#DiscountFilter").focus(),"DiscountFilter"==a&&$("#DiscAmountFilter").focus()},a.QtyFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.btnEdit=function(){var b={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.Id};h.Post("detail",b,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},k(),b(function(){o()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=7,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){p()}),b(function(){q()},50)}]),app.controller("ImportPromotionCtrl",["$scope","$http","$timeout","$uibModalInstance","$translate","data","PromotionService","AppDialog",function(a,b,c,d,e,f,g,h){a.selectedFile=null,a.msg="",a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.btnUpload_Click=function(){var a=$("#file").get(0).files;if(0==a.length)h.ShowMessageDialog("Vui lòng chọn file.");else{var b=new FormData;if(a.length>0)for(var c=0;c<a.length;c++)b.append("UploadedImage"+c,a[c]);$("#divImportResult").html("Đang thực hiện, vui lòng chờ trong giây lát..."),g.showloading(),$.ajax({type:"POST",url:g.url+"UpLoadExcelImport/",contentType:!1,processData:!1,data:b,headers:{Authorization:"Bearer "+g.accessToken},success:function(a){if(g.closeloading(),0===a.Status.StatusCode){var b=a.Data;d.close({status:1,responseData:b})}else $("#divImportResult").html(a.Status.MessageId)},error:function(a,b,c){g.closeloading(),console.log(a.statusText),console.log(b),console.log(c)}})}},a.DownloadTemplate=function(){b({method:"Post",url:g.url+"DownloadTemplate/",xhrFields:{withCredentials:!0},headers:{Authorization:"Bearer "+g.accessToken},cache:!1,responseType:"arraybuffer"}).success(function(a,b,c){c=c();var d="TemplateImportPromotion.xlsx",e=c["content-type"],f=document.createElement("a");try{var g=new Blob([a],{type:e}),h=window.URL.createObjectURL(g);f.setAttribute("href",h),f.setAttribute("download",d);var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});f.dispatchEvent(i)}catch(j){console.log(j)}}).error(function(a){console.log(a)})},a.btnCancel=function(){d.close({status:0,responseData:[]})}}]),app.factory("ThietLapTheVipService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/ThietLapTheVip/",e}]),app.controller("ThietLapTheVipCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","ThietLapTheVipService",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"ThietLapTheVip"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===c?!0:!c.IsEnable)}else a.viewRole=!1}}a.ThietLapTheVipInfo=null,a.searhResultList=null,a.viewRole=!0,a.btnSearch=function(){f.showloading();var b={CompanyId:f.CompanyId};f.Post("detail",b,f.url).then(function(b){0!=b.data.Status.StatusCode?showAlertMessage(c.instant(b.data.Status.MessageId)):a.ThietLapTheVipInfo=b.data.Data},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnSearch(),a.btnSave_Click=function(){f.showloading(),f.Post("Save",a.ThietLapTheVipInfo,f.url).then(function(b){e.ShowMessageDialog(b.data.Status.MessageId),a.ThietLapTheVipInfo=b.data.Data},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},g(),h()}]),app.factory("BanHangNhomTheoKhachHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("BanHangNhomTheoKhachHangCtrl",["$scope","$uibModal","$translate","AppDialog","BanHangNhomTheoKhachHangService",function(a,b,c,d,e){function f(){e.showloading(),e.Post("InitDoanhThuTheoNgay",{CompanyId:e.CompanyId,BranchId:e.BranchId},e.urlCombobox).then(function(b){a.CustomerList=b.data.Data,a.EmployeeCreatedList=b.data.Data2},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})}a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.EmployeeCreatedOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){e.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,DocumentNo:a.DocumentNo,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("search",b,e.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):d.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.EmployeeCreatedId=0,a.DocumentNo="",$("#FromDate").focus()},f()}]),app.factory("BaoCaoTongHopService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("BaoCaoTongHopCtrl",["$scope","$filter","$uibModal","$timeout","$translate","AppDialog","BaoCaoTongHopService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_BaoCaoTongHop",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.AreaList=b.data.Data,a.EmployeeCreatedList=b.data.Data2,a.SellerIdList=b.data.Data2,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var c=b("filter")(g.Role,{ScreenCode:"Sales_BaoCaoTongHop"},!0);if(c.length>0){var d=b("filter")(c,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.EmployeeCreatedList=null,a.SellerIdList=null,a.TotalRow=null,a.sumListGroup=null,a.AreaList=null,a.LoaiPM=g.MaNganh,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,EmployeeCreatedId:a.EmployeeCreatedId,AreaId:a.AreaId,CompanyId:g.CompanyId,BranchId:g.BranchId,SellerId:a.SellerId};g.Post("BaoCaoTongHop",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,a.sumListGroup=b.data.Data3,a.indexGroup=0,j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.indexGroup=-1,a.getIndexGroup=function(){a.indexGroup=a.indexGroup+1},h(),a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,EmployeeCreatedId:a.EmployeeCreatedId,AreaId:a.AreaId,CompanyId:g.CompanyId,BranchId:g.BranchId,SellerId:a.SellerId},c="BaoCaoTongHop.xlsx";g.ExportExcel("BaoCaoTongHopExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("BieuDoDoanhThuService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("BieuDoDoanhThuCtrl",["$scope","$filter","$uibModal","$translate","AppDialog","BieuDoDoanhThuService",function(a,b,c,d,e,f){function g(a,b){return b+" "+a.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")}function h(){var a=($("#tdResult").width(),$("#tdResult").height());
$("#containerTable").height(a-40)}function i(){"BieuDoKhuVuc"===a.reportType?(j(),$("#BieuDoKhuVuc").css("display",""),$("#BieuDoSoSanhDoanhThu").css("display","none"),$("#DashboardBarWeek").css("display","none"),$("#DashboardBarYear").css("display","none")):"BieuDoSoSanhDoanhThu"===a.reportType?(k(),$("#BieuDoKhuVuc").css("display","none"),$("#BieuDoSoSanhDoanhThu").css("display",""),$("#DashboardBarWeek").css("display","none"),$("#DashboardBarYear").css("display","none")):"DashboardBarWeek"===a.reportType?(l(),$("#BieuDoKhuVuc").css("display","none"),$("#BieuDoSoSanhDoanhThu").css("display","none"),$("#DashboardBarWeek").css("display",""),$("#DashboardBarYear").css("display","none")):"DashboardBarYear"===a.reportType&&(m(),$("#BieuDoKhuVuc").css("display","none"),$("#BieuDoSoSanhDoanhThu").css("display","none"),$("#DashboardBarWeek").css("display","none"),$("#DashboardBarYear").css("display",""))}function j(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BieuDoDoanhThuKhuVuc",b,f.url).then(function(b){0==b.data.Status.StatusCode?a.BieuDoDoanhThuKhuVuc=b.data.Data:e.ShowMessageDialog(b.data.Status.MessageId)},function(a){})["finally"](function(){f.closeloading()})}function k(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BieuDoSoSanhDoanhThu",b,f.url).then(function(b){if(0===b.data.Status.StatusCode){a.dataBieuDoSoSanhDoanhThu=b.data.Data,a.chartBieuDoSoSanhDoanhThu.labels.length=0;for(var c=a.dataBieuDoSoSanhDoanhThu.length-1;c>=0;c--)a.chartBieuDoSoSanhDoanhThu.datasets[0].data.push(a.dataBieuDoSoSanhDoanhThu[c].DoanhThu),a.chartBieuDoSoSanhDoanhThu.labels.push(a.dataBieuDoSoSanhDoanhThu[c].Ngay)}else e.ShowMessageDialog(b.data.Status.MessageId)},function(a){})["finally"](function(){f.closeloading()})}function l(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("DashboardBarWeek",b,f.url).then(function(b){0===b.data.Status.StatusCode?(a.dashboardWeek=b.data.Data,a.chartDashboardWeek.datasets[0].data=[a.dashboardWeek[0].DoanhThu,a.dashboardWeek[1].DoanhThu,a.dashboardWeek[2].DoanhThu,a.dashboardWeek[3].DoanhThu,a.dashboardWeek[4].DoanhThu,a.dashboardWeek[5].DoanhThu,a.dashboardWeek[6].DoanhThu],a.chartDashboardWeek.datasets[1].data=[a.dashboardWeek[7].DoanhThu,a.dashboardWeek[8].DoanhThu,a.dashboardWeek[9].DoanhThu,a.dashboardWeek[10].DoanhThu,a.dashboardWeek[11].DoanhThu,a.dashboardWeek[12].DoanhThu,a.dashboardWeek[13].DoanhThu]):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){})["finally"](function(){f.closeloading()})}function m(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,Year:a.iYear};f.Post("DashboardBarYear",b,f.url).then(function(b){0===b.data.Status.StatusCode?(a.dashboardYear=b.data.Data,console.log(a.dashboardYear),a.chartDashboardYear.datasets[0].data=[a.dashboardYear[0].DoanhThu,a.dashboardYear[1].DoanhThu,a.dashboardYear[2].DoanhThu,a.dashboardYear[3].DoanhThu,a.dashboardYear[4].DoanhThu,a.dashboardYear[5].DoanhThu,a.dashboardYear[6].DoanhThu,a.dashboardYear[7].DoanhThu,a.dashboardYear[8].DoanhThu,a.dashboardYear[9].DoanhThu,a.dashboardYear[10].DoanhThu,a.dashboardYear[11].DoanhThu]):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){})["finally"](function(){f.closeloading()})}function n(){if("1"!==f.IsAdministrator){var c=b("filter")(f.Role,{ScreenCode:"Sales_BieuDoDoanhThu"},!0);if(c.length>0){var d=b("filter")(c,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.BieuDoDoanhThuKhuVuc=null,a.dataBieuDoSoSanhDoanhThu=null,a.dashboardWeek=null,a.dashboardYear=null,a.LoaiPM=f.MaNganh,a.currentYear=(new Date).getFullYear(),a.maxYear=a.currentYear,a.minYear=a.currentYear-3,a.iYear=a.currentYear,a.reportType="BieuDoKhuVuc","POS"===a.LoaiPM&&(a.reportType="BieuDoSoSanhDoanhThu"),a.options={scales:{yAxes:[{ticks:{callback:function(a,b,c){return g(a,"$")}}}],xAxes:[{}]},legend:{display:!0,labels:{fontColor:"rgb(255, 99, 132)"}},tooltips:{enabled:!0,mode:"single",callbacks:{label:function(a,b){var c=b.labels[a.index],d=b.datasets[a.datasetIndex].data[a.index];return c+": "+g(d,"$")}}}},a.optionsHorizontal={scales:{xAxes:[{ticks:{callback:function(a,b,c){return g(a,"$")}}}],yAxes:[{}]},legend:{display:!0,labels:{fontColor:"rgb(255, 99, 132)"}},tooltips:{enabled:!0,mode:"single",callbacks:{label:function(a,b){var c=b.labels[a.index],d=b.datasets[a.datasetIndex].data[a.index];return c+": "+g(d,"$")}}}},h(),i(),a.chartBieuDoSoSanhDoanhThu={labels:[],datasets:[{label:"Biểu đồ so sánh doanh thu",backgroundColor:["rgba(255, 99, 132, 1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255, 99, 132, 1)","rgba(75, 192, 192, 1)","rgba(255, 102, 86, 1)","rgba(179, 181, 198, 1)"],borderColor:["rgba(255,99,132,1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255,99,132,1)","rgba(75, 192, 192, 1)","rgba(255, 102, 86, 1)","rgba(179, 181, 198, 1)"],borderWidth:1,data:[]}]},a.chartDashboardWeek={labels:["Thứ hai","Thứ ba","Thứ tư","Thứ năm","Thứ sáu","Thứ bảy","Chủ nhật"],datasets:[{label:"Tuần trước",backgroundColor:"rgba(255, 99, 132, 0.8)",data:[1,2,3,4,5,6,7]},{label:"Tuần này",backgroundColor:"rgba(75, 192, 192, 0.8)",data:[4,2,6,5,8,1,7]}]},a.chartDashboardYear={labels:["Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5","Tháng 6","Tháng 7","Tháng 8","Tháng 9","Tháng 10","Tháng 11","Tháng 12"],datasets:[{label:"Tháng trong năm ",backgroundColor:"rgba(75, 192, 192, 0.8)",data:[]}]},a.DoanhThuNam_Change=function(){m()},a.ViewReport_Click=function(b){a.reportType=b,i()},n()}]),app.factory("ChiTietBanHangNhomKhachHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ChiTietBanHangNhomKhachHangCtrl",["$scope","$http","$uibModal","$translate","$filter","AppDialog","ChiTietBanHangNhomKhachHangService",function(a,b,c,d,e,f,g){function h(){var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.showloading(),g.Post("InitBC_ChiTietBanHang_TheoNhomHang",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.LocationList=b.data.Data2,a.CustomerList=b.data.Data3,a.EmployeeCreatedList=b.data.Data4,a.ItemCategoryList=b.data.Data5,a.SellerIdList=b.data.Data4,a.CusCategoryList=b.data.Data6,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_ChiTietBanHang_NhomKhachHang"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.SellerIdList=null,a.ItemList=null,a.LocationList=null,a.TotalRow=null,a.ItemCategoryList=null,a.sumListGroup=null,a.CusCategoryList=null,a.LoaiPM=g.MaNganh,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,ItemId:a.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemCategoryId:a.ItemCategoryId,SellerId:a.SellerId,CusCategoryId:a.CusCategoryId};g.Post("BC_ChiTietBanHang_NhomKhachHang",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,a.sumListGroup=b.data.Data3,a.indexGroup=0,j(),showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.indexGroup=-1,a.getIndexGroup=function(){a.indexGroup=a.indexGroup+1},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,ItemId:a.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemCategoryId:a.ItemCategoryId,SellerId:a.SellerId,ExportType:"Excel",ExportTypeId:0,CusCategoryId:a.CusCategoryId},c="BC_ChiTietBanHang_NhomKhachHang.xlsx";g.ExportExcel("BC_ChiTietBanHang_NhomKhachHangExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.EmployeeCreatedId=0,a.ItemId=0,$("#FromDate").focus()},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("ChiTietBanHangPTLaiLoService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ChiTietBanHangPTLaiLoCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","ChiTietBanHangPTLaiLoService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_ChiTietBanHangPTLaiLo",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=new Date;b.getMonth(),b.getFullYear();a.FromDate=new Date,a.ToDate=new Date;var d=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(d-40),c(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"ChiTietBanHangPTLaiLo"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.TotalRow=null,a.ItemList=null,a.ItemId=0,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("ChiTietBanHangPTLaiLo",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h(),a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,CompanyId:g.CompanyId,BranchId:g.BranchId},c="ChiTietBanHangPTLaiLo.xlsx";g.ExportExcel("ChiTietBanHangPTLaiLoExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date;b.getMonth(),b.getFullYear();a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("ChiTietBanHangTheoKhuVucService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ChiTietBanHangTheoKhuVucCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","ChiTietBanHangTheoKhuVucService",function(a,b,c,d,e,f){function g(){f.showloading(),f.Post("InitBC_ChiTietBanHang_TheoKhuVuc",{CompanyId:f.CompanyId,BranchId:f.BranchId},f.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.LocationList=b.data.Data2,a.AreaList=b.data.Data3,h()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function i(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function j(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Sales_ChiTietBanHang_TheoKhuVuc"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.AreaList=null,a.ItemList=null,a.LocationList=null,a.viewRole=!0,a.TotalRow=null,a.sumListGroup=null,a.ItemOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.LocationOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){f.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,AreaId:a.AreaId,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BC_ChiTietBanHang_TheoKhuVuc",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,a.sumListGroup=b.data.Data3,a.indexGroup=0,i(),showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.indexGroup=-1,a.getIndexGroup=function(){a.indexGroup=a.indexGroup+1},a.btnExport_Click=function(){f.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,AreaId:a.AreaId,CustomerId:a.CustomerId,CompanyId:f.CompanyId,BranchId:f.BranchId},d="BC_ChiTietBanHang_TheoKhuVuc.xlsx";f.ExportExcel("BC_ChiTietBanHang_TheoKhuVucExport",b,f.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.ItemId=0,a.LocationId=0,$("#FromDate").focus()},g(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()}),j()}]),app.factory("ChiTietBanHangTheoNhomHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ChiTietBanHangTheoNhomHangCtrl",["$scope","$http","$uibModal","$translate","$filter","AppDialog","ChiTietBanHangTheoNhomHangService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_ChiTietBanHang_TheoNhomHang",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.LocationList=b.data.Data2,a.CustomerList=b.data.Data3,a.EmployeeCreatedList=b.data.Data4,a.ItemCategoryList=b.data.Data5,a.SellerIdList=b.data.Data4,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_ChiTietBanHang_TheoNhomHang"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.SellerIdList=null,a.ItemList=null,a.LocationList=null,a.TotalRow=null,a.ItemCategoryList=null,a.sumListGroup=null,a.LoaiPM=g.MaNganh,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,ItemId:a.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemCategoryId:a.ItemCategoryId,SellerId:a.SellerId};g.Post("BC_ChiTietBanHang_TheoNhomHang",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,a.sumListGroup=b.data.Data3,a.indexGroup=0,j(),showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.indexGroup=-1,a.getIndexGroup=function(){a.indexGroup=a.indexGroup+1},a.btnExport_Click=function(){f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/ChiTietBanHangTheoNhomHang/ExportSelect.html",ctrl:"ChiTietBanHangTheoNhomHangExportSelectCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(b){if(1===b.status){g.showloading();var c={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,ItemId:a.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId,ItemCategoryId:a.ItemCategoryId,SellerId:a.SellerId,ExportType:"Excel",ExportTypeId:b.ExportTypeId},e=1===b.ExportTypeId?"ChiTietBanHang_TheoNhomHang.xlsx":"BangKeBanHangTheoNhomHang.xlsx";g.ExportExcel("BC_ChiTietBanHang_TheoNhomHangExport",c,g.url,e).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.EmployeeCreatedId=0,a.ItemId=0,$("#FromDate").focus()},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.controller("ChiTietBanHangTheoNhomHangExportSelectCtrl",["$scope","$http","$filter","$timeout","$uibModalInstance","$translate","data","ChiTietBanHangTheoNhomHangService","AppDialog",function(a,b,c,d,e,f,g,h,i){a.ExportSelectList=[{ID:1,Name:"Doanh thu chi tiết theo nhóm hàng"},{ID:2,Name:"Bảng kê bán hàng"}],a.ExportTypeId=1,a.btnExport_Click=function(){e.close({status:1,ExportTypeId:a.ExportTypeId})},a.btnCancel=function(){e.close({status:0,ExportTypeId:0})}}]),app.factory("ChiTietBanHangShipperService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ChiTietBanHang_ShipperCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","ChiTietBanHangShipperService",function(a,b,c,d,e,f){function g(){f.showloading(),f.Post("InitBC_ChiTietBanHang_Shipper",{CompanyId:f.CompanyId,BranchId:f.BranchId},f.urlCombobox).then(function(b){a.GroupShipperList=b.data.Data,a.ShipperList=b.data.Data2,h()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function i(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Sales_ChiTietBanHang_Shipper"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.GroupShipperList=null,a.ShipperList=null,a.viewRole=!0,a.TotalRow=null,a.btnSearch=function(){f.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,GroupShipperId:a.GroupShipperId,ShipperId:a.ShipperId,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BC_ChiTietBanHang_Shipper",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnExport_Click=function(){f.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,GroupShipperId:a.GroupShipperId,ShipperId:a.ShipperId,CompanyId:f.CompanyId,BranchId:f.BranchId},d="BC_ChiTietBanHang_Shipper.xlsx";f.ExportExcel("BC_ChiTietBanHang_ShipperExport",b,f.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.GroupShipperId=0,a.ShipperId=0,$("#FromDate").focus()},g(),i()}]),app.factory("CongNoKhachHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("CongNoKhachHangCtrl",["$scope","$uibModal","$translate","$filter","$timeout","AppDialog","CongNoKhachHangService",function(a,b,c,d,e,f,g){function h(){var b=new Date,d=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,d,1),a.ToDate=new Date,g.showloading(),g.Post("Init_BaoCaoCongNoKhachHang",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.CustomerList=b.data.Data,i()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=d("filter")(g.Role,{ScreenCode:"BaoCaoCongNoKhachHang"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.TotalRow=null,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,CustomerId:a.CustomerId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BaoCaoCongNoKhachHang",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,ItemId:a.ItemId,LocationId:a.LocationId,CompanyId:g.CompanyId,BranchId:g.BranchId},d="BaoCaoSoQuyTien.xlsx";g.ExportExcel("Inv_BC_NhapXuatTonExport",b,g.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,a.CustomerOptions.setValue=0,$("#FromDate").focus()},a.btnViewDetail_Click=function(a){f.ShowDetailFormDialog({data:a,tempUrl:"app/components/Sales/CongNoKhachHang/CongNoKhachHangDetail.html",ctrl:"CongNoKhachHangDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.controller("CongNoKhachHangDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","CongNoKhachHangService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){g.CompanyId=h.CompanyId,g.BranchId=h.BranchId,h.Post("CongNoKhachHangDetail",g,h.url).then(function(b){0===b.data.Status.StatusCode?(a.dataResult=JSON.parse(b.data.Data),a.TienDauKy=b.data.Data3,a.TotalRow=b.data.Data2):i.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function k(){var a=window.innerHeight-50-20;$("#CongNoKhachHangDetail").height(a);var b=a-40-40-20;$(".customergrid-table").height(b)}a.TienDauKy=0,a.dataResult=null,a.TotalRow=null,a.detail=g,a.btnCancel=function(){c.close(0)},a.btnExport_Click=function(){h.showloading(),g.CompanyId=h.CompanyId,g.BranchId=h.BranchId;var a="BaoCao_CongNoPhaiThuChiTiet.xlsx";h.ExportExcel("CongNoKhachHangDetail_Export",g,h.url,a).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},b(function(){k(),j()},50)}]),app.factory("DoanhSoNhaHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhSoNhaHangCtrl",["$scope","$uibModal","$translate","AppDialog","DoanhSoNhaHangService",function(a,b,c,d,e){function f(){e.showloading(),e.Post("InitDoanhThuTheoNgay",{CompanyId:e.CompanyId,BranchId:e.BranchId},e.urlCombobox).then(function(b){a.CustomerList=b.data.Data,a.EmployeeCreatedList=b.data.Data2},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})}a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.EmployeeCreatedOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){e.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,DocumentNo:a.DocumentNo,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("search",b,e.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):d.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.EmployeeCreatedId=0,a.DocumentNo="",$("#FromDate").focus()},f()}]),app.factory("DoanhSoTheoNVKDService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhSoTheoNVKDCtrl",["$scope","$uibModal","$translate","AppDialog","DoanhSoTheoNVKDService",function(a,b,c,d,e){function f(){e.showloading(),e.Post("InitDoanhThuTheoNgay",{CompanyId:e.CompanyId,BranchId:e.BranchId},e.urlCombobox).then(function(b){a.CustomerList=b.data.Data,a.EmployeeCreatedList=b.data.Data2},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})}a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.EmployeeCreatedOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){e.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,DocumentNo:a.DocumentNo,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("search",b,e.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):d.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.EmployeeCreatedId=0,a.DocumentNo="",$("#FromDate").focus()},f()}]),app.factory("DoanhThuChiTietHangHoaService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("DoanhThuChiTietHangHoaCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","DoanhThuChiTietHangHoaService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_BC_DoanhThuChiTietHangHoa",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.ItemCategoryList=b.data.Data2,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=new Date;b.getMonth(),b.getFullYear();a.FromDate=new Date,a.ToDate=new Date;var d=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(d-40),c(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_DoanhThuChiTietHangHoa"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.TotalRow=null,a.Type=0,a.ItemCategoryList=null,a.ItemList=null,a.ItemCategoryId=0,a.ItemId=0,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){if("1"===a.Type&&0===a.ItemCategoryId&&0===a.ItemId)return void f.ShowMessageDialog("Vui lòng chọn điều kiện tìm kiếm là Nhóm hàng hoặc hàng hóa");g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,ItemCategoryId:a.ItemCategoryId,ItemId:a.ItemId,CompanyId:g.CompanyId,BranchId:g.BranchId,Type:a.Type};g.Post("BC_DoanhThuChiTietHangHoa",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h(),a.radLoaiBaoCao_Check=function(b){a.Type=b},a.btnExport_Click=function(){g.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,ItemCategoryId:a.ItemCategoryId,
ItemId:a.ItemId,CompanyId:g.CompanyId,BranchId:g.BranchId,Type:a.Type},c="DoanhThuChiTietHangHoa.xlsx";g.ExportExcel("BC_DoanhThuChiTietHangHoaExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date;b.getMonth(),b.getFullYear();a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("DoanhThuChiTietTheoNgayService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhThuChiTietTheoNgayCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","DoanhThuChiTietTheoNgayService",function(a,b,c,d,e,f,g){function h(){var b=new Date,d=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,d,1),a.ToDate=new Date;var f=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(f-40),c(function(){a.btnSearch()},200)}function i(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_DoanhThuChiTietTheoNgay"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.TotalRow=null,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BC_DoanhThuChiTietTheoNgay",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId},c="DoanhThuChiTietTheoNgay.xlsx";g.ExportExcel("BC_DoanhThuChiTietTheoNgayExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){var b=new Date,c=b.getMonth(),d=b.getFullYear();a.FromDate=new Date(d,c,1),a.ToDate=new Date,$("#FromDate").focus()},h(),i()}]),app.factory("DoanhThuChiTietTienGioService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("DoanhThuChiTietTienGioCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","DoanhThuChiTietTienGioService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_BC_DoanhThuChiTietTienGio",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.AreaList=b.data.Data,a.NhanVienList=b.data.Data2,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=new Date;b.getMonth(),b.getFullYear();a.FromDate=new Date,a.ToDate=new Date;var d=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(d-40),c(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_DoanhThuChiTietHangHoa"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.TotalRow=null,a.AreaList=null,a.NhanVienList=null,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,AreaId:a.AreaId,NVLapPhieuId:a.NVLapPhieuId,NVPhucVuId:a.NVPhucVuId};g.Post("BC_DoanhThuChiTietTienGio",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h(),a.btnClearSearch=function(){var b=new Date;b.getMonth(),b.getFullYear();a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("DoanhThuNhomTheoNamService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhThuNhomTheoNamCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","DoanhThuNhomTheoNamService",function(a,b,c,d,e,f){function g(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Sales_DoanhThuNhomTheoNam"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.FromYear=(new Date).getFullYear(),a.ToYear=(new Date).getFullYear(),a.btnSearch=function(){f.showloading();var b={FromYear:a.FromYear,ToYear:a.ToYear,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BC_DoanhThuNhomTheoNam",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,g(),showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){g()}),h()}]),app.factory("DoanhThuNhomTheoNgayService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhThuNhomTheoNgayCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","DoanhThuNhomTheoNgayService",function(a,b,c,d,e,f){function g(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Sales_DoanhThu_NhomTheoNgay"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.btnSearch=function(){f.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BC_DoanhThu_NhomTheoNgay",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,g(),showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){g()}),h()}]),app.factory("DoanhThuNhomTheoThangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhThuNhomTheoThangCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","DoanhThuNhomTheoThangService",function(a,b,c,d,e,f){function g(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Sales_DoanhThu_NhomTheoThang"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.FromMonth=(new Date).getMonth()+1,a.FromYear=(new Date).getFullYear(),a.ToMonth=(new Date).getMonth()+1,a.ToYear=(new Date).getFullYear(),a.btnSearch=function(){f.showloading();var b={FromMonth:a.FromMonth,FromYear:a.FromYear,ToMonth:a.ToMonth,ToYear:a.ToYear,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("BC_DoanhThu_NhomTheoThang",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,g(),showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){g()}),h()}]),app.factory("DoanhThuTheoNgayService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("DoanhThuTheoNgayCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","DoanhThuTheoNgayService",function(a,b,c,d,e,f,g){function h(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_DoanhThuTheoNgay"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.TotalRow=null,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BC_DoanhThuTheoNgay",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},c(function(){a.btnSearch()},200),h()}]),app.factory("DonDatHangBanService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleOrder/",e}]),app.controller("DonDatHangBanCtrl",["$scope","$uibModal","$translate","AppDialog","DonDatHangBanService","$filter","$timeout",function(a,b,c,d,e,f,g){function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),g(function(){a.btnSearch()},200)}function i(){if("1"!==e.IsAdministrator){var b=f("filter")(e.Role,{ScreenCode:"DonDatHangBan"},!0);if(b.length>0){var c=f("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=f("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var g=f("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LocationIdList=null,a.DocumentTypeList=null,a.LoaiPM=e.MaNganh,a.gridOptions={data:[],id:"grid_DonDatHang",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"ApplicationStatusName",display:"Trạng thái",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DocumentNo",display:"Số chứng từ",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"Ngày ghi sổ",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"Expect_Receipt_Date",display:"Ngày giao",headerclass:"text-align-center col-w-80px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"CustomerName",display:"Khách hàng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"DienThoaiKH",display:"Điện thoại",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"Tổng tiền",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Info_InAdvance_Amount",display:"Tạm ứng",headerclass:"text-align-center col-w-80px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Note",display:"Ghi chú",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){e.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,BranchId:e.BranchId,CompanyId:e.CompanyId};e.Post("search",b,e.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):d.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})},a.btnClearSearch=function(){},a.btnAddOrEdit=function(b){var c={Id:b,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("detail",c,e.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?d.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):d.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/DonDatHangBan/DonDatHangBanDetail.html",ctrl:"DonDatHangBanDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){d.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.Id)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?d.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):d.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(e.showloading(),e.Post("deletelist",b,e.url).then(function(c){var e=c.data.Status;0==e.StatusCode?d.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,d.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){e.closeloading()}))})},h(),i()}]),app.controller("DonDatHangBanDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","DonDatHangBanService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={CustomerId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.CustomerList=b.data.Data,a.LocationList=b.data.Data2,a.CustomerOptions.setValue=a.detail.CustomerId,(null===g.ID||""===g.ID)&&(a.detail.LocationId=a.LocationList.length>1?0:a.LocationList[0].ID)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((0===parseFloat(a.detail.CustomerId)||void 0===a.detail.CustomerId)&&(g+=d.instant("Vui lòng nhập khách hàng.")+"<br/>",e=!1,c=-1==c?0:c),(null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockIn_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng lưu dữ liệu không được nhiều hơn 100 dòng.")+"<br/>"));for(var j="",k=0;k<=a.detail.listDetail.length-1;k++)parseFloat(a.detail.listDetail[k].SLDatHang)<=0?j+="Dòng ["+(k+1)+"], vui lòng nhập số lượng đặt hàng<br/>":parseFloat(a.detail.listDetail[k].SoLuong)>parseFloat(a.detail.listDetail[k].SLDatHang)&&(j+="Dòng ["+(k+1)+"] SL giao không được lớn hơn SL đặt hàng<br/>");return parseFloat(a.detail.Info_InAdvance_Amount)>parseFloat(a.detail.Info_Amount)&&(j+="Tiền tạm ứng không được lớn hơn tổng tiền<br/>"),""!==j&&(c=!1,i.ShowMessageDialog(j)),b.resolve(c),b.promise}function o(){a.TongSL=0,a.TongTien=0;for(var b=0;b<=a.detail.listDetail.length-1;b++)0===a.detail.listDetail[b].Canceled&&(a.TongSL+=parseFloat(a.detail.listDetail[b].Quantity),a.TongTien+=parseFloat(a.detail.listDetail[b].Amount)),a.detail.Info_Amount=a.TongTien}function p(){var b=f.defer(),c="",e=-1,g=!0;switch((0==a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockIn_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(c+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",g=!1,e=-1==e?1:e),(parseFloat(a.QtyFilter)<=0||void 0==a.QtyFilter)&&(c+=d.instant("InvStockIn_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?2:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 1:$("#LocationId").focus();break;case 2:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function q(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function r(){var b=window.innerHeight-50-20;$("#HoaDonTraHangDetail").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function s(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function t(){if("1"!==h.IsAdministrator){var c=e("filter")(h.Role,{ScreenCode:"DonDatHangBan"},!0);if(c.length>0){var d=e("filter")(c,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===d?!0:!d.IsEnable)}else $("#btnSave").prop("disabled",!0)}b(function(){0!==a.detail.ApplicationStatus&&j(!1,!1,!1,!1,!0)},100)}a.dataCopy=angular.copy(g),a.CustomerList=null,a.LocationList=null,a.TongSL=0,a.TongTien=0;var u=0;a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={CustomerId:!0,LocationId:!0,PostingDate:!0},a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.Id&&""!==g.Id?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0)),a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.SupplierId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.UnitPrice_Change=function(a){a.Amount=parseFloat(a.SLDatHang)*parseFloat(a.UnitPrice),o()},a.SLDatHang_Change=function(a){a.Amount=parseFloat(a.SLDatHang)*parseFloat(a.UnitPrice),o()},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,a.detail.ApplicationStatus=0,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,u=1,k(!1,!1,!1,!1)):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnCancel=function(){c.close(u)},a.btnTimHangHoa_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/DonDatHangBan/SearchHangHoa.html",ctrl:"DDHBSearchHangHoaCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){if(1==b.confirmStatus){for(var c=b.data,d=0;d<=c.length-1;d++){var f=e("filter")(a.detail.listDetail,{ItemId:c[d].ItemId,UomId:c[d].UnitId,Canceled:0},!0);if(void 0===f||0==f.length){var g=angular.copy(a.detail.CloneDetailObj);g.Id=0,g.ItemId=c[d].ItemId,g.ItemCode=c[d].ItemCode,g.ItemName=c[d].ItemName,g.UomId=c[d].UnitId,g.UnitName=c[d].UnitName,g.SLDatHang=1,g.SLDaNhan=0,g.SoLuong=0,g.SLConLai=1,g.UnitPrice=c[d].UnitPrice,g.Amount=parseFloat(g.SLDatHang)*parseFloat(g.UnitPrice),g.Canceled=0,g.BranchId=h.BranchId,g.CompanyId=h.CompanyId,a.detail.listDetail.push(g)}else f[0].SLDatHang=parseFloat(f[0].SLDatHang)+1,f[0].Amount=parseFloat(f[0].SLDatHang)*parseFloat(f[0].UnitPrice)}o()}})},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=p();1==c.$$state.value&&(b.ID=0,b.ItemId=a.ItemFilter,b.ItemCode=$("#ItemFilter").attr("aacode"),b.ItemName=$("#ItemFilter").attr("aaname"),b.UomId=$("#ItemFilter").attr("aafield3"),b.UnitName=$("#ItemFilter").attr("aafield4"),b.LocationId=parseInt(a.detail.LocationId),b.UnitCost=null==a.PriceFilter?0:a.PriceFilter,b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,a.detail.listDetail.push(b),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,q())},a.btnRemoveRow=function(a){a.Canceled=1,q()},a.CalculateAmount=function(a){a.Amount=a.UnitCost*a.Quantity,q()},a.QtyFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.Id};h.showloading(),h.Post("InBienNhanDatHang",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"BIEN NHAN DAT HANG","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},l(),b(function(){r()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){s()}),b(function(){t()},50)}]),app.controller("DDHBSearchHangHoaCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","DonDatHangBanService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.Post("SearchHangHoa",{CompanyId:h.CompanyId,BranchId:h.BranchId,Type:0},h.url).then(function(b){a.dataResult=b.data.Data},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function k(){var a=window.innerHeight-50-20;$("#SearchHangHoaDetail").height(a);var b=a-50-50-40;$(".customergrid-table").height(b)}a.dataResult=null,b(function(){j(),$("#txtSearchHangHoa").focus(),k()},50),a.btnCancel=function(){c.dismiss("cancel")},a.btnSelect_Click=function(){var b=e("filter")(a.dataResult,{IsChecked:1},!0);0===b.length?i.ShowMessageDialog("Vui lòng chọn hàng hóa"):c.close({confirmStatus:1,data:b})}}]),app.factory("HoaDonBanSiService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/HoaDonBanSi/",e}]),app.controller("HoaDonBanSiCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","HoaDonBanSiService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b=new Date,c=b.getMonth(),e=b.getFullYear();a.FromDate=new Date(e,c,1),a.ToDate=new Date,g.Post("GetCodeNameDataMaster",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.url).then(function(b){a.CustomerList=b.data.Data,a.LocationIdList=b.data.Data2,i()},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"HoaDonBanSi"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LocationIdList=null,a.CustomerList=null,a.LoaiPM=g.MaNganh,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.gridOptions={data:[],id:"grid_hoadonsi",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"DocumentNo",display:"InvStockIn_Label_DocumentNo",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"InvStockIn_Label_PostingDate",headerclass:"text-align-center col-w-100px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"CustomerName",display:"Khách hàng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"LocationName",display:"Kho hàng",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"InvStockIn_Label_Amount",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"InAdvanced",display:"Thanh toán",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Note",display:"InvStockIn_Label_Note",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,CustomerId:a.CustomerId_Search,BranchId:g.BranchId,CompanyId:g.CompanyId};g.Post("search",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={Id:b,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/HoaDonBanSi/HoaDonBanSiDetail.html",ctrl:"HoaDonBanSiDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.Id)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})})},h(),j()}]),app.controller("HoaDonBanSiDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","HoaDonBanSiService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={CustomerId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.CustomerList=b.data.Data,a.LocationList=b.data.Data2,a.CustomerOptions.setValue=a.detail.CustomerId,(null===g.ID||""===g.ID)&&(a.detail.LocationId=a.LocationList.length>1?0:a.LocationList[0].ID)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((0==parseFloat(a.detail.CustomerId)||void 0===a.detail.CustomerId)&&(g+="Vui lòng nhập Khách hàng<br/>",e=!1,c=-1==c?0:c),(null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockIn_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng lưu dữ liệu không được nhiều hơn 100 dòng.")+"<br/>"));for(var j="",k=0;k<=a.detail.listDetail.length-1;k++)0===a.detail.listDetail[k].Canceled&&(parseFloat(a.detail.listDetail[k].SoLuong)<=0?j+="Dòng ["+(k+1)+"], vui lòng nhập số lượng [Còn lại]<br/>":parseFloat(a.detail.listDetail[k].SoLuong)>parseFloat(a.detail.listDetail[k].SLDatHang)-parseFloat(a.detail.listDetail[k].SLDaNhan)&&(j+="Dòng ["+(k+1)+"] số lượng [Còn lại] không được lớn hơn [SL đặt] - [Đã giao]<br/>"));return parseFloat(a.detail.InAdvanced)>parseFloat(a.detail.Info_Amount)-parseFloat(a.detail.TienDaThanhToan)&&(j+="Tiền thanh toán không được lớn hơn tổng tiền<br/>"),""!==j&&(c=!1,i.ShowMessageDialog(j)),b.resolve(c),b.promise}function o(){a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Amount+=parseFloat(c.Amount))}}function p(){var b=window.innerHeight-50-20;$("#HoaDonBanSi").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function q(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,
a.end=a.begin+a.itemsPerPage)}function r(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"HoaDonBanSi"},!0);if(a.length>0){var c=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===c?!0:!c.IsEnable)}else $("#btnSave").prop("disabled",!0)}b(function(){null!==g.Id&&""!==g.Id&&$("#btnTimDonDatHang").prop("disabled",!0)},100)}a.dataCopy=angular.copy(g),a.CustomerList=null,a.LocationList=null,a.InfoId_Ref=null,a.DocumentNo_Ref=null;var s=0;a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={CustomerId:!0,LocationId:!0,PostingDate:!0},a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:6},a.detail=g,null!==g.Id&&""!==g.Id?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0),a.InfoId_Ref=g.InfoId_Ref,a.DocumentNo_Ref=g.DocumentNo_Ref,$("#btnTimDonDatHang").prop("disabled",!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0)),a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.Id="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.CustomerId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,a.detail.InfoId_Ref=a.InfoId_Ref,a.detail.DocumentNo_Ref=a.DocumentNo_Ref,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,s=1,k(!1,!1,!1,!1)):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.Id};h.showloading(),h.Post("InHoaDonBanHang",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"HOA DON BAN HANG","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.close(s)},a.btnRemoveRow=function(a){a.Canceled=1,o()},a.CalculateAmount=function(a){a.Amount=a.UnitPrice*a.SLDatHang,o()},a.SoLuong_Change=function(a){a.Amount=a.UnitPrice*a.SLDatHang,a.EditAmount=0,o()},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,a.CustomerOptions.setValue=a.detail.CustomerId,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},a.btnTimDonDatHang_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/HoaDonBanSi/TimDonDatHang.html",ctrl:"TimDonDatHangCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(c){if(1===c.status){var d=c.responseData,e=c.TienDaThanhToan;a.detail.TienDaThanhToan=e,a.detail.CustomerId=0,a.CustomerOptions.setValue=0,a.detail.LocationId=0,d.length>0&&(a.InfoId_Ref=d[0].InfoId,a.DocumentNo_Ref=d[0].DocumentNo),b(function(){for(var b=0;b<=a.detail.listDetail.length-1;b++)a.detail.listDetail[b].Canceled=1;for(var b=0;b<=d.length-1;b++){var c=angular.copy(a.detail.CloneDetailObj);c.ItemId=d[b].ItemId,c.ItemCode=d[b].ItemCode,c.ItemName=d[b].ItemName,c.UomId=d[b].UnitId,c.UnitName=d[b].UnitName,c.LocationId=0,c.UnitPrice=d[b].UnitPrice,c.SLDatHang=d[b].SLDatHang,c.SLDaNhan=d[b].SLDaNhan,c.SoLuong=d[b].SoLuong,c.Amount=parseFloat(c.UnitPrice)*c.SLDatHang,c.Canceled=0,a.detail.listDetail.push(c),(0===a.detail.CustomerId||void 0===a.detail.CustomerId)&&(a.detail.CustomerId=d[b].CustomerId,a.CustomerOptions.setValue=a.detail.CustomerId,a.detail.LocationId=d[b].LocationId,a.detail.ReceiverName=h.UserName,a.detail.Note="Xuất bán từ đơn hàng "+d[b].DocumentNo)}o(),a.detail.InAdvanced=parseFloat(a.detail.Info_Amount)-parseFloat(a.detail.TienDaThanhToan)},50)}})},l(),b(function(){p()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){q()}),b(function(){r()},100)}]),app.controller("TimDonDatHangCtrl",["$scope","$http","$filter","$timeout","$uibModalInstance","$translate","data","HoaDonBanSiService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.showloading();var b={BranchId:h.BranchId,CompanyId:h.CompanyId};h.Post("TimDonDatHang",b,h.url).then(function(b){d(function(){a.dtInfo=b.data.Data,a.dtDetail=b.data.Data2,a.dtInfo.length>0&&k(a.dtInfo[0].InfoId)},50)},function(b){a.gridOptions.data=null,showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}function k(b){a.dtDetailFilter=c("filter")(a.dtDetail,{InfoId:b},!0)}a.dtInfo=null,a.dtDetail=null,a.dtDetailFilter=null,j(),a.selectedRow=0,a.rowFilter_Click=function(b,d){a.selectedRow=d,a.dtDetailFilter=c("filter")(a.dtDetail,{InfoId:b.InfoId},!0)},a.btnSelected_Click=function(){var b=a.dtDetailFilter,c=a.dtInfo[a.selectedRow];e.close({status:1,responseData:b,TienDaThanhToan:c.TienDaThanhToan})},a.btnCancel=function(){e.close({status:0,responseData:[]})}}]),app.factory("LichSuKetCaService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("LichSuKetCaCtrl",["$scope","$uibModal","$filter","$window","$timeout","$translate","AppDialog","LichSuKetCaService","AuthenticationService",function(a,b,c,d,e,f,g,h,i){function j(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),e(function(){a.btnSearch_Click()},200)}function k(){if("1"!==h.IsAdministrator){var b=c("filter")(h.Role,{ScreenCode:"Sale_LichSuKetCa"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}else a.viewRole=!0}var l=d.localStorage.TokenInfo;return null===l||void 0===l||"null"===l?void(window.location.href="#/login"):(a.viewRole=!0,a.searhResultList=null,a.LocationList=null,a.TotalRow=null,a.btnSearch_Click=function(){a.Title="Lịch sử kết ca",a.showResult=1,h.showloading();var b={TuNgay:a.FromDate,DenNgay:a.ToDate,CompanyId:h.CompanyId,BranchId:h.BranchId};h.Post("LichSuKetCa",b,h.url).then(function(b){0==b.data.Status.StatusCode?a.searhResultList=JSON.parse(b.data.Data):g.ShowMessageDialog(b.data.Status.MessageId)},function(a){})["finally"](function(){h.closeloading()})},j(),void k())}]),app.factory("MotelService",["$q","$http","AppServices","AuthenticationService","signalR",function(a,b,c,d,e){var f=Object.create(c);return f.url=f.Url+"api/Restaurant/",f.urlCombobox=f.Url+"api/Combobox/",e.startHub({MaGianHang:c.MaGianHang,IsServer_Offline:0,ComputerName:c.UserName,LoginDevice:"WebApp",ScreenName:"Motel",PublicIP:c.PublicIP}).then(function(){}),f}]),app.controller("MotelCtrl",["$scope","$q","$uibModal","$translate","AppDialog","MotelService","appKeyBoard","$filter","$timeout","$location","$window","$interval","signalR",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,UserId:f.userId,IPAddress:f.IPAddress};f.Post("InitTouchScreen",b,f.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.DataConfig=b.data.DataConfig,a.AreaList=b.data.Data,a.TableList=b.data.Data2,a.ItemCategoryList=b.data.Data3,a.ItemList=b.data.Data4,a.VatList=b.data.Data5,a.KhachHangList=b.data.Data6,a.NVPVuList=b.data.Data7,a.MaNVLapList=b.data.Data7,a.NVChonMonList=b.data.Data7,a.dtKhuyenMaiHangHoa=b.data.Data8,a.dtChuongTrinhKhuyenMai=b.data.Data9,a.ItemAddonList=b.data.Data10,a.dtSize_TraSua=b.data.Data11,a.PriceByAreaList=b.data.Data12,a.BankAccountList=b.data.Data13,a.customerModels=b.data.Data14,a.TheVipList=b.data.Data15,a.ShipperList=b.data.Data16,a.itemTienGio=b.data.Data17,a.itemTienGio.length>0&&(a.ItemIdTienGio=a.itemTienGio[0].ID),a.HinhThucTinhGioList=b.data.Data18,a.ItemCategoryList.push({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:"",Selected:0}))},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))}).then(function(b){p(),a.isSelectArea=1,a.AreaList.length>0&&(a.btnAreaId_Click(a.AreaList[0]),"1"===a.BanHangCanTeen&&(X=0,a.btnChonMon(),$("#btnBanPhong").css("display","none"),$("#btnThucDon").css("display","none"),a.btnTableDetail_Click({ID:0,Code:"000",Name:"Takeaway"})))},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}function o(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,IPAddress:f.IPAddress};f.Post("InitTouchScreen2",b,f.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.ItemList=b.data.Data4,a.ItemAddonList=b.data.Data10,a.PriceByAreaList=b.data.Data12)},function(a){}).then(function(b){a.ItemListFilter=null===P||0===P.ID?a.ItemList:h("filter")(a.ItemList,{Field6:P.ID.toString()},!0),a.btnShowAllItemDetail_Click(P)},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}function p(){I=Math.round(Z/(H+2)-.5),J=1;a.AreaListFilter=a.AreaList,a.AreaListFilter.length>0&&(a.AreaListFilter[0].Selected=1),_=$("#divItemListDetail").width()-20,aa=$("#divItemListDetail").height()-20;var b=parseInt(_/ba),c=parseInt(aa/ca);a.itemListDetailPerPage=b*c}function q(){K=Math.round(Z/(L+2)-.5),M=1;var b=(M-1)*K,c=b+K;a.ItemCategoryListFilter=a.ItemCategoryList.slice(b,c)}function r(){for(var b=0;b<=a.ItemListDetailFilter.length-1;b++){var c=h("filter")(a.PriceByAreaList,{AreaId:U,ItemId:a.ItemListDetailFilter[b].ID},!0);c.length>0&&(a.ItemListDetailFilter[b].UnitPrice=c[0].Price)}}function s(){var a=$("#td-sale-invoice").height();$("#divSaleInvoice").height(a);var b=$("#td-Detail-Item").height();$("#divDetailTable_Item").height(b-10)}function t(b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,MasterType:b};f.Post("reloadMasterPlus",c,f.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):"Customer"===b.data.Status.ObjData&&(a.KhachHangList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function u(c,d,g){var h=b.defer(),i=9;a.dtInfo.BranchId=f.BranchId,a.dtInfo.CompanyId=f.CompanyId,a.dtInfo.IPAddress=f.IPAddress;for(var j=0,k=0;k<=a.dtItem.length-1;k++)j+=parseFloat(a.dtItem[k].TotalAmount);a.dtInfo.Info_Amount=j;var l={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,dtInfo:a.dtInfo,dtItem:a.dtItem,dtReturnItem:a.dtReturnItem,PromotionType:c,PromotionId:d,KhuyenMaiVip:g,IPAddress:f.IPAddress};return f.Post("SaveInvoiceTmp",l,f.url).then(function(b){var c=(a.dtInfo.ID,b.data.Status.StatusCode);if(3==b.data.Status.StatusCode)a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0;else{if(9==b.data.Status.StatusCode)return void e.ShowMessageDialog(b.data.Status.MessageId);a.dtInfo=b.data.Data,a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var d=0,g=0;g<=a.dtDoiDiemVipList.length-1;g++)d+=parseFloat(a.dtDoiDiemVipList[g].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(d)}"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:c,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio)}),i=0,h.resolve(i)},function(a){console.log("Error:"+a.data.Message),h.reject("Error:"+a.data.Message)})["finally"](function(){f.closeloading()}).then(function(a){},function(a){console.log("error:"+a.data),h.reject("error:"+a.data)}),h.promise}function v(b,c){null===c&&(c=1);var d=b.Field11,e=b.Field12,g={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,ItemId:b.ID,Size_TraSua:1==a.AddOn&&1===b.Field12?D.Medium:""};f.Post("GetPriceItem",g,f.url).then(function(g){a.priceItem=g.data.Data;var i=angular.copy(a.drItem),j=h("filter")(a.dtItem,{ItemId:b.ID,StatusId:C.ChonMon,UnitPrice:a.priceItem},!0),k=new Date,l=k.getFullYear()+""+k.getMonth()+k.getDate()+k.getHours()+k.getMinutes()+k.getSeconds();if(0===a.dtInfo.EmployeeOrderId&&(a.dtInfo.EmployeeOrderId=null===f.userId||void 0===f.userId?0:f.userId),0===j.length||1===d||1===e){i.ID=0,i.IdTmp=l,i.InfoId="",i.AddOn=0,i.ParentId=0,i.ItemId=b.ID,i.ItemName=b.Name,i.Quantity=parseFloat(c),i.UomId=b.Field3,i.Size_TraSua=D.Medium,i.UnitPrice=parseFloat(a.priceItem),i.DisCount02=0,i.Disc_Amount02=0,i.BranchId=f.BranchId,i.CompanyId=f.CompanyId,i.Canceled=0,i.StatusId=C.ChonMon,i.Amount=parseFloat(i.Quantity)*parseFloat(i.UnitPrice),i.DisCount01=0,i.Disc_Amount01=parseFloat(i.Amount)*parseFloat(i.DisCount01)/100,i.VAT_DiscAmount=0,i.VatAmount=parseFloat(i.Amount)*parseFloat(i.VAT_DiscAmount)/100,i.TotalAmount=parseFloat(i.Amount)+parseFloat(i.VatAmount)-parseFloat(i.Disc_Amount01),i.RowStatus=B.Insert,i.CreatedBy=f.UserName,i.UpdatedBy=f.UserName;var m=h("filter")(a.dtKhuyenMaiHangHoa,{ItemId:b.ID},!0);m.length>0&&(0===m[0].DiscAmountEdit?(i.DisCount01=m[0].Discount,i.Dis_AmountEdit=0,i.Disc_Amount01=parseFloat(i.Amount)*parseFloat(i.DisCount01)/100):(i.Disc_Amount01=m[0].DiscAmount,i.Dis_AmountEdit=1,0!=i.Disc_Amount01&&0!=i.Amount&&(i.DisCount01=100*i.Disc_Amount01/i.Amount)),i.TotalAmount=parseFloat(i.Amount)+parseFloat(i.VatAmount)-parseFloat(i.Disc_Amount01)),a.dtItem.push(i),1===b.Field11}else j[0].Quantity+=parseFloat(c),j[0].Amount=parseFloat(j[0].Quantity)*parseFloat(j[0].UnitPrice),0===j[0].Dis_AmountEdit?j[0].Disc_Amount01=parseFloat(j[0].Amount)*parseFloat(j[0].DisCount01)/100:j[0].DisCount01=100*j[0].Disc_Amount01/j[0].Amount,j[0].TotalAmount=j[0].Amount-j[0].Disc_Amount01,j[0].RowStatus=B.Update,j[0].UpdatedBy=f.UserName},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}).then(function(b){u().then(function(){"1"===f.AddOn&&1===d&&(a.selectedRow=a.dtItem.length-1,a.btnAddon_Click())})},function(a){console.log("error:"+a.data)})}function w(b,c,d){null===c&&(c=1);var e=angular.copy(a.drReturnItem);e.ItemId=b.ItemId,e.ItemName=b.ItemName,e.Quantity=parseFloat(c),e.UomId=b.UomId,e.UnitPrice=b.UnitPrice,e.Amount=parseFloat(e.Quantity)*parseFloat(e.UnitPrice),e.DisCount01=0,e.Disc_Amount01=0,e.DisCount02=0,e.Disc_Amount02=0,e.Note=d,e.StatusId=b.StatusId,e.NVTraMon=f.UserName,e.RowStatus=B.Insert,a.dtReturnItem.push(e)}function x(b){E===!1&&b.StatusId===C.InHoaDon?e.ShowMessageDialog("User không có quyền trả hàng sau khi in hóa đơn."):F===!1&&b.StatusId===C.InCheBien?e.ShowMessageDialog("User không có quyền trả hàng sau khi in chế biến."):"005"===a.LoaiHinhKinhDoanh&&a.itemTienGio.length>0&&a.itemTienGio[0].ID===b.ItemId?e.ShowMessageDialog("Bạn không thể xóa hàng hóa Tiền giờ."):e.ShowConfirmDialog("Bạn có chắc muốn xóa ["+b.ItemName+"] ?").then(function(c){if(0==c)if(b.StatusId==C.ChonMon){b.RowStatus=B.Delete;for(var d=h("filter")(a.dtItem,{ParentId:b.ID,AddOn:1},!0),e=0;e<=d.length-1;e++)d[e].RowStatus=B.Delete;u()}else g.LyDoTraDialog("").then(function(c){if(0==c.Cancel){b.RowStatus=B.Delete,w(b,parseFloat(b.Quantity),c.value);for(var d=h("filter")(a.dtItem,{ParentId:b.ID,AddOn:1},!0),e=0;e<=d.length-1;e++)d[e].RowStatus=B.Delete,w(d[e],parseFloat(d[e].Quantity),c.value);u()}})})}function y(a){$("#btnshowAlertMsgContent").html(a),$("#btnshowAlertMsg").alert(),$("#btnshowAlertMsg").fadeTo(1e3,300).slideUp(300,function(){$("#btnshowAlertMsg").slideUp(300)})}function z(){a.TongTienTamUng=0;for(var b=0;b<=a.TamUngList.length-1;b++)a.TongTienTamUng+=parseFloat(a.TamUngList[b].Amount)}function A(){var b=h("filter")(f.Role,{ScreenCode:"Restaurant"},!0);if("1"!==f.IsAdministrator){if(b.length>0){var c=h("filter")(b,{ActionCode:"ChoPhepTraMonSauInHoaDon"},!0)[0];E=void 0===c?!0:c.IsEnable;var d=h("filter")(b,{ActionCode:"ChoPhepTraMonSauInCheBien"},!0)[0];F=void 0===d?!0:d.IsEnable;var e=h("filter")(b,{ActionCode:"EditGioVao"},!0)[0];G=void 0===e?!1:e.IsEnable;var g=h("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=void 0===g?!1:g.IsEnable}}else{G=!0;var g=h("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=void 0===g?!1:g.IsEnable}}var B={NotUpdate:0,Insert:1,Update:2,Delete:3},C={ChonMon:0,InCheBien:1,InHoaDon:2},D={Small:"S",Medium:"M",Large:"L"};a.DataConfig=null,a.AreaList=null,a.TableList=null,a.ItemCategoryList=null,a.ItemList=null,a.PriceByAreaList=null,a.ItemAddonList=null,a.VatList=null,a.KhachHangList=null,a.NVPVuList=null,a.MaNVLapList=null,a.NVChonMonList=null,a.permissionList=null,a.systemData=null,a.dtChuongTrinhKhuyenMai=null,a.dtKhuyenMaiHangHoa=null,a.dtSize_TraSua=null,a.TheVipList=null,a.dtDoiDiemVipList=null,a.ShipperList=null,a.GhiNhanTinhGio=null,a.HinhThucTinhGioList=null,a.TamUngList=null,a.TongTienTamUng=0;var E=!0,F=!0;a.itemTienGio=null,a.ChoPhepSuaGiaBan=!1,a.ItemIdTienGio=0;var G=!1;a.DiemTichLuySauDoiDiem=0,a.customerModels=null,a.BankAccountList=null,a.HinhThucThanhToan=[],a.AddOn=f.AddOn,a.BanHangCanTeen=f.BanHangCanTeen,a.InVaLuuHoaDon=f.InVaLuuHoaDon,a.TraSua_SuaSoLuong=parseInt(f.TraSua_SuaSoLuong),a.TraSua_SuaSoLuong=void 0===a.TraSua_SuaSoLuong?0:a.TraSua_SuaSoLuong,a.LoaiHinhKinhDoanh=f.LoaiHinhKinhDoanh,a.btnAddOnDisable=!1,a.MaKHOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"300",field3width:"0",field4width:"0",field5width:"0",setValue:-1,maxDropDownItems:6},a.selectedRow=0,a.setClickedRow=function(b){if(a.selectedRow=b,a.dtItem.length>0){var c=a.dtItem[a.selectedRow];0===c.AddOn&&0===c.AllowSelectedSize&&0===c.ShowChooseAddOn?a.btnAddOnDisable=!0:1===c.AddOn?a.btnAddOnDisable=!0:a.btnAddOnDisable=!1}else a.btnAddOnDisable=!0},a.isSelectArea=1;var H=50,I=0,J=1,K=0,L=50,M=1,N=null,O=null,P=null,Q=null,R=null,S=null,T=null,U=null,V=null,W=null,X=null,Y=null,Z=0,_=0,aa=0;a.itemListDetailPerPage=0;var ba=165,ca=105,da=0;a.ItemListDetailFilter=null,a.btnAllItemCategory_Selected=0;var ea=null;a.isShowbtnDelete=!1,a.MaTheVipFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.btnPreArea_Click=function(){J>1&&(J-=1);var b=(J-1)*I,c=b+I;a.AreaListFilter=a.AreaList.slice(b,c)},a.btnNextArea_Click=function(){var b=J+1,c=(b-1)*I,d=c;c<a.AreaList.length&&(d=c+I,a.AreaListFilter=a.AreaList.slice(c,d),J=b)},a.btnAreaId_Click=function(b){a.TableListFilter=h("filter")(a.TableList,{Field6:b.ID.toString()},!0),U=b.ID,V=b.Code,W=b.Name,O=N,N=b,N.Selected=1,null!=O&&b!=O&&(O.Selected=0);var c={CompanyId:f.CompanyId,BranchId:f.BranchId,AreaId:U};$("#txtTextSearch").focus(),a.txtTextSearch="",f.showloading(),f.Post("GetListTableHasCustomer",c,f.url).then(function(b){a.dtBanCoKhach=b.data.Data;for(var c=null,d=0;d<=a.TableListFilter.length-1;d++)c=h("filter")(a.dtBanCoKhach,{ID:a.TableListFilter[d].ID},!0)[0],null!=c?(a.TableListFilter[d].isHasCustomer=1,a.TableListFilter[d].StatusId=c.StatusId,a.TableListFilter[d].TongTien=c.TotalAmount,a.TableListFilter[d].aaGioVao=c.CheckIn_Date):(a.TableListFilter[d].isHasCustomer=0,a.TableListFilter[d].StatusId=-1,a.TableListFilter[d].TongTien=0)},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()}).then(function(a){},function(a){console.log("error:"+a.data)})},a.btnPreItemCategory_Click=function(){M>1&&(M-=1);var b=(M-1)*K,c=b+K;a.ItemCategoryListFilter=a.ItemCategoryList.slice(b,c)},a.btnNextItemCategory_Click=function(){var b=M+1,c=(b-1)*K,d=c;c<a.ItemCategoryList.length&&(d=c+K,a.ItemCategoryListFilter=a.ItemCategoryList.slice(c,d),M=b)},a.btnItemCategory_Click=function(b){return null===X?void e.ShowMessageDialog("Vui lòng chọn Bàn / Phòng."):(a.txtTextSearch="",a.ItemListFilter=0===b.ID?a.ItemList:h("filter")(a.ItemList,{Field6:b.ID.toString()},!0),itemCategoryBeforeSelected=P,P=b,P.Selected=1,null!=itemCategoryBeforeSelected&&b!=itemCategoryBeforeSelected&&(itemCategoryBeforeSelected.Selected=0),a.btnShowAllItemDetail_Click(b),void $("#txtTextSearch").focus())},a.btnShowAllItemDetail_Click=function(b){void 0===b?a.btnItemCategory_Click({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:""}):(b.Selected=1,0===b.ID?a.btnAllItemCategory_Selected=1:a.btnAllItemCategory_Selected=0),ea=angular.copy(a.ItemListFilter),da=1;var c=(da-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;a.ItemListDetailFilter=h("orderBy")(ea,"-ItemTotalSales").slice(c,d),r()},a.btnItemDetailPre_Click=function(){da>1&&(da-=1);var b=(da-1)*a.itemListDetailPerPage,c=b+a.itemListDetailPerPage;a.ItemListDetailFilter=ea.slice(b,c),r()},a.btnItemDetailNext_Click=function(){var b=da+1,c=(b-1)*a.itemListDetailPerPage,d=c;c<ea.length&&(d=c+a.itemListDetailPerPage,a.ItemListDetailFilter=ea.slice(c,d),da=b,r())},a.$watch("txtTextSearch",function(b){if(void 0!==a.ItemListFilter){da=1;var c=(da-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;ea=h("filter")(a.ItemListFilter,b),a.ItemListDetailFilter=ea.slice(c,d),r()}}),i(function(){Z=$("#idContentAreaId").height()},100),i(function(){s(),n()},1e3),a.btnChonMon=function(){a.isSelectArea=0,q(),$("#txtTextSearch").focus()},a.btnChonBan=function(){a.isSelectArea=1,a.btnAreaId_Click(N)},a.btnTableDetail_Click=function(b){a.isShowbtnDelete=!1,X=b.ID,Y=b.Code,a.displayKhuVuc_Ban=b.Name+"-"+W,a.btnChonMon(),f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X};f.Post("GetDataByKhuVucBan",c,f.url).then(function(c){a.dtInfo=c.data.Data,a.dtItem=c.data.Data2,a.dtReturnItem=c.data.Data4,a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drReturnItem=c.data.Data8,a.dtDoiDiemVipList=c.data.Data9,a.GhiNhanTinhGio=c.data.Data10,a.TamUngList=c.data.Data11,z(),a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var d=0,e=0;e<=a.dtDoiDiemVipList.length-1;e++)d+=parseFloat(a.dtDoiDiemVipList[e].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(d),a.MaKHOptions.setValue=a.dtInfo.CustomerId,a.MaTheVipFilterOptions.setValue=a.dtInfo.VipId,0===parseFloat(a.dtInfo.AreaId)&&(a.dtInfo.AreaId=parseFloat(b.Field6)),0===parseFloat(a.dtInfo.TableId)&&(a.dtInfo.TableId=b.ID),a.setClickedRow(0)},function(a){console.log("Error:"+a.data.Message)}).then(function(b){a.ItemCategoryList.length>0&&null==P&&a.btnItemCategory_Click(a.ItemCategoryList[a.ItemCategoryList.length-1])},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()}),R=Q,Q=b,Q.Selected=1,null!=R&&b!=R&&(R.Selected=0)},a.btnItemDetail_SingleClick=function(b){if(T=S,S=b,S.Selected=1,null!=T&&b!=T&&(T.Selected=0),1==a.AddOn){f.showloading();var c=1;v(b,c)}else{var c=1;v(b,c)}},a.btnAddon_Click=function(){if(void 0!==a.dtItem)if(a.selectedRow>a.dtItem.length-1)e.ShowMessageDialog("Vui lòng chọn một hàng hóa trên lưới.");else{var b=a.dtItem[a.selectedRow];e.ShowDetailFormDialog({data:{ItemAddonList:a.ItemAddonList,ParentItem:b,dtInfo:a.dtInfo,dtSize_TraSua:a.dtSize_TraSua},tempUrl:"app/components/Sales/Restaurant/SelectAddon.html",ctrl:"SelectAddonCtrl",cssclass:"Modal-width750",focuscontrolid:""}).then(function(b){if(0==b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X};f.Post("GetDataByKhuVucBan",c,f.url).then(function(b){a.dtInfo=b.data.Data,a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,a.MaKHOptions.setValue=a.dtInfo.CustomerId},function(a){console.log("Error:"+a.data.Message)}).then(function(b){a.ItemCategoryList.length>0&&null==P&&a.btnItemCategory_Click(a.ItemCategoryList[a.ItemCategoryList.length-1])},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})}},a.btnInNhan_Click=function(){void 0!==a.dtItem&&0!==a.dtItem.length&&e.ShowDetailFormDialog({data:{InfoId:a.dtInfo.ID,TenKH_TraSua:a.dtInfo.TenKH_TraSua},tempUrl:"app/components/Sales/Restaurant/ShowInNhan.html",ctrl:"InNhanCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(a){})},a.btnAddNewItem_Click=function(){e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Restaurant/AddItem.html",ctrl:"AddNewItemCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(a){0===a&&(o(),m.sendInitTouchScreen2({MaGianHang:f.MaGianHang,StatusCode:0}))})},a.btnCustomerPlus_Click=function(){a.dataid=0;var b={ID:0,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",b,f.Url+"api/Customer/").then(function(b){a.data=b.data.Data}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerDetail.html",ctrl:"CustomerDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(a){1==a&&t("Customer")})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.$on("handleResponseSaveInvoiceTemp",function(b,c){var d={MaGianHang:c.MaGianHang,StatusCode:c.StatusCode,dtInfo:JSON.parse(c.dtInfo),dtItem:JSON.parse(c.dtItem),dtAddon:JSON.parse(c.dtAddon),dtReturnItem:JSON.parse(c.dtReturnItem)};0===d.StatusCode&&X===d.dtInfo.TableId&&i(function(){a.dtInfo=d.dtInfo,a.dtItem=d.dtItem,a.dtReturnItem=d.dtReturnItem},50)}),a.$on("handleResponseSaveInvoiceCompleted",function(b,c){var d={MaGianHang:c.MaGianHang,StatusCode:c.StatusCode,TableId:c.TableId};0===d.StatusCode&&X===d.TableId&&i(function(){a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0},50)}),a.$on("handleResponseChuyenGopBan",function(b,c){var d={MaGianHang:c.MaGianHang,StatusCode:c.StatusCode,TableId:c.TableId};0===d.StatusCode&&X===d.TableId&&i(function(){a.btnChonBan()},50)}),a.$on("handleResponseInitTouchScreen2",function(a,b){o()}),a.btnSoLuong_Click=function(a){a.StatusId!=C.ChonMon?E===!1&&a.StatusId===C.InHoaDon?e.ShowMessageDialog("User không có quyền trả hàng sau khi in hóa đơn."):F===!1&&a.StatusId===C.InCheBien?e.ShowMessageDialog("User không có quyền trả hàng sau khi in chế biến."):g.returnNumber(a.Quantity,1).then(function(b){0==b.Cancel&&e.ShowConfirmDialog("Bạn có chắc muốn trả món ["+a.ItemName+"] với số lượng : "+b.returnNumber).then(function(c){0==c&&(a.Quantity=parseFloat(a.Quantity)-parseFloat(b.returnNumber),a.Amount=parseFloat(a.Quantity)*parseFloat(a.UnitPrice),0===a.Dis_AmountEdit?a.Disc_Amount01=parseFloat(a.Amount)*parseFloat(a.DisCount01)/100:a.DisCount01=100*a.Disc_Amount01/a.Amount,a.TotalAmount=a.Amount-a.Disc_Amount01,a.RowStatus=B.Update,a.Quantity<=0&&(a.RowStatus=B.Delete,a.Quantity=b.returnNumber),w(a,parseFloat(b.returnNumber),b.LyDo),u())})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}):g.keyBoardNumber(a.Quantity,0,"Điều chỉnh số lượng",a.Amount,-1).then(function(b){a.Quantity!=b.value&&0==b.Cancel&&(a.Quantity=b.value,a.Amount=parseFloat(a.Quantity)*parseFloat(a.UnitPrice),0===a.Dis_AmountEdit?a.Disc_Amount01=parseFloat(a.Amount)*parseFloat(a.DisCount01)/100:a.DisCount01=100*a.Disc_Amount01/a.Amount,a.TotalAmount=a.Amount-a.Disc_Amount01,a.RowStatus=B.Update,a.Quantity<=0&&(a.RowStatus=B.Delete),u())},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnGiaBan_Click=function(b){(0===b.UnitPrice||a.ChoPhepSuaGiaBan!==!1)&&(b.StatusId==C.InHoaDon?e.ShowMessageDialog("Không được điều chỉnh giá khi đã in hóa đơn."):g.keyBoardNumber(b.UnitPrice,0,"Điều chỉnh giá bán",b.Amount,-1).then(function(a){b.UnitPrice!=a.value&&0==a.Cancel&&(b.UnitPrice=a.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=B.Update,u())},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}))},a.btnGiamGiaDetail_Click=function(a){var b=!1;a.StatusId==C.InHoaDon?e.ShowMessageDialog("Không được điều chỉnh giảm giá khi đã in hóa đơn."):g.keyBoardNumber(a.Disc_Amount01,a.DisCount01,"Điều chỉnh giảm giá món",a.Amount,1==a.Dis_AmountEdit?1:0).then(function(c){0==c.discountType&&0==c.Cancel?a.DisCount01!=c.value&&(a.DisCount01=c.value,a.Dis_AmountEdit=!1,a.Disc_Amount01=parseFloat(a.Amount)*parseFloat(a.DisCount01)/100,a.TotalAmount=a.Amount-a.Disc_Amount01,a.RowStatus=B.Update,b=!0):1==c.discountType&&a.Disc_Amount01!=c.value&&(a.Disc_Amount01=c.value,a.DisCount01=100*a.Disc_Amount01/a.Amount,a.Dis_AmountEdit=!0,a.TotalAmount=a.Amount-a.Disc_Amount01,a.RowStatus=B.Update,b=!0),1==b&&u()},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnDeleteItem_Click=function(a){x(a)},a.btnNoteItem_Click=function(a){g.NoteDialog(a.Note).then(function(b){a.Note!==b.value&&(a.Note=b.value,a.RowStatus=B.Update,u())},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnShowbtnDelete_Click=function(){a.isShowbtnDelete=!a.isShowbtnDelete},a.btnInCheBien_Click=function(){var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X,Value01:a.dtInfo.ID};f.Post("InCheBien",b,f.url).then(function(b){0!==b.data.Status.StatusCode&&""!==b.data.Status.MessageId?e.ShowMessageDialog(b.data.Status.MessageId):(a.dtInfo=b.data.Data,a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,""!==b.data.URL&&(window.open(b.data.URL,"PRINT PHIEU CHE BIEN","width=600,height=650").print(),window.close()),"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio)}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnInTraMon_Click=function(){var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X,Value01:a.dtInfo.ID};f.showloading(),f.Post("InTraMon",b,f.url).then(function(b){0!==b.data.Status.StatusCode&&""!==b.data.Status.MessageId?e.ShowMessageDialog(b.data.Status.MessageId):(a.dtInfo=b.data.Data,a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drAddon=b.data.Data7,a.drReturnItem=b.data.Data8,""!==b.data.URL&&(window.open(b.data.URL,"PRINT PHIEU TRA MON","width=600,height=650").print(),window.close()))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})},a.btnInHoaDon_Click=function(){if("005"===a.LoaiHinhKinhDoanh&&1===a.dtInfo.IsTinhGio&&a.itemTienGio.length>0){var b=h("filter")(a.dtItem,{ItemId:a.itemTienGio[0].ID},!0);if(0===b.length)return void e.ShowMessageDialog("Vui lòng Tính tiền phòng trước khi In hóa đơn.")}var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X,Value01:a.dtInfo.ID,EmployeeId:null===f.userId||void 0===f.userId?0:f.userId,IPAddress:f.IPAddress};f.Post("InHoaDon",c,f.url).then(function(b){0!==b.data.Status.StatusCode&&""!==b.data.Status.MessageId?e.ShowMessageDialog(b.data.Status.MessageId):(a.dtInfo=b.data.Data,
a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,""!==b.data.URL&&(window.open(b.data.URL,"IN PHIEU THANH TOAN","width=600,height=650").print(),window.close()),"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio)}),"1"===a.BanHangCanTeen&&"1"===a.InVaLuuHoaDon&&a.btnLuuHoaDon_Click(a.BanHangCanTeen))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnLuuHoaDon_Click=function(b){var c=h("filter")(a.dtItem,{StatusId:2},!0);if(a.dtInfo.StatusId!=C.InHoaDon||c.length<a.dtItem.length)e.ShowMessageDialog("Phòng chưa in hóa đơn.");else if("1"===b){var d=[];d.push({Bank_AccountId:0,Amount:a.dtInfo.Info_TotalAmount,SoTaiKhoan:"",TaiKhoanNhan:""});var g={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X,Value01:a.dtInfo.ID,Value02:a.dtInfo.CustomerId,ListObject:d,IPAddress:f.IPAddress,LoaiPM:f.MaNganh};f.showloading(),f.Post("SaveInvoice",g,f.url).then(function(b){0!==b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):(y("Lưu thành công."),"1"===a.BanHangCanTeen||m.sendSaveInvoiceCompleted({MaGianHang:f.MaGianHang,StatusCode:0,TableId:X,InfoId:a.dtInfo.ID}),X=0,a.btnTableDetail_Click({ID:0,Code:"000",Name:"Takeaway"}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})}else e.ShowDetailFormDialog({data:{dtInfo:a.dtInfo,KhachHangList:a.KhachHangList,BankAccountList:a.BankAccountList,customerModels:a.customerModels,TongTienTamUng:a.TongTienTamUng},tempUrl:"app/components/Sales/Motel/ThanhToan.html?nd="+Date.now(),ctrl:"MotelThanhToanCtrl",cssclass:"Modal-width550",focuscontrolid:"txtTienKhachDua"}).then(function(b){if(1==b.confirmStatus){a.KhachHangList.length!==b.data.KhachHangList.length&&(a.KhachHangList=angular.copy(b.data.KhachHangList));var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:U,TableId:X,Value01:a.dtInfo.ID,Value02:b.data.dtInfo.CustomerId,ListObject:b.data.HinhThucTT};f.showloading(),f.Post("SaveInvoice",c,f.url).then(function(b){0!==b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):(y("Lưu thành công."),"1"===a.BanHangCanTeen||m.sendSaveInvoiceCompleted({MaGianHang:f.MaGianHang,StatusCode:0,TableId:X,InfoId:a.dtInfo.ID}),"1"===a.BanHangCanTeen?(X=0,a.btnTableDetail_Click({ID:0,Code:"000",Name:"Takeaway"})):(a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0,Q.Selected=0,Q=null))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})}})},a.btnGiamGiaTongBill_Click=function(){if(null===Q)e.ShowMessageDialog("Vui lòng chọn bàn.");else{var b=!1;g.keyBoardNumber(a.dtInfo.Info_DiscAmount,a.dtInfo.Info_Discount,"Điều chỉnh giảm giá tổng Bill",a.dtInfo.Info_Amount,1==a.dtInfo.Info_Dis_AmountEdit?1:0).then(function(c){0==c.discountType&&0==c.Cancel?a.dtInfo.Info_Discount!=c.value&&(a.dtInfo.Info_Discount=c.value,a.dtInfo.Info_DiscAmount=parseFloat(a.dtInfo.Info_Amount)*parseFloat(a.dtInfo.Info_Discount)/100,a.dtInfo.Info_Dis_AmountEdit=0,b=!0):1==c.discountType&&0==c.Cancel&&a.dtInfo.Info_DiscAmount!=c.value&&(a.dtInfo.Info_DiscAmount=c.value,a.dtInfo.Info_Discount=100*parseFloat(a.dtInfo.Info_DiscAmount)/parseFloat(a.dtInfo.Info_Amount),a.dtInfo.Info_Dis_AmountEdit=1,b=!0),1==b&&u()},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnPhiPhucVu_Click=function(){if(null===Q)e.ShowMessageDialog("Vui lòng chọn bàn.");else{var b=!1;g.keyBoardNumber(a.dtInfo.Info_ServiceChargeAmount,a.dtInfo.Info_Percent_ServiceCharge,"Điều chỉnh Phí phục vụ",a.dtInfo.Info_Amount,1==a.dtInfo.Info_ServiceChargeAmtEdit?1:0).then(function(c){0==c.discountType&&0==c.Cancel?a.dtInfo.Info_Percent_ServiceCharge!=c.value&&(a.dtInfo.Info_Percent_ServiceCharge=c.value,a.dtInfo.Info_ServiceChargeAmount=parseFloat(a.dtInfo.Info_Percent_ServiceCharge)*parseFloat(a.dtInfo.Info_Amount)/100,a.dtInfo.Info_ServiceChargeAmtEdit=0,b=!0):1==c.discountType&&0==c.Cancel&&a.dtInfo.Info_ServiceChargeAmount!=c.value&&(a.dtInfo.Info_ServiceChargeAmount=c.value,a.dtInfo.Info_Percent_ServiceCharge=100*parseFloat(a.dtInfo.Info_ServiceChargeAmount)/parseFloat(a.dtInfo.Info_Amount),a.dtInfo.Info_ServiceChargeAmtEdit=1,b=!0),1==b&&u()},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnChuyenGopBan_Click=function(b){var c=0;null===Q?e.ShowMessageDialog("Vui lòng chọn bàn."):Q.StatusId===C.InHoaDon?e.ShowMessageDialog("Bàn đã in hóa đơn, không thể thực hiện chuyển/gộp bàn."):(k.sessionStorage.AreaList=JSON.stringify(a.AreaList),k.sessionStorage.type=b,k.sessionStorage.MaBanGop=Q.ID,c=Q.ID,k.sessionStorage.displayKhuVuc_Ban=a.displayKhuVuc_Ban,k.sessionStorage.TongTien=a.dtInfo.Info_TotalAmount,k.sessionStorage.TinhTienGioId=a.GhiNhanTinhGio.Id,e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Restaurant/ChuyenGopBan.html",ctrl:"ChuyenGopBanCtrl",cssclass:"Modal-width750",focuscontrolid:""}).then(function(b){if(0==b.StatusId){a.btnAreaId_Click(b.Area);for(var d=0;d<=a.AreaListFilter.length-1;d++)a.AreaListFilter[d].Code===N.Code?a.AreaListFilter[d].Selected=1:a.AreaListFilter[d].Selected=0;a.btnTableDetail_Click(b.Table);for(var d=0;d<=a.TableListFilter.length-1;d++)a.TableListFilter[d].ID===Q.ID?a.TableListFilter[d].Selected=1:a.TableListFilter[d].Selected=0;a.btnChonBan(),m.sendChuyenGopBan({MaGianHang:f.MaGianHang,StatusCode:0,TableId:c,TableId_New:Q.ID})}}))},a.btnTienThue_Click=function(){var b=!1;g.selectVAT(a.dtInfo.Info_VAT_DiscAmount,a.VatList).then(function(c){""!=c.Code&&0==c.Cancel&&(a.dtInfo.Info_VAT_DiscAmount=c.GiaTri,a.dtInfo.Info_VatAmount=(a.dtInfo.Info_Amount-a.dtInfo.Info_DiscAmount+a.dtInfo.Info_ServiceChargeAmount)*a.dtInfo.Info_VAT_DiscAmount/100,b=!0),1==b&&u()},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnChiTietHoaDon_Click=function(){null===Q||1===a.isSelectArea?e.ShowMessageDialog("Vui lòng chọn bàn."):($("#divChiTietHoaDonOutside").css("height",$("#divContainer").height()-8),$("#divChiTietHoaDonOutside").css("display",""))},a.btnCloseChiTietHoaDon_Click=function(){$("#divChiTietHoaDonOutside").css("display","none")},a.btnSaveChiTietHoaDon_Click=function(){null===Q?e.ShowMessageDialog("Vui lòng chọn bàn."):(u(),a.btnCloseChiTietHoaDon_Click())},a.btnDanhSachTraMon_Click=function(){null===Q||1===a.isSelectArea?e.ShowMessageDialog("Vui lòng chọn bàn."):($("#divDanhSachTraMonOutside").css("height",$("#divContainer").height()-8),$("#divDanhSachTraMonOutside").css("display",""))},a.btnCloseDanhSachTraMon_Click=function(){$("#divDanhSachTraMonOutside").css("display","none")},a.btnChuongTrinhKhuyenMai_Click=function(){var b=null===a.dtChuongTrinhKhuyenMai||1===a.isSelectArea||void 0===a.dtChuongTrinhKhuyenMai?0:a.dtChuongTrinhKhuyenMai.length;if(null===Q)e.ShowMessageDialog("Vui lòng chọn bàn.");else if(0===b)e.ShowMessageDialog("Không có chương trình khuyến mãi ở thời điểm hiện tại.");else{g.selectChuongTrinhKhuyenMai(a.dtChuongTrinhKhuyenMai).then(function(a){0==a.Cancel&&u(a.PromotionType,a.ID)},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnKhuyenMaiTheVip_Click=function(){null===Q||1===a.isSelectArea?e.ShowMessageDialog("Vui lòng chọn bàn."):($("#divKhuyenMaiTheVipOutside").css("height",$("#divContainer").height()-8),$("#divKhuyenMaiTheVipOutside").css("display",""))},a.btnCloseKhuyenMaiTheVip_Click=function(){$("#divKhuyenMaiTheVipOutside").css("display","none")},a.MaTheVipFilter_selectedrow=function(b){0!==b.ID&&0===b.Field7?e.ShowMessageDialog("Thẻ Vip đã hết hạn sử dụng."):(a.dtInfo.VipId=b.ID,u(null,null,1))},a.btnDoiDiem_Click=function(){e.ShowConfirmDialog("Bạn có chắc muốn đổi điểm thẻ Vip ?").then(function(b){if(0==b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,InfoId:a.dtInfo.ID,MaTheVipId:a.dtInfo.VipId,HanMucDoiDiemThuong:a.DataConfig.HanMucDoiDiemThuong};f.Post("DoiDiemTheVip",c,f.url).then(function(b){if(0===b.data.Status.StatusCode){a.dtDoiDiemVipList=b.data.Data,a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var c=0,d=0;d<=a.dtDoiDiemVipList.length-1;d++)c+=parseFloat(a.dtDoiDiemVipList[d].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(c),y("Đổi điểm thành công.")}},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})},a.btnKhaiBaoTienDauCa_Click=function(a){e.ShowDetailFormDialog({data:a,tempUrl:"app/components/Sales/Restaurant/KhaiBaoTienDauCa.html",ctrl:"TienDauCaCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(a){})},a.btnBaoCaoKetCa_Click=function(){e.ShowDetailFormDialog({data:null,tempUrl:"app/components/Sales/Restaurant/BaoCaoKetCa.html",ctrl:"BaoCaoKetCaCtrl",cssclass:"Modal-width700",focuscontrolid:""}).then(function(a){})},a.btnTamUng_Click=function(){null!==a.dtInfo.ID&&""!==a.dtInfo.ID&&void 0!==a.dtInfo.ID&&e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Motel/TamUng.html",ctrl:"MotelTamUngCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){if(1===b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,InfoId:a.dtInfo.ID};f.Post("GetDataTienTamUng",c,f.url).then(function(b){0===b.data.Status.StatusCode&&(a.TamUngList=b.data.Data,z())},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})},a.btnKhachThuePhong_Click=function(){null!==a.dtInfo.ID&&""!==a.dtInfo.ID&&void 0!==a.dtInfo.ID&&e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Motel/KhachThuePhong.html",ctrl:"KhachThuePhongCtrl",cssclass:"Modal-width800",focuscontrolid:"TenKH"}).then(function(b){if(1===b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,InfoId:a.dtInfo.ID};f.Post("GetDataKhachHang",c,f.url).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})},a.btnLogOut_Click=function(){e.ShowConfirmDialog("Bạn có chắc muốn thoát chương trình ?").then(function(a){0==a&&j.path("/")})},a.chkIsTinhGio_Checked=function(){e.ShowConfirmDialog("Bạn có chắc muốn [Check in] cho Phòng đang chọn ?").then(function(b){if(0==b){a.dtInfo.IsTinhGio=1,console.log(a.dtInfo);var c={AreaId:N.ID,TableId:Q.ID,InfoId:a.dtInfo.ID,CompanyId:f.CompanyId,BranchId:f.BranchId,HinhThucTinhGioId:a.dtInfo.HinhThucTinhGioId};f.Post("GhiNhanTinhGio",c,f.url).then(function(b){0===b.data.Status.StatusCode&&(a.GhiNhanTinhGio=b.data.Data,a.dtInfo=b.data.Data2,"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio)}))},function(a){})["finally"](function(){f.closeloading()})}else a.dtInfo.IsTinhGio=0})},a.btnTinhTienGio_Click=function(){e.ShowDetailFormDialog({data:{dtInfo:a.dtInfo,GhiNhanTinhGio:a.GhiNhanTinhGio,allowEditGioVao:G,HinhThucTinhGioList:a.HinhThucTinhGioList},tempUrl:"app/components/Sales/Motel/TinhTienPhong.html",ctrl:"TinhTienPhongCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){if(0===b.statusCode){var c=b.aaValue;c.HinhThucTinhGioId=a.dtInfo.HinhThucTinhGioId,c.AreaId=a.dtInfo.AreaId,f.Post("TinhTienPhong",c,f.url).then(function(b){0===b.data.Status.StatusCode&&(a.dtInfo=b.data.Data,a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,a.dtDoiDiemVipList=b.data.Data9,a.GhiNhanTinhGio=b.data.Data10,a.TamUngList=b.data.Data11,z(),"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio)}))},function(a){})["finally"](function(){f.closeloading()})}})},a.cboHinhThucTinhGio_Change=function(a){u()},i(function(){A()},50)}]),app.controller("TinhTienPhongCtrl",["$scope","$uibModalInstance","$timeout","$filter","$window","data","AppDialog","MotelService",function(a,b,c,d,e,f,g,h){function i(){a.allowEditGioVao=f.allowEditGioVao;var b=new Date,c=b.getFullYear(),d=b.getMonth(),e=b.getDate(),g=b.getHours(),h=b.getMinutes(),i=c.toString()+(d+1>9?(d+1).toString():"0"+(d+1).toString())+(e>9?e.toString():"0"+e.toString())+(g>9?g.toString():"0"+g.toString())+(h>9?h.toString():"0"+h.toString()),j=new Date(a.GhiNhanTinhGio.ToTime);console.log(j),c=j.getFullYear(),d=j.getMonth(),e=j.getDate(),g=j.getHours(),h=j.getMinutes();var k=c.toString()+(d+1>9?(d+1).toString():"0"+(d+1).toString())+(e>9?e.toString():"0"+e.toString())+(g>9?g.toString():"0"+g.toString())+(h>9?h.toString():"0"+h.toString());console.log(k),parseFloat(k)<parseFloat(i)&&(a.GhiNhanTinhGio.ToTime=new Date,a.GhiNhanTinhGio.ToHour=b.getHours(),a.GhiNhanTinhGio.ToMinute=b.getMinutes())}a.dtInfo=f.dtInfo,a.GhiNhanTinhGio=f.GhiNhanTinhGio,a.GioRaDuKien=new Date,a.allowEditGioVao=f.allowEditGioVao,a.HinhThucTinhGioList=f.HinhThucTinhGioList,c(function(){i()},50),a.btnCancel_Click=function(){b.close({statusCode:-1,aaValue:null})},a.btnTinhTienGio_Click=function(){g.ShowConfirmDialog("Bạn có chắc muốn tính tiền phòng ?").then(function(c){0==c&&(a.GhiNhanTinhGio.TinhTienGioId=a.GhiNhanTinhGio.Id,b.close({statusCode:0,aaValue:a.GhiNhanTinhGio}))})}}]),app.controller("MotelTamUngCtrl",["$scope","$uibModalInstance","$timeout","$filter","$window","data","AppDialog","MotelService",function(a,b,c,d,e,f,g,h){function i(){h.showloading();var b={CompanyId:h.CompanyId,BranchId:h.BranchId,InfoId:k.ID};h.Post("GetDataTienTamUng",b,h.url).then(function(b){0===b.data.Status.StatusCode&&(a.TamUngList=b.data.Data,a.TamUngObj=b.data.Data2,j())},function(a){showAlertMessage($translate.instant("CMN_MSG_ERROR"))}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()})}function j(){a.TongTienTamUng=0;for(var b=0;b<=a.TamUngList.length-1;b++)a.TongTienTamUng+=parseFloat(a.TamUngList[b].Amount)}var k=f;a.TamUngList=null,a.TamUngObj=null,a.TongTienTamUng=0;var l=0;a.btnCancel_Click=function(){b.close(l)},a.btnSaveTienTamUng_Click=function(){parseFloat(a.TamUngObj.Amount)<=0?(g.ShowMessageDialog("Vui lòng nhập tiền tạm ứng"),$("#Amount").focus()):(h.showloading(),a.TamUngObj.InfoId=k.ID,a.TamUngObj.UserName=h.UserName,a.TamUngObj.CompanyId=h.CompanyId,a.TamUngObj.BranchId=h.BranchId,h.Post("UpdateTienTamUng",a.TamUngObj,h.url).then(function(b){0===b.data.Status.StatusCode&&(g.ShowMessageDialog("Lưu thành công."),a.TamUngList=b.data.Data,j(),l=1)},function(a){g.ShowMessageDialog("Đã có lỗi xảy ra, vui lòng thử lại.")}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()}))},a.btnRemoveRow_Click=function(b){g.ShowConfirmDialog("Bạn có chắc muốn xóa tiền tạm ứng ?").then(function(c){0==c&&(b.IsDeleted=1,h.showloading(),b.UserName=h.UserName,h.Post("UpdateTienTamUng",b,h.url).then(function(b){0===b.data.Status.StatusCode&&(g.ShowMessageDialog("Xóa thành công."),a.TamUngList=b.data.Data,j(),l=1)},function(a){g.ShowMessageDialog("Đã có lỗi xảy ra, vui lòng thử lại.")}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()}))})},c(function(){i()},50)}]),app.controller("MotelThanhToanCtrl",["$scope","$timeout","$uibModalInstance","data","RestaurantService","AppDialog",function(a,b,c,d,e,f){function g(b){e.showloading();var c={CompanyId:e.CompanyId,BranchId:e.BranchId,MasterType:b};e.Post("reloadMasterPlus",c,e.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?f.ShowMessageDialog(b.data.Status.MessageId):"Customer"===b.data.Status.ObjData&&(a.KhachHangList=b.data.Data)},function(a){showAlertMessage($translate.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})}a.dataCopy=angular.copy(d),a.IsEnableCustomerId=!0,a.success=!1,a.submitted=!1,a.dtInfo=d.dtInfo,a.KhachHangList=d.KhachHangList,a.BankAccountList=d.BankAccountList,a.customerModels=d.customerModels,a.TongTienTamUng=d.TongTienTamUng,a.TienConLaiPhaiTra=parseFloat(a.dtInfo.Info_TotalAmount)>parseFloat(a.TongTienTamUng)?parseFloat(a.dtInfo.Info_TotalAmount)-parseFloat(a.TongTienTamUng):0,a.txtTienMat=a.dtInfo.Info_TotalAmount,a.txtTheNganHang=0,a.txtTienKhachDua=0,a.txtTienTraLaiKhach=0,a.txtTongTienKhachDaTra=parseFloat(a.txtTienMat)+parseFloat(a.txtTheNganHang),b(function(){a.MaKHOptions.setValue=parseFloat(a.dtInfo.CustomerId),a.CustomerId=a.dtInfo.CustomerId,parseFloat(a.dtInfo.CustomerId)>0?a.IsEnableCustomerId=!1:a.IsEnableCustomerId=!0},100),a.txtTienKhachDua_Change=function(){a.txtTienTraLaiKhach=parseFloat(a.txtTienKhachDua)-parseFloat(a.TienConLaiPhaiTra),a.txtTienTraLaiKhach=a.txtTienTraLaiKhach<0?0:a.txtTienTraLaiKhach,parseFloat(a.txtTienKhachDua)>0&&(a.txtTienMat=parseFloat(a.txtTienKhachDua)+parseFloat(a.TongTienTamUng)>parseFloat(a.dtInfo.Info_TotalAmount)?parseFloat(a.dtInfo.Info_TotalAmount)-parseFloat(a.txtTheNganHang):parseFloat(a.txtTienKhachDua)+parseFloat(a.TongTienTamUng)-parseFloat(a.txtTheNganHang),a.txtTienMat=a.txtTienMat<0?0:a.txtTienMat,a.TinhTongTienKhachTra())},a.TinhTongTienKhachTra=function(){a.txtTongTienKhachDaTra=parseFloat(a.txtTienMat)+parseFloat(a.txtTheNganHang),a.txtTongTienKhachDaTra=a.txtTongTienKhachDaTra<0?0:a.txtTongTienKhachDaTra},a.btnSave_Click=function(){if(parseFloat(a.txtTongTienKhachDaTra)>parseFloat(a.dtInfo.Info_TotalAmount))return void f.ShowMessageDialog("Tiền khách trả không được lớn hơn tổng tiền hóa đơn.");if(0!==parseFloat(a.txtTheNganHang)&&(0===a.Bank_AccountId||void 0===a.Bank_AccountId||null===a.Bank_AccountId))return f.ShowMessageDialog("Vui lòng chọn ngân hàng"),void $("#Bank_AccountId").focus();if(parseFloat(a.txtTongTienKhachDaTra)<parseFloat(a.dtInfo.Info_TotalAmount)&&(a.CustomerId<=0||void 0===a.CustomerId||null===a.CustomerId))return void f.ShowMessageDialog("Tiền khách trả nhỏ hơn tổng tiền hóa đơn, vui lòng chọn Khách hàng để ghi nhận công nợ.");a.dtInfo.CustomerId=a.CustomerId,a.HinhThucThanhToan=[],parseFloat(a.txtTienMat)>0&&a.HinhThucThanhToan.push({Bank_AccountId:0,Amount:a.txtTienMat,SoTaiKhoan:"",TaiKhoanNhan:""}),parseFloat(a.txtTheNganHang)>0&&a.HinhThucThanhToan.push({Bank_AccountId:a.Bank_AccountId,Amount:a.txtTheNganHang,SoTaiKhoan:"",TaiKhoanNhan:""});var b={dtInfo:a.dtInfo,KhachHangList:a.KhachHangList,HinhThucTT:a.HinhThucThanhToan};c.close({confirmStatus:1,data:b})},a.btnCancel_Click=function(){c.close({confirmStatus:0,data:a.dtInfo})},a.btnCustomerPlus_Click=function(){a.dataid=0;var b={ID:0,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("detail",b,e.Url+"api/Customer/").then(function(b){a.data=b.data.Data}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerDetail.html",ctrl:"CustomerDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(a){1==a&&g("Customer")})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){e.closeloading()})}}]),app.controller("KhachThuePhongCtrl",["$scope","$uibModalInstance","$timeout","$filter","$window","data","AppDialog","MotelService",function(a,b,c,d,e,f,g,h){function i(){h.showloading();var b={CompanyId:h.CompanyId,BranchId:h.BranchId,InfoId:j.ID};h.Post("GetDataKhachHang",b,h.url).then(function(b){0===b.data.Status.StatusCode&&(a.KhachThuePhongList=b.data.Data,a.KhachThuePhongObj=b.data.Data2)},function(a){showAlertMessage($translate.instant("CMN_MSG_ERROR"))}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()})}var j=f;a.KhachThuePhongList=null,a.KhachThuePhongObj=null;var k=0;a.btnCancel_Click=function(){b.close(k)},a.btnSaveKhachThuePhong_Click=function(){void 0===a.KhachThuePhongObj.TenKH||null===a.KhachThuePhongObj.TenKH?(g.ShowMessageDialog("Vui lòng nhập họ tên"),$("#TenKH").focus()):void 0===a.KhachThuePhongObj.SoCMND||null===a.KhachThuePhongObj.SoCMND?(g.ShowMessageDialog("Vui lòng nhập Số chứng minh thư"),$("#SoCMND").focus()):(h.showloading(),a.KhachThuePhongObj.InfoId=j.ID,a.KhachThuePhongObj.UserName=h.UserName,a.KhachThuePhongObj.CompanyId=h.CompanyId,a.KhachThuePhongObj.BranchId=h.BranchId,h.Post("UpdateKhachHang",a.KhachThuePhongObj,h.url).then(function(b){0===b.data.Status.StatusCode&&(g.ShowMessageDialog("Lưu thành công."),a.KhachThuePhongList=b.data.Data,k=1)},function(a){g.ShowMessageDialog("Đã có lỗi xảy ra, vui lòng thử lại.")}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()}))},a.btnRemoveRow_Click=function(b){g.ShowConfirmDialog("Bạn có chắc muốn xóa khách thuê phòng ?").then(function(c){0==c&&(b.IsDeleted=1,h.showloading(),b.UserName=h.UserName,h.Post("UpdateKhachHang",b,h.url).then(function(b){0===b.data.Status.StatusCode&&(g.ShowMessageDialog("Xóa thành công."),a.KhachThuePhongList=b.data.Data,k=1)},function(a){g.ShowMessageDialog("Đã có lỗi xảy ra, vui lòng thử lại.")}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()}))})},c(function(){i()},50)}]),app.factory("NhatKyBanHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("NhatKyBanHangCtrl",["$scope","$filter","$uibModal","$timeout","$translate","AppDialog","NhatKyBanHangService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_NhatKyBanHang",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.CustomerList=b.data.Data,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var c=b("filter")(g.Role,{ScreenCode:"Sales_NhatKyBanHang"},!0);if(c.length>0){var d=b("filter")(c,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.TotalRow=null,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BC_NhatKyBanHang",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,CompanyId:g.CompanyId,BranchId:g.BranchId},c="BC_NhatKyBanHang.xlsx";g.ExportExcel("BC_NhatKyBanHangExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("BanLeService",["$q","$http","AppServices","AuthenticationService","signalR",function(a,b,c,d,e){var f=Object.create(c);return f.url=f.Url+"api/Restaurant/",f.urlCombobox=f.Url+"api/Combobox/",e.startHub({MaGianHang:c.MaGianHang,IsServer_Offline:0,ComputerName:c.UserName,LoginDevice:"WebApp",ScreenName:"ManHinhBanLe-1.0",PublicIP:c.PublicIP}).then(function(){}),f}]),app.controller("ManHinhBanLeCtrl",["$scope","$q","$uibModal","$translate","AppDialog","BanLeService","appKeyBoard","$filter","$timeout","$location","$window","$interval","signalR",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,IPAddress:f.IPAddress,UserId:f.userId};f.Post("InitHoaDonBanLe",b,f.urlCombobox).then(function(b){if(0===b.data.Status.StatusCode){var c=parseInt(b.data.isCheckTienDauCa);0===c&&a.btnKhaiBaoTienDauCa_Click(0),a.DataConfig=b.data.DataConfig,a.ItemCategoryList=b.data.Data,a.ItemList=JSON.parse(b.data.Data2),a.VatList=b.data.Data3,a.KhachHangList=b.data.Data4,a.NVPVuList=b.data.Data5,a.MaNVLapList=b.data.Data5,a.SellerIdList=b.data.Data5,a.NVChonMonList=b.data.Data5,a.dtKhuyenMaiHangHoa=b.data.Data6,a.dtChuongTrinhKhuyenMai=b.data.Data7,a.BankAccountList=b.data.Data8,a.customerModels=b.data.Data9,a.TheVipList=b.data.Data10,a.ShipperList=b.data.Data11,a.DetailBangGiaLePos=JSON.parse(b.data.Data12),a.dtInfo=b.data.Data13,a.dtItem=a.dtInfo.listDetail,a.drItem=b.data.Data14,a.ArrHoaDon=b.data.Data15,a.LocationList=b.data.Data16,a.TonKhoList=JSON.parse(b.data.ArrTonKho),a.ItemCategoryList.push({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:"",Selected:0}),0===a.ArrHoaDon.length&&a.ArrHoaDon.push({OrdinalNumber:0,InfoId:""}),x(a.ArrHoaDon[0])}},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))}).then(function(b){J=$("#divItemListDetail").width()-20,K=$("#divItemListDetail").height()-20;var c=parseInt(J/L),d=parseInt(K/M);a.itemListDetailPerPage=c*d;var e=(J-L*c)/2,f=(K-M*d)/2;$("#divContainerItemDetail").css("padding-left",e),$("#divContainerItemDetail").css("padding-top",f),a.btnItemCategory_Click({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:""})},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading(),$("#btnItemDetailPre").css("display",""),$("#btnItemDetailNext").css("display",""),a.SoHoaDonHienThiToiDa=30})}function o(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,IPAddress:f.IPAddress};f.Post("InitHoaDonBanLe2",b,f.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.ItemList=JSON.parse(b.data.Data2),a.DetailBangGiaLePos=JSON.parse(b.data.Data12))},function(a){}).then(function(b){a.ItemListFilter=null===G||0===G.ID?a.ItemList:h("filter")(a.ItemList,{Field6:G.ID.toString()},!0),a.btnShowAllItemDetail_Click(G)},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}function p(){for(var b=0;b<=a.ItemListDetailFilter.length-1;b++){var c=h("filter")(a.DetailBangGiaLePos,{ItemId:a.ItemListDetailFilter[b].ID,UnitId:parseFloat(a.ItemListDetailFilter[b].Field3)},!0);c.length>0&&(a.ItemListDetailFilter[b].UnitPrice=c[0].Price);var d=h("filter")(a.TonKhoList,{ItemId:a.ItemListDetailFilter[b].ID,DVT:parseFloat(a.ItemListDetailFilter[b].Field3)},!0);d.length>0?a.ItemListDetailFilter[b].SLTonKho=d[0].SLDK:a.ItemListDetailFilter[b].SLTonKho=0}}function q(){var a=$("#td-sale-invoice").height()-40;$("#divSaleInvoice").height(a);var b=$("#td-Detail-Item").height();$("#divDetailTable_Item").height(b-10)}function r(b,c){f.showloading();var g={CompanyId:f.CompanyId,BranchId:f.BranchId,MasterType:b};f.Post("reloadMasterPlus",g,f.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):"Customer"===b.data.Status.ObjData&&(a.KhachHangList=b.data.Data,a.dtInfo.CustomerId=c.ID,a.dtInfo.DiaChiKH=c.Address,a.dtInfo.DienThoaiKH=c.PhoneNo)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function s(b,c){null===c&&(c=1),a.priceItem=0;var d=null===a.PriceDetailByCustomer?a.DetailBangGiaLePos:a.PriceDetailByCustomer,e=h("filter")(d,{ItemId:b.ID,UnitId:parseFloat(b.Field3)},!0);e.length>0&&(a.priceItem=e[0].Price);var g=angular.copy(a.drItem),i=h("filter")(a.dtItem,{ItemId:b.ID,UomId:parseFloat(b.Field3),UnitPrice:a.priceItem,StatusId:D.ChonMon},!0),j=new Date,k=j.getFullYear()+""+j.getMonth()+j.getDate()+j.getHours()+j.getMinutes()+j.getSeconds();if(0===a.dtInfo.EmployeeOrderId&&(a.dtInfo.EmployeeOrderId=null===f.userId||void 0===f.userId?0:f.userId),0==i.length){g.ID=0,g.IdTmp=k,g.InfoId="",g.AddOn=0,g.ParentId=0,g.ItemId=b.ID,g.ItemName=b.Name,g.Quantity=parseFloat(c),g.UomId=parseFloat(b.Field3),g.UnitPrice=parseFloat(a.priceItem),g.DisCount02=0,g.Disc_Amount02=0,g.BranchId=f.BranchId,g.CompanyId=f.CompanyId,g.Canceled=0,g.StatusId=0,g.Amount=parseFloat(g.Quantity)*parseFloat(g.UnitPrice),g.DisCount01=0,g.Disc_Amount01=parseFloat(g.Amount)*parseFloat(g.DisCount01)/100,g.VAT_DiscAmount=0,g.VatAmount=parseFloat(g.Amount)*parseFloat(g.VAT_DiscAmount)/100,g.TotalAmount=parseFloat(g.Amount)+parseFloat(g.VatAmount)-parseFloat(g.Disc_Amount01),g.RowStatus=C.Active;var l=h("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1},!0);if(1===a.dtChuongTrinhKhuyenMai.length&&1===l.length){var m=h("filter")(a.dtKhuyenMaiHangHoa,{ItemId:b.ID,UomId:parseFloat(b.Field3)},!0);m.length>0&&(0===m[0].DiscAmountEdit?(g.DisCount01=m[0].Discount,g.Dis_AmountEdit=0,g.Disc_Amount01=parseFloat(g.Amount)*parseFloat(g.DisCount01)/100):(g.Disc_Amount01=m[0].DiscAmount,g.Dis_AmountEdit=1,0!=g.Disc_Amount01&&0!=g.Amount&&(g.DisCount01=100*g.Disc_Amount01/g.Amount)),g.TotalAmount=parseFloat(g.Amount)+parseFloat(g.VatAmount)-parseFloat(g.Disc_Amount01))}a.dtItem.push(g),1===b.Field11}else i[0].Quantity+=parseFloat(c),i[0].Amount=parseFloat(i[0].Quantity)*parseFloat(i[0].UnitPrice),0===i[0].Dis_AmountEdit?i[0].Disc_Amount01=parseFloat(i[0].Amount)*parseFloat(i[0].DisCount01)/100:i[0].DisCount01=100*i[0].Disc_Amount01/i[0].Amount,i[0].TotalAmount=i[0].Amount-i[0].Disc_Amount01,i[0].RowStatus=C.Update;u().then(function(a){v()})}function t(a,b){}function u(c,d,g){var i=b.defer(),j=9;a.dtInfo.BranchId=f.BranchId,a.dtInfo.CompanyId=f.CompanyId,a.dtInfo.IPAddress=f.IPAddress,d=void 0===d||null===d?"":d;var k=h("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1,Id:d},!0);if(1===k.length)for(var l=0;l<=a.dtItem.length-1;l++){var m=h("filter")(a.dtKhuyenMaiHangHoa,{ItemId:a.dtItem[l].ItemId,UomId:a.dtItem[l].UomId,DocInfoId:d},!0);m.length>0&&(0===m[0].DiscAmountEdit?(a.dtItem[l].DisCount01=m[0].Discount,a.dtItem[l].Dis_AmountEdit=0,a.dtItem[l].Disc_Amount01=parseFloat(a.dtItem[l].Amount)*parseFloat(a.dtItem[l].DisCount01)/100):(a.dtItem[l].Disc_Amount01=m[0].DiscAmount,a.dtItem[l].Dis_AmountEdit=1,0!=a.dtItem[l].Disc_Amount01&&0!=a.dtItem[l].Amount&&(a.dtItem[l].DisCount01=100*a.dtItem[l].Disc_Amount01/a.dtItem[l].Amount)),a.dtItem[l].TotalAmount=parseFloat(a.dtItem[l].Amount)+parseFloat(a.dtItem[l].VatAmount)-parseFloat(a.dtItem[l].Disc_Amount01))}var n={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,dtInfo:a.dtInfo,dtItem:a.dtItem,dtReturnItem:a.dtReturnItem,PromotionType:c,PromotionId:d,KhuyenMaiVip:g,IPAddress:f.IPAddress};return f.showloading(),f.Post("SaveInvoiceTmp",n,f.url).then(function(b){a.dtInfo.ID,b.data.Status.StatusCode;if(3==b.data.Status.StatusCode)a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0;else{if(9==b.data.Status.StatusCode)return void e.ShowMessageDialog(b.data.Status.MessageId);a.dtInfo=JSON.parse(b.data.Data),
a.dtItem=JSON.parse(b.data.Data2),a.dtReturnItem=JSON.parse(b.data.Data4),a.ArrHoaDon=b.data.ArrHoaDon,w(),a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var c=0,d=0;d<=a.dtDoiDiemVipList.length-1;d++)c+=parseFloat(a.dtDoiDiemVipList[d].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(c)}j=0,i.resolve(j)},function(a){console.log("Error:"+a.data.Message),i.reject("Error:"+a.data.Message)})["finally"](function(){f.closeloading()}).then(function(a){},function(a){console.log("error:"+a.data),i.reject("error:"+a.data)}),i.promise}function v(b){(null===b||void 0===b)&&(b=0);var c=h("filter")(a.dtItem,{StatusId:0},!0);if(c.length>0||1===b){a.dtInfo.SoTienKhachDua=a.dtInfo.Info_TotalAmount;var d=parseFloat(a.dtInfo.SoTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount);0>=d&&(d=0),a.dtInfo.TienTraLaiKhach=d}}function w(){if(""===E.InfoId)a.ArrHoaDon[a.ArrHoaDon.length-1].Selected=1;else for(var b=0;b<=a.ArrHoaDon.length-1;b++)a.ArrHoaDon[b].InfoId===E.InfoId?a.ArrHoaDon[b].Selected=1:a.ArrHoaDon[b].Selected=0}function x(b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,ID:b.InfoId};f.Post("GetDetailById",c,f.url).then(function(b){a.dtInfo=JSON.parse(b.data.Data),a.dtItem=JSON.parse(b.data.Data2),a.dtReturnItem=JSON.parse(b.data.Data4),a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,a.dtDoiDiemVipList=JSON.parse(b.data.Data9),a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var c=0,d=0;d<=a.dtDoiDiemVipList.length-1;d++)c+=parseFloat(a.dtDoiDiemVipList[d].HanMucDoiDiemThuong);if(a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(c),a.MaKHOptions.setValue=a.dtInfo.CustomerId,a.MaTheVipFilterOptions.setValue=a.dtInfo.VipId,v(),parseFloat(a.dtInfo.CustomerId)>0){var e=h("filter")(a.KhachHangList,{ID:a.dtInfo.CustomerId},!0);if(e.length>0)var g=null!==e[0].Field6?e[0].Field6:0;if(parseFloat(g)>0){var i={CompanyId:f.CompanyId,BranchId:f.BranchId,ID:g};f.Post("GetDetailBangGiaLePosById",i,f.Url+"api/BGLePOS/").then(function(b){a.PriceDetailByCustomer=JSON.parse(responsee.data.Data)},function(a){})["finally"](function(){})}}else a.PriceDetailByCustomer=null},function(a){console.log("Error:"+a.data.Message)}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()}),F=E,E=b,E.Selected=1,null!=F&&b!=F&&(F.Selected=0)}function y(b){b.StatusId===D.InHoaDon?e.ShowConfirmDialog("Bạn có chắc muốn xóa ["+b.ItemName+"] ?").then(function(a){0==a&&g.LyDoTraDialog("").then(function(a){0==a.Cancel&&(b.RowStatus=C.InActive,z(b,parseFloat(b.Quantity),a.value),u().then(function(a){v(1)}))})}):(b.RowStatus=C.InActive,t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u().then(function(a){v(1)}))}function z(b,c,d){null===c&&(c=1);var e=angular.copy(a.drReturnItem);e.ItemId=b.ItemId,e.ItemName=b.ItemName,e.Quantity=parseFloat(c),e.UomId=b.UomId,e.UnitPrice=b.UnitPrice,e.Amount=parseFloat(e.Quantity)*parseFloat(e.UnitPrice),e.DisCount01=0,e.Disc_Amount01=0,e.DisCount02=0,e.Disc_Amount02=0,e.Note=d,e.StatusId=b.StatusId,e.RowStatus=C.Active,a.dtReturnItem.push(e)}function A(a){$("#btnshowAlertMsgContent").html(a),$("#btnshowAlertMsg").alert(),$("#btnshowAlertMsg").fadeTo(1e3,300).slideUp(300,function(){$("#btnshowAlertMsg").slideUp(300)})}function B(){var b=h("filter")(f.Role,{ScreenCode:"ScreenPOSLe"},!0);if("1"!==f.IsAdministrator){if(b.length>0){var c=h("filter")(b,{ActionCode:"InHoaDon"},!0)[0];$("#btnInHoaDon").prop("disabled",void 0===c?!0:!c.IsEnable);var d=h("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnLuuHoaDon").prop("disabled",void 0===d?!0:!d.IsEnable);var e=h("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=void 0===e?!1:e.IsEnable;var g=h("filter")(b,{ActionCode:"EditPostingDate"},!0)[0];a.editPostingDate=void 0===g?!1:g.IsEnable}}else{var e=h("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=!0;var g=h("filter")(b,{ActionCode:"EditPostingDate"},!0)[0];a.editPostingDate=!0}}var C={Active:1,Update:2,InActive:3},D={ChonMon:0,InHoaDon:2};a.linkPdfPhieuThanhToan="http://",a.CurrOrdinalNumber=0,a.ArrHoaDon=null;var E=null,F=null;a.DataConfig=null,a.ItemCategoryList=null,a.ItemList=null,a.VatList=null,a.KhachHangList=null,a.NVPVuList=null,a.NVKinhDoanh=null,a.MaNVLapList=null,a.SellerIdList=null,a.NVChonMonList=null,a.permissionList=null,a.systemData=null,a.dtChuongTrinhKhuyenMai=null,a.dtKhuyenMaiHangHoa=null,a.TheVipList=null,a.dtDoiDiemVipList=null,a.ShipperList=null,a.DetailBangGiaLePos=null,a.PriceDetailByCustomer=null,a.SoHoaDonHienThiToiDa=4,a.ChoPhepSuaGiaBan=!1,a.editPostingDate=!1,a.LocationList=null,a.TonKhoList=null,a.dtInfo=null,a.dtItem=null,a.drItem=null,a.DiemTichLuySauDoiDiem=0,a.customerModels=null,a.BankAccountList=null,a.HinhThucThanhToan=[],a.MaKHOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"300",field3width:"0",field4width:"0",field5width:"0",setValue:-1,maxDropDownItems:6},a.selectedRow=0,a.setClickedRow=function(b){a.selectedRow=b;var c=a.dtItem[a.selectedRow];1==c.AddOn?a.btnAddOnDisable=!0:a.btnAddOnDisable=!1};var G=null,H=null,I=null,J=0,K=0;a.itemListDetailPerPage=0;var L=160,M=105,N=0;a.ItemListDetailFilter=null,a.btnAllItemCategory_Selected=0;var O=null;a.isShowbtnDelete=!1,a.MaTheVipFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.btnItemCategory_Click=function(b){a.txtTextSearch="",a.ItemListFilter=0===b.ID?a.ItemList:h("filter")(a.ItemList,{Field6:b.ID.toString()},!0),itemCategoryBeforeSelected=G,G=b,G.Selected=1,null!=itemCategoryBeforeSelected&&b!=itemCategoryBeforeSelected&&(itemCategoryBeforeSelected.Selected=0),a.btnShowAllItemDetail_Click(b),$("#txtMaHangQuetBarcode").focus()},a.btnShowAllItemDetail_Click=function(b){void 0===b?a.btnItemCategory_Click({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:""}):(b.Selected=1,0===b.ID?a.btnAllItemCategory_Selected=1:a.btnAllItemCategory_Selected=0),O=angular.copy(a.ItemListFilter),N=1;var c=(N-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;a.ItemListDetailFilter=O.slice(c,d),p()},a.btnItemDetailPre_Click=function(){N>1&&(N-=1);var b=(N-1)*a.itemListDetailPerPage,c=b+a.itemListDetailPerPage;a.ItemListDetailFilter=O.slice(b,c),p()},a.btnItemDetailNext_Click=function(){var b=N+1,c=(b-1)*a.itemListDetailPerPage,d=c;c<O.length&&(d=c+a.itemListDetailPerPage,a.ItemListDetailFilter=O.slice(c,d),N=b,p())},a.$watch("txtTextSearch",function(b){if(void 0!==a.ItemListFilter){N=1;var c=(N-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;O=h("filter")(a.ItemListFilter,b),a.ItemListDetailFilter=O.slice(c,d),p()}}),i(function(){q(),n()},2e3),a.btnItemDetail_SingleClick=function(a){I=H,H=a,H.Selected=1,null!=I&&a!=I&&(I.Selected=0);var b=1;s(a,b)},a.btnAddNewItem_Click=function(){e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Restaurant/AddItem.html",ctrl:"AddNewItemCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(a){0===a&&(o(),m.sendInitTouchScreen2({MaGianHang:f.MaGianHang,StatusCode:0}))})},a.btnCustomerPlus_Click=function(){a.dataid=0;var b={ID:0,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",b,f.Url+"api/Customer/").then(function(b){a.data=b.data.Data}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerDetail.html",ctrl:"CustomerDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(a){if(1===a.confirm){var b=a.data;r("Customer",b)}})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.btnKhaiBaoTienDauCa_Click=function(a){e.ShowDetailFormDialog({data:a,tempUrl:"app/components/Sales/Restaurant/KhaiBaoTienDauCa.html",ctrl:"TienDauCaCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(a){})},a.btnBaoCaoKetCa_Click=function(){e.ShowDetailFormDialog({data:null,tempUrl:"app/components/Sales/Restaurant/BaoCaoKetCa.html",ctrl:"BaoCaoKetCaCtrl",cssclass:"Modal-width700",focuscontrolid:""}).then(function(a){})},a.txtMaHangQuetBarcode_keydown=function(b){if(13===b.which){var c=h("filter")(a.ItemList,{Barcode:a.txtMaHangQuetBarcode.toUpperCase()},!0);if(1===c.length){if(s(c[0],1),a.txtMaHangQuetBarcode="",$("#txtMaHangQuetBarcode").focus(),void 0!==a.ItemListFilter){N=1;var d=(N-1)*a.itemListDetailPerPage,e=d+a.itemListDetailPerPage;O=h("filter")(a.ItemListFilter,a.txtMaHangQuetBarcode),a.ItemListDetailFilter=O.slice(d,e),p()}}else if(void 0!==a.ItemListFilter){N=1;var d=(N-1)*a.itemListDetailPerPage,e=d+a.itemListDetailPerPage;O=h("filter")(a.ItemListFilter,a.txtMaHangQuetBarcode),a.ItemListDetailFilter=O.slice(d,e),p()}}else if(void 0!==a.ItemListFilter){N=1;var d=(N-1)*a.itemListDetailPerPage,e=d+a.itemListDetailPerPage;O=h("filter")(a.ItemListFilter,a.txtMaHangQuetBarcode),a.ItemListDetailFilter=O.slice(d,e),p()}},a.btnAddArrHoaDon_Click=function(){if(a.ArrHoaDon.length<a.SoHoaDonHienThiToiDa){var b=h("filter")(a.ArrHoaDon,{InfoId:""},!0);if(0===b.length){a.ArrHoaDon.push({OrdinalNumber:-1,InfoId:""}),x(a.ArrHoaDon[a.ArrHoaDon.length-1]);for(var c=0;c<=a.ArrHoaDon.length-2;c++)a.ArrHoaDon[c].Selected=0}}},a.btnArrHoaDon_Click=function(b){x(b);for(var c=0;c<=a.ArrHoaDon.length-1;c++)a.ArrHoaDon[c].InfoId===b.InfoId?a.ArrHoaDon[c].Selected=1:a.ArrHoaDon[c].Selected=0;$("#btnInfo_Amount").focus()},a.btnXoaHoaDon_Click=function(b){void 0!==a.dtInfo.ID&&null!==a.dtInfo.ID&&""!==a.dtInfo.ID&&e.ShowConfirmDialog("Bạn có chắc muốn xóa hóa đơn ?").then(function(b){if(0==b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,Value01:a.dtInfo.ID};f.Post("DeleteInvoiceTmp",c,f.url).then(function(b){if(0===b.data.Status.StatusCode){for(var c=-1,d=0;d<=a.ArrHoaDon.length-1;d++)if(a.ArrHoaDon[d].InfoId===a.dtInfo.ID){c=d;break}a.ArrHoaDon.splice(c,1),0===a.ArrHoaDon.length?a.btnAddArrHoaDon_Click():a.btnArrHoaDon_Click(a.ArrHoaDon[0]),A("Xóa thành công.")}else e.ShowMessageDialog("Đã có lỗi xảy ra, vui lòng thử lại.")},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})},a.btnSoLuong_Click=function(b){g.keyBoardNumber(b.Quantity,0,"Điều chỉnh số lượng",b.Amount,-1).then(function(c){b.Quantity!=c.value&&0==c.Cancel&&(b.Quantity=c.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=C.Update,b.Quantity<=0&&(b.RowStatus=C.InActive),t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u().then(function(a){v()}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnGiaBan_Click=function(b){(0===b.UnitPrice||a.ChoPhepSuaGiaBan!==!1)&&(b.StatusId==D.InHoaDon?e.ShowMessageDialog("Không được điều chỉnh giá khi đã in hóa đơn."):g.keyBoardNumber(b.UnitPrice,0,"Điều chỉnh giá bán",b.Amount,-1).then(function(c){b.UnitPrice!=c.value&&0==c.Cancel&&(b.UnitPrice=c.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=C.Update,t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u().then(function(a){v()}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}))},a.btnGiamGiaDetail_Click=function(b){b.StatusId==D.InHoaDon?e.ShowMessageDialog("Không được điều chỉnh giảm giá khi đã in hóa đơn."):g.keyBoardNumber(b.Disc_Amount01,b.DisCount01,"Điều chỉnh giảm giá món",b.Amount,1==b.Dis_AmountEdit?1:0).then(function(c){0==c.discountType&&0==c.Cancel?b.DisCount01!=c.value&&(b.DisCount01=c.value,b.Dis_AmountEdit=!1,b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=C.Update):1==c.discountType&&b.Disc_Amount01!=c.value&&(b.Disc_Amount01=c.value,b.DisCount01=100*b.Disc_Amount01/b.Amount,b.Dis_AmountEdit=!0,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=C.Update),t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u().then(function(a){v()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnNoteItem_Click=function(a){g.NoteDialog(a.Note).then(function(b){a.Note!==b.value&&(a.Note=b.value,a.RowStatus=C.Update,u())},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnDeleteItem_Click=function(a){y(a)},a.btnInHoaDon_Click=function(b){(null===b||void 0===b)&&(b=0);h("filter")(a.dtItem,{StatusId:2},!0);a.dtItem.length<=0?e.ShowMessageDialog("Bạn vui lòng nhập hàng hóa."):u().then(function(c){var d={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:0,TableId:0,Value01:a.dtInfo.ID,EmployeeId:null===f.userId||void 0===f.userId?0:f.userId,IPAddress:f.IPAddress,TienKhachDua:a.dtInfo.SoTienKhachDua,TienTraLai:a.dtInfo.TienTraLaiKhach,TTTienMat:0,TTNganHang:0,NganHangId:0,TTVoucher:0,VoucherId:0};f.Post("InHoaDonBanLe",d,f.url).then(function(c){0!==c.data.Status.StatusCode&&""!==c.data.Status.MessageId?e.ShowMessageDialog(c.data.Status.MessageId):(a.dtInfo=c.data.Data,a.dtItem=c.data.Data2,a.dtReturnItem=c.data.Data4,a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drReturnItem=c.data.Data8,a.ArrHoaDon=c.data.ArrHoaDon,w(),""!==c.data.URL&&(1===b?printJS({printable:c.data.URL,type:"pdf",showModal:!0}):window.open(c.data.URL,"PRINT PHIEU THANH TOAN","width=600,height=650").print()))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})})},a.btnLuuHoaDon_Click=function(b){var c=h("filter")(a.dtItem,{StatusId:2},!0);a.dtInfo.StatusId!=D.InHoaDon||c.length<a.dtItem.length?e.ShowMessageDialog("Bạn chưa in hóa đơn."):e.ShowDetailFormDialog({data:{dtInfo:a.dtInfo,KhachHangList:a.KhachHangList,BankAccountList:a.BankAccountList,customerModels:a.customerModels},tempUrl:"app/components/Sales/Restaurant/HinhThucThanhToan.html?nd="+Date.now(),ctrl:"HinhThucThanhToanCtrl",cssclass:"Modal-width550",focuscontrolid:"txtTienKhachDua"}).then(function(b){if(1==b.confirmStatus){a.KhachHangList.length!==b.data.KhachHangList.length&&(a.KhachHangList=angular.copy(b.data.KhachHangList));var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:0,TableId:0,Value01:a.dtInfo.ID,Value02:b.data.dtInfo.CustomerId,ListObject:b.data.HinhThucTT,IPAddress:f.IPAddress,LoaiPM:f.MaNganh};f.showloading(),f.Post("SaveInvoice",c,f.url).then(function(b){if(0!==b.data.Status.StatusCode)e.ShowMessageDialog(b.data.Status.MessageId);else{A("Lưu thành công.");for(var c=JSON.parse(b.data.ArrTonKho),d=0;d<=c.length-1;d++){var f=h("filter")(a.TonKhoList,{ItemId:c[d].ItemId,DVT:c[d].DVT},!0);f.length>0?f[0].SLDK=c[d].SLDK:a.TonKhoList.push(c[d])}c.length>0&&a.btnShowAllItemDetail_Click(G);for(var g=-1,d=0;d<=a.ArrHoaDon.length-1;d++)if(a.ArrHoaDon[d].InfoId===a.dtInfo.ID){g=d;break}a.ArrHoaDon.splice(g,1),0===a.ArrHoaDon.length?a.btnAddArrHoaDon_Click():a.btnArrHoaDon_Click(a.ArrHoaDon[0]),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0,a.MaTheVipFilterOptions.setValue=-1,a.MaTheVipFilter=-1}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})}})},a.btnGiamGiaTongBill_Click=function(){g.keyBoardNumber(a.dtInfo.Info_DiscAmount,a.dtInfo.Info_Discount,"Điều chỉnh giảm giá tổng Bill",a.dtInfo.Info_Amount,1==a.dtInfo.Info_Dis_AmountEdit?1:0).then(function(b){0==b.discountType&&0==b.Cancel?a.dtInfo.Info_Discount!=b.value&&(a.dtInfo.Info_Discount=b.value,a.dtInfo.Info_DiscAmount=parseFloat(a.dtInfo.Info_Amount)*parseFloat(a.dtInfo.Info_Discount)/100,a.dtInfo.Info_Dis_AmountEdit=0):1==b.discountType&&0==b.Cancel&&a.dtInfo.Info_DiscAmount!=b.value&&(a.dtInfo.Info_DiscAmount=b.value,a.dtInfo.Info_Discount=100*parseFloat(a.dtInfo.Info_DiscAmount)/parseFloat(a.dtInfo.Info_Amount),a.dtInfo.Info_Dis_AmountEdit=1),t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u().then(function(a){v()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnTienKhachDua_Click=function(){g.keyBoardNumber(a.dtInfo.SoTienKhachDua,0,"Tiền khách đưa",a.dtInfo.Info_Amount,-1).then(function(b){if(0===b.Cancel){a.dtInfo.SoTienKhachDua=parseFloat(b.value);var c=parseFloat(a.dtInfo.SoTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount);0>=c&&(c=0),a.dtInfo.TienTraLaiKhach=c,t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u()}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnTienThue_Click=function(){var b=!1;g.selectVAT(a.dtInfo.Info_VAT_DiscAmount,a.VatList).then(function(c){""!=c.Code&&0==c.Cancel&&(a.dtInfo.Info_VAT_DiscAmount=c.GiaTri,a.dtInfo.Info_VatAmount=(a.dtInfo.Info_Amount-a.dtInfo.Info_DiscAmount+a.dtInfo.Info_ServiceChargeAmount)*a.dtInfo.Info_VAT_DiscAmount/100,b=!0),t(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),u().then(function(a){v()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnChiTietHoaDon_Click=function(){$("#divChiTietHoaDonOutside").css("height",$("#divContainer").height()-8),$("#divChiTietHoaDonOutside").css("display","")},a.btnCloseChiTietHoaDon_Click=function(){$("#divChiTietHoaDonOutside").css("display","none")},a.btnSaveChiTietHoaDon_Click=function(){u(),a.btnCloseChiTietHoaDon_Click()},a.btnChuongTrinhKhuyenMai_Click=function(){var b=null===a.dtChuongTrinhKhuyenMai||void 0===a.dtChuongTrinhKhuyenMai?0:a.dtChuongTrinhKhuyenMai.length;if(0===a.dtItem.length)e.ShowMessageDialog("Vui lòng chọn hàng hóa.");else if(0===b)e.ShowMessageDialog("Không có chương trình khuyến mãi ở thời điểm hiện tại.");else{g.selectChuongTrinhKhuyenMai(a.dtChuongTrinhKhuyenMai).then(function(a){0==a.Cancel&&u(a.PromotionType,a.ID)},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnKhuyenMaiTheVip_Click=function(){0===a.dtItem.length?e.ShowMessageDialog("Vui lòng chọn hàng hóa."):($("#divKhuyenMaiTheVipOutside").css("height",$("#divContainer").height()-8),$("#divKhuyenMaiTheVipOutside").css("display",""))},a.btnCloseKhuyenMaiTheVip_Click=function(){$("#divKhuyenMaiTheVipOutside").css("display","none")},a.MaTheVipFilter_selectedrow=function(b){0!==b.ID&&0===b.Field7?e.ShowMessageDialog("Thẻ Vip đã hết hạn sử dụng."):(a.dtInfo.VipId=b.ID,u(null,null,1))},a.btnDoiDiem_Click=function(){e.ShowConfirmDialog("Bạn có chắc muốn đổi điểm thẻ Vip ?").then(function(b){if(0==b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,InfoId:a.dtInfo.ID,MaTheVipId:a.dtInfo.VipId,HanMucDoiDiemThuong:a.DataConfig.HanMucDoiDiemThuong};f.Post("DoiDiemTheVip",c,f.url).then(function(b){if(0===b.data.Status.StatusCode){a.dtDoiDiemVipList=b.data.Data,a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var c=0,d=0;d<=a.dtDoiDiemVipList.length-1;d++)c+=parseFloat(a.dtDoiDiemVipList[d].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(c),A("Đổi điểm thành công.")}},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})},a.btnTraHang_Click=function(){var b={Id:"",CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",b,f.Url+"api/SaleReturn/").then(function(b){a.data=b.data.Data,a.dataid=""}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/POSRefund/HoaDonTraHangDetail.html",ctrl:"HoaDonTraHangDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})},a.CustomerId_selectedrow=function(b){if(a.PriceInfoId=null!==b&&null!==b.Field6?b.Field6:0,a.dtInfo.TenKH=b.Name,a.dtInfo.DiaChiKH=b.Field11,a.dtInfo.DienThoaiKH=b.Field12,parseFloat(a.PriceInfoId)>0){var c={CompanyId:f.CompanyId,BranchId:f.BranchId,ID:a.PriceInfoId};f.showloading(),f.Post("GetDetailBangGiaLePosById",c,f.Url+"api/BGLePOS/").then(function(b){a.PriceDetailByCustomer=JSON.parse(b.data.Data)},function(a){})["finally"](function(){f.closeloading()})}else a.PriceDetailByCustomer=null},a.btnLogOut_Click=function(){e.ShowConfirmDialog("Bạn có chắc muốn thoát chương trình ?").then(function(a){0==a&&j.path("/")})},i(function(){B()},50)}]),app.factory("HoaDonTraHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReturn/",e}]),app.controller("HoaDonTraHangCtrl",["$scope","$uibModal","$translate","AppDialog","HoaDonTraHangService","$filter","$timeout",function(a,b,c,d,e,f,g){function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),g(function(){a.btnSearch()},200)}function i(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function j(){if("1"!==e.IsAdministrator){var b=f("filter")(e.Role,{ScreenCode:"KhachHangTraHang"},!0);if(b.length>0){var c=f("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=f("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!0:!d.IsEnable);var g=f("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.LocationIdList=null,a.DocumentTypeList=null,a.TotalRow=null,a.LoaiPM=e.MaNganh,a.gridOptions={data:[],id:"grid_refund",showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showPrint:!0,showpaging:!0,columnDefs:[{field:"DocumentNo",display:"Số chứng từ",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"Ngày",headerclass:"text-align-center col-w-80px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"CustomerName",display:"Khách hàng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"Tổng tiền",headerclass:"text-align-center col-w-80px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"ReceiverName",display:"Người nhận",headerclass:"text-align-center col-w-100px",detailclass:"text-align-left",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Ghi chú",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){e.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,LocationId:a.LocationId,BranchId:e.BranchId,CompanyId:e.CompanyId};e.Post("search",b,e.url).then(function(b){a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,a.TotalRow=b.data.Data2,console.log(a.TotalRow),i(),showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})},a.btnClearSearch=function(){},a.selectAll=function(){for(var b=!a.checkIsSelectAll(),c=0;c<=a.searhResultList.length-1;c++)$("#"+c+"_selected").prop("checked",b)},a.checkIsSelectAll=function(){if(null!==a.searhResultList){for(var b=[],c=0;c<=a.searhResultList.length-1;c++)1==$("#"+c+"_selected").prop("checked")&&b.push(a.searhResultList[c]);return b.length===a.searhResultList.length}return!1},a.btnAddOrEdit=function(b){var c={Id:b,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("detail",c,e.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?d.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):d.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/POSRefund/HoaDonTraHangDetail.html",ctrl:"HoaDonTraHangDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){1==b&&a.btnSearch()})},function(a){d.ShowMessageDialog("CMN_MSG_ERROR")})},a.gridEditData=function(b){a.btnAddOrEdit(b.Id)},a.btnDeleteList=function(){var b=[];angular.forEach(a.searhResultList,function(a,c){1==$("#"+c+"_selected").prop("checked")&&b.push(a)});a.gridOptions.ListCheckSelected;b.length<=0?d.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):d.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(e.showloading(),e.Post("deletelist",b,e.url).then(function(c){var e=c.data.Status;0==e.StatusCode?d.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):a.success=!1},function(b){a.success=!1,d.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){e.closeloading()}))})},a.gridPrintData=function(a,b){(null===b||void 0===b)&&(b=0);var c={CompanyId:e.CompanyId,BranchId:e.BranchId,Value01:a.Id};e.showloading(),e.Post("InPhieuTraHang",c,e.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?d.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU TRA HANG","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),d.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){e.closeloading()})},h(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){i()}),j()}]),app.controller("HoaDonTraHangDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","HoaDonTraHangService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(b,c,d,e,f){a.btnStatus={Copy:b,AddNew:c,Edit:d,Save:e,Print:f}}function k(b,c,d,e){a.ControlStatus={CustomerId:c,LocationId:d,PostingDate:e}}function l(){h.Post("GetCodeNameDataMaster",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.CustomerList=b.data.Data,a.LocationList=b.data.Data2,a.CustomerOptions.setValue=a.detail.CustomerId},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function m(){var b=f.defer(),c=-1,e=!0,g="";switch((null===a.detail.PostingDate||void 0===a.detail.PostingDate)&&(g+=d.instant("InvStockIn_PostingDate_Invalid")+"<br/>",e=!1,c=-1==c?1:c),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(g+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",e=!1,c=-1==c?0:c),""!=g&&i.ShowMessageDialog(g),c){case 0:$("#LocationId").focus();break;case 1:$("#PostingDate").focus()}return b.resolve(e),b.promise}function n(){var b=f.defer(),c=!0,g=e("filter")(a.detail.listDetail,{Canceled:0},!0)[0],h=e("filter")(a.detail.listDetail,{Canceled:0},!0);null==g||void 0==g?(c=!1,i.ShowMessageDialog(d.instant("InvStockIn_GridDetail_Invalid")+"<br/>")):h.length>100&&(c=!1,i.ShowMessageDialog(d.instant("Tổng số dòng lưu dữ liệu không được nhiều hơn 100 dòng.")+"<br/>"));for(var j="",k=0;k<=a.detail.listDetail.length-1;k++)parseFloat(a.detail.listDetail[k].Quantity)<=0?j+="Dòng ["+(k+1)+"], vui lòng nhập số lượng trả<br/>":parseFloat(a.detail.listDetail[k].Quantity)>parseFloat(a.detail.listDetail[k].SLDaBan)&&(j+="Dòng ["+(k+1)+"] SL trả không được lớn hơn SL bán<br/>");return""!==j&&(c=!1,i.ShowMessageDialog(j)),b.resolve(c),b.promise}function o(){a.TongSL=0,a.TongTien=0;for(var b=0;b<=a.detail.listDetail.length-1;b++)0===a.detail.listDetail[b].Canceled&&(a.TongSL+=parseFloat(a.detail.listDetail[b].Quantity),a.TongTien+=parseFloat(a.detail.listDetail[b].Amount)),a.detail.Info_Amount=a.TongTien}function p(){var b=f.defer(),c="",e=-1,g=!0;switch((0==a.ItemFilter||void 0==a.ItemFilter)&&(c+=d.instant("InvStockIn_Item_Invalid")+"<br/>",g=!1,e=-1==e?0:e),(0===a.detail.LocationId||void 0===a.detail.LocationId)&&(c+=d.instant("InvStockIn_LocationId_Invalid")+"<br/>",g=!1,e=-1==e?1:e),(parseFloat(a.QtyFilter)<=0||void 0==a.QtyFilter)&&(c+=d.instant("InvStockIn_Quantity_Invalid")+"<br/>",g=!1,e=-1==e?2:e),""!=c&&i.ShowMessageDialog(c),e){case 0:a.ItemFilterOptions.setfocus=!0;break;case 1:$("#LocationId").focus();break;case 2:$("#QtyFilter").focus()}return b.resolve(g),b.promise}function q(){a.detail.Info_Quantity=0,a.detail.Info_Amount=0;for(var b=0;b<=a.detail.listDetail.length-1;b++){var c=a.detail.listDetail[b];0==c.Canceled&&(a.detail.Info_Quantity+=parseFloat(c.Quantity),a.detail.Info_Amount+=parseFloat(c.Amount))}}function r(){var b=window.innerHeight-50-20;$("#HoaDonTraHangDetail").height(b);$(".customergrid-table").parent().height();a.itemsPerPage=8,a.itemsPerPage<8&&(a.itemsPerPage=8)}function s(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function t(){if("1"!==h.IsAdministrator){var a=e("filter")(h.Role,{ScreenCode:"KhachHangTraHang"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(g),a.CustomerList=null,a.LocationList=null,a.TongSL=0,a.TongTien=0,a.btnStatus={Copy:!0,AddNew:!0,Edit:!0,Save:!0,Print:!0},a.ControlStatus={CustomerId:!0,LocationId:!0,PostingDate:!0},a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.detail=g,null!==g.Id&&""!==g.Id?(j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)):(j(!1,!0,!1,!0,!1),k(!0,!0,!0,!0)),a.btnAddnew=function(c){k(!0,!0,!0,!0),j(!1,!0,!1,!0,!1),a.detail.ID="",1==c||1==c?(a.detail.DocumentNo="",a.detail.PostingDate=new Date):(a.detail.DocumentNo="",a.detail.PostingDate=new Date,a.detail.Note="",a.detail.Address="",a.detail.PhoneNo="",a.detail.ReceiverName="",a.detail.Info_Quantity=0,a.detail.Info_Amount=0,a.detail.SupplierId=0,a.detail.listDetail.splice(0,a.detail.listDetail.length)),b(function(){document.getElementById("DocumentNo").focus()},50)},a.UnitPrice_Change=function(a){a.Amount=parseFloat(a.Quantity)*parseFloat(a.UnitPrice),o()},a.Quantity_Change=function(a){a.Amount=parseFloat(a.Quantity)*parseFloat(a.UnitPrice),o()},a.btnSave=function(){var b=m();if(b.$$state.value===!0&&(b=n()),b.$$state.value===!0){for(var c=0;c<=a.detail.listDetail.length-1;c++)a.detail.listDetail[c].LocationId=a.detail.LocationId;a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.UserName=h.UserName,h.showloading(),h.Post("Save",a.detail,h.url).then(function(b){var c=b.data.Status;0==c.StatusCode?(i.ShowMessageDialog(c.MessageId),j(!0,!0,!0,!1,!0),a.detail=b.data.Data,k(!1,!1,!1,!1)):(a.success=!1,i.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,i.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){h.closeloading()})}},a.btnPrint_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:h.CompanyId,BranchId:h.BranchId,Value01:a.detail.Id};h.showloading(),h.Post("InPhieuTraHang",c,h.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?i.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"PHIEU TRA HANG","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message),i.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")})["finally"](function(){h.closeloading()})},a.btnCancel=function(){c.dismiss("cancel")},a.btnTimHangHoa_Click=function(){i.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/POSRefund/SearchHangHoa.html",ctrl:"SearchHangHoaCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(b){if(1==b.confirmStatus){for(var c=b.data,d=0;d<=c.length-1;d++){var e=angular.copy(a.detail.CloneDetailObj);
e.Id=0,e.ItemId=c[d].ItemId,e.ItemCode=c[d].ItemCode,e.ItemName=c[d].ItemName,e.UomId=c[d].UnitId,e.UnitName=c[d].UnitName,e.LocationId=c[d].LocationId,e.LocationName=c[d].LocationName,e.SLDaBan=c[d].QtyOrder,e.Quantity=1,e.GiaDaBan=c[d].GiaSauCK,e.UnitPrice=c[d].GiaSauCK,e.Amount=parseFloat(e.Quantity)*parseFloat(e.UnitPrice),e.Canceled=0,e.BranchId=h.BranchId,e.CompanyId=h.CompanyId,e.InfoId_Ref=c[d].InfoId,e.DocumentNo_Ref=c[d].DocumentNo,a.detail.listDetail.push(e),0===a.detail.CustomerId&&(a.detail.CustomerId=c[d].CustomerId,a.detail.LocationId=c[d].LocationId,a.detail.ReceiverName=h.UserName,a.detail.Note="Khách trả hàng hóa đơn "+c[d].DocumentNo)}o()}})},a.btnAddRowGrid=function(){var b=angular.copy(a.detail.CloneDetailObj),c=p();1==c.$$state.value&&(b.ID=0,b.ItemId=a.ItemFilter,b.ItemCode=$("#ItemFilter").attr("aacode"),b.ItemName=$("#ItemFilter").attr("aaname"),b.UomId=$("#ItemFilter").attr("aafield3"),b.UnitName=$("#ItemFilter").attr("aafield4"),b.LocationId=parseInt(a.detail.LocationId),b.UnitCost=null==a.PriceFilter?0:a.PriceFilter,b.Quantity=a.QtyFilter,b.Amount=b.UnitCost*b.Quantity,b.Canceled=0,a.detail.listDetail.push(b),a.ItemFilterOptions.setValue=0,a.PriceFilter=0,a.QtyFilter=1,a.ItemFilterOptions.setfocus=!0,q())},a.btnRemoveRow=function(a){a.Canceled=1,q()},a.CalculateAmount=function(a){a.Amount=a.UnitCost*a.Quantity,q()},a.QtyFilter_Keydown=function(b){13==b.which&&a.btnAddRowGrid()},a.btnEdit=function(){h.Post("detail",a.detail,h.url).then(function(b){a.detail=b.data.Data,j(!0,!0,!1,!0,!1),k(!0,!0,!0,!0)},function(a){i.ShowMessageDialog("CMN_MSG_ERROR")})},l(),b(function(){r()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=8,a.maxSize=3,a.listPageSize=[10,30,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){s()}),b(function(){t()},50)}]),app.controller("SearchHangHoaCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","HoaDonTraHangService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){h.Post("TimHangHoaTraHang",{CompanyId:h.CompanyId,BranchId:h.BranchId},h.url).then(function(b){a.dataResult=b.data.Data,a.dataResult.length>0&&(a.dataResultFilter=a.dataResult.slice(0,100))},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})}function k(){var a=window.innerHeight-50-20;$("#SearchHangHoaDetail").height(a);var b=a-50-50-40;$(".customergrid-table").height(b)}a.dataResult=null,a.dataResultFilter=null,a.$watch("txtSearchHangHoa",function(b){if(null!==a.dataResult&&void 0!==a.dataResult){var c=[];c=null===b||void 0===b?angular.copy(a.dataResult):e("filter")(a.dataResult,function(a){return a.DocumentNo.toLowerCase().includes(b)||a.CustomerName.toLowerCase().includes(b)||a.ItemCode.toLowerCase().includes(b)||a.ItemName.toLowerCase().includes(b)}),a.dataResultFilter=c.slice(0,100)}}),b(function(){j(),$("#txtSearchHangHoa").focus(),k()},50),a.btnCancel=function(){c.dismiss("cancel")},a.btnSelect_Click=function(){var b=e("filter")(a.dataResult,{IsChecked:1},!0);console.log(b),0===b.length?i.ShowMessageDialog("Vui lòng chọn hàng trả"):c.close({confirmStatus:1,data:b})}}]),app.factory("RestaurantService",["$q","$http","AppServices","AuthenticationService","signalR",function(a,b,c,d,e){var f=Object.create(c);return f.url=f.Url+"api/Restaurant/",f.urlCombobox=f.Url+"api/Combobox/",e.startHub({MaGianHang:c.MaGianHang,IsServer_Offline:0,ComputerName:c.UserName,LoginDevice:"WebApp",ScreenName:"Restaurant-1.0",PublicIP:c.PublicIP}).then(function(){}),f}]),app.controller("RestaurantCtrl",["$scope","$q","$uibModal","$translate","AppDialog","RestaurantService","appKeyBoard","$filter","$timeout","$location","$window","$interval","signalR",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,UserId:f.userId,IPAddress:f.IPAddress};f.Post("InitTouchScreen",b,f.urlCombobox).then(function(b){if(0===b.data.Status.StatusCode){var c=parseInt(b.data.isCheckTienDauCa);if(0===c&&a.btnKhaiBaoTienDauCa_Click(0),a.DataConfig=b.data.DataConfig,a.AreaList=b.data.Data,a.TableList=b.data.Data2,a.ItemCategoryList=b.data.Data3,a.ItemList=JSON.parse(b.data.Data4),a.VatList=b.data.Data5,a.KhachHangList=JSON.parse(b.data.Data6),a.NVPVuList=b.data.Data7,a.MaNVLapList=b.data.Data7,a.NVChonMonList=b.data.Data7,a.dtKhuyenMaiHangHoa=JSON.parse(b.data.Data8),a.dtChuongTrinhKhuyenMai=b.data.Data9,a.ItemAddonList=JSON.parse(b.data.Data10),a.dtSize_TraSua=b.data.Data11,a.PriceByAreaList=JSON.parse(b.data.Data12),a.BankAccountList=b.data.Data13,a.customerModels=b.data.Data14,a.TheVipList=JSON.parse(b.data.Data15),a.ShipperList=b.data.Data16,a.permissionList=JSON.parse(b.data.RoleUser),a.Params=b.data.Params,null!==a.Params){var d=h("filter")(a.Params,{Code:"IsTinhGioTheoThoiDiem"},!0);null!==d&&(G=parseInt(d[0].Value))}K=b.data.Data17,K.length>0&&(a.ItemIdTienGio=K[0].ID),a.relationList=b.data.Data19,a.PricyBySizeList=b.data.Data20,a.ItemCategoryList.push({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:"",Selected:0})}},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))}).then(function(b){p(),a.isSelectArea=1,a.AreaList.length>0&&a.btnAreaId_Click(a.AreaList[0]),"1"===a.BanHangCanTeen&&(ba=0,a.btnChonMon(),$("#btnBanPhong").css("display","none"),$("#btnThucDon").css("display","none"),$("#btnChuyenBan").css("display","none"),$("#btnGhepBan").css("display","none"),a.btnTableDetail_Click({ID:0,Code:"000",Name:"Takeaway",Field6:"0"}))},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}function o(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,IPAddress:f.IPAddress};f.Post("InitTouchScreen2",b,f.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.ItemList=b.data.Data4,a.ItemAddonList=b.data.Data10,a.PriceByAreaList=b.data.Data12)},function(a){}).then(function(b){a.ItemListFilter=null===U||0===U.ID?a.ItemList:h("filter")(a.ItemList,{Field6:U.ID.toString()},!0),a.btnShowAllItemDetail_Click(U)},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}function p(){N=Math.round(da/(M+2)-.5),O=1;a.AreaListFilter=a.AreaList,a.AreaListFilter.length>0&&(a.AreaListFilter[0].Selected=1),ea=$("#divItemListDetail").width()-20,fa=$("#divItemListDetail").height()-20;var b=parseInt(ea/ga),c=parseInt(fa/ha);a.itemListDetailPerPage=b*c}function q(){P=Math.round(da/(Q+2)-.5),R=1;var b=(R-1)*P,c=b+P;a.ItemCategoryListFilter=a.ItemCategoryList.slice(b,c)}function r(){if(null!==a.ItemListDetailFilter)for(var b=0;b<=a.ItemListDetailFilter.length-1;b++){var c=h("filter")(a.PriceByAreaList,{AreaId:Z,ItemId:a.ItemListDetailFilter[b].ID},!0);c.length>0&&(a.ItemListDetailFilter[b].UnitPrice=c[0].Price)}}function s(){var a=$("#td-sale-invoice").height();$("#divSaleInvoice").height(a);var b=$("#td-Detail-Item").height();$("#divDetailTable_Item").height(b-10)}function t(b,c){f.showloading();var g={CompanyId:f.CompanyId,BranchId:f.BranchId,MasterType:b};f.Post("reloadMasterPlus",g,f.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):"Customer"===b.data.Status.ObjData&&(a.KhachHangList=b.data.Data,a.dtInfo.CustomerId=c.ID,a.dtInfo.DiaChiKH=c.Address,a.dtInfo.DienThoaiKH=c.PhoneNo)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function u(c,d,g){var i=b.defer(),j=9;a.dtInfo.BranchId=f.BranchId,a.dtInfo.CompanyId=f.CompanyId,a.dtInfo.IPAddress=f.IPAddress,a.dtInfo.AreaName=S.Name,a.dtInfo.TableName=V.Name,d=void 0===d||null===d?"":d;var k=h("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1,Id:d},!0);if(1===k.length)for(var l=0;l<=a.dtItem.length-1;l++){var n=A(new Date,0,16),o=A(a.dtInfo.PostingDate,0,16),p=B(a.dtKhuyenMaiHangHoa,n,o),q=h("filter")(p,{ItemId:a.dtItem[l].ItemId,DocInfoId:d},!0);q.length>0&&(0===q[0].DiscAmountEdit?(a.dtItem[l].DisCount01=q[0].Discount,a.dtItem[l].Dis_AmountEdit=0,a.dtItem[l].Disc_Amount01=parseFloat(a.dtItem[l].Amount)*parseFloat(a.dtItem[l].DisCount01)/100):(a.dtItem[l].Disc_Amount01=parseFloat(q[0].DiscAmount)*parseFloat(quantity),a.dtItem[l].Dis_AmountEdit=1,0!=a.dtItem[l].Disc_Amount01&&0!=a.dtItem[l].Amount&&(a.dtItem[l].DisCount01=100*a.dtItem[l].Disc_Amount01/a.dtItem[l].Amount)),a.dtItem[l].TotalAmount=parseFloat(a.dtItem[l].Amount)+parseFloat(a.dtItem[l].VatAmount)-parseFloat(a.dtItem[l].Disc_Amount01))}for(var r=0,l=0;l<=a.dtItem.length-1;l++)r+=parseFloat(a.dtItem[l].TotalAmount);a.dtInfo.Info_Amount=r;var s={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,dtInfo:a.dtInfo,dtItem:a.dtItem,dtReturnItem:a.dtReturnItem,PromotionType:c,PromotionId:d,KhuyenMaiVip:g,IPAddress:f.IPAddress};return f.showloading(),f.Post("SaveInvoiceTmp",s,f.url).then(function(b){var c=(a.dtInfo.ID,b.data.Status.StatusCode);if(3==b.data.Status.StatusCode)a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0;else{if(9==b.data.Status.StatusCode)return void e.ShowMessageDialog(b.data.Status.MessageId);a.dtInfo=JSON.parse(b.data.Data),a.dtItem=JSON.parse(b.data.Data2),a.dtReturnItem=JSON.parse(b.data.Data4),a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var d=0,g=0;g<=a.dtDoiDiemVipList.length-1;g++)d+=parseFloat(a.dtDoiDiemVipList[g].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(d)}"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:c,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),UserId:f.userId}),j=0,i.resolve(j)},function(a){console.log("Error:"+a.data.Message),i.reject("Error:"+a.data.Message)})["finally"](function(){f.closeloading()}).then(function(a){},function(a){console.log("error:"+a.data),i.reject("error:"+a.data)}),i.promise}function v(b){(null===b||void 0===b)&&(b=0);var c=h("filter")(a.dtItem,{StatusId:0},!0);if(c.length>0||1===b){a.dtInfo.SoTienKhachDua=a.dtInfo.Info_TotalAmount;var d=parseFloat(a.dtInfo.SoTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount);0>=d&&(d=0),a.dtInfo.TienTraLaiKhach=d}}function w(b,c){null===c&&(c=1);var d=b.Field11,e=b.Field12,g={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,ItemId:b.ID,Size_TraSua:1==a.AddOn&&1===b.Field12?F.Medium:""};f.Post("GetPriceItem",g,f.url).then(function(g){a.priceItem=g.data.Data;var i=angular.copy(a.drItem),j=h("filter")(a.dtItem,{ItemId:b.ID,StatusId:E.ChonMon,UnitPrice:a.priceItem,InNhan:0},!0),k=new Date,l=k.getFullYear()+""+k.getMonth()+k.getDate()+k.getHours()+k.getMinutes()+k.getSeconds();0===a.dtInfo.EmployeeOrderId&&(a.dtInfo.EmployeeOrderId=null===f.userId||void 0===f.userId?0:f.userId);var m=h("filter")(a.AreaList,{ID:parseFloat(a.dtInfo.AreaId)},!0)[0];if((null===a.dtInfo.ID||void 0===a.dtInfo.ID)&&void 0!==m&&null!==m){var n=m.Field6,o=m.Field7,p=m.Field8,q=m.Field9,r=m.Field10;parseFloat(n)>0?(a.dtInfo.Info_Discount=parseFloat(n),a.dtInfo.Info_Dis_AmountEdit=0):parseFloat(o)>0&&(a.dtInfo.Info_DiscAmount=parseFloat(o),a.dtInfo.Info_Dis_AmountEdit=1),parseFloat(p)>0?(a.dtInfo.Info_Percent_ServiceCharge=parseFloat(p),a.dtInfo.Info_ServiceChargeAmtEdit=0):parseFloat(q)>0&&(a.dtInfo.Info_ServiceChargeAmount=parseFloat(q),a.dtInfo.Info_ServiceChargeAmtEdit=1),parseFloat(r)>0&&(a.dtInfo.Info_VAT_DiscAmount=parseFloat(r))}if(0===j.length||1===d||1===e){i.ID=0,i.IdTmp=l,i.InfoId="",i.AddOn=0,i.ParentId=0,i.ItemId=b.ID,i.ItemName=b.Name,i.Quantity=parseFloat(c),i.UomId=b.Field3,i.Size_TraSua=F.Medium,i.UnitPrice=parseFloat(a.priceItem),i.DisCount02=0,i.Disc_Amount02=0,i.LocationId=b.SellLocationId,i.BranchId=f.BranchId,i.CompanyId=f.CompanyId,i.Canceled=0,i.StatusId=E.ChonMon,i.Amount=parseFloat(i.Quantity)*parseFloat(i.UnitPrice),i.DisCount01=0,i.Disc_Amount01=parseFloat(i.Amount)*parseFloat(i.DisCount01)/100,i.VAT_DiscAmount=0,i.VatAmount=parseFloat(i.Amount)*parseFloat(i.VAT_DiscAmount)/100,i.AllowSelectedSize=b.AllowSelectedSize,i.ShowChooseAddOn=b.ShowChooseAddOn,i.TotalAmount=parseFloat(i.Amount)+parseFloat(i.VatAmount)-parseFloat(i.Disc_Amount01),i.RowStatus=D.Insert,i.CreatedBy=f.UserName,i.UpdatedBy=f.UserName;var s=h("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1},!0);if(1===a.dtChuongTrinhKhuyenMai.length&&1===s.length){var t=A(new Date,0,16),u=A(a.dtInfo.PostingDate,0,16),v=B(a.dtKhuyenMaiHangHoa,t,u),w=h("filter")(v,{ItemId:b.ID},!0);w.length>0&&(0===w[0].DiscAmountEdit?(i.DisCount01=w[0].Discount,i.Dis_AmountEdit=0,i.Disc_Amount01=parseFloat(i.Amount)*parseFloat(i.DisCount01)/100):(i.Disc_Amount01=parseFloat(w[0].DiscAmount)*parseFloat(c),i.Dis_AmountEdit=1,0!=i.Disc_Amount01&&0!=i.Amount&&(i.DisCount01=100*i.Disc_Amount01/i.Amount)),i.TotalAmount=parseFloat(i.Amount)+parseFloat(i.VatAmount)-parseFloat(i.Disc_Amount01))}a.dtItem.push(i),1===b.Field11}else{j[0].Quantity+=parseFloat(c),j[0].Amount=parseFloat(j[0].Quantity)*parseFloat(j[0].UnitPrice),0===j[0].Dis_AmountEdit?j[0].Disc_Amount01=parseFloat(j[0].Amount)*parseFloat(j[0].DisCount01)/100:j[0].DisCount01=100*j[0].Disc_Amount01/j[0].Amount;var s=h("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1},!0);if(1===a.dtChuongTrinhKhuyenMai.length&&1===s.length){var t=A(new Date,0,16),u=A(a.dtInfo.PostingDate,0,16),v=B(a.dtKhuyenMaiHangHoa,t,u),w=h("filter")(v,{ItemId:b.ID},!0);w.length>0&&(0===w[0].DiscAmountEdit?(j[0].DisCount01=w[0].Discount,j[0].Dis_AmountEdit=0,j[0].Disc_Amount01=parseFloat(j[0].Amount)*parseFloat(j[0].DisCount01)/100):(j[0].Disc_Amount01=parseFloat(w[0].DiscAmount)*parseFloat(j[0].Quantity),j[0].Dis_AmountEdit=1,0!=j[0].Disc_Amount01&&0!=j[0].Amount&&(j[0].DisCount01=100*j[0].Disc_Amount01/j[0].Amount)),j[0].TotalAmount=parseFloat(j[0].Amount)+parseFloat(j[0].VatAmount)-parseFloat(j[0].Disc_Amount01))}j[0].TotalAmount=j[0].Amount-j[0].Disc_Amount01,j[0].RowStatus=D.Update,j[0].UpdatedBy=f.UserName}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}).then(function(b){var c=0,e="";1===a.dtChuongTrinhKhuyenMai.length&&(e=a.dtChuongTrinhKhuyenMai[0].Id,c=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(c,e).then(function(){"1"===f.AddOn&&1===d&&(a.selectedRow=a.dtItem.length-1,a.btnAddon_Click())})},function(a){console.log("error:"+a.data)})}function x(b,c,d){null===c&&(c=1);var e=angular.copy(a.drReturnItem);e.ItemId=b.ItemId,e.ItemName=b.ItemName,e.Quantity=parseFloat(c),e.UomId=b.UomId,e.UnitPrice=b.UnitPrice,e.Amount=parseFloat(e.Quantity)*parseFloat(e.UnitPrice),e.DisCount01=0,e.Disc_Amount01=0,e.DisCount02=0,e.Disc_Amount02=0,e.Note=d,e.StatusId=b.StatusId,e.NVTraMon=f.UserName,e.RowStatus=D.Insert,a.dtReturnItem.push(e)}function y(b){H===!1&&b.StatusId===E.InHoaDon?e.ShowMessageDialog("User không có quyền trả hàng sau khi in hóa đơn."):I===!1&&b.StatusId===E.InCheBien?e.ShowMessageDialog("User không có quyền trả hàng sau khi in chế biến."):"004"===a.LoaiHinhKinhDoanh&&K.length>0&&K[0].ID===b.ItemId?e.ShowMessageDialog("Bạn không thể xóa hàng hóa Tiền giờ."):e.ShowConfirmDialog("Bạn có chắc muốn xóa ["+b.ItemName+"] ?").then(function(c){if(0==c)if(b.StatusId===E.ChonMon||b.StatusId===E.HangHoaBanDau){b.RowStatus=D.Delete;for(var d=h("filter")(a.dtItem,{ParentId:b.ID,AddOn:1},!0),e=0;e<=d.length-1;e++)d[e].RowStatus=D.Delete;var f=0,i="";1===a.dtChuongTrinhKhuyenMai.length&&(i=a.dtChuongTrinhKhuyenMai[0].Id,f=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(f,i)}else g.LyDoTraDialog("").then(function(c){if(0==c.Cancel){b.RowStatus=D.Delete,x(b,parseFloat(b.Quantity),c.value);for(var d=h("filter")(a.dtItem,{ParentId:b.ID,AddOn:1},!0),e=0;e<=d.length-1;e++)d[e].RowStatus=D.Delete,x(d[e],parseFloat(d[e].Quantity),c.value);var f=0,g="";1===a.dtChuongTrinhKhuyenMai.length&&(g=a.dtChuongTrinhKhuyenMai[0].Id,f=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(f,g)}})})}function z(a){$("#btnshowAlertMsgContent").html(a),$("#btnshowAlertMsg").alert(),$("#btnshowAlertMsg").fadeTo(1e3,300).slideUp(300,function(){$("#btnshowAlertMsg").slideUp(300)})}function A(a,b,c){var d=new Date(a),e=d.getFullYear(),f=d.getMonth()+1,g=d.getDate(),h=d.getHours(),i=d.getMinutes(),j=d.getSeconds();0===f&&(f+=1),10>f&&(f="0"+f),10>g&&(g="0"+g),10>h&&(h="0"+h),10>i&&(i="0"+i),10>j&&(j="0"+j);var k=e+"/"+f+"/"+g+" "+h+":"+i+":"+j;return(null===b||void 0===b)&&(b=0),(null===c||void 0===c)&&(c=0),0===parseInt(c)&&(c=k.length),k.slice(b,c)}function B(a,b,c){for(var d=[],e=0;e<=a.length-1;e++)(0===a[e].ApDungGioGoiMon_VaoBan&&a[e].FromDateTime<=b&&a[e].ToDateTime>=b||1===a[e].ApDungGioGoiMon_VaoBan&&a[e].FromDateTime<=curPostingTime&&a[e].ToDateTime>=curPostingTime)&&d.push(a[e]);return d}function C(){var b=h("filter")(f.Role,{ScreenCode:"Restaurant"},!0);if("1"!==f.IsAdministrator){if(b.length>0){var c=h("filter")(b,{ActionCode:"ChoPhepTraMonSauInHoaDon"},!0)[0];H=void 0===c?!0:c.IsEnable;var d=h("filter")(b,{ActionCode:"ChoPhepTraMonSauInCheBien"},!0)[0];I=void 0===d?!0:d.IsEnable;var e=h("filter")(b,{ActionCode:"InCheBienTruocInHoaDon"},!0)[0];J=void 0===e?!1:e.IsEnable;var g=h("filter")(b,{ActionCode:"EditGioVao"},!0)[0];L=void 0===g?!1:g.IsEnable;var i=h("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=void 0===i?!1:i.IsEnable;var j=h("filter")(b,{ActionCode:"EditPostingDate"},!0)[0];a.editPostingDate=void 0===j?!1:j.IsEnable}}else{L=!0;var i=h("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=void 0===i?!1:i.IsEnable;var j=h("filter")(b,{ActionCode:"EditPostingDate"},!0)[0];a.editPostingDate=!0}}var D={NotUpdate:0,Insert:1,Update:2,Delete:3},E={ChonMon:0,InCheBien:1,InHoaDon:2,HangHoaBanDau:3},F={Small:"S",Medium:"M",Large:"L"};a.DataConfig=null,a.AreaList=null,a.TableList=null,a.ItemCategoryList=null,a.ItemList=null,a.PriceByAreaList=null,a.ItemAddonList=null,a.VatList=null,a.KhachHangList=null,a.NVPVuList=null,a.MaNVLapList=null,a.NVChonMonList=null,a.permissionList=null,a.systemData=null,a.dtChuongTrinhKhuyenMai=null,a.dtKhuyenMaiHangHoa=null,a.dtSize_TraSua=null,a.TheVipList=null,a.dtDoiDiemVipList=null,a.ShipperList=null,a.GhiNhanTinhGio=null,a.Params=null;var G=0;a.relationList=null,a.PricyBySizeList=null;var H=!0,I=!0,J=!1,K=null;a.ChoPhepSuaGiaBan=!1,a.ItemIdTienGio=0,a.chkSuaCKSauKhiInHD=!0;var L=!1;a.editPostingDate=!1,a.DiemTichLuySauDoiDiem=0,a.customerModels=null,a.BankAccountList=null,a.HinhThucThanhToan=[],a.AddOn=f.AddOn,a.BanHangCanTeen=f.BanHangCanTeen,a.InVaLuuHoaDon=f.InVaLuuHoaDon,a.TraSua_SuaSoLuong=parseInt(f.TraSua_SuaSoLuong),a.TraSua_SuaSoLuong=void 0===a.TraSua_SuaSoLuong?0:a.TraSua_SuaSoLuong,a.LoaiHinhKinhDoanh=f.LoaiHinhKinhDoanh,a.btnAddOnDisable=!1,a.MaKHOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"300",field3width:"0",field4width:"0",field5width:"0",setValue:-1,maxDropDownItems:6},a.selectedRow=0,a.setClickedRow=function(b){if(a.selectedRow=b,a.dtItem.length>0){var c=a.dtItem[a.selectedRow];0===c.AddOn&&0===c.AllowSelectedSize&&0===c.ShowChooseAddOn?a.btnAddOnDisable=!0:1===c.AddOn?a.btnAddOnDisable=!0:a.btnAddOnDisable=!1}else a.btnAddOnDisable=!0},a.isSelectArea=1;var M=50,N=0,O=1,P=0,Q=50,R=1,S=null,T=null,U=null,V=null,W=null,X=null,Y=null,Z=null,_=null,aa=null,ba=null,ca=null,da=0,ea=0,fa=0;a.itemListDetailPerPage=0;var ga=160,ha=105,ia=0;a.ItemListDetailFilter=null,a.btnAllItemCategory_Selected=0;var ja=null;a.isShowbtnDelete=!1,a.MaTheVipFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.btnPreArea_Click=function(){O>1&&(O-=1);var b=(O-1)*N,c=b+N;a.AreaListFilter=a.AreaList.slice(b,c)},a.btnNextArea_Click=function(){var b=O+1,c=(b-1)*N,d=c;c<a.AreaList.length&&(d=c+N,a.AreaListFilter=a.AreaList.slice(c,d),O=b)},a.btnAreaId_Click=function(b){a.TableListFilter=h("filter")(a.TableList,{Field6:b.ID.toString()},!0),Z=b.ID,_=b.Code,aa=b.Name,T=S,S=b,S.Selected=1,null!=T&&b!=T&&(T.Selected=0);var c={CompanyId:f.CompanyId,BranchId:f.BranchId,AreaId:Z};$("#txtTextSearch").focus(),a.txtTextSearch="",f.showloading(),f.Post("GetListTableHasCustomer",c,f.url).then(function(b){a.dtBanCoKhach=b.data.Data;for(var c=null,d=0;d<=a.TableListFilter.length-1;d++)c=h("filter")(a.dtBanCoKhach,{ID:a.TableListFilter[d].ID},!0)[0],null!=c?(a.TableListFilter[d].isHasCustomer=1,a.TableListFilter[d].StatusId=c.StatusId,a.TableListFilter[d].TongTien=c.TotalAmount,a.TableListFilter[d].aaGioVao=c.CheckIn_Date):(a.TableListFilter[d].isHasCustomer=0,a.TableListFilter[d].StatusId=-1,a.TableListFilter[d].TongTien=0)},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()}).then(function(a){},function(a){console.log("error:"+a.data)})},a.btnPreItemCategory_Click=function(){R>1&&(R-=1);var b=(R-1)*P,c=b+P;a.ItemCategoryListFilter=a.ItemCategoryList.slice(b,c)},a.btnNextItemCategory_Click=function(){var b=R+1,c=(b-1)*P,d=c;c<a.ItemCategoryList.length&&(d=c+P,a.ItemCategoryListFilter=a.ItemCategoryList.slice(c,d),R=b)},a.btnItemCategory_Click=function(b){return null===ba?void e.ShowMessageDialog("Vui lòng chọn Bàn / Phòng."):(a.txtTextSearch="",a.ItemListFilter=0===b.ID?a.ItemList:h("filter")(a.ItemList,{Field6:b.ID.toString()},!0),itemCategoryBeforeSelected=U,U=b,U.Selected=1,null!=itemCategoryBeforeSelected&&b!=itemCategoryBeforeSelected&&(itemCategoryBeforeSelected.Selected=0),a.btnShowAllItemDetail_Click(b),void $("#txtTextSearch").focus())},a.btnShowAllItemDetail_Click=function(b){void 0===b?a.btnItemCategory_Click({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:""}):(b.Selected=1,0===b.ID?a.btnAllItemCategory_Selected=1:a.btnAllItemCategory_Selected=0),ja=angular.copy(a.ItemListFilter),ia=1;var c=(ia-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;a.ItemListDetailFilter=h("orderBy")(ja,"-ItemTotalSales").slice(c,d),r()},a.btnItemDetailPre_Click=function(){ia>1&&(ia-=1);var b=(ia-1)*a.itemListDetailPerPage,c=b+a.itemListDetailPerPage;a.ItemListDetailFilter=ja.slice(b,c),r()},a.btnItemDetailNext_Click=function(){var b=ia+1,c=(b-1)*a.itemListDetailPerPage,d=c;c<ja.length&&(d=c+a.itemListDetailPerPage,a.ItemListDetailFilter=ja.slice(c,d),ia=b,r())},a.$watch("txtTextSearch",function(b){if(void 0!==a.ItemListFilter){ia=1;var c=(ia-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;b=b.toLowerCase(),ja=h("filter")(a.ItemListFilter,function(a){return a.Name.toLowerCase().includes(b)||a.NameEN.toLowerCase().includes(b)}),a.ItemListDetailFilter=ja.slice(c,d),r()}}),i(function(){da=$("#idContentAreaId").height()},100),i(function(){s(),n()},1e3),a.btnChonMon=function(){a.isSelectArea=0,q(),$("#txtTextSearch").focus()},a.btnChonBan=function(){a.isSelectArea=1,a.btnAreaId_Click(S)},a.btnTableDetail_Click=function(b){a.isShowbtnDelete=!1,ba=b.ID,ca=b.Code,a.displayKhuVuc_Ban=b.Name+"-"+(null===aa?"":aa),a.btnChonMon(),f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba};f.Post("GetDataByKhuVucBan",c,f.url).then(function(c){a.dtInfo=JSON.parse(c.data.Data),a.dtItem=JSON.parse(c.data.Data2),a.dtReturnItem=JSON.parse(c.data.Data4),a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drReturnItem=c.data.Data8,a.dtDoiDiemVipList=JSON.parse(c.data.Data9),a.GhiNhanTinhGio=JSON.parse(c.data.Data10),a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var d=0,e=0;e<=a.dtDoiDiemVipList.length-1;e++)d+=parseFloat(a.dtDoiDiemVipList[e].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(d),a.MaKHOptions.setValue=a.dtInfo.CustomerId,a.MaTheVipFilterOptions.setValue=a.dtInfo.VipId,0===parseFloat(a.dtInfo.AreaId)&&(a.dtInfo.AreaId=parseFloat(b.Field6)),0===parseFloat(a.dtInfo.TableId)&&(a.dtInfo.TableId=b.ID),a.setClickedRow(0)},function(a){console.log("Error:"+a.data.Message)}).then(function(b){a.ItemCategoryList.length>0&&null==U&&a.btnItemCategory_Click(a.ItemCategoryList[a.ItemCategoryList.length-1]),"004"===a.LoaiHinhKinhDoanh&&("1"!==S.Field4||""!==a.dtInfo.ID&&null!==a.dtInfo.ID||a.chkIsTinhGio_Checked())},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()}),W=V,V=b,V.Selected=1,null!=W&&b!=W&&(W.Selected=0)},a.btnItemDetail_SingleClick=function(b){if(Y=X,X=b,X.Selected=1,null!=Y&&b!=Y&&(Y.Selected=0),1==a.AddOn){f.showloading();var c=1;w(b,c)}else{var c=1;w(b,c)}},a.btnAddon_Click=function(){if(void 0!==a.dtItem)if(a.selectedRow>a.dtItem.length-1)e.ShowMessageDialog("Vui lòng chọn một hàng hóa trên lưới.");else{var b=a.dtItem[a.selectedRow],c=angular.copy(a.dtSize_TraSua);if(c.length=0,null!==a.PricyBySizeList&&a.PricyBySizeList.length>0){var d=h("filter")(a.PricyBySizeList,{ItemId:b.ItemId},!0);if(d.length>0)for(var g=0;g<=d.length-1;g++){var i=h("filter")(a.dtSize_TraSua,{Code:d[g].Size_TraSua},!0);i.length>0&&c.push({ID:i[0].ID,Code:i[0].Code,Name:i[0].Name})}console.log(d),console.log(a.dtSize_TraSua),console.log(c)}e.ShowDetailFormDialog({data:{ItemAddonList:a.ItemAddonList,ParentItem:b,dtInfo:a.dtInfo,dtSize_TraSua:a.dtSize_TraSua},tempUrl:"app/components/Sales/Restaurant/SelectAddon.html",ctrl:"SelectAddonCtrl",cssclass:"Modal-width750",focuscontrolid:""}).then(function(b){if(0==b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba};f.Post("GetDataByKhuVucBan",c,f.url).then(function(b){a.dtInfo=JSON.parse(b.data.Data),a.dtItem=JSON.parse(b.data.Data2),a.dtReturnItem=JSON.parse(b.data.Data4),a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,a.MaKHOptions.setValue=a.dtInfo.CustomerId,m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:0,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),UserId:f.userId})},function(a){console.log("Error:"+a.data.Message)}).then(function(b){a.ItemCategoryList.length>0&&null==U&&a.btnItemCategory_Click(a.ItemCategoryList[a.ItemCategoryList.length-1])},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})}},a.btnInNhan_Click=function(){void 0!==a.dtItem&&0!==a.dtItem.length&&e.ShowDetailFormDialog({data:{InfoId:a.dtInfo.ID,TenKH_TraSua:a.dtInfo.TenKH_TraSua},tempUrl:"app/components/Sales/Restaurant/ShowInNhan.html",ctrl:"InNhanCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){1===b&&a.btnTableDetail_Click(V)})},a.btnAddNewItem_Click=function(){e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Restaurant/AddItem.html",ctrl:"AddNewItemCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(a){0===a&&(o(),m.sendInitTouchScreen2({MaGianHang:f.MaGianHang,StatusCode:0}))})},a.btnCustomerPlus_Click=function(){a.dataid=0;var b={ID:0,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",b,f.Url+"api/Customer/").then(function(b){a.data=b.data.Data}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerDetail.html",ctrl:"CustomerDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(a){if(1===a.confirm){var b=a.data;t("Customer",b)}})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.$on("handleResponseSaveInvoiceTemp",function(b,c){var d={MaGianHang:c.MaGianHang,StatusCode:c.StatusCode,dtInfo:JSON.parse(c.dtInfo),dtItem:JSON.parse(c.dtItem),dtAddon:JSON.parse(c.dtAddon),dtReturnItem:JSON.parse(c.dtReturnItem)};0===d.StatusCode&&ba===d.dtInfo.TableId&&i(function(){a.dtInfo=d.dtInfo,a.dtItem=d.dtItem,a.dtReturnItem=d.dtReturnItem},50)}),a.$on("handleResponseSaveInvoiceCompleted",function(b,c){var d={MaGianHang:c.MaGianHang,StatusCode:c.StatusCode,TableId:c.TableId};0===d.StatusCode&&ba===d.TableId&&i(function(){a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0},50)}),a.$on("handleResponseChuyenGopBan",function(b,c){var d={MaGianHang:c.MaGianHang,StatusCode:c.StatusCode,TableId:c.TableId};0===d.StatusCode&&ba===d.TableId&&i(function(){a.btnChonBan()},50)}),a.$on("handleResponseInitTouchScreen2",function(a,b){o()}),a.btnSoLuong_Click=function(b){if(b.StatusId!=E.ChonMon&&b.StatusId!=E.HangHoaBanDau)H===!1&&b.StatusId===E.InHoaDon?e.ShowMessageDialog("User không có quyền trả hàng sau khi in hóa đơn."):I===!1&&b.StatusId===E.InCheBien?e.ShowMessageDialog("User không có quyền trả hàng sau khi in chế biến."):g.returnNumber(b.Quantity,1).then(function(c){0==c.Cancel&&e.ShowConfirmDialog("Bạn có chắc muốn trả món ["+b.ItemName+"] với số lượng : "+c.returnNumber).then(function(d){if(0==d){if(b.Quantity=parseFloat(b.Quantity)-parseFloat(c.returnNumber),b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=D.Update,b.Quantity>0){var e=A(new Date,0,16),f=A(a.dtInfo.PostingDate,0,16),g=B(a.dtKhuyenMaiHangHoa,e,f),i=h("filter")(g,{ItemId:b.ItemId},!0);i.length>0&&(0===i[0].DiscAmountEdit?(b.DisCount01=i[0].Discount,b.Dis_AmountEdit=0,b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100):(b.Disc_Amount01=parseFloat(i[0].DiscAmount)*parseFloat(b.Quantity),b.Dis_AmountEdit=1,0!=b.Disc_Amount01&&0!=b.Amount&&(b.DisCount01=100*b.Disc_Amount01/b.Amount)),b.TotalAmount=parseFloat(b.Amount)+parseFloat(b.VatAmount)-parseFloat(b.Disc_Amount01))}b.Quantity<=0&&(b.RowStatus=D.Delete,b.Quantity=c.returnNumber),x(b,parseFloat(c.returnNumber),c.LyDo);var j=0,k="";1===a.dtChuongTrinhKhuyenMai.length&&(k=a.dtChuongTrinhKhuyenMai[0].Id,j=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(j,k)}})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){});else{var c=h("filter")(a.dtItem,{ID:b.ID},!0);if(c.length>0&&1===c[0].AddOn){var d=h("filter")(a.dtItem,{ID:c[0].ParentId},!0);if(d.length>0&&d[0].Quantity>1)return}g.keyBoardNumber(b.Quantity,0,"Điều chỉnh số lượng",b.Amount,-1).then(function(c){if(b.Quantity!=c.value&&0==c.Cancel){if(b.Quantity=c.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=D.Update,b.Quantity>0){var d=A(new Date,0,16),e=A(a.dtInfo.PostingDate,0,16),f=B(a.dtKhuyenMaiHangHoa,d,e),g=h("filter")(f,{ItemId:b.ItemId},!0);g.length>0&&(0===g[0].DiscAmountEdit?(b.DisCount01=g[0].Discount,b.Dis_AmountEdit=0,b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100):(b.Disc_Amount01=parseFloat(g[0].DiscAmount)*parseFloat(b.Quantity),b.Dis_AmountEdit=1,0!=b.Disc_Amount01&&0!=b.Amount&&(b.DisCount01=100*b.Disc_Amount01/b.Amount)),b.TotalAmount=parseFloat(b.Amount)+parseFloat(b.VatAmount)-parseFloat(b.Disc_Amount01))}b.Quantity<=0&&(b.RowStatus=D.Delete);var i=0,j="";1===a.dtChuongTrinhKhuyenMai.length&&(j=a.dtChuongTrinhKhuyenMai[0].Id,i=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(i,j)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnGiaBan_Click=function(b){(0===b.UnitPrice||a.ChoPhepSuaGiaBan!==!1)&&(b.StatusId==E.InHoaDon?e.ShowMessageDialog("Không được điều chỉnh giá khi đã in hóa đơn."):g.keyBoardNumber(b.UnitPrice,0,"Điều chỉnh giá bán",b.Amount,-1).then(function(c){if(b.UnitPrice!=c.value&&0==c.Cancel){b.UnitPrice=c.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=D.Update;var d=0,e="";1===a.dtChuongTrinhKhuyenMai.length&&(e=a.dtChuongTrinhKhuyenMai[0].Id,d=a.dtChuongTrinhKhuyenMai[0].PromotionType),
u(d,e)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}))},a.btnGiamGiaDetail_Click=function(b){var c=!1;b.StatusId==E.InHoaDon?e.ShowMessageDialog("Không được điều chỉnh giảm giá khi đã in hóa đơn."):g.keyBoardNumber(b.Disc_Amount01,b.DisCount01,"Điều chỉnh giảm giá món",b.Amount,1==b.Dis_AmountEdit?1:0).then(function(d){if(0==d.discountType&&0==d.Cancel?b.DisCount01!=d.value&&(b.DisCount01=d.value,b.Dis_AmountEdit=!1,b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=D.Update,c=!0):1==d.discountType&&b.Disc_Amount01!=d.value&&(b.Disc_Amount01=d.value,b.DisCount01=100*b.Disc_Amount01/b.Amount,b.Dis_AmountEdit=!0,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=D.Update,c=!0),1==c){var e=0,f="";1===a.dtChuongTrinhKhuyenMai.length&&(f=a.dtChuongTrinhKhuyenMai[0].Id,e=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(e,f)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnDeleteItem_Click=function(a){y(a)},a.btnNoteItem_Click=function(b){g.NoteDialog(b.Note).then(function(c){if(b.Note!==c.value){b.Note=c.value,b.RowStatus=D.Update;var d=0,e="";1===a.dtChuongTrinhKhuyenMai.length&&(e=a.dtChuongTrinhKhuyenMai[0].Id,d=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(d,e)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnShowbtnDelete_Click=function(){a.isShowbtnDelete=!a.isShowbtnDelete},a.btnInCheBien_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba,Value01:a.dtInfo.ID};f.Post("InCheBien",c,f.url).then(function(c){0!==c.data.Status.StatusCode&&""!==c.data.Status.MessageId?e.ShowMessageDialog(c.data.Status.MessageId):(a.dtInfo=c.data.Data,a.dtItem=c.data.Data2,a.dtReturnItem=c.data.Data4,a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drReturnItem=c.data.Data8,""!==c.data.URL&&(1===b?printJS({printable:c.data.URL,type:"pdf",showModal:!0}):window.open(c.data.URL,"PRINT PHIEU CHE BIEN","width=600,height=650").print()),"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:c.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),UserId:f.userId}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnInTraMon_Click=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba,Value01:a.dtInfo.ID};f.showloading(),f.Post("InTraMon",c,f.url).then(function(c){0!==c.data.Status.StatusCode&&""!==c.data.Status.MessageId?e.ShowMessageDialog(c.data.Status.MessageId):(a.dtInfo=c.data.Data,a.dtItem=c.data.Data2,a.dtReturnItem=c.data.Data4,a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drAddon=c.data.Data7,a.drReturnItem=c.data.Data8,""!==c.data.URL&&(1===b?printJS({printable:c.data.URL,type:"pdf",showModal:!0}):window.open(c.data.URL,"PRINT PHIEU TRA MON","width=600,height=650").print()),m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:c.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),UserId:f.userId}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})},a.btnInHoaDon_Click=function(b){(null===b||void 0===b)&&(b=0);var c=h("filter")(a.dtItem,{StatusId:E.ChonMon},!0);if(J===!0&&a.dtItem.length>0&&c.length>0)return void e.ShowMessageDialog("Vui lòng in chế biến trước khi in hóa đơn.");if("004"===a.LoaiHinhKinhDoanh&&1===a.dtInfo.IsTinhGio&&K.length>0){var d=h("filter")(a.dtItem,{ItemId:K[0].ID},!0);if(0===d.length)return void e.ShowMessageDialog("Vui lòng Tính tiền giờ trước khi In hóa đơn.")}var g={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba,Value01:a.dtInfo.ID,EmployeeId:null===f.userId||void 0===f.userId?0:f.userId,IPAddress:f.IPAddress,TienKhachDua:0,TienTraLai:0,TTTienMat:0,TTNganHang:0,NganHangId:0,TTVoucher:0,VoucherId:0};f.Post("InHoaDon",g,f.url).then(function(c){0!==c.data.Status.StatusCode&&""!==c.data.Status.MessageId?e.ShowMessageDialog(c.data.Status.MessageId):(a.dtInfo=c.data.Data,a.dtItem=c.data.Data2,a.dtReturnItem=c.data.Data4,a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drReturnItem=c.data.Data8,""!==c.data.URL&&(1===b?printJS({printable:c.data.URL,type:"pdf",showModal:!0}):window.open(c.data.URL,"IN PHIEU THANH TOAN","width=600,height=650").print()),"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:c.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),UserId:f.userId}),"1"===a.InVaLuuHoaDon&&a.btnLuuHoaDon_Click(a.BanHangCanTeen,a.InVaLuuHoaDon))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnLuuHoaDon_Click=function(b,c){var d=h("filter")(a.dtItem,{StatusId:2},!0);if(a.dtInfo.StatusId!=E.InHoaDon||d.length<a.dtItem.length)e.ShowMessageDialog("Bàn chưa in hóa đơn.");else if(v(1),"1"===c){var g=[];g.push({Bank_AccountId:0,Amount:a.dtInfo.Info_TotalAmount,SoTaiKhoan:"",TaiKhoanNhan:""});var i={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba,Value01:a.dtInfo.ID,Value02:a.dtInfo.CustomerId,ListObject:g,IPAddress:f.IPAddress,LoaiPM:f.MaNganh};f.showloading(),f.Post("SaveInvoice",i,f.url).then(function(b){0!==b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):(z("Lưu thành công."),"1"===a.BanHangCanTeen||m.sendSaveInvoiceCompleted({MaGianHang:f.MaGianHang,StatusCode:0,TableId:ba,InfoId:a.dtInfo.ID,UserId:f.userId}),"1"===a.BanHangCanTeen?(ba=0,a.btnTableDetail_Click({ID:0,Code:"000",Name:"Takeaway",Field6:"0"})):(a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0,V.Selected=0,V=null))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})}else e.ShowDetailFormDialog({data:{dtInfo:a.dtInfo,KhachHangList:a.KhachHangList,BankAccountList:a.BankAccountList,customerModels:a.customerModels},tempUrl:"app/components/Sales/Restaurant/HinhThucThanhToan.html?nd="+Date.now(),ctrl:"HinhThucThanhToanCtrl",cssclass:"Modal-width550",focuscontrolid:"txtTienKhachDua"}).then(function(b){if(1==b.confirmStatus){var c=parseFloat(b.data.dtInfo.Info_TotalAmount);if(c!=parseFloat(a.dtInfo.Info_TotalAmount))e.ShowMessageDialog("Tổng tiền thanh toán đã thay đổi, vui lòng Lưu lại hóa đơn.");else{a.KhachHangList.length!==b.data.KhachHangList.length&&(a.KhachHangList=angular.copy(b.data.KhachHangList));var d={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:Z,TableId:ba,Value01:a.dtInfo.ID,Value02:b.data.dtInfo.CustomerId,ListObject:b.data.HinhThucTT};f.showloading(),f.Post("SaveInvoice",d,f.url).then(function(b){0!==b.data.Status.StatusCode?e.ShowMessageDialog(b.data.Status.MessageId):(z("Lưu thành công."),"1"===a.BanHangCanTeen||m.sendSaveInvoiceCompleted({MaGianHang:f.MaGianHang,StatusCode:0,TableId:ba,InfoId:a.dtInfo.ID,UserId:f.userId}),"1"===a.BanHangCanTeen?(ba=0,a.btnTableDetail_Click({ID:0,Code:"000",Name:"Takeaway",Field6:"0"})):(a.btnChonBan(),a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0,V.Selected=0,V=null))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})}}})},a.btnGiamGiaTongBill_Click=function(){if(null===V)e.ShowMessageDialog("Vui lòng chọn bàn.");else{var b=!0;if(a.dtInfo.StatusId==E.InHoaDon&&"1"!==f.IsAdministrator){var c=h("filter")(a.permissionList,{ScreenCode:"Restaurant",ActionCode:"SuaCKSauKhiInHD"},!0)[0];console.log(c),b=null===c||void 0===c?!0:c.IsEnable}if(b===!1)return void e.ShowMessageDialog("Tài khoản không có quyền điều chỉnh giảm giá, phí P.Vụ sau khi In hóa đơn.");var d=!1;g.keyBoardNumber(a.dtInfo.Info_DiscAmount,a.dtInfo.Info_Discount,"Điều chỉnh giảm giá tổng Bill",a.dtInfo.Info_Amount,1==a.dtInfo.Info_Dis_AmountEdit?1:0).then(function(b){if(0==b.discountType&&0==b.Cancel?a.dtInfo.Info_Discount!=b.value&&(a.dtInfo.Info_Discount=b.value,a.dtInfo.Info_DiscAmount=parseFloat(a.dtInfo.Info_Amount)*parseFloat(a.dtInfo.Info_Discount)/100,a.dtInfo.Info_Dis_AmountEdit=0,d=!0):1==b.discountType&&0==b.Cancel&&a.dtInfo.Info_DiscAmount!=b.value&&(a.dtInfo.Info_DiscAmount=b.value,a.dtInfo.Info_Discount=100*parseFloat(a.dtInfo.Info_DiscAmount)/parseFloat(a.dtInfo.Info_Amount),a.dtInfo.Info_Dis_AmountEdit=1,d=!0),1==d){var c=0,e="";1===a.dtChuongTrinhKhuyenMai.length&&(e=a.dtChuongTrinhKhuyenMai[0].Id,c=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(c,e)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnPhiPhucVu_Click=function(){if(null===V)e.ShowMessageDialog("Vui lòng chọn bàn.");else{var b=!0;if(a.dtInfo.StatusId==E.InHoaDon&&"1"!==f.IsAdministrator){var c=h("filter")(a.permissionList,{ScreenCode:"Restaurant",ActionCode:"SuaCKSauKhiInHD"},!0)[0];console.log(c),b=null===c||void 0===c?!0:c.IsEnable}if(b===!1)return void e.ShowMessageDialog("Tài khoản không có quyền điều chỉnh giảm giá, phí P.Vụ sau khi In hóa đơn.");var d=!1;g.keyBoardNumber(a.dtInfo.Info_ServiceChargeAmount,a.dtInfo.Info_Percent_ServiceCharge,"Điều chỉnh Phí phục vụ",a.dtInfo.Info_Amount,1==a.dtInfo.Info_ServiceChargeAmtEdit?1:0).then(function(b){if(0==b.discountType&&0==b.Cancel?a.dtInfo.Info_Percent_ServiceCharge!=b.value&&(a.dtInfo.Info_Percent_ServiceCharge=b.value,a.dtInfo.Info_ServiceChargeAmount=parseFloat(a.dtInfo.Info_Percent_ServiceCharge)*parseFloat(a.dtInfo.Info_Amount)/100,a.dtInfo.Info_ServiceChargeAmtEdit=0,d=!0):1==b.discountType&&0==b.Cancel&&a.dtInfo.Info_ServiceChargeAmount!=b.value&&(a.dtInfo.Info_ServiceChargeAmount=b.value,a.dtInfo.Info_Percent_ServiceCharge=100*parseFloat(a.dtInfo.Info_ServiceChargeAmount)/parseFloat(a.dtInfo.Info_Amount),a.dtInfo.Info_ServiceChargeAmtEdit=1,d=!0),1==d){var c=0,e="";1===a.dtChuongTrinhKhuyenMai.length&&(e=a.dtChuongTrinhKhuyenMai[0].Id,c=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(c,e)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnChuyenGopBan_Click=function(b){var c=0,d=a.dtInfo.ID;null===V?e.ShowMessageDialog("Vui lòng chọn bàn."):V.StatusId===E.InHoaDon?e.ShowMessageDialog("Bàn đã in hóa đơn, không thể thực hiện chuyển/gộp bàn."):(k.sessionStorage.AreaList=JSON.stringify(a.AreaList),k.sessionStorage.type=b,k.sessionStorage.MaBanGop=V.ID,c=V.ID,k.sessionStorage.displayKhuVuc_Ban=a.displayKhuVuc_Ban,k.sessionStorage.TongTien=a.dtInfo.Info_TotalAmount,k.sessionStorage.TinhTienGioId=a.GhiNhanTinhGio.Id,k.sessionStorage.relationList=JSON.stringify(a.relationList),e.ShowDetailFormDialog({data:a.dtInfo,tempUrl:"app/components/Sales/Restaurant/ChuyenGopBan.html",ctrl:"ChuyenGopBanCtrl",cssclass:"Modal-width750",focuscontrolid:""}).then(function(b){if(0===b.StatusId){a.btnAreaId_Click(b.Area);for(var e=0;e<=a.AreaListFilter.length-1;e++)a.AreaListFilter[e].Code===S.Code?a.AreaListFilter[e].Selected=1:a.AreaListFilter[e].Selected=0;a.btnTableDetail_Click(b.Table);for(var e=0;e<=a.TableListFilter.length-1;e++)a.TableListFilter[e].ID===V.ID?a.TableListFilter[e].Selected=1:a.TableListFilter[e].Selected=0;a.btnChonBan();var g=b.tiengioList;void 0!==g&&null!==g?m.sendChuyenGopBan({MaGianHang:f.MaGianHang,StatusCode:0,TableId:c,TableId_New:V.ID,TienGioList:JSON.stringify(g),UserId:f.userId}):m.sendChuyenGopBan({MaGianHang:f.MaGianHang,StatusCode:0,TableId:c,TableId_New:V.ID,InfoId:d,UserId:f.userId})}}))},a.btnTienThue_Click=function(){var b=!1;g.selectVAT(a.dtInfo.Info_VAT_DiscAmount,a.VatList).then(function(c){if(""!=c.Code&&0==c.Cancel&&(a.dtInfo.Info_VAT_DiscAmount=c.GiaTri,a.dtInfo.Info_VatAmount=(a.dtInfo.Info_Amount-a.dtInfo.Info_DiscAmount+a.dtInfo.Info_ServiceChargeAmount)*a.dtInfo.Info_VAT_DiscAmount/100,b=!0),1==b){var d=0,e="";1===a.dtChuongTrinhKhuyenMai.length&&(e=a.dtChuongTrinhKhuyenMai[0].Id,d=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(d,e)}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnChiTietHoaDon_Click=function(){null===V||1===a.isSelectArea?e.ShowMessageDialog("Vui lòng chọn bàn."):($("#divChiTietHoaDonOutside").css("height",$("#divContainer").height()-8),$("#divChiTietHoaDonOutside").css("display",""))},a.btnCloseChiTietHoaDon_Click=function(){$("#divChiTietHoaDonOutside").css("display","none")},a.btnSaveChiTietHoaDon_Click=function(){if(null===V)e.ShowMessageDialog("Vui lòng chọn bàn.");else{var b=0,c="";1===a.dtChuongTrinhKhuyenMai.length&&(c=a.dtChuongTrinhKhuyenMai[0].Id,b=a.dtChuongTrinhKhuyenMai[0].PromotionType),u(b,c),a.btnCloseChiTietHoaDon_Click()}},a.CustomerId_selectedrow=function(b){a.dtInfo.TenKH=b.Name,a.dtInfo.DiaChiKH=b.Field11,a.dtInfo.DienThoaiKH=b.Field12},a.btnDanhSachTraMon_Click=function(){null===V||1===a.isSelectArea?e.ShowMessageDialog("Vui lòng chọn bàn."):($("#divDanhSachTraMonOutside").css("height",$("#divContainer").height()-8),$("#divDanhSachTraMonOutside").css("display",""))},a.btnCloseDanhSachTraMon_Click=function(){$("#divDanhSachTraMonOutside").css("display","none")},a.btnChuongTrinhKhuyenMai_Click=function(){var b=null===a.dtChuongTrinhKhuyenMai||1===a.isSelectArea||void 0===a.dtChuongTrinhKhuyenMai?0:a.dtChuongTrinhKhuyenMai.length;if(null===V)e.ShowMessageDialog("Vui lòng chọn bàn.");else if(0===b)e.ShowMessageDialog("Không có chương trình khuyến mãi ở thời điểm hiện tại.");else{g.selectChuongTrinhKhuyenMai(a.dtChuongTrinhKhuyenMai).then(function(a){0==a.Cancel&&u(a.PromotionType,a.ID)},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.btnKhuyenMaiTheVip_Click=function(){null===V||1===a.isSelectArea?e.ShowMessageDialog("Vui lòng chọn bàn."):($("#divKhuyenMaiTheVipOutside").css("height",$("#divContainer").height()-8),$("#divKhuyenMaiTheVipOutside").css("display",""))},a.btnCloseKhuyenMaiTheVip_Click=function(){$("#divKhuyenMaiTheVipOutside").css("display","none")},a.MaTheVipFilter_selectedrow=function(b){0!==b.ID&&0===b.Field7?e.ShowMessageDialog("Thẻ Vip đã hết hạn sử dụng."):(a.dtInfo.VipId=b.ID,u(null,null,1))},a.btnDoiDiem_Click=function(){e.ShowConfirmDialog("Bạn có chắc muốn đổi điểm thẻ Vip ?").then(function(b){if(0==b){f.showloading();var c={CompanyId:f.CompanyId,BranchId:f.BranchId,InfoId:a.dtInfo.ID,MaTheVipId:a.dtInfo.VipId,HanMucDoiDiemThuong:a.DataConfig.HanMucDoiDiemThuong};f.Post("DoiDiemTheVip",c,f.url).then(function(b){if(0===b.data.Status.StatusCode){a.dtDoiDiemVipList=b.data.Data,a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var c=0,d=0;d<=a.dtDoiDiemVipList.length-1;d++)c+=parseFloat(a.dtDoiDiemVipList[d].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(c),z("Đổi điểm thành công."),m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),UserId:f.userId})}},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){f.closeloading()})}})},a.btnKhaiBaoTienDauCa_Click=function(a){e.ShowDetailFormDialog({data:a,tempUrl:"app/components/Sales/Restaurant/KhaiBaoTienDauCa.html",ctrl:"TienDauCaCtrl",cssclass:"Modal-width400",focuscontrolid:""}).then(function(a){})},a.btnBaoCaoKetCa_Click=function(){e.ShowDetailFormDialog({data:null,tempUrl:"app/components/Sales/Restaurant/BaoCaoKetCa.html",ctrl:"BaoCaoKetCaCtrl",cssclass:"Modal-width700",focuscontrolid:""}).then(function(a){})},a.btnViewVideo_Click=function(){e.ShowDetailFormDialog({data:null,tempUrl:"app/components/Sales/Restaurant/ViewVideo.html",ctrl:"BaoCaoKetCaCtrl",cssclass:"Modal-width1000",focuscontrolid:""}).then(function(a){})},a.btnLogOut_Click=function(){e.ShowConfirmDialog("Bạn có chắc muốn thoát chương trình ?").then(function(a){0==a&&j.path("/")})},a.chkIsTinhGio_Checked=function(){e.ShowConfirmDialog("Bạn có chắc muốn tính tiền giờ cho Phòng/Bàn đang chọn ?").then(function(b){if(0==b){a.dtInfo.IsTinhGio=1;var c={AreaId:S.ID,TableId:V.ID,InfoId:a.dtInfo.ID,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("GhiNhanTinhGio",c,f.url).then(function(b){if(0===b.data.Status.StatusCode){a.GhiNhanTinhGio=b.data.Data,a.dtInfo=b.data.Data2;var c=b.data.Data3;a.dtItem=b.data.Data4,"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),TienGioList:JSON.stringify(c),UserId:f.userId})}},function(a){})["finally"](function(){f.closeloading()})}else a.dtInfo.IsTinhGio=0})},a.btnTinhTienGio_Click=function(){var b=!0;if(a.dtInfo.StatusId==E.InHoaDon&&"1"!==f.IsAdministrator){var c=h("filter")(a.permissionList,{ScreenCode:"Restaurant",ActionCode:"SuaCKSauKhiInHD"},!0)[0];b=null===c||void 0===c?!0:c.IsEnable}e.ShowDetailFormDialog({data:{dtInfo:a.dtInfo,GhiNhanTinhGio:JSON.stringify(a.GhiNhanTinhGio),allowEditGioVao:L,isEditTienGioSauInHD:b},tempUrl:"app/components/Sales/Restaurant/TinhTienGio.html",ctrl:"TinhTienGioCtrl",cssclass:"Modal-width500",focuscontrolid:""}).then(function(b){if(0===b.statusCode){var c=b.aaValue,d="TinhTienGio";1===G&&(d="TinhTienGio_TheoThoiDiem"),f.Post(d,c,f.url).then(function(b){if(0===b.data.Status.StatusCode){a.dtInfo=b.data.Data,a.dtItem=b.data.Data2,a.dtReturnItem=b.data.Data4,a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,a.dtDoiDiemVipList=b.data.Data9,a.GhiNhanTinhGio=b.data.Data10;var c=b.data.Data20;"1"===a.BanHangCanTeen||m.sendSaveInvoiceTemp({MaGianHang:f.MaGianHang,StatusCode:b.data.Status.StatusCode,dtInfo:JSON.stringify(a.dtInfo),dtItem:JSON.stringify(a.dtItem),dtReturnItem:JSON.stringify(a.dtReturnItem),dtDoiDiemVip:JSON.stringify(a.dtDoiDiemVipList),dtTienGio:JSON.stringify(a.GhiNhanTinhGio),TienGioList:JSON.stringify(c),UserId:f.userId})}},function(a){})["finally"](function(){f.closeloading()})}})},i(function(){C()},50)}]),app.controller("HinhThucThanhToanCtrl",["$scope","$timeout","$uibModalInstance","data","RestaurantService","AppDialog",function(a,b,c,d,e,f){function g(b,c){e.showloading();var d={CompanyId:e.CompanyId,BranchId:e.BranchId,MasterType:b};e.Post("reloadMasterPlus",d,e.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?f.ShowMessageDialog(b.data.Status.MessageId):"Customer"===b.data.Status.ObjData&&(a.KhachHangList=b.data.Data,a.CustomerId=c.ID)},function(a){showAlertMessage($translate.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})}a.dataCopy=angular.copy(d),a.IsEnableCustomerId=!0,a.success=!1,a.submitted=!1,a.dtInfo=d.dtInfo,a.KhachHangList=d.KhachHangList,a.BankAccountList=d.BankAccountList,a.customerModels=d.customerModels,a.MaKHOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"300",field3width:"0",field4width:"0",field5width:"0",setValue:-1,maxDropDownItems:6},a.txtTienMat=a.dtInfo.Info_TotalAmount,a.txtTheNganHang=0,a.txtTienKhachDua=a.dtInfo.SoTienKhachDua,a.txtTienTraLaiKhach=a.dtInfo.TienTraLaiKhach,a.txtTongTienKhachDaTra=parseFloat(a.txtTienMat)+parseFloat(a.txtTheNganHang),b(function(){a.MaKHOptions.setValue=parseFloat(a.dtInfo.CustomerId),a.CustomerId=a.dtInfo.CustomerId,parseFloat(a.dtInfo.CustomerId)>0?a.IsEnableCustomerId=!1:a.IsEnableCustomerId=!0},100),a.txtTienKhachDua_Change=function(){a.txtTienTraLaiKhach=parseFloat(a.txtTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount),a.txtTienTraLaiKhach=a.txtTienTraLaiKhach<0?0:a.txtTienTraLaiKhach,parseFloat(a.txtTienKhachDua)>0?(a.txtTienMat=parseFloat(a.txtTienKhachDua)>parseFloat(a.dtInfo.Info_TotalAmount)?parseFloat(a.dtInfo.Info_TotalAmount)-parseFloat(a.txtTheNganHang):parseFloat(a.txtTienKhachDua)-parseFloat(a.txtTheNganHang),a.txtTienMat=a.txtTienMat<0?0:a.txtTienMat,a.TinhTongTienKhachTra()):parseFloat(a.txtTienKhachDua)<=0&&(a.txtTienMat=0,a.TinhTongTienKhachTra())},a.txtTienKhachDua_Keydown=function(a){},a.TinhTongTienKhachTra=function(){a.txtTongTienKhachDaTra=parseFloat(a.txtTienMat)+parseFloat(a.txtTheNganHang),a.txtTongTienKhachDaTra=a.txtTongTienKhachDaTra<0?0:a.txtTongTienKhachDaTra},a.btnSave_Click=function(){if(parseFloat(a.txtTongTienKhachDaTra)>parseFloat(a.dtInfo.Info_TotalAmount))return void f.ShowMessageDialog("Tiền khách trả không được lớn hơn tổng tiền hóa đơn.");if(0!==parseFloat(a.txtTheNganHang)&&(0===a.Bank_AccountId||void 0===a.Bank_AccountId||null===a.Bank_AccountId))return f.ShowMessageDialog("Vui lòng chọn ngân hàng"),void $("#Bank_AccountId").focus();if(parseFloat(a.txtTongTienKhachDaTra)<parseFloat(a.dtInfo.Info_TotalAmount)&&(a.CustomerId<=0||void 0===a.CustomerId||null===a.CustomerId))return void f.ShowMessageDialog("Tiền khách trả nhỏ hơn tổng tiền hóa đơn, vui lòng chọn Khách hàng để ghi nhận công nợ.");a.dtInfo.CustomerId=a.CustomerId,a.HinhThucThanhToan=[],parseFloat(a.txtTienMat)>0&&a.HinhThucThanhToan.push({Bank_AccountId:0,Amount:a.txtTienMat,SoTaiKhoan:"",TaiKhoanNhan:""}),parseFloat(a.txtTheNganHang)>0&&a.HinhThucThanhToan.push({Bank_AccountId:a.Bank_AccountId,Amount:a.txtTheNganHang,SoTaiKhoan:"",TaiKhoanNhan:""}),a.dtInfo.TTTienMat=a.txtTienMat,a.dtInfo.TTNganHang=a.txtTheNganHang,a.dtInfo.NganHangId=a.Bank_AccountId;var b={dtInfo:a.dtInfo,KhachHangList:a.KhachHangList,HinhThucTT:a.HinhThucThanhToan};c.close({confirmStatus:1,data:b})},a.btnCancel_Click=function(){c.close({confirmStatus:0,data:a.dtInfo})},a.btnCustomerPlus_Click=function(){a.dataid=0;var b={ID:0,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("detail",b,e.Url+"api/Customer/").then(function(b){a.data=b.data.Data}).then(function(){a.dataid>0&&0==a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Master/Customer/CustomerDetail.html",ctrl:"CustomerDetailCtrl",cssclass:"Modal-width550",focuscontrolid:0==a.data.ID?"Code":"Name"}).then(function(a){if(1===a.confirm){var b=a.data;g("Customer",b)}})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){e.closeloading()})},parseFloat(a.dtInfo.SoTienKhachDua)>0?(a.txtTienTraLaiKhach=parseFloat(a.txtTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount),a.txtTienTraLaiKhach=a.txtTienTraLaiKhach<0?0:a.txtTienTraLaiKhach,parseFloat(a.txtTienKhachDua)>0?(a.txtTienMat=parseFloat(a.txtTienKhachDua)>parseFloat(a.dtInfo.Info_TotalAmount)?parseFloat(a.dtInfo.Info_TotalAmount)-parseFloat(a.txtTheNganHang):parseFloat(a.txtTienKhachDua)-parseFloat(a.txtTheNganHang),a.txtTienMat=a.txtTienMat<0?0:a.txtTienMat,a.TinhTongTienKhachTra()):parseFloat(a.txtTienKhachDua)<=0&&(a.txtTienMat=0,a.TinhTongTienKhachTra())):(a.txtTienMat=0,a.TinhTongTienKhachTra())}]),app.controller("ChuyenGopBanCtrl",["$scope","$uibModalInstance","$window","$timeout","data","RestaurantService","AppDialog",function(a,b,c,d,e,f,g){function h(c){var d={CompanyId:f.CompanyId,BranchId:f.BranchId,IDTo:p.InfoId,AreaIdTo:m.ID,TableIdTo:p.ID,IDFrom:a.dataChuyenBan.ID,AreaIdFrom:a.dataChuyenBan.AreaId,TableIdFrom:a.dataChuyenBan.TableId,TinhGiaTheoKhuVuc:c,InfoId:a.dataChuyenBan.ID,TinhTienGioId:a.TinhTienGioId},e="";0===a.type&&(e="Execute_Transfer"),1===a.type&&(e="Execute_Merge"),f.Post(e,d,f.url).then(function(a){0==a.data.Status.StatusCode?g.ShowMessageDialog(a.data.Status.MessageId).then(function(){var c=a.data.Data,d={StatusId:0,Area:m,Table:p,tiengioList:c};b.close(d)}):g.ShowMessageDialog(a.data.Status.MessageId)},function(a){g.ShowMessageDialog("Lỗi, vui lòng kiểm tra lại")})}a.AreaListFilter=null;var j=1,k=90,l=0,m=null,n=null,o=null,p=null;for(a.TableListChuyenBan=null,a.dataChuyenBan=angular.copy(e),a.AreaList=JSON.parse(c.sessionStorage.AreaList),a.relationList=JSON.parse(c.sessionStorage.relationList),i=0;i<=a.AreaList.length-1;i++)a.AreaList[i].Selected=0;a.type=JSON.parse(c.sessionStorage.type),a.MaBanGop=c.sessionStorage.MaBanGop,a.displayKhuVuc_Ban=c.sessionStorage.displayKhuVuc_Ban,a.TongTien=c.sessionStorage.TongTien,a.TinhTienGioId=c.sessionStorage.TinhTienGioId,a.btnPreAreaChuyenGopBan_Click=function(){j>1&&(j-=1);var b=(j-1)*l,c=b+l;a.AreaListFilter=a.AreaList.slice(b,c)},a.btnNextAreaChuyenGopBan_Click=function(){var b=j+1,c=(b-1)*l,d=c;c<a.AreaList.length&&(d=c+l,a.AreaListFilter=a.AreaList.slice(c,d),j=b)},a.btnSetupAreaId=function(){l=Math.round($("#idContentAreaId2").width()/(k+10)-.5),j=1;var b=(j-1)*l,c=b+l;a.AreaListFilter=a.AreaList.slice(b,c)},a.btnAreaIdChuyenGopBan_Click=function(b){var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,AreaId:b.ID,TableId:a.MaBanGop,Value01:a.type};f.Post("GetTableList_MergeTransfer",c,f.url).then(function(c){a.TableListChuyenBan=c.data.Data,n=m,m=b,m.Selected=1,null!=n&&b!=n&&(n.Selected=0)},function(a){null===a.data&&-1===a.status?g.ShowMessageDialog("Lỗi kết nối server, vui lòng kiểm tra lại kết nối."):console.log("Error:"+a.data)})},a.btnTableDetailChuyenBan_Click=function(a){o=p,p=a,p.Selected=1,p.InfoId=a.InfoId,null!=o&&a!=o&&(o.Selected=0)},d(function(){a.btnSetupAreaId()},100),a.btnXuLy_Click=function(){var b=0;if(a.relationList.length>0&&parseFloat(a.dataChuyenBan.AreaId)!==parseFloat(m.ID)){for(var c=[],d=0;d<=a.relationList.length-1;d++)(parseFloat(a.relationList[d].AreaId)===parseFloat(m.ID)||parseFloat(a.relationList[d].AreaId)===parseFloat(a.dataChuyenBan.AreaId))&&c.push(a.relationList[d]);if(c.length>1)if(parseFloat(c[0].PriceId)!==parseFloat(c[1].PriceId)){var e="Bạn có muốn tính giá theo khu vực mới không?";e+="</br>",e+="[Yes]: Đồng ý tính giá theo khu vực mới",e+="</br>",e+="[No]: Giữ nguyên giá cũ",e+="</br>",e+="[Cancel]: Đóng xác nhận",g.ShowConfirmDialog(e,!0).then(function(a){if(0===parseInt(a))b=1;else if(1===parseInt(a))b=0;else if(2===parseInt(a))return;h(b)})}else h(b);else h(b)}else h(b)},a.btnThoat_Click=function(){b.dismiss("cancel")}}]),app.controller("SelectAddonCtrl",["$scope","$uibModalInstance","$filter","$window","$timeout","data","RestaurantService","AppDialog",function(a,b,c,d,e,f,g,h){a.SelectedListFilter=null;var i=1,j=90,k=0,l="";a.AddonList=null,a.itemDetail=angular.copy(f.ParentItem),a.dtSize_TraSua=angular.copy(f.dtSize_TraSua),a.CurSize_TraSua=a.itemDetail.Size_TraSua,a.txtSoLuong=a.itemDetail.Quantity,a.ItemAddonList=angular.copy(f.ItemAddonList);angular.copy(f.dtInfo);a.listSelected=[],a.btnItemAddon_Click=function(b){b.Selected=1==b.Selected?0:1;var d=c("filter")(a.ItemAddonList,{ID:b.ID},!0);if(d.length>0){1==b.Selected?a.listSelected.push(b):a.listSelected=$.grep(a.listSelected,function(a,c){return a.ID===b.ID},!0),i>1&&(i-=1);var e=(i-1)*k,f=e+k;a.SelectedListFilter=a.listSelected.slice(e,f)}},a.btnSizeTraSua_Click=function(b){for(var c=0;c<=a.dtSize_TraSua.length-1;c++)a.dtSize_TraSua[c].Code===b.Code?(a.dtSize_TraSua[c].Selected=1,l=a.dtSize_TraSua[c].Code):a.dtSize_TraSua[c].Selected=0},a.btnPreAreaChuyenGopBan_Click=function(){i>1&&(i-=1);var b=(i-1)*k,c=b+k;a.SelectedListFilter=a.listSelected.slice(b,c)},a.btnNextAreaChuyenGopBan_Click=function(){var b=i+1,c=(b-1)*k,d=c;c<a.listSelected.length&&(d=c+k,a.SelectedListFilter=a.listSelected.slice(c,d),i=b)},btnSetupSelectedId=function(){k=Math.round($("#idContentAreaId2").width()/(j+10)-.5),i=1;var b=(i-1)*k,c=b+k;a.SelectedListFilter=a.listSelected.slice(b,c),(null===a.CurSize_TraSua||void 0===a.CurSize_TraSua)&&(a.CurSize_TraSua=a.dtSize_TraSua[0].Code,l=a.dtSize_TraSua[0].Code);for(var d=0;d<=a.dtSize_TraSua.length-1;d++)if(a.dtSize_TraSua[d].Code===a.CurSize_TraSua){a.dtSize_TraSua[d].Selected=1,l=a.dtSize_TraSua[1].Code;break}},e(function(){btnSetupSelectedId()},100),a.btnXuLy_Click=function(){var c={CompanyId:g.CompanyId,BranchId:g.BranchId,SelectedAddon:a.listSelected,dtInfo:f.dtInfo,ParentId:a.itemDetail.ID,Size_TraSua:l,dtItem:a.itemDetail,SoLuong:a.txtSoLuong};g.showloading(),g.Post("SelectedAddon",c,g.url).then(function(a){0==a.data.Status.StatusCode?b.close(a.data.Status.StatusCode):(h.ShowMessageDialog(a.data.Status.MessageId),b.close(a.data.Status.StatusCode))},function(a){h.ShowMessageDialog("Lỗi, vui lòng kiểm tra lại")})["finally"](function(){g.closeloading()})},a.btnThoat_Click=function(){b.dismiss("cancel")}}]),app.controller("InNhanCtrl",["$scope","$uibModalInstance","$filter","$window","$timeout","data","RestaurantService","AppDialog",function(a,b,c,d,e,f,g,h){function i(){var b={CompanyId:g.CompanyId,BranchId:g.BranchId,Value01:f.InfoId};g.showloading(),g.Post("GetlistInNhanTraSua",b,g.url).then(function(b){a.dtItem=b.data.Data},function(a){h.ShowMessageDialog("Lỗi, vui lòng kiểm tra lại")})["finally"](function(){g.closeloading()})}a.dtItem=null,a.dtInfo=null,a.TenKH_TraSua=f.TenKH_TraSua,i(),a.btnInNhan_Click=function(){var d=c("filter")(a.dtItem,{SelectInNhan:!0},!0);0==d.length?h.ShowMessageDialog("Vui lòng chọn dữ liệu cần in nhãn."):(g.showloading(),g.Post("InNhanTraSua",d,g.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?h.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(window.open(a.data.URL,"IN NHAN","width=600,height=650").print(),b.close(1))},function(a){h.ShowMessageDialog("Lỗi, vui lòng kiểm tra lại")})["finally"](function(){g.closeloading()}))},a.btnThoat_Click=function(){b.close(0)}}]),app.controller("AddNewItemCtrl",["$scope","$uibModalInstance","$timeout","$filter","data","AppDialog","RestaurantService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:g.UserName};g.Post("InitItemDetail",b,g.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.ItemCategoryList=b.data.Data,a.UnitList=b.data.Data2)},function(a){}).then(function(c){g.Post("GetMaxCode",b,g.Url+"api/Item/").then(function(b){0===b.data.Status.StatusCode&&(a.detail=b.data.Data)},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){g.closeloading()})},function(a){console.log("error:"+a.data)})["finally"](function(){g.closeloading()})}a.detail=null,a.ItemCategoryList=null,a.UnitList=null,a.LoaiHinhKinhDoanh=g.MaNganh,h(),a.btnCancel_Click=function(){b.close(-1)},a.btnSave_Click=function(){var c="";if((null===a.detail.Code||""===a.detail.Code)&&(c+="Vui lòng nhập mã hàng</br>"),(null===a.detail.Name||""===a.detail.Name)&&(c+="Vui lòng nhập tên hàng</br>"),(0===a.detail.Item_CategoryId||null===a.detail.Item_CategoryId)&&(c+="Vui lòng nhập nhóm hàng</br>"),(0===a.detail.UnitBasic||null===a.detail.UnitBasic)&&(c+="Vui lòng nhập đơn vị tính</br>"),""!==c)f.ShowMessageDialog(c);else{a.detail.CompanyId=g.CompanyId,g.showloading();({CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:g.UserName});g.Post("SaveExpress",a.detail,g.Url+"api/Item/").then(function(a){0===a.data.Status.StatusCode?(f.ShowMessageDialog("Lưu thành công."),b.close(0)):5===a.data.Status.StatusCode?f.ShowMessageDialog("Dữ liệu đã tồn tại, vui lòng nhập lại."):f.ShowMessageDialog("Đã xảy ra lỗi, vui lòng thử lại.")},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){g.closeloading()})}}}]),app.controller("TienDauCaCtrl",["$scope","$uibModalInstance","$timeout","$filter","data","AppDialog","RestaurantService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b=new Date,c=b.getFullYear(),d=b.getMonth(),e=b.getDate(),f=c+"-"+(d+1)+"-"+e,h={CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:g.UserName,UserId:g.userId,Ngay:f};g.Post("GetDataTienDauCa",h,g.url).then(function(b){0===b.data.Status.StatusCode&&(a.detail=b.data.Data)},function(a){})["finally"](function(){g.closeloading()})}a.isShowbtnClose=parseInt(e),a.detail=null,
a.NhanVien=g.UserName,a.Ngay=new Date,h(),a.btnCancel_Click=function(){b.close(-1)},a.TinhTongTien=function(){var b=0;b+=500*parseFloat(a.detail.To500D),b+=1e3*parseFloat(a.detail.To1000D),b+=2e3*parseFloat(a.detail.To2000D),b+=5e3*parseFloat(a.detail.To5000D),b+=1e4*parseFloat(a.detail.To10000D),b+=2e4*parseFloat(a.detail.To20000D),b+=5e4*parseFloat(a.detail.To50000D),b+=1e5*parseFloat(a.detail.To100000D),b+=2e5*parseFloat(a.detail.To200000D),b+=5e5*parseFloat(a.detail.To500000D),a.detail.TongTien=b},a.btnSave_Click=function(){g.showloading();var c=new Date;c.getFullYear(),c.getMonth(),c.getDate();a.detail.UserName=g.UserName,a.detail.UserId=g.userId,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.Post("SaveDataTienDauCa",a.detail,g.url).then(function(a){0===a.data.Status.StatusCode&&(f.ShowMessageDialog(a.data.Status.MessageId),b.close(-1))},function(a){f.ShowMessageDialog(response.data.Status.MessageId)})["finally"](function(){g.closeloading()})}}]),app.controller("BaoCaoKetCaCtrl",["$scope","$uibModalInstance","$timeout","$filter","$window","data","AppDialog","RestaurantService",function(a,b,c,d,e,f,g,h){function i(){h.showloading();var b=new Date,c=b.getFullYear(),d=b.getMonth(),e=b.getDate(),f=c+"-"+(d+1)+"-"+e,g={CompanyId:h.CompanyId,BranchId:h.BranchId,UserName:h.UserName,UserId:h.userId,Ngay:f};h.Post("GetDataTienKetThucCa",g,h.url).then(function(b){0===b.data.Status.StatusCode&&(a.detail=b.data.Data,a.TienKetThucCa=b.data.Data3,a.TienDauCaId=a.detail.TienDauCaId,a.detail.TongTienCuoiCa=parseFloat(a.detail.TongTienCuoiCa)-parseFloat(a.detail.NganHang))},function(a){})["finally"](function(){h.closeloading()})}function j(b){h.showloading(),a.detail.UserId=h.userId,a.detail.UserName=h.UserName,a.detail.To500D=a.TienKetThucCa.To500D,a.detail.To1000D=a.TienKetThucCa.To1000D,a.detail.To2000D=a.TienKetThucCa.To2000D,a.detail.To5000D=a.TienKetThucCa.To5000D,a.detail.To10000D=a.TienKetThucCa.To10000D,a.detail.To20000D=a.TienKetThucCa.To20000D,a.detail.To50000D=a.TienKetThucCa.To50000D,a.detail.To100000D=a.TienKetThucCa.To100000D,a.detail.To200000D=a.TienKetThucCa.To200000D,a.detail.To500000D=a.TienKetThucCa.To500000D,a.detail.TongTienDauCa=a.detail.TienDauCa,a.detail.TongTienKetThucCa=a.detail.TongTienCuoiCa,a.detail.CompanyId=h.CompanyId,a.detail.BranchId=h.BranchId,a.detail.TienDauCaId=a.TienDauCaId,a.detail.KetCaByWeb=1,h.Post("SaveDataTienKetThucCa",a.detail,h.url).then(function(a){0===a.data.Status.StatusCode&&(""!==a.data.URL&&(window.open(a.data.URL,"BAO CAO KET CA","width=600,height=650").print(),window.close()),h.Post("LogOff",null,h.Url+"api/Auth/").then(function(a){sessionStorage.clear(),e.localStorage.TokenInfo=null,h.accessToken=void 0,window.location="/login.html"}))},function(a){})["finally"](function(){h.closeloading()})}a.detail=null,a.TienKetThucCa=null,a.NhanVien=h.UserName,a.GioHienTai=new Date,a.TongMenhGiaTien=0,a.TienDauCaId=0,i(),a.btnCancel_Click=function(){b.close(-1)},a.TinhTongTien=function(){var b=0;b+=500*parseFloat(a.TienKetThucCa.To500D),b+=1e3*parseFloat(a.TienKetThucCa.To1000D),b+=2e3*parseFloat(a.TienKetThucCa.To2000D),b+=5e3*parseFloat(a.TienKetThucCa.To5000D),b+=1e4*parseFloat(a.TienKetThucCa.To10000D),b+=2e4*parseFloat(a.TienKetThucCa.To20000D),b+=5e4*parseFloat(a.TienKetThucCa.To50000D),b+=1e5*parseFloat(a.TienKetThucCa.To100000D),b+=2e5*parseFloat(a.TienKetThucCa.To200000D),b+=5e5*parseFloat(a.TienKetThucCa.To500000D),a.TongMenhGiaTien=b},a.btnSave_Click=function(b){(null===b||void 0===b)&&(b=0),parseFloat(a.detail.TongTienCuoiCa)!==parseFloat(a.TongMenhGiaTien)?g.ShowConfirmDialog("[Tổng tiền cuối ca] khác [Tổng mệnh giá tiền], bạn có muốn tiếp tục Kết ca ?").then(function(a){0===parseInt(a)&&j(b)}):j(b)}}]),app.controller("TinhTienGioCtrl",["$scope","$uibModalInstance","$timeout","$filter","$window","data","AppDialog","RestaurantService",function(a,b,c,d,e,f,g,h){function i(){a.allowEditGioVao=f.allowEditGioVao;var b=new Date,c=b.getFullYear(),d=b.getMonth(),e=b.getDate(),g=b.getHours(),h=b.getMinutes(),i=c.toString()+(d+1>9?(d+1).toString():"0"+(d+1).toString())+(e>9?e.toString():"0"+e.toString())+(g>9?g.toString():"0"+g.toString())+(h>9?h.toString():"0"+h.toString()),j=new Date(a.ChiTietTinhGio.ToTime),k=j.getFullYear(),l=j.getMonth(),m=j.getDate(),n=new Date(k,l,m,a.ChiTietTinhGio.ToHour,a.ChiTietTinhGio.ToMinute,0),o=n.getHours(),p=n.getMinutes(),q=k.toString()+(l+1>9?(l+1).toString():"0"+(l+1).toString())+(m>9?m.toString():"0"+m.toString())+(o>9?o.toString():"0"+o.toString())+(p>9?p.toString():"0"+p.toString());parseFloat(q)<parseFloat(i)&&(a.ChiTietTinhGio.ToTime=new Date,a.ChiTietTinhGio.ToHour=b.getHours(),a.ChiTietTinhGio.ToMinute=b.getMinutes())}a.dtInfo=f.dtInfo,a.ChiTietTinhGio=JSON.parse(f.GhiNhanTinhGio),a.GioRaDuKien=new Date,a.allowEditGioVao=f.allowEditGioVao,a.allowEditTienGioSauInHD=f.isEditTienGioSauInHD,c(function(){i()},50),a.btnCancel_Click=function(){b.close({statusCode:-1,aaValue:null})},a.btnTinhTienGio_Click=function(){g.ShowConfirmDialog("Bạn có chắc muốn tính tiền giờ ?").then(function(c){0==c&&(a.ChiTietTinhGio.TinhTienGioId=a.ChiTietTinhGio.Id,b.close({statusCode:0,aaValue:a.ChiTietTinhGio}))})}}]),app.factory("RestaurantListService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/RestaurantList/",e.urlCombobox=e.Url+"api/Combobox/",e.urlEdit=e.Url+"api/Restaurant/",e}]),app.controller("RestaurantListCtrl",["$scope","$uibModal","$timeout","$translate","$filter","AppDialog","RestaurantListService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitRestaurantListSearch",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.CustomerList=b.data.Data,a.EmployeeCreatedList=b.data.Data2,a.EmployeeServiceList=b.data.Data2,a.ShipperList=b.data.Data3,a.SellerIdList=b.data.Data2,a.HinhThucThanhToanList=b.data.Data4,i()},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),c(function(){a.btnSearch()},50)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"RestaurantList"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===d?!1:!d.IsEnable);var f=e("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===f?!1:!f.IsEnable);var h=e("filter")(b,{ActionCode:"Edit"},!0)[0];a.IsEdit=void 0===h?!1:!h.IsEnable}else a.viewRole=!1}else a.IsEdit=!0}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.EmployeeServiceList=null,a.ShipperList=null,a.HinhThucThanhToanList=null,a.SellerIdList=null,a.IsEdit=!1,a.LoaiPM=g.MaNganh,a.showIsEditAfterSave=!1,"3bc1bd7d-aec9-4b9b-b5ea-d680afb8fde1"===g.BranchId?a.showIsEditAfterSave=!0:"POS"===a.LoaiPM&&(a.showIsEditAfterSave=!0),a.TotalRow=null,a.gridOptions={data:[],id:"grid_RestaurantList",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!1,showDelete:!1,showpaging:!0,columnDefs:[{field:"DocumentNo",display:"Số phiếu",headerclass:"text-align-center col-w-120px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PostingDate",display:"Ngày",headerclass:"text-align-center col-w-90px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"dd/MM/yyyy",visible:!0},{field:"CustomerName",display:"Khách hàng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"EmployeeCreatedName",display:"Nhân viên lập",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"TableName",display:"Bàn",headerclass:"text-align-center col-w-40px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Info_Amount",display:"Tiền hàng",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Info_DiscAmount",display:"Giảm giá",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Info_ServiceChargeAmount",display:"Phí p.vụ",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Info_VatAmount",display:"Tiền thuế",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0},{field:"Info_TotalAmount",display:"Tổng tiền",headerclass:"text-align-center col-w-100px",detailclass:"text-align-right",formatnumber:"0",formatdatetime:"",visible:!0}]},a.currentElement=50,a.loadMore=function(){a.currentElement=a.currentElement+50},a.EmployeeCreatedOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,DocumentNo:a.DocumentNo,ShipperId:a.ShipperId,EmpServiceId:a.EmpServiceId,CompanyId:g.CompanyId,BranchId:g.BranchId,HinhThucTT:a.HinhThucThanhToanId,SellerId:a.SellerId};g.Post("search",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.gridOptions.data=a.searhResultList,a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+d.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,DocumentNo:a.DocumentNo,ShipperId:a.ShipperId,EmpServiceId:a.EmpServiceId,CompanyId:g.CompanyId,BranchId:g.BranchId,HinhThucTT:a.HinhThucThanhToanId,SellerId:a.SellerId},c="DanhSachHoaDonBan.xlsx";g.ExportExcel("Export",b,g.url,c).then(function(a){},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.EmployeeCreatedId=0,a.DocumentNo="",$("#FromDate").focus()},a.selectAll=function(){for(var b=!a.checkIsSelectAll(),c=0;c<=a.searhResultList.length-1;c++)$("#"+c+"_selected").prop("checked",b)},a.checkIsSelectAll=function(){if(null!==a.searhResultList){for(var b=[],c=0;c<=a.searhResultList.length-1;c++)1==$("#"+c+"_selected").prop("checked")&&b.push(a.searhResultList[c]);return b.length===a.searhResultList.length}return!1},a.btnDeleteList=function(){var b=[];angular.forEach(a.searhResultList,function(a,c){1==$("#"+c+"_selected").prop("checked")&&b.push(a)}),b.length<=0?f.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):f.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(g.showloading(),g.Post("deletelist",b,g.url).then(function(c){var d=c.data.Status;0==d.StatusCode?f.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(f.ShowMessageDialog(c.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))})},a.btnViewDetail_Click=function(b){g.showloading();var c={InfoId:b.ID,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("detail",c,g.url).then(function(c){a.data=c.data.Data,a.dataid=b.ID}).then(function(){""===a.data.ID?f.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):f.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Sales/RestaurantList/RestaurantDetail.html",ctrl:"RestaurantListDetailCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},function(a){f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},h(),a.btnGridEdit_Click=function(a){f.ShowDetailFormDialog({data:a,tempUrl:"app/components/Sales/RestaurantList/HoaDonBanEdit.html",ctrl:"HoaDonBanEditCtrl",cssclass:"Modal-ManHinhBanLe",focuscontrolid:""}).then(function(a){})},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.controller("RestaurantListDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","data","RestaurantListService","AppDialog",function(a,b,c,d,e,f,g){function h(){var b=$q.defer(),c=!0;return parseFloat(a.detail.TTNganHang)>0&&0===a.detail.NganHangId?(c=!1,g.ShowMessageDialog("Vui lòng chọn hình thức thanh toán.")):parseFloat(a.detail.TTTienMat)+parseFloat(a.detail.TTNganHang)>parseFloat(a.detail.Info_TotalAmount)&&(c=!1,g.ShowMessageDialog("Tổng tiền thanh toán không được lớn hơn số tiền:"+formatThousands(a.detail.Info_TotalAmount))),b.resolve(c),b.promise}function i(){var b=window.innerHeight-50-20;$("#RestaurantDetail").height(b);var c=$(".customergrid-table").parent().height();a.itemsPerPage=Math.floor((c-60)/35),a.itemsPerPage<10&&(a.itemsPerPage=10)}function j(){f.showloading(),f.Post("InitRestaurantDetail",{CompanyId:f.CompanyId,BranchId:f.BranchId},f.urlCombobox).then(function(b){a.HinhThucThanhToanList=b.data.Data},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function k(){null!=a.detail.listDetail&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function l(){null!=a.detail.listLogItem&&(a.beginlog=(a.currentPagelog-1)*a.itemsPerPagelog,a.endlog=a.beginlog+a.itemsPerPagelog)}function m(){null!=a.detail.listChiTietTraMon&&(a.beginTraMon=(a.currentPageTraMon-1)*a.itemsPerPageTraMon,a.endTraMon=a.beginTraMon+a.itemsPerPageTraMon)}function n(){if("1"!==f.IsAdministrator){var a=$filter("filter")(f.Role,{ScreenCode:"RestaurantList"},!0);if(a.length>0){var b=$filter("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSave").prop("disabled",!0)}}a.dataCopy=angular.copy(e),a.success=!1,a.submitted=!1,a.HinhThucThanhToanList=null,a.LoaiPM=f.MaNganh,a.disablecode=!1,a.detail=e,a.Note=e.Note+", "+e.Description,a.btnCancel=function(){c.dismiss("cancel")},a.btnPrint=function(b){(null===b||void 0===b)&&(b=0);var c={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName,Value01:a.detail.ID,Value02:a.detail.VipId};f.showloading(),f.Post("RePrint",c,f.url).then(function(a){0!==a.data.Status.StatusCode&&""!==a.data.Status.MessageId?g.ShowMessageDialog(a.data.Status.MessageId):""!==a.data.URL&&(1===b?printJS({printable:a.data.URL,type:"pdf",showModal:!0}):window.open(a.data.URL,"REPRINT PHIEU THANH TOAN","width=600,height=650").print())},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){f.closeloading()})},a.txtTTNganHang_Change=function(){var b=a.detail.Info_TotalAmount-parseFloat(a.detail.TTNganHang);0>b&&(b=0),a.detail.TTTienMat=b},a.btnSave_Click=function(){var b=h();b.$$state.value===!0&&f.Post("Save",a.detail,f.url).then(function(b){var c=b.data.Status;0===c.StatusCode?(g.ShowMessageDialog(c.MessageId),a.detail=b.data.Data):(a.success=!1,g.ShowMessageDialog(c.MessageId))},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})},b(function(){i()},50),j(),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=10,a.maxSize=3,a.listPageSize=[100,200,500],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){k()}),a.beginlog=0,a.endlog=0,a.currentPagelog=1,a.itemsPerPagelog=8,a.maxSize=3,a.listPageSizelog=[100,200,500],a.pageChangedlog=function(b){a.currentPagelog=b},a.itemsPerPageChangedlog=function(b){a.currentPagelog=1,a.itemsPerPagelog=b},a.$watch("currentPagelog + itemsPerPagelog",function(){l()}),a.beginTraMon=0,a.endTraMon=0,a.currentPageTraMon=1,a.itemsPerPageTraMon=8,a.maxSize=3,a.listPageSizeTraMon=[100,200,500],a.pageChangedTraMon=function(b){a.currentPageTraMon=b},a.itemsPerPageChangedTraMon=function(b){a.currentPageTraMon=1,a.itemsPerPageTraMon=b},a.$watch("currentPageTraMon + itemsPerPageTraMon",function(){m()}),b(function(){n()},50)}]),app.controller("HoaDonBanEditCtrl",["$scope","$timeout","$filter","$uibModalInstance","$q","$translate","data","RestaurantListService","AppDialog","appKeyBoard",function(a,b,c,d,e,f,g,h,i,j){function k(){h.showloading();var b={CompanyId:h.CompanyId,BranchId:h.BranchId,UserName:h.UserName,IPAddress:h.IPAddress,UserId:h.userId};h.Post("InitHoaDonBanLe",b,h.urlCombobox).then(function(b){0===b.data.Status.StatusCode&&(a.DataConfig=b.data.DataConfig,a.ItemCategoryList=b.data.Data,a.ItemList=JSON.parse(b.data.Data2),a.VatList=b.data.Data3,a.KhachHangList=b.data.Data4,a.NVPVuList=b.data.Data5,a.MaNVLapList=b.data.Data5,a.SellerIdList=b.data.Data5,a.NVChonMonList=b.data.Data5,a.dtKhuyenMaiHangHoa=b.data.Data6,a.dtChuongTrinhKhuyenMai=b.data.Data7,a.BankAccountList=b.data.Data8,a.customerModels=b.data.Data9,a.TheVipList=b.data.Data10,a.ShipperList=b.data.Data11,a.DetailBangGiaLePos=JSON.parse(b.data.Data12),a.dtInfo=b.data.Data13,a.dtItem=a.dtInfo.listDetail,a.drItem=b.data.Data14,a.LocationList=b.data.Data16,a.TonKhoList=JSON.parse(b.data.ArrTonKho),a.ItemCategoryList.push({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:"",Selected:0}),l(a.dataCopy))},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))}).then(function(b){B=$("#divItemListDetail").width()-20,C=$("#divItemListDetail").height()-20;var c=parseInt(B/D),d=parseInt(C/E);a.itemListDetailPerPage=c*d;var e=(B-D*c)/2,f=(C-E*d)/2;$("#divContainerItemDetail").css("padding-left",e),$("#divContainerItemDetail").css("padding-top",f),a.btnItemCategory_Click({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:""})},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading(),$("#btnItemDetailPre").css("display",""),$("#btnItemDetailNext").css("display",""),a.SoHoaDonHienThiToiDa=30})}function l(a){h.showloading();var b={CompanyId:h.CompanyId,BranchId:h.BranchId,ID:a.ID};h.Post("ReloadHoaDonBan",b,h.urlEdit).then(function(b){0===b.data.Status.StatusCode?s({InfoId:a.ID}):i.ShowMessageDialog(b.data.Status.MessageId).then(function(){d.close()})},function(a){}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()})}function m(){for(var b=0;b<=a.ItemListDetailFilter.length-1;b++){var d=c("filter")(a.DetailBangGiaLePos,{ItemId:a.ItemListDetailFilter[b].ID,UnitId:parseFloat(a.ItemListDetailFilter[b].Field3)},!0);d.length>0&&(a.ItemListDetailFilter[b].UnitPrice=d[0].Price);var e=c("filter")(a.TonKhoList,{ItemId:a.ItemListDetailFilter[b].ID,DVT:parseFloat(a.ItemListDetailFilter[b].Field3)},!0);e.length>0?a.ItemListDetailFilter[b].SLTonKho=e[0].SLDK:a.ItemListDetailFilter[b].SLTonKho=0}}function n(){var a=$("#td-sale-invoice").height()-40;$("#divSaleInvoice").height(a);var b=$("#td-Detail-Item").height();$("#divDetailTable_Item").height(b-10)}function o(b,d){null===d&&(d=1),a.priceItem=0;var e=null===a.PriceDetailByCustomer?a.DetailBangGiaLePos:a.PriceDetailByCustomer,f=c("filter")(e,{ItemId:b.ID,UnitId:parseFloat(b.Field3)},!0);f.length>0&&(a.priceItem=f[0].Price);var g=angular.copy(a.drItem),i=c("filter")(a.dtItem,{ItemId:b.ID,UomId:parseFloat(b.Field3),UnitPrice:a.priceItem,StatusId:x.ChonMon},!0),j=new Date,k=j.getFullYear()+""+j.getMonth()+j.getDate()+j.getHours()+j.getMinutes()+j.getSeconds();if(0===a.dtInfo.EmployeeOrderId&&(a.dtInfo.EmployeeOrderId=null===h.userId||void 0===h.userId?0:h.userId),0==i.length){g.ID=0,g.IdTmp=k,g.InfoId="",g.AddOn=0,g.ParentId=0,g.ItemId=b.ID,g.ItemName=b.Name,g.Quantity=parseFloat(d),g.UomId=parseFloat(b.Field3),g.UnitPrice=parseFloat(a.priceItem),g.DisCount02=0,g.Disc_Amount02=0,g.BranchId=h.BranchId,g.CompanyId=h.CompanyId,g.Canceled=0,g.StatusId=0,g.Amount=parseFloat(g.Quantity)*parseFloat(g.UnitPrice),g.DisCount01=0,g.Disc_Amount01=parseFloat(g.Amount)*parseFloat(g.DisCount01)/100,g.VAT_DiscAmount=0,g.VatAmount=parseFloat(g.Amount)*parseFloat(g.VAT_DiscAmount)/100,g.TotalAmount=parseFloat(g.Amount)+parseFloat(g.VatAmount)-parseFloat(g.Disc_Amount01),g.RowStatus=w.Active;var l=c("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1},!0);if(1===a.dtChuongTrinhKhuyenMai.length&&1===l.length){var m=c("filter")(a.dtKhuyenMaiHangHoa,{ItemId:b.ID,UomId:parseFloat(b.Field3)},!0);m.length>0&&(0===m[0].DiscAmountEdit?(g.DisCount01=m[0].Discount,g.Dis_AmountEdit=0,g.Disc_Amount01=parseFloat(g.Amount)*parseFloat(g.DisCount01)/100):(g.Disc_Amount01=m[0].DiscAmount,g.Dis_AmountEdit=1,0!=g.Disc_Amount01&&0!=g.Amount&&(g.DisCount01=100*g.Disc_Amount01/g.Amount)),g.TotalAmount=parseFloat(g.Amount)+parseFloat(g.VatAmount)-parseFloat(g.Disc_Amount01))}a.dtItem.push(g),1===b.Field11}else i[0].Quantity+=parseFloat(d),i[0].Amount=parseFloat(i[0].Quantity)*parseFloat(i[0].UnitPrice),0===i[0].Dis_AmountEdit?i[0].Disc_Amount01=parseFloat(i[0].Amount)*parseFloat(i[0].DisCount01)/100:i[0].DisCount01=100*i[0].Disc_Amount01/i[0].Amount,i[0].TotalAmount=i[0].Amount-i[0].Disc_Amount01,i[0].RowStatus=w.Update;q().then(function(a){r()})}function p(a,b){}function q(b,d,f){var g=e.defer(),j=9;a.dtInfo.BranchId=h.BranchId,a.dtInfo.CompanyId=h.CompanyId,a.dtInfo.IPAddress=h.IPAddress,d=void 0===d||null===d?"":d;var k=c("filter")(a.dtChuongTrinhKhuyenMai,{PromotionType:1,Id:d},!0);if(1===k.length)for(var l=0;l<=a.dtItem.length-1;l++){var m=c("filter")(a.dtKhuyenMaiHangHoa,{ItemId:a.dtItem[l].ItemId,UomId:a.dtItem[l].UomId,DocInfoId:d},!0);m.length>0&&(0===m[0].DiscAmountEdit?(a.dtItem[l].DisCount01=m[0].Discount,a.dtItem[l].Dis_AmountEdit=0,a.dtItem[l].Disc_Amount01=parseFloat(a.dtItem[l].Amount)*parseFloat(a.dtItem[l].DisCount01)/100):(a.dtItem[l].Disc_Amount01=m[0].DiscAmount,a.dtItem[l].Dis_AmountEdit=1,0!=a.dtItem[l].Disc_Amount01&&0!=a.dtItem[l].Amount&&(a.dtItem[l].DisCount01=100*a.dtItem[l].Disc_Amount01/a.dtItem[l].Amount)),a.dtItem[l].TotalAmount=parseFloat(a.dtItem[l].Amount)+parseFloat(a.dtItem[l].VatAmount)-parseFloat(a.dtItem[l].Disc_Amount01))}var n={CompanyId:h.CompanyId,BranchId:h.BranchId,UserName:h.UserName,dtInfo:a.dtInfo,dtItem:a.dtItem,dtReturnItem:a.dtReturnItem,PromotionType:b,PromotionId:d,KhuyenMaiVip:f,IPAddress:h.IPAddress};return h.showloading(),h.Post("SaveInvoiceTmp",n,h.urlEdit).then(function(b){a.dtInfo.ID,b.data.Status.StatusCode;if(3==b.data.Status.StatusCode)a.dtInfo.length=0,a.dtItem.length=0,a.dtReturnItem.length=0;else{if(9==b.data.Status.StatusCode)return void i.ShowMessageDialog(b.data.Status.MessageId);a.dtInfo=JSON.parse(b.data.Data),a.dtItem=JSON.parse(b.data.Data2),a.dtReturnItem=JSON.parse(b.data.Data4),a.ArrHoaDon=b.data.ArrHoaDon,a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var c=0,d=0;d<=a.dtDoiDiemVipList.length-1;d++)c+=parseFloat(a.dtDoiDiemVipList[d].HanMucDoiDiemThuong);a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(c)}j=0,g.resolve(j)},function(a){console.log("Error:"+a.data.Message),g.reject("Error:"+a.data.Message)})["finally"](function(){h.closeloading()}).then(function(a){},function(a){console.log("error:"+a.data),g.reject("error:"+a.data)}),g.promise}function r(b){(null===b||void 0===b)&&(b=0);var d=c("filter")(a.dtItem,{StatusId:0},!0);if(d.length>0||1===b){a.dtInfo.SoTienKhachDua=a.dtInfo.Info_TotalAmount;var e=parseFloat(a.dtInfo.SoTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount);0>=e&&(e=0),a.dtInfo.TienTraLaiKhach=e}}function s(b){h.showloading();var d={CompanyId:h.CompanyId,BranchId:h.BranchId,ID:b.InfoId};h.Post("GetDetailById",d,h.urlEdit).then(function(b){a.dtInfo=JSON.parse(b.data.Data),a.dtItem=JSON.parse(b.data.Data2),a.dtReturnItem=JSON.parse(b.data.Data4),a.drInfo=b.data.Data5,a.drItem=b.data.Data6,a.drReturnItem=b.data.Data8,a.dtDoiDiemVipList=JSON.parse(b.data.Data9),a.DiemTichLuySauDoiDiem=a.dtInfo.DiemTichLuy;for(var d=0,e=0;e<=a.dtDoiDiemVipList.length-1;e++)d+=parseFloat(a.dtDoiDiemVipList[e].HanMucDoiDiemThuong);if(a.DiemTichLuySauDoiDiem=parseFloat(a.dtInfo.DiemTichLuy)-parseFloat(d),a.MaKHOptions.setValue=a.dtInfo.CustomerId,a.MaTheVipFilterOptions.setValue=a.dtInfo.VipId,r(),parseFloat(a.dtInfo.CustomerId)>0){var f=c("filter")(a.KhachHangList,{ID:a.dtInfo.CustomerId},!0);if(f.length>0)var g=null!==f[0].Field6?f[0].Field6:0;if(parseFloat(g)>0){var i={CompanyId:h.CompanyId,BranchId:h.BranchId,ID:g};h.Post("GetDetailBangGiaLePosById",i,h.Url+"api/BGLePOS/").then(function(b){a.PriceDetailByCustomer=JSON.parse(responsee.data.Data)},function(a){})["finally"](function(){})}}else a.PriceDetailByCustomer=null;if(a.LocationList.length>0){var j=c("filter")(a.LocationList,{ID:a.dtInfo.LocationId},!0);j.length>0&&(a.LocationName=j[0].Name)}},function(a){console.log("Error:"+a.data.Message)}).then(function(a){},function(a){console.log("error:"+a.data)})["finally"](function(){h.closeloading()})}function t(b){b.StatusId===x.InHoaDon?i.ShowConfirmDialog("Bạn có chắc muốn xóa ["+b.ItemName+"] ?").then(function(a){0==a&&j.LyDoTraDialog("").then(function(a){0==a.Cancel&&(b.RowStatus=w.InActive,u(b,parseFloat(b.Quantity),a.value),q().then(function(a){r(1)}))})}):(b.RowStatus=w.InActive,p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q().then(function(a){r(1)}))}function u(b,c,d){null===c&&(c=1);var e=angular.copy(a.drReturnItem);e.ItemId=b.ItemId,e.ItemName=b.ItemName,e.Quantity=parseFloat(c),e.UomId=b.UomId,e.UnitPrice=b.UnitPrice,e.Amount=parseFloat(e.Quantity)*parseFloat(e.UnitPrice),e.DisCount01=0,e.Disc_Amount01=0,e.DisCount02=0,e.Disc_Amount02=0,e.Note=d,e.StatusId=b.StatusId,e.RowStatus=w.Active,a.dtReturnItem.push(e)}function v(){var b=c("filter")(h.Role,{ScreenCode:"ScreenPOSLe"},!0);if("1"!==h.IsAdministrator){if(b.length>0){var d=c("filter")(b,{ActionCode:"InHoaDon"},!0)[0];$("#btnInHoaDon").prop("disabled",void 0===d?!0:!d.IsEnable);var e=c("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnLuuHoaDon").prop("disabled",void 0===e?!0:!e.IsEnable);var f=c("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=void 0===f?!1:f.IsEnable;var g=c("filter")(b,{ActionCode:"EditPostingDate"},!0)[0];a.editPostingDate=void 0===g?!1:g.IsEnable}}else{var f=c("filter")(b,{ActionCode:"ChoPhepSuaGiaBan"},!0)[0];a.ChoPhepSuaGiaBan=!0;var g=c("filter")(b,{ActionCode:"EditPostingDate"},!0)[0];a.editPostingDate=!0}}a.dataCopy=angular.copy(g);var w={Active:1,Update:2,InActive:3},x={ChonMon:0,InHoaDon:2};a.linkPdfPhieuThanhToan="http://",a.CurrOrdinalNumber=0,a.LocationName="",a.ArrHoaDon=null;a.DataConfig=null,a.ItemCategoryList=null,a.ItemList=null,a.VatList=null,a.KhachHangList=null,a.NVPVuList=null,a.NVKinhDoanh=null,a.MaNVLapList=null,a.SellerIdList=null,a.NVChonMonList=null,a.permissionList=null,a.systemData=null,a.dtChuongTrinhKhuyenMai=null,a.dtKhuyenMaiHangHoa=null,a.TheVipList=null,a.dtDoiDiemVipList=null,a.ShipperList=null,a.DetailBangGiaLePos=null,a.PriceDetailByCustomer=null,a.SoHoaDonHienThiToiDa=4,a.ChoPhepSuaGiaBan=!1,a.editPostingDate=!1,a.LocationList=null,a.TonKhoList=null,a.dtInfo=null,a.dtItem=null,a.drItem=null,a.DiemTichLuySauDoiDiem=0,a.customerModels=null,a.BankAccountList=null,a.HinhThucThanhToan=[],a.MaKHOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"300",field3width:"0",field4width:"0",field5width:"0",setValue:-1,maxDropDownItems:6},a.selectedRow=0,a.setClickedRow=function(b){a.selectedRow=b;var c=a.dtItem[a.selectedRow];1==c.AddOn?a.btnAddOnDisable=!0:a.btnAddOnDisable=!1};var y=null,z=null,A=null,B=0,C=0;a.itemListDetailPerPage=0;var D=160,E=105,F=0;a.ItemListDetailFilter=null,a.btnAllItemCategory_Selected=0;var G=null;a.isShowbtnDelete=!1,a.MaTheVipFilterOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"100",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,setfocus:!1,maxDropDownItems:10},a.btnItemCategory_Click=function(b){a.txtTextSearch="",a.ItemListFilter=0===b.ID?a.ItemList:c("filter")(a.ItemList,{Field6:b.ID.toString()},!0),itemCategoryBeforeSelected=y,y=b,y.Selected=1,null!=itemCategoryBeforeSelected&&b!=itemCategoryBeforeSelected&&(itemCategoryBeforeSelected.Selected=0),a.btnShowAllItemDetail_Click(b),$("#txtMaHangQuetBarcode").focus()},a.btnShowAllItemDetail_Click=function(b){void 0===b?a.btnItemCategory_Click({ID:0,Code:"000",Name:"Tất cả hàng hóa",Field3:""}):(b.Selected=1,0===b.ID?a.btnAllItemCategory_Selected=1:a.btnAllItemCategory_Selected=0),G=angular.copy(a.ItemListFilter),F=1;var c=(F-1)*a.itemListDetailPerPage,d=c+a.itemListDetailPerPage;a.ItemListDetailFilter=G.slice(c,d),m()},a.btnItemDetailPre_Click=function(){F>1&&(F-=1);var b=(F-1)*a.itemListDetailPerPage,c=b+a.itemListDetailPerPage;a.ItemListDetailFilter=G.slice(b,c),m()},a.btnItemDetailNext_Click=function(){var b=F+1,c=(b-1)*a.itemListDetailPerPage,d=c;c<G.length&&(d=c+a.itemListDetailPerPage,a.ItemListDetailFilter=G.slice(c,d),F=b,m())},a.$watch("txtTextSearch",function(b){if(void 0!==a.ItemListFilter){F=1;var d=(F-1)*a.itemListDetailPerPage,e=d+a.itemListDetailPerPage;G=c("filter")(a.ItemListFilter,b),a.ItemListDetailFilter=G.slice(d,e),m()}}),b(function(){n(),k()},2e3),a.btnItemDetail_SingleClick=function(a){A=z,z=a,z.Selected=1,null!=A&&a!=A&&(A.Selected=0);var b=1;o(a,b)},a.txtMaHangQuetBarcode_keydown=function(b){if(13===b.which){var d=c("filter")(a.ItemList,{Barcode:a.txtMaHangQuetBarcode.toUpperCase()},!0);if(1===d.length){if(o(d[0],1),a.txtMaHangQuetBarcode="",$("#txtMaHangQuetBarcode").focus(),void 0!==a.ItemListFilter){F=1;var e=(F-1)*a.itemListDetailPerPage,f=e+a.itemListDetailPerPage;G=c("filter")(a.ItemListFilter,a.txtMaHangQuetBarcode),a.ItemListDetailFilter=G.slice(e,f),m()}}else if(void 0!==a.ItemListFilter){F=1;var e=(F-1)*a.itemListDetailPerPage,f=e+a.itemListDetailPerPage;G=c("filter")(a.ItemListFilter,a.txtMaHangQuetBarcode),a.ItemListDetailFilter=G.slice(e,f),m()}}else if(void 0!==a.ItemListFilter){F=1;var e=(F-1)*a.itemListDetailPerPage,f=e+a.itemListDetailPerPage;G=c("filter")(a.ItemListFilter,a.txtMaHangQuetBarcode),a.ItemListDetailFilter=G.slice(e,f),m()}},a.btnSoLuong_Click=function(b){j.keyBoardNumber(b.Quantity,0,"Điều chỉnh số lượng",b.Amount,-1).then(function(c){b.Quantity!=c.value&&0==c.Cancel&&(b.Quantity=c.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=w.Update,b.Quantity<=0&&(b.RowStatus=w.InActive),p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q().then(function(a){r(1)}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnGiaBan_Click=function(b){(0===b.UnitPrice||a.ChoPhepSuaGiaBan!==!1)&&(b.StatusId==x.InHoaDon?i.ShowMessageDialog("Không được điều chỉnh giá khi đã in hóa đơn."):j.keyBoardNumber(b.UnitPrice,0,"Điều chỉnh giá bán",b.Amount,-1).then(function(c){b.UnitPrice!=c.value&&0==c.Cancel&&(b.UnitPrice=c.value,b.Amount=parseFloat(b.Quantity)*parseFloat(b.UnitPrice),0===b.Dis_AmountEdit?b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100:b.DisCount01=100*b.Disc_Amount01/b.Amount,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=w.Update,p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q().then(function(a){r()}))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){}))},a.btnGiamGiaDetail_Click=function(b){b.StatusId==x.InHoaDon?i.ShowMessageDialog("Không được điều chỉnh giảm giá khi đã in hóa đơn."):j.keyBoardNumber(b.Disc_Amount01,b.DisCount01,"Điều chỉnh giảm giá món",b.Amount,1==b.Dis_AmountEdit?1:0).then(function(c){
0==c.discountType&&0==c.Cancel?b.DisCount01!=c.value&&(b.DisCount01=c.value,b.Dis_AmountEdit=!1,b.Disc_Amount01=parseFloat(b.Amount)*parseFloat(b.DisCount01)/100,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=w.Update):1==c.discountType&&b.Disc_Amount01!=c.value&&(b.Disc_Amount01=c.value,b.DisCount01=100*b.Disc_Amount01/b.Amount,b.Dis_AmountEdit=!0,b.TotalAmount=b.Amount-b.Disc_Amount01,b.RowStatus=w.Update),p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q().then(function(a){r()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnNoteItem_Click=function(a){j.NoteDialog(a.Note).then(function(b){a.Note!==b.value&&(a.Note=b.value,a.RowStatus=w.Update,q())},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnDeleteItem_Click=function(a){t(a)},a.btnInHoaDon_Click=function(b){(null===b||void 0===b)&&(b=0);c("filter")(a.dtItem,{StatusId:2},!0);a.dtItem.length<=0?i.ShowMessageDialog("Bạn vui lòng nhập hàng hóa."):q().then(function(c){var d={CompanyId:h.CompanyId,BranchId:h.BranchId,UserName:h.UserName,AreaId:0,TableId:0,Value01:a.dtInfo.ID,EmployeeId:null===h.userId||void 0===h.userId?0:h.userId,IPAddress:h.IPAddress,TienKhachDua:a.dtInfo.SoTienKhachDua,TienTraLai:a.dtInfo.TienTraLaiKhach,TTTienMat:0,TTNganHang:0,NganHangId:0,TTVoucher:0,VoucherId:0};h.Post("InHoaDonBanLe",d,h.urlEdit).then(function(c){0!==c.data.Status.StatusCode&&""!==c.data.Status.MessageId?i.ShowMessageDialog(c.data.Status.MessageId):(a.dtInfo=c.data.Data,a.dtItem=c.data.Data2,a.dtReturnItem=c.data.Data4,a.drInfo=c.data.Data5,a.drItem=c.data.Data6,a.drReturnItem=c.data.Data8,a.ArrHoaDon=c.data.ArrHoaDon,""!==c.data.URL&&(1===b?printJS({printable:c.data.URL,type:"pdf",showModal:!0}):window.open(c.data.URL,"PRINT PHIEU THANH TOAN","width=600,height=650").print()))},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})})},a.btnLuuHoaDon_Click=function(b){var e=c("filter")(a.dtItem,{StatusId:2},!0);a.dtInfo.StatusId!=x.InHoaDon||e.length<a.dtItem.length?i.ShowMessageDialog("Bạn chưa in hóa đơn."):i.ShowDetailFormDialog({data:{dtInfo:a.dtInfo,KhachHangList:a.KhachHangList,BankAccountList:a.BankAccountList,customerModels:a.customerModels},tempUrl:"app/components/Sales/Restaurant/HinhThucThanhToan.html?nd="+Date.now(),ctrl:"HinhThucThanhToanCtrl",cssclass:"Modal-width550",focuscontrolid:"txtTienKhachDua"}).then(function(b){if(1==b.confirmStatus){a.KhachHangList.length!==b.data.KhachHangList.length&&(a.KhachHangList=angular.copy(b.data.KhachHangList));var c={CompanyId:h.CompanyId,BranchId:h.BranchId,UserName:h.UserName,AreaId:0,TableId:0,Value01:a.dtInfo.ID,Value02:b.data.dtInfo.CustomerId,ListObject:b.data.HinhThucTT,IPAddress:h.IPAddress,LoaiPM:h.MaNganh};h.showloading(),h.Post("SaveInvoiceAfterEdit",c,h.urlEdit).then(function(a){0!==a.data.Status.StatusCode?i.ShowMessageDialog(a.data.Status.MessageId):i.ShowMessageDialog("Lưu thành công.").then(function(){d.close()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){h.closeloading()})}})},a.btnGiamGiaTongBill_Click=function(){j.keyBoardNumber(a.dtInfo.Info_DiscAmount,a.dtInfo.Info_Discount,"Điều chỉnh giảm giá tổng Bill",a.dtInfo.Info_Amount,1==a.dtInfo.Info_Dis_AmountEdit?1:0).then(function(b){0==b.discountType&&0==b.Cancel?a.dtInfo.Info_Discount!=b.value&&(a.dtInfo.Info_Discount=b.value,a.dtInfo.Info_DiscAmount=parseFloat(a.dtInfo.Info_Amount)*parseFloat(a.dtInfo.Info_Discount)/100,a.dtInfo.Info_Dis_AmountEdit=0):1==b.discountType&&0==b.Cancel&&a.dtInfo.Info_DiscAmount!=b.value&&(a.dtInfo.Info_DiscAmount=b.value,a.dtInfo.Info_Discount=100*parseFloat(a.dtInfo.Info_DiscAmount)/parseFloat(a.dtInfo.Info_Amount),a.dtInfo.Info_Dis_AmountEdit=1),p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q().then(function(a){r()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnTienKhachDua_Click=function(){j.keyBoardNumber(a.dtInfo.SoTienKhachDua,0,"Tiền khách đưa",a.dtInfo.Info_Amount,-1).then(function(b){if(0===b.Cancel){a.dtInfo.SoTienKhachDua=parseFloat(b.value);var c=parseFloat(a.dtInfo.SoTienKhachDua)-parseFloat(a.dtInfo.Info_TotalAmount);0>=c&&(c=0),a.dtInfo.TienTraLaiKhach=c,p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q()}},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnTienThue_Click=function(){var b=!1;j.selectVAT(a.dtInfo.Info_VAT_DiscAmount,a.VatList).then(function(c){""!=c.Code&&0==c.Cancel&&(a.dtInfo.Info_VAT_DiscAmount=c.GiaTri,a.dtInfo.Info_VatAmount=(a.dtInfo.Info_Amount-a.dtInfo.Info_DiscAmount+a.dtInfo.Info_ServiceChargeAmount)*a.dtInfo.Info_VAT_DiscAmount/100,b=!0),p(a.dtInfo.Info_Dis_AmountEdit,a.dtInfo.Info_ServiceChargeAmtEdit),q().then(function(a){r()})},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})},a.btnChiTietHoaDon_Click=function(){$("#divChiTietHoaDonOutside").css("height",$("#divContainer").height()-8),$("#divChiTietHoaDonOutside").css("display","")},a.btnCloseChiTietHoaDon_Click=function(){$("#divChiTietHoaDonOutside").css("display","none")},a.btnSaveChiTietHoaDon_Click=function(){q(),a.btnCloseChiTietHoaDon_Click()},a.btnChuongTrinhKhuyenMai_Click=function(){var b=null===a.dtChuongTrinhKhuyenMai||void 0===a.dtChuongTrinhKhuyenMai?0:a.dtChuongTrinhKhuyenMai.length;if(0===a.dtItem.length)i.ShowMessageDialog("Vui lòng chọn hàng hóa.");else if(0===b)i.ShowMessageDialog("Không có chương trình khuyến mãi ở thời điểm hiện tại.");else{j.selectChuongTrinhKhuyenMai(a.dtChuongTrinhKhuyenMai).then(function(a){0==a.Cancel&&q(a.PromotionType,a.ID)},function(a){console.log("Error:"+a.data.Message)})["finally"](function(){})}},a.MaTheVipFilter_selectedrow=function(b){0!==b.ID&&0===b.Field7?i.ShowMessageDialog("Thẻ Vip đã hết hạn sử dụng."):(a.dtInfo.VipId=b.ID,q(null,null,1))},a.CustomerId_selectedrow=function(b){if(a.PriceInfoId=null!==b&&null!==b.Field6?b.Field6:0,a.dtInfo.TenKH=b.Name,a.dtInfo.DiaChiKH=b.Field11,a.dtInfo.DienThoaiKH=b.Field12,parseFloat(a.PriceInfoId)>0){var c={CompanyId:h.CompanyId,BranchId:h.BranchId,ID:a.PriceInfoId};h.showloading(),h.Post("GetDetailBangGiaLePosById",c,h.Url+"api/BGLePOS/").then(function(b){a.PriceDetailByCustomer=JSON.parse(b.data.Data)},function(a){})["finally"](function(){h.closeloading()})}else a.PriceDetailByCustomer=null},a.btnLogOut_Click=function(){i.ShowConfirmDialog("Bạn có chắc muốn thoát chương trình ?").then(function(a){0==a&&$location.path("/")})},b(function(){v()},50),a.btnThoat_Click=function(){d.close()}}]),app.factory("TongHopDoanhSoKhachHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e}]),app.controller("TongHopDoanhSoKhachHangCtrl",["$scope","$uibModal","$translate","AppDialog","TongHopDoanhSoKhachHangService",function(a,b,c,d,e){function f(){e.showloading(),e.Post("InitDoanhThuTheoNgay",{CompanyId:e.CompanyId,BranchId:e.BranchId},e.urlCombobox).then(function(b){a.CustomerList=b.data.Data,a.EmployeeCreatedList=b.data.Data2},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})}a.searhResultList=null,a.CustomerList=null,a.EmployeeCreatedList=null,a.CustomerOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.EmployeeCreatedOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){e.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,EmployeeCreatedId:a.EmployeeCreatedId,DocumentNo:a.DocumentNo,CompanyId:e.CompanyId,BranchId:e.BranchId};e.Post("search",b,e.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):d.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){e.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.EmployeeCreatedId=0,a.DocumentNo="",$("#FromDate").focus()},f()}]),app.factory("TongHopDoanhSoTrongNgayService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("TongHopDoanhSoTrongNgayCtrl",["$scope","$filter","$uibModal","$timeout","$translate","AppDialog","TongHopDoanhSoTrongNgayService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_BaoCaoTongHop",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.EmployeeCreatedList=b.data.Data2,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){null!=a.searhResultList&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}function k(){if("1"!==g.IsAdministrator){var c=b("filter")(g.Role,{ScreenCode:"BaoCaoTongHopDoanhSoTrongNgay"},!0);if(c.length>0){var d=b("filter")(c,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.EmployeeCreatedList=null,a.TotalRow=null,a.AreaList=null,a.LoaiPM=g.MaNganh,a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,EmployeeCreatedId:a.EmployeeCreatedId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BaoCaoTongHopDoanhSoTrongNgay",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,j(),showAlertMessage(formatThousands(a.searhResultList.length)+e.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h(),a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,EmployeeCreatedId:a.EmployeeCreatedId,AreaId:a.AreaId,CompanyId:g.CompanyId,BranchId:g.BranchId},c="TongHopDoanhSoTrongNgay.xlsx";g.ExportExcel("BaoCaoTongHopDoanhSoTrongNgayExport",b,g.url,c).then(function(a){},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,$("#FromDate").focus()},a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){j()}),k()}]),app.factory("TongHopTraMonService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/SaleReports/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("TongHopTraMonCtrl",["$scope","$uibModal","$translate","$timeout","$filter","AppDialog","TongHopTraMonService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitBC_TongHopTraMon",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.ItemList=b.data.Data,a.CustomerList=b.data.Data2,i()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),d(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Sales_TongHopTraMon"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.CustomerList=null,a.ItemList=null,a.TotalRow=null,a.LoaiPM=g.MaNganh,a.CodeNameOptions={showcode:!0,showname:!0,showfield3:!1,showfield4:!1,showfield5:!1,codewidth:"70",namewidth:"200",field3width:"0",field4width:"0",field5width:"0",setValue:0,maxDropDownItems:6},a.btnSearch=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,ItemId:a.ItemId,CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("BC_TongHopTraMon",b,g.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=JSON.parse(b.data.Data),a.TotalRow=b.data.Data2,showAlertMessage(formatThousands(a.searhResultList.length)+c.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnExport_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CustomerId:a.CustomerId,ItemId:a.ItemId,CompanyId:g.CompanyId,BranchId:g.BranchId},d="BC_TongHopTraHang.xlsx";g.ExportExcel("BC_TongHopTraHangExport",b,g.url,d).then(function(a){},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.CustomerId=0,a.ItemId=0,$("#FromDate").focus()},h(),j()}]),app.factory("AuthService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Auth/",e}]),app.controller("RegisterCtrl",["$scope","$http","AuthService","AppDialog",function(a,b,c,d){a.btnBack=function(){jQuery(".login-form").show(),jQuery(".register-form").hide(),$("#idContentLogin").css("width","360px")},a.MaNganhList=[],a.MaNganhList.push({Code:"001",MoTa:"Cafe - quán ăn - fastfood - nhà hàng"}),a.MaNganhList.push({Code:"002",MoTa:"Trà sữa - zise topping - in tem dán ly"}),a.MaNganhList.push({Code:"003",MoTa:"Bán lẻ - bán sỉ - cửa hàng - shop - siêu thị"}),a.MaNganhList.push({Code:"004",MoTa:"Karaoke - bida - tính tiền giờ"}),a.submitted=!1,a.comparePass=!0;a.btnRegister=function(){""!==a.Password&&a.Password!==a.RePassword?a.comparePass=!1:a.comparePass=!0;var c=sessionStorage.getItem("host")+"api/Auth/Register";if(a.submitted=!0,a.register.$valid){var e={FullName:a.FullName,Phone:a.Phone,Address:a.Address,Email:a.Email,TenCuaHang:a.TenCuaHang,MaGianHang:a.MaGianHang,UserName:a.UserName,Password:a.Password,RePassword:a.RePassword,MaNganh:a.MaNganh,LoaiHinhKinhDoanh:a.MaNganh,Capcha:"",PartnerCode:a.PartnerCode};b({url:c,method:"post",data:e,cache:!1}).success(function(b){0===b.Status.StatusCode?d.ShowMessageDialog("REGISTER_SUCESSFULLY").then(function(){$("#login.MaGianHang").val(e.MaGianHang),$("#login.UserName").val(e.UserName),$("#login.Password").val(e.Password),a.btnBack()}):d.ShowMessageDialog(b.Status.MessageId)}).error(function(a){d.ShowMessageDialog("CMN_MSG_ERROR")})}}}]),app.directive("compareTo",function(){return{require:"ngModel",scope:{confirmPassword:"=compareTo"},link:function(a,b,c,d){d.$validators.compareTo=function(b){return b==a.confirmPassword},a.$watch("confirmPassword",function(){d.$validate()})}}}),app.controller("LoginCtrl",["$scope","$http","$q","$window","AuthService","AuthenticationService","LoginService","AppDialog",function(a,b,c,d,e,f,g,h){a.linkRegister=function(){jQuery(".login-form").hide(),jQuery(".register-form").show(),$("#idContentLogin").css("width","80%")},$("#idContentLogin").css("width","360px");var i=d.localStorage.MaGianHang,j=d.localStorage.UserName;a.MaGianHang=i,a.UserName=j,a.Password="",$("#login.Password").attr("autocomplete","off");a.submitted=!1,a.btnLogin=function(){a.submitted=!0,a.formLogin.$valid&&g.login(a.MaGianHang,a.UserName,a.Password).then(function(b){null!=b&&void 0!=b.error?(a.message=b.error_description,a.errorInput=!0,h.ShowMessageDialog("CMN_MSG_LOGIN_ERROR")):window.location="/"})}}]),app.factory("ConnectedStatusService",["$q","$http","AppServices",function(a,b,c){var d=Object.create(c);return d.url=d.Url+"api/CheckConnect/",d}]),app.controller("ConnectedStatusCtrl",["$scope","$http","ConnectedStatusService",function(a,b,c){function d(){var b={};c.Post("ConnectedList",b,c.url).then(function(b){a.Data=b.data},function(b){a.gridOptions.data=null,showAlertMessage($translate.instant("CMN_MSG_ERROR"))})["finally"](function(){c.closeloading()})}a.Data=null,d()}]),app.factory("ChuoiCuaHangService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/BaoCaoChuoi/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("ChuoiCuaHangCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","ChuoiCuaHangService",function(a,b,c,d,e,f){function g(){f.showloading(),f.Post("InitQuanLyChuoi",{CompanyId:f.CompanyId,BranchId:f.BranchId},f.urlCombobox).then(function(b){a.GianHangList=JSON.parse(b.data.Data),a.KhoHangList=JSON.parse(b.data.Data2),a.NhomHangList=JSON.parse(b.data.Data3),a.HangHoaList=JSON.parse(b.data.Data4)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){f.showloading();var b={UserId:f.UserId,CompanyId:f.CompanyId,BranchId:a.BranchId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,ItemId:a.ItemId};f.Post("BCChuoiKhoHang",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.TonKhoChuoiList=JSON.parse(b.data.Data),a.TonKhoChuoiTotalRow=b.data.Data2):e.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}a.ReportTypeId=0,a.ReportType={BaoCaoHangTonKho:0,BaoCaoBanHang:1,BaoCaoSoQuyTien:2,BaoCaoKetQuaKinhDoanh:3},a.GianHangList=[],a.KhoHangList=[],a.NhomHangList=[],a.HangHoaList=[],a.TonKhoChuoiList=[],a.TonKhoChuoiTotalRow=[],a.btnViewReport_Click=function(b){a.ReportTypeId=b},a.btnViewReport_Click(0),g(),a.btnSearch_Click=function(){a.ReportTypeId===a.ReportType.BaoCaoHangTonKho&&h()},a.btnViewDetailKhoHang_Click=function(b){var d={FromDate:new Date,ToDate:new Date,ItemId:a.ItemId,LocationId:a.LocationId,ItemCategoryId:a.ItemCategoryId,CompanyId:f.CompanyId,BranchId:b.BranchId};f.Post("Inv_BC_TonKho",d,f.Url+"api/InvReports/").then(function(a){e.ShowDetailFormDialog({data:{data:a.data.Data,TotalRow:a.data.Data2},tempUrl:"app/components/Systems/BaoCaoChuoiCuaHang/ChuoiKhoHangChiTiet.html",ctrl:"ChuoiKhoHangChiTietCtrl",cssclass:"Modal-transaction",focuscontrolid:""}).then(function(a){})},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}}]),app.controller("ChuoiKhoHangChiTietCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","$q","data","ChuoiCuaHangService","AppDialog",function(a,b,c,d,e,f,g,h,i){function j(){l()}function k(){window.innerHeight-40-20}function l(){a.dtItem.length>0&&(a.begin=(a.currentPage-1)*a.itemsPerPage,a.end=a.begin+a.itemsPerPage)}a.dtItem=JSON.parse(g.data),a.TotalRow=g.TotalRow,a.btnCancel=function(){c.close(0)},b(function(){k(),j()},50),a.begin=0,a.end=0,a.currentPage=1,a.itemsPerPage=100,a.maxSize=3,a.listPageSize=[10,20,50,100,200],a.pageChanged=function(b){a.currentPage=b},a.itemsPerPageChanged=function(b){a.currentPage=1,a.itemsPerPage=b},a.$watch("currentPage + itemsPerPage",function(){l()})}]),app.factory("BranchService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Branch/",e}]),app.controller("BranchCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","BranchService",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"Branch"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_Branch",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"Code",display:"Mã",headerclass:"text-align-center col-w-80px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Name",display:"Tên chi nhánh",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Address",display:"Địa chỉ",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"PhoneNo",display:"Điện thoại",headerclass:"text-align-center col-w-100px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"Ghi chú",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={Code:a.Code,Name:a.Name,CompanyId:f.CompanyId};f.Post("search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.Code="",a.Name="",$("#Code").focus()},a.btnAddOrEdit=function(b){var c={ID:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.ID?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Systems/Branch/BranchDetail.html",ctrl:"BranchDetailCtrl",cssclass:"Modal-width550",focuscontrolid:null===a.data.ID?"code":"name"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.ID)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(c.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("BranchDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","BranchService","AppDialog",function(a,b,c,d,e,f,g,h){function i(b){g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})}function j(){g.showloading();var b={BranchId:f.ID};g.Post("GetListLicense",b,g.url).then(function(b){a.listLicense=b.data.Data},function(a){})["finally"](function(){g.closeloading()})}function k(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"Branch"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.listLicense=null,a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,null!==f.ID&&(a.disablecode=!0),a.btnAddnew=function(c){1==c||1==c?null!=a.detail&&(a.detail.ID=0,a.detail.Code=""):a.detail=null,a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("code").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,""!==a.detail.Id&&a.detail.HinhThucTraSua!==a.dataCopy.HinhThucTraSua?h.ShowConfirmDialog("Bạn vừa thay đổi hình thức kinh doanh trà sữa, bảng giá sẽ bị thay đổi, bạn có muốn tiếp tục không ?").then(function(a){0===parseInt(a)&&i(b)}):i(b))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("code").focus():""==a.detail.Code||null==a.detail.Code?document.getElementById("code").focus():document.getElementById("name").focus(),a.form.$setPristine()},j(),b(function(){k()},50)}]),app.factory("CounterService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Counter/",e}]),app.controller("CounterCtrl",["$scope","$rootScope","$uibModal","$translate","$filter","AppDialog","CounterService",function(a,b,c,d,e,f,g){function h(){if("1"!==g.IsAdministrator){var b=e("filter")(g.Role,{ScreenCode:"Counter"},!0);if(b.length>0){var c=e("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var d=e("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave").prop("disabled",void 0===d?!0:!d.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.btnSearch=function(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("Search",b,g.url).then(function(b){0!=b.data.Status.StatusCode?showAlertMessage(d.instant(b.data.Status.MessageId)):a.searhResultList=b.data.Data},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnSearch(),a.btnSave_Click=function(){g.showloading(),g.Post("Update",a.searhResultList,g.url).then(function(b){0!=b.data.Status.StatusCode?f.ShowMessageDialog(b.data.Status.MessageId):(f.ShowMessageDialog(b.data.Status.MessageId),a.searhResultList=b.data.Data)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},h()}]),app.factory("DashboardService",["$q","$http","AppServices","AuthenticationService","signalR",function(a,b,c,d,e){var f=Object.create(c);return f.url=f.Url+"api/Dashboard/",void 0===f.accessToken&&(window.location="/login.html"),e.startHub({MaGianHang:c.MaGianHang,IsServer_Offline:0,ComputerName:c.UserName,LoginDevice:"WebApp",PublicIP:c.PublicIP}).then(function(){}),f}]),app.controller("DashboardCtrl",["$scope","$filter","$uibModal","$timeout","$translate","AppDialog","DashboardService","signalR",function(a,b,c,d,e,f,g,h){function i(a,b){return b+" "+a.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")}function j(){g.showloading();var a={MaGianHang:g.MaGianHang};g.Post("GetNumberDeviceConnect",a,g.Url+"api/CheckConnect/").then(function(a){var b=parseInt(a.data);b>parseInt(g.NumDeviceConnect)&&f.ShowMessageDialog("Số lượng User kết nối không được nhiều hơn "+g.NumDeviceConnect.toString()).then(function(){h.disconnected({MaGianHang:g.MaGianHang,ComputerName:g.UserName}),window.location="/login.html"})},function(a){})["finally"](function(){g.closeloading()})}function k(a){return[l(a.getDate()),l(a.getMonth()+1),a.getFullYear()].join("/")}function l(a){return a.toString().padStart(2,"0")}function m(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("search",b,g.url).then(function(b){if(12===b.data.Status.StatusCode)a.viewRole=!1;else if(14===b.data.Status.StatusCode)f.ShowMessageDialog(b.data.Status.MessageId);else if(0===b.data.Status.StatusCode){a.DoanhThuHomNay=b.data.Data,a.DoanhThuHomQua=b.data.Data2,a.DoanhThuTuanNay=b.data.Data3,a.dataTop10ItemMaxAmount=b.data.Data4,a.dataTop10ItemMaxQty=b.data.Data5,a.HanSuDung=b.data.Data6,a.CanhBaoHangTon=b.data.Data7;for(var c=0;c<a.dataTop10ItemMaxAmount.length;c++)a.chartDataTop10MaxAmount.datasets[0].data.push(a.dataTop10ItemMaxAmount[c].TotalAmount),a.chartDataTop10MaxAmount.labels.push(a.dataTop10ItemMaxAmount[c].ItemName);for(var c=0;c<a.dataTop10ItemMaxQty.length;c++)a.chartDataTop10MaxQty.datasets[0].data.push(a.dataTop10ItemMaxQty[c].QtyOrder),a.chartDataTop10MaxQty.labels.push(a.dataTop10ItemMaxQty[c].ItemName);null!==a.HanSuDung&&a.HanSuDung.length>0&&f.ShowMsgBanQuyen("Phần mềm hết hạn vào ngày "+k(new Date(a.HanSuDung[0].NgayHetHanDateTime))+", bạn có muốn nâng cấp bản quyền không giới hạn tính năng để dùng ổn định?")}},function(a){})["finally"](function(){g.closeloading()})}function n(){if("1"!==g.IsAdministrator){var c=b("filter")(g.Role,{ScreenCode:"DashBoard"},!0);if(c.length>0){var d=b("filter")(c,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.DoanhThuHomNay=null,a.DoanhThuHomQua=null,a.DoanhThuTuanNay=null,a.LoaiPM=g.MaNganh,a.HanSuDung=null,a.dataTop10ItemMaxAmount=null,a.dataTop10ItemMaxQty=null,a.CanhBaoHangTon=null,a.chartDataTop10MaxAmount=null,a.chartDataTop10MaxAmount={labels:[],datasets:[{label:"Top 10 sản phẩm doanh số cao nhất",backgroundColor:["rgba(255, 99, 132, 1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255, 99, 132, 1)","rgba(75, 192, 192, 1)","rgba(255, 102, 86, 1)","rgba(179, 181, 198, 1)"],borderColor:["rgba(255,99,132,1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255,99,132,1)","rgba(75, 192, 192, 1)","rgba(255, 102, 86, 1)","rgba(179, 181, 198, 1)"],borderWidth:1,data:[]}]},a.chartDataTop10MaxQty={labels:[],datasets:[{label:"Top 10 sản phẩm bán chạy theo số lượng",backgroundColor:["rgba(255, 99, 132, 1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255, 99, 132, 1)","rgba(75, 192, 192, 1)","rgba(255, 102, 86, 1)","rgba(179, 181, 198, 1)"],borderColor:["rgba(255,99,132,1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255,99,132,1)","rgba(75, 192, 192, 1)","rgba(255, 102, 86, 1)","rgba(179, 181, 198, 1)"],borderWidth:1,data:[]}]},a.Top10MaxAmountOptions={scales:{xAxes:[{ticks:{callback:function(a,b,c){return i(a,"$")}}}],yAxes:[{}]},tooltips:{enabled:!0,mode:"single",callbacks:{label:function(a,b){var c=b.labels[a.index],d=b.datasets[a.datasetIndex].data[a.index];return c+": "+i(d,"$")}}}},m(),d(function(){j()},1e3),n()}]),app.factory("DeviceConnectedService",["$q","$http","AppServices",function(a,b,c){var d=Object.create(c);return d.url=d.Url+"api/CheckConnect/",d}]),app.controller("DeviceConnectedCtrl",["$scope","$http","AppDialog","DeviceConnectedService","signalR",function(a,b,c,d,e){function f(){var b={MaGianHang:d.MaGianHang};d.Post("ConnectedListByBranch",b,d.url).then(function(b){a.Data=b.data},function(b){a.gridOptions.data=null,showAlertMessage($translate.instant("CMN_MSG_ERROR"))})["finally"](function(){d.closeloading()})}a.Data=null,f(),a.btnLogout_Click=function(a){c.ShowConfirmDialog("Bạn có chắc muốn đăng xuất ra khỏi hệ thống?").then(function(b){0==b&&e.LogoutDevice(a)})}}]),app.factory("LogTransactionService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/InvReports/",e.urlCombobox=e.Url+"api/Combobox/",e.urlSales=e.Url+"api/SaleReports/",e}]),app.controller("LogTransactionCtrl",["$scope","$uibModal","$filter","$timeout","$translate","AppDialog","LogTransactionService",function(a,b,c,d,e,f,g){function h(){g.showloading(),g.Post("InitLogTransaction",{CompanyId:g.CompanyId,BranchId:g.BranchId},g.urlCombobox).then(function(b){a.UserList=b.data.Data,a.ScreenList=b.data.Data2,a.ActionList=b.data.Data3,i()},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){
g.closeloading()})}function i(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),$("#containerTable1").height(b-40),d(function(){a.btnSearch()},200)}function j(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"LogTransaction"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable}else a.viewRole=!1}}a.viewRole=!0,a.searhResultList=null,a.UserList=null,a.ScreenList=null,a.ActionList=null,a.LogRefundList=null,a.tabIndex=0,a.changeTab_Click=function(b){a.tabIndex=b},a.btnSearch=function(){if(1===a.tabIndex)a.btnSearchItemRefund_Click();else{g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:a.UserName,ScreenCode:a.ScreenCode,ActionCode:a.ActionCode};g.Post("GetLogTransaction",b,g.url).then(function(b){0===b.data.Status.StatusCode?(a.searhResultList=b.data.Data,showAlertMessage(formatThousands(b.data.Data.length)+e.instant("CMN_SearchResult"))):f.ShowMessageDialog(b.data.Status.MessageId)},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}},a.btnSearchItemRefund_Click=function(){g.showloading();var b={FromDate:a.FromDate,ToDate:a.ToDate,CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:a.UserName};g.Post("GetListItemRefund",b,g.urlSales).then(function(b){a.LogRefundList=b.data.Data,showAlertMessage(formatThousands(b.data.Data.length)+e.instant("CMN_SearchResult"))},function(a){showAlertMessage(e.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})},a.btnClearSearch=function(){a.FromDate=new Date,a.ToDate=new Date,a.ItemId=0,a.LocationId=0,$("#FromDate").focus()},a.SLKiemKho_Change=function(a){a.SLChenhLech=a.SLKiemKho-a.SLTon},h(),j()}]),app.factory("PermissionService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Permission/",e}]),app.controller("PermissionCtrl",["$scope","$uibModal","$filter","$translate","$timeout","AppDialog","PermissionService",function(a,b,c,d,e,f,g){function h(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId};g.Post("InitPermession",b,g.url).then(function(b){a.UserGroupList=b.data.Data,a.FunctionList=b.data.Data2,a.BranchList=b.data.Data3,a.PermissionUserAreaList=b.data.Data4,a.gridUserGroupOptions.data=a.UserGroupList,a.gridFunctionOptions.data=a.FunctionList,a.UserGroupList.length>0&&a.btnUserGroup_Click(a.UserGroupList[0],0),a.FunctionList.length>0&&a.btnFunction_Click(a.FunctionList[0],0),a.BranchList.length>0&&a.btnBranch_Click(a.BranchList[0],0)},function(b){a.gridOptions.data=null,showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function i(){if(0!==l&&""!==m){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId,GroupId:l,FunctionCode:m};g.Post("GetPermission_UserGroup",b,g.url).then(function(b){a.PermissionList=b.data.Data,a.ScreenList=angular.copy(a.PermissionList),a.ScreenList.length=0;for(var d=0;d<=a.PermissionList.length-1;d++){var e=c("filter")(a.ScreenList,{ScreenCode:a.PermissionList[d].ScreenCode},!0);0===e.length&&a.ScreenList.push(a.PermissionList[d])}},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}}function j(b){g.showloading();var c={CompanyId:b.CompanyId,BranchId:b.ID};g.Post("GetRelationUserBranch",c,g.url).then(function(b){a.RelationUserBranch=b.data.Data},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function k(){if("1"!==g.IsAdministrator){var b=c("filter")(g.Role,{ScreenCode:"Permission"},!0);if(b.length>0){var d=c("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===d?!1:d.IsEnable;var e=c("filter")(b,{ActionCode:"Save"},!0)[0];$("#btnSave1").prop("disabled",void 0===e?!0:!e.IsEnable),$("#btnSave2").prop("disabled",void 0===e?!0:!e.IsEnable)}else a.viewRole=!1}}a.UserGroupList=null,a.FunctionList=null,a.PermissionList=null,a.BranchList=null,a.RelationUserBranch=null,a.ScreenList=null,a.viewRole=!0,a.PermissionUserAreaList=null,a.LoaiHinhKinhDoanh=g.LoaiHinhKinhDoanh,a.msgChiTietPhanQuyen="",a.msgChiTietPhanQuyenChiNhanh="";var l=0,m="";a.gridUserGroupOptions={data:[],id:"grid_UserGroup",reloaddata:0,showCheckall:!1,ListCheckSelected:[],showEdit:!1,showDelete:!1,showpaging:!1,columnDefs:[{field:"Name",display:"Tên",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.gridFunctionOptions={data:[],id:"grid_Function",reloaddata:0,showCheckall:!1,ListCheckSelected:[],showEdit:!1,showDelete:!1,showpaging:!1,columnDefs:[{field:"Name",display:"Chức năng",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},e(function(){h()},50),a.selectedRowUserGroup=0,a.btnUserGroup_Click=function(b,c){a.selectedRowUserGroup=c,l=b.ID,i(),a.msgChiTietPhanQuyen=b.Name},a.selectedRowFunction=0,a.btnFunction_Click=function(b,c){a.selectedRowFunction=c,m=b.Code,i()},a.selectedRowChiTiet=0,a.btnChiTietPhanQuyen_Click=function(b){a.selectedRowChiTiet=b},a.btnSave_Click=function(){g.showloading(),g.Post("SavePermission",a.PermissionList,g.url).then(function(a){var b=a.data.Status;f.ShowMessageDialog(b.MessageId)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.selectedRowBranch=0,a.btnBranch_Click=function(b,c){a.selectedRowBranch=c,j(b),a.msgChiTietPhanQuyenChiNhanh=b.Name},a.selectedRowRelation=0,a.btnRelationBranch_Click=function(b){a.selectedRowRelation=b},a.btnSaveRelationChiNhanh_Click=function(){g.showloading(),g.Post("SaveRelationChiNhanh",a.RelationUserBranch,g.url).then(function(a){var b=a.data.Status;f.ShowMessageDialog(b.MessageId)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},a.btnSaveRelationUserArea_Click=function(){g.showloading(),g.Post("SaveRelationUserArea",a.PermissionUserAreaList,g.url).then(function(a){var b=a.data.Status;f.ShowMessageDialog(b.MessageId)},function(b){a.success=!1,f.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()})},e(function(){k()},50)}]),app.factory("SettingService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/CompanyInfo/",e}]),app.controller("SettingCtrl",["$scope","$uibModal","$window","$filter","$timeout","$translate","AppDialog","SettingService",function(a,b,c,d,e,f,g,h){function i(){if("1"!==h.IsAdministrator){var b=d("filter")(h.Role,{ScreenCode:"Company"},!0);if(console.log(b),b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"ThanhLyData"},!0)[0];$("#btnThanhLyData").prop("disabled",void 0===e?!0:!e.IsEnable);var f=d("filter")(b,{ActionCode:"UploadReport"},!0)[0];$("#btnUploadReport").prop("disabled",void 0===f?!0:!f.IsEnable)}else a.viewRole=!1}}a.CompanyInfo=null,a.ParamList=null,a.ThanhLyChungTu=!1,a.ThanhLyDanhMuc=!1,a.ThanhLyDanhMucToanCty=!1,a.LoaiPM=h.MaNganh,a.LoaiHinhKinhDoanh=h.LoaiHinhKinhDoanh,a.IsAdministrator=h.IsAdministrator,a.ThanhLyData={LoaiThanhLy:0},a.UploadReport={TaoThuMucRiengChiNhanh:0},a.Params={BanHangCanTeen:0,InVaLuuHoaDon:0,TenWifi:"",PassWifi:"",TraSua_SuaSoLuong:0,SoLanInThanhToan:1,SoLanInCheBien:1,SoLanInTraMon:1,IsUsedColor_Size:0,showAllTable:0,IsTinhGioTheoThoiDiem:0,DoanhThuDenNgayHomSau:0,InHoaDonKetNoiBluetooth:0,Bluetooth_InHoaDonPC:0,Bluetooth_InCheBienBluetooth:0,Bluetooth_InCheBienPC:0,InHoaDonMayInAo:0,XacNhanInCheBien_RoiBan:0,isShowChooseCategory:0,BlockTimeOpenTable:0,InHoaDon_InCheBien_LuuHD:0,InHoaDon_ShowThanhToan_Luu:0},a.searhResultList=null,a.viewRole=!0,a.viewThanhLyData=!1,a.LocationList=null,a.btnSearch=function(){h.showloading();var b={ID:h.CompanyId};h.Post("Init",b,h.url).then(function(b){if(0!=b.data.Status.StatusCode)showAlertMessage(f.instant(b.data.Status.MessageId));else{a.CompanyInfo=b.data.Data,a.ParamList=b.data.Data4;var c=d("filter")(a.ParamList,{Code:"BanHangCanteen"},!0);a.Params.BanHangCanTeen=0===c.length?0:parseInt(c[0].Value);var e=d("filter")(a.ParamList,{Code:"InVaLuuHoaDon"},!0);a.Params.InVaLuuHoaDon=0===e.length?0:parseInt(e[0].Value);var g=d("filter")(a.ParamList,{Code:"TenWifi"},!0);a.Params.TenWifi=0===g.length?"":g[0].Value;var h=d("filter")(a.ParamList,{Code:"PassWifi"},!0);a.Params.PassWifi=0===h.length?"":h[0].Value;var i=d("filter")(a.ParamList,{Code:"TraSua_SuaSoLuong"},!0);a.Params.TraSua_SuaSoLuong=0===i.length?0:parseInt(i[0].Value);var j=d("filter")(a.ParamList,{Code:"SoLanInThanhToan"},!0);a.Params.SoLanInThanhToan=0===j.length?0:parseInt(j[0].Value);var k=d("filter")(a.ParamList,{Code:"SoLanInCheBien"},!0);a.Params.SoLanInCheBien=0===k.length?0:parseInt(k[0].Value);var l=d("filter")(a.ParamList,{Code:"SoLanInTraMon"},!0);a.Params.SoLanInTraMon=0===l.length?0:parseInt(l[0].Value);var m=d("filter")(a.ParamList,{Code:"IsUsedColor_Size"},!0);a.Params.IsUsedColor_Size=0===m.length?0:parseInt(m[0].Value);var n=d("filter")(a.ParamList,{Code:"ShowAllTable"},!0);a.Params.showAllTable=0===n.length?0:parseInt(n[0].Value);var o=d("filter")(a.ParamList,{Code:"IsTinhGioTheoThoiDiem"},!0);a.Params.IsTinhGioTheoThoiDiem=0===o.length?0:parseInt(o[0].Value);var p=d("filter")(a.ParamList,{Code:"DoanhThuDenNgayHomSau"},!0);a.Params.DoanhThuDenNgayHomSau=0===p.length?0:parseInt(p[0].Value);var q=d("filter")(a.ParamList,{Code:"InHoaDonKetNoiBluetooth"},!0);a.Params.InHoaDonKetNoiBluetooth=0===q.length?0:parseInt(q[0].Value);var r=d("filter")(a.ParamList,{Code:"Bluetooth_InHoaDonPC"},!0);a.Params.Bluetooth_InHoaDonPC=0===r.length?0:parseInt(r[0].Value);var s=d("filter")(a.ParamList,{Code:"Bluetooth_InCheBienBluetooth"},!0);a.Params.Bluetooth_InCheBienBluetooth=0===s.length?0:parseInt(s[0].Value);var t=d("filter")(a.ParamList,{Code:"Bluetooth_InCheBienPC"},!0);a.Params.Bluetooth_InCheBienPC=0===t.length?0:parseInt(t[0].Value);var u=d("filter")(a.ParamList,{Code:"InHoaDonMayInAo"},!0);a.Params.InHoaDonMayInAo=0===u.length?0:parseInt(u[0].Value);var v=d("filter")(a.ParamList,{Code:"XacNhanInCheBien_RoiBan"},!0);a.Params.XacNhanInCheBien_RoiBan=0===v.length?0:parseInt(v[0].Value);var w=d("filter")(a.ParamList,{Code:"isShowChooseCategory"},!0);a.Params.isShowChooseCategory=0===w.length?0:parseInt(w[0].Value);var x=d("filter")(a.ParamList,{Code:"BlockTimeOpenTable"},!0);a.Params.BlockTimeOpenTable=0===x.length?0:parseInt(x[0].Value);var y=d("filter")(a.ParamList,{Code:"InHoaDon_InCheBien_LuuHD"},!0);a.Params.InHoaDon_InCheBien_LuuHD=0===y.length?0:parseInt(y[0].Value);var z=d("filter")(a.ParamList,{Code:"InHoaDon_ShowThanhToan_Luu"},!0);a.Params.InHoaDon_ShowThanhToan_Luu=0===z.length?0:parseInt(z[0].Value)}},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.btnSearch(),a.btnSaveCompany_Click=function(){h.showloading(),h.Post("Update",a.CompanyInfo,h.url).then(function(a){g.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.btnThanhLy_Click=function(){var b=0===parseInt(a.ThanhLyData.LoaiThanhLy)?!0:!1,c=1===parseInt(a.ThanhLyData.LoaiThanhLy)?!0:!1,d=2===parseInt(a.ThanhLyData.LoaiThanhLy)?!0:!1,e=3===parseInt(a.ThanhLyData.LoaiThanhLy)?!0:!1;g.ShowConfirmDialog("Bạn có chắc muốn thanh lý dữ liệu ?").then(function(a){if(0==a){h.showloading();var i={ThanhLyChungTu:b,ThanhLyDanhMuc:c,ThanhLyDanhMucToanCty:d,ResetKho:e,CompanyId:h.CompanyId,BranchId:h.BranchId,UserName:h.UserName,PublicIP:h.PublicIP,UserId:h.userId};h.Post("ThanhLyData",i,h.url).then(function(a){0===a.data.Status.StatusCode?g.ShowMessageDialog("Thực hiện thành công!"):g.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})}})},a.btnSaveParams_Click=function(){for(var b=0;b<=a.ParamList.length-1;b++)"BanHangCanteen"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.BanHangCanTeen:"InVaLuuHoaDon"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.InVaLuuHoaDon:"TenWifi"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.TenWifi:"PassWifi"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.PassWifi:"TraSua_SuaSoLuong"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.TraSua_SuaSoLuong:"SoLanInThanhToan"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.SoLanInThanhToan:"SoLanInCheBien"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.SoLanInCheBien:"SoLanInTraMon"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.SoLanInTraMon:"IsUsedColor_Size"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.IsUsedColor_Size:"ShowAllTable"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.showAllTable:"IsTinhGioTheoThoiDiem"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.IsTinhGioTheoThoiDiem:"DoanhThuDenNgayHomSau"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.DoanhThuDenNgayHomSau:"InHoaDonKetNoiBluetooth"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.InHoaDonKetNoiBluetooth:"Bluetooth_InHoaDonPC"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.Bluetooth_InHoaDonPC:"Bluetooth_InCheBienBluetooth"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.Bluetooth_InCheBienBluetooth:"Bluetooth_InCheBienPC"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.Bluetooth_InCheBienPC:"InHoaDonMayInAo"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.InHoaDonMayInAo:"XacNhanInCheBien_RoiBan"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.XacNhanInCheBien_RoiBan:"isShowChooseCategory"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.isShowChooseCategory:"BlockTimeOpenTable"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.BlockTimeOpenTable:"InHoaDon_InCheBien_LuuHD"===a.ParamList[b].Code?a.ParamList[b].Value=a.Params.InHoaDon_InCheBien_LuuHD:"InHoaDon_ShowThanhToan_Luu"===a.ParamList[b].Code&&(a.ParamList[b].Value=a.Params.InHoaDon_ShowThanhToan_Luu);console.log(a.Params.InHoaDon_ShowThanhToan_Luu),h.showloading(),h.Post("UpdateParams",a.ParamList,h.url).then(function(a){0===a.data.Status.StatusCode?g.ShowMessageDialog("Thực hiện thành công!"):g.ShowMessageDialog(a.data.Status.MessageId)},function(a){showAlertMessage(f.instant("CMN_MSG_ERROR"))})["finally"](function(){h.closeloading()})},a.loadFile=function(b){a.$apply(function(){a.selectedFile=b[0]})},a.uploadFiles=function(){var b=$("#file1").get(0).files;0==b.length?g.ShowMessageDialog("Vui lòng chọn file."):g.ShowConfirmDialog("Bạn có chắc muốn Upload Report Design ?").then(function(c){if(0==c){var d={TaoThuMucRiengChiNhanh:a.UploadReport.TaoThuMucRiengChiNhanh};console.log(d);var e=new FormData;if(e.append("jsonData",JSON.stringify(d)),b.length>0)for(var f=0;f<b.length;f++)e.append("UploadedImage"+f,b[f]);$.ajax({type:"POST",url:h.url+"UpLoadReport/",contentType:!1,processData:!1,data:e,headers:{Authorization:"Bearer "+h.accessToken},success:function(a){0===a.Status.StatusCode?g.ShowMessageDialog("Upload file thành công."):g.ShowMessageDialog(a.data.Status.MessageId)},error:function(a,b,c){console.log(a.statusText),console.log(b),console.log(c)}})}})},e(function(){i()},50)}]),app.factory("SupportService",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/Support/",e}]),app.controller("SupportCtrl",["$scope","$translate","AppDialog","SupportService",function(a,b,c,d){a.linksupport=""}]),app.factory("sysUserServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/User/",e.urlCombobox=e.Url+"api/Combobox/",e}]),app.controller("sysUserCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","sysUserServices",function(a,b,c,d,e,f){function g(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId,UserName:f.UserName};f.Post("InitsysUser",b,f.urlCombobox).then(function(b){a.UserGroupList=b.data.Data2,h()},function(a){showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})}function h(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function i(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"User"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable);var h=d("filter")(b,{ActionCode:"ResetPassword"},!0)[0];$("#btnResetPass").prop("disabled",void 0===h?!0:!h.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.EmployeeList=null,a.UserGroupList=null,a.gridOptions={data:[],id:"grid_sysUser",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"UserName",display:"sysUser_LABEL_UserName",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"GroupName",display:"sysUser_LABEL_Group",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"EmployeeName",display:"sysUser_LABEL_Employee",headerclass:"text-align-center col-w-200px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"BranchName",display:"Chi nhánh",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"IsUsedDisplay",display:"Sử dụng",headerclass:"text-align-center col-w-80px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={UserName:a.UserName,GroupId:a.GroupId,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.UserName="",a.GroupId=0,$("#UserName").focus()},a.btnAddOrEdit=function(b){var c={Id:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.Id?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Systems/sysUser/sysUserDetail.html",ctrl:"sysUserDetailCtrl",cssclass:"Modal-width550",focuscontrolid:(0==a.data.Id,"UserName")}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.btnResetPass=function(){e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Systems/sysUser/ResetPassword.html",ctrl:"sysUserResetPassCtrl",cssclass:"Modal-width550",focuscontrolid:"UserName"}).then(function(a){})},a.gridEditData=function(b){a.btnAddOrEdit(b.Id)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(a.success=!1,e.ShowMessageDialog(c.data.Status.MessageId))},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),i()}]),app.controller("sysUserDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","sysUserServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){g.showloading();var b={CompanyId:g.CompanyId,BranchId:g.BranchId,UserName:g.UserName};g.Post("InitsysUser",b,g.urlCombobox).then(function(b){a.EmployeeList=b.data.Data,a.UserGroupList=b.data.Data2,a.userGroupModels=b.data.Data3},function(a){})["finally"](function(){g.closeloading()})}function j(b){g.showloading();var c={CompanyId:g.CompanyId,BranchId:g.BranchId,MasterType:b};g.Post("reloadMasterPlus",c,g.urlCombobox).then(function(b){0!=b.data.Status.StatusCode?h.ShowMessageDialog(b.data.Status.MessageId):"UserGroup"===b.data.Status.ObjData&&(a.UserGroupList=b.data.Data)},function(a){showAlertMessage(d.instant("CMN_MSG_ERROR"))})["finally"](function(){g.closeloading()})}function k(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"User"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.EmployeeList=null,a.UserGroupList=null,a.userGroupModels=null,a.disablecode=!1,a.detail=f,f.Id>0&&(a.disablecode=!0),a.btnAddnew=function(c){1==c||1==c?null!=a.detail&&(a.detail.Id=0,a.detail.UserName=""):(a.detail.Id=0,a.detail.UserName="",a.detail.Pwd="",a.detail.EmployeeName="",a.detail.GroupId=0,a.detail.IsUsed=1),a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("UserName").focus()},50)},a.btnSave=function(b){a.submitted=!0,null!=a.detail&&(0==a.detail.GroupId&&(a.detail.GroupId=null),null!==a.detail.UserName&&null!==a.detail.Pwd&&null!==a.detail.GroupId&&(a.form.$valid=!0)),a.form.$valid&&null!==a.detail.GroupId&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("UserName").focus():""==a.detail.UserName||null==a.detail.UserName?document.getElementById("UserName").focus():document.getElementById("Pwd").focus(),a.form.$setPristine()},i(),a.btnGroupUserPlus_Click=function(){h.ShowDetailFormDialog({data:angular.copy(a.userGroupModels),tempUrl:"app/components/Systems/sysUserGroup/sysUserGroupDetail.html",ctrl:"sysUserGroupDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(a){1==a&&j("UserGroup")})},b(function(){k()},50)}]),app.controller("sysUserChangePassCtrl",["$scope","$timeout","$uibModalInstance","$translate","data","sysUserServices","AppDialog",function(a,b,c,d,e,f,g){a.success=!1,a.submitted=!1,e.UserName=f.UserName,a.detail=e,a.btnSave=function(){a.submitted=!0,a.form.$valid&&(a.iserror=!1,f.showloading(),f.Post("ChangePass",a.detail,f.url).then(function(b){var d=b.data.Status;0==d.StatusCode?g.ShowMessageDialog("Đổi mật khẩu thành công.").then(function(){c.close("1")}):(a.success=!1,g.ShowMessageDialog(d.MessageId))},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")}}]),app.controller("sysUserResetPassCtrl",["$scope","$timeout","$uibModalInstance","$translate","data","sysUserServices","AppDialog",function(a,b,c,d,e,f,g){function h(){f.showloading();var b={CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Search",b,f.url).then(function(b){0===b.data.Status.StatusCode&&(a.ListUser=b.data.Data,console.log(a.ListUser))},function(a){})["finally"](function(){f.closeloading()})}a.success=!1,a.submitted=!1,a.ListUser=null,h(),a.btnSave=function(){a.submitted=!0,a.form.$valid&&(a.iserror=!1,f.showloading(),f.Post("ResetPassword",a.detail,f.url).then(function(b){var d=b.data.Status;0==d.StatusCode?g.ShowMessageDialog("Reset mật khẩu thành công.").then(function(){c.close("1")}):(a.success=!1,g.ShowMessageDialog(d.MessageId))},function(b){a.success=!1,g.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")}}]),app.factory("sysUserGroupServices",["$q","$http","AppServices","AuthenticationService",function(a,b,c,d){var e=Object.create(c);return e.url=e.Url+"api/UserGroup/",e}]),app.controller("sysUserGroupCtrl",["$scope","$uibModal","$translate","$filter","AppDialog","sysUserGroupServices",function(a,b,c,d,e,f){function g(){var b=($("#tdResult").width(),$("#tdResult").height());$("#containerTable").height(b-40),a.btnSearch()}function h(){if("1"!==f.IsAdministrator){var b=d("filter")(f.Role,{ScreenCode:"UserGroup"},!0);if(b.length>0){var c=d("filter")(b,{ActionCode:"View"},!0)[0];a.viewRole=void 0===c?!1:c.IsEnable;var e=d("filter")(b,{ActionCode:"Search"},!0)[0];$("#btnSearch").prop("disabled",void 0===e?!0:!e.IsEnable);var g=d("filter")(b,{ActionCode:"Delete"},!0)[0];$("#btnDelete").prop("disabled",void 0===g?!0:!g.IsEnable)}else a.viewRole=!1}}a.searhResultList=null,a.viewRole=!0,a.gridOptions={data:[],id:"grid_sysUserGroup",reloaddata:1,showCheckall:!0,ListCheckSelected:[],showEdit:!0,showDelete:!1,showpaging:!0,columnDefs:[{field:"GroupName",display:"sysUserGroup_LABEL_GroupName",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0},{field:"AllowAppReportString",display:"Cho phép đăng nhập app Báo cáo",headerclass:"text-align-center col-w-150px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"",visible:!0},{field:"AllowAppOrderString",display:"Cho phép đăng nhập app Order",headerclass:"text-align-center col-w-150px",detailclass:"text-align-center",formatnumber:"",formatdatetime:"",visible:!0},{field:"Note",display:"sysUserGroup_LABEL_Note",headerclass:"text-align-center col-w-150px",detailclass:"",formatnumber:"",formatdatetime:"",visible:!0}]},a.btnSearch=function(){f.showloading();var b={GroupName:a.GroupName,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Search",b,f.url).then(function(b){0==b.data.Status.StatusCode?(a.searhResultList=b.data.Data,a.gridOptions.data=a.searhResultList,showAlertMessage(formatThousands(b.data.Data.length)+c.instant("CMN_SearchResult"))):e.ShowMessageDialog(b.data.Status.MessageId)},function(b){a.gridOptions.data=null,showAlertMessage(c.instant("CMN_MSG_ERROR"))})["finally"](function(){f.closeloading()})},a.btnClearSearch=function(){a.GroupName="",$("#GroupName").focus()},a.btnAddOrEdit=function(b){var c={Id:b,CompanyId:f.CompanyId,BranchId:f.BranchId};f.Post("Detail",c,f.url).then(function(c){a.data=c.data.Data,a.dataid=b}).then(function(){a.dataid>0&&0==a.data.Id?e.ShowMessageDialog("CMN_MSG_DATA_NOT_EXIST"):e.ShowDetailFormDialog({data:a.data,tempUrl:"app/components/Systems/sysUserGroup/sysUserGroupDetail.html",ctrl:"sysUserGroupDetailCtrl",cssclass:"Modal-width550",focuscontrolid:"code"}).then(function(b){1==b&&a.btnSearch()})},function(a){e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()})},a.gridEditData=function(b){a.btnAddOrEdit(b.Id)},a.btnDeleteList=function(){var b=a.gridOptions.ListCheckSelected;b.length<=0?e.ShowMessageDialog("CMN_MSG_CONFIRM_SELECT_DATA"):e.ShowConfirmDialog("CMN_MSG_CONFIRM_DELETE").then(function(c){0==c&&(f.showloading(),f.Post("Deletelist",b,f.url).then(function(c){var d=c.data.Status;0==d.StatusCode?e.ShowMessageDialog("CMN_MSG_DELETE_SUCESSFULLY").then(function(){for(var c=0;c<=b.length-1;c++){var d=a.searhResultList.indexOf(b[c]);a.searhResultList.splice(d,1)}}):(e.ShowMessageDialog(c.data.Status.MessageId),a.success=!1)},function(b){a.success=!1,e.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){f.closeloading()}))})},g(),h()}]),app.controller("sysUserGroupDetailCtrl",["$scope","$timeout","$uibModalInstance","$translate","$filter","data","sysUserGroupServices","AppDialog",function(a,b,c,d,e,f,g,h){function i(){if("1"!==g.IsAdministrator){var a=e("filter")(g.Role,{ScreenCode:"UserGroup"},!0);if(a.length>0){var b=e("filter")(a,{ActionCode:"Save"},!0)[0];$("#btnSaveAndNew").prop("disabled",void 0===b?!0:!b.IsEnable),$("#btnSaveAndClose").prop("disabled",void 0===b?!0:!b.IsEnable)}else $("#btnSaveAndNew").prop("disabled",!0),$("#btnSaveAndClose").prop("disabled",!0)}}a.dataCopy=angular.copy(f),a.success=!1,a.submitted=!1,a.disablecode=!1,a.detail=f,a.btnAddnew=function(c){1==c||1==c?null!=a.detail&&(a.detail.Id=0,a.detail.UserName=""):a.detail=null,a.success=!1,a.submitted=!1,a.disablecode=!1,a.dataCopy=angular.copy(a.detail),b(function(){document.getElementById("UserName").focus()},50)},a.btnSave=function(b){a.submitted=!0,a.form.$valid&&(a.iserror=!1,a.detail.CompanyId=g.CompanyId,a.detail.BranchId=g.BranchId,g.showloading(),g.Post("Save",a.detail,g.url).then(function(d){var e=d.data.Status;0==e.StatusCode?h.ShowMessageDialog(e.MessageId).then(function(){1==b||1==b?a.btnAddnew(0):c.close("1")}):(a.success=!1,h.ShowMessageDialog(e.MessageId))},function(b){a.success=!1,h.ShowMessageDialog("CMN_MSG_ERROR")})["finally"](function(){g.closeloading()}))},a.btnCancel=function(){c.dismiss("cancel")},a.btnReset=function(){a.detail=angular.copy(a.dataCopy),null==a.detail?document.getElementById("UserName").focus():""==a.detail.UserName||null==a.detail.UserName?document.getElementById("UserName").focus():document.getElementById("Pwd").focus(),a.form.$setPristine()},b(function(){i()},50)}]);